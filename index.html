<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lufthansa Group Virtual — Fleet Groups UI</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg-1:#071727; --bg-2:#042f39; --card:#062630; --muted:#9fb6d6; --accent:#ffd700; --text:#eaf4ff;
  --glass:rgba(255,255,255,0.03); --shadow:0 12px 30px rgba(2,8,20,0.6); --radius:12px;
  --ok:#bff2be; --warn:#fff0b8; --danger:#ffcc88; --reserved:#c8b7ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:
linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(90deg,#032e3d,#063a59);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
.brand{display:flex;gap:14px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#073a45,#021a22);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
.title{line-height:1}
.title h1{margin:0;font-size:18px;color:var(--accent)}
.title p{margin:0;color:var(--muted);font-size:13px}
.header-actions{display:flex;gap:10px}
.btn{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer}
.btn-ghost{border:1px solid rgba(255,255,255,0.06)}
.btn-primary{background:var(--accent);color:#04202a;font-weight:800}
.layout{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
@media(max-width:1024px){.layout{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg,var(--card),#043945);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
.main-col{display:flex;flex-direction:column;gap:12px}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.select-wrap{display:flex;gap:8px;align-items:center}
.airline-groups{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:1100px){.airline-groups{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.airline-groups{grid-template-columns:1fr}}
.airline-card{border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border:1px solid rgba(255,255,255,0.03)}
.airline-card h4{margin:0;font-size:14px}
.row{display:flex;align-items:center;gap:10px}
.durations{display:flex;gap:8px;flex-wrap:wrap}
.btn-chip{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;cursor:pointer;color:var(--muted)}
.btn-chip.selected{background:rgba(255,215,0,0.06);border-color:rgba(255,215,0,0.18);color:var(--text);box-shadow:0 8px 20px rgba(255,215,0,0.04)}
.result{margin-top:8px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#021923,#042c33);border:1px solid rgba(255,255,255,0.03);display:none}
.result .head{display:flex;align-items:center;gap:12px}
.result .title{font-weight:900;color:var(--accent)}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.result .label{font-size:12px;color:var(--muted)}
.result .value{font-weight:800}
.actions{display:flex;gap:8px;margin-top:12px}
.aside{display:flex;flex-direction:column;gap:12px}
.fleet-panel{display:flex;flex-direction:column;gap:10px}
.fleet-search{display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
.filter{display:flex;gap:8px;align-items:center}
.fleet-groups{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto;padding-right:6px}
.group{border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.group-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
.group-head .title{display:flex;align-items:center;gap:10px}
.group-body{padding:10px;border-top:1px solid rgba(255,255,255,0.02);display:grid;grid-template-columns:1fr;gap:8px}
.card-plane{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.plane-type{width:56px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800}
.plane-info{display:flex;flex-direction:column;min-width:0}
.plane-meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
.tag-airline{font-size:11px;background:var(--accent);color:#04202a;padding:3px 8px;border-radius:999px;font-weight:800}
.status{margin-left:auto}
.status .idle{background:#083b22;color:var(--ok);padding:6px 8px;border-radius:8px;font-weight:800}
.status .reserved{background:#3b2b6a;color:var(--reserved);padding:6px 8px;border-radius:8px;font-weight:800}
.status .inflight{background:#603f00;color:var(--warn);padding:6px 8px;border-radius:8px;font-weight:800}
.empty{padding:12px;color:var(--muted);font-size:13px;text-align:center}
.confirmed-card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#063034,#043c45);border:1px solid rgba(255,255,255,0.04)}
.footer-note{margin-top:10px;color:var(--muted);font-size:13px}
.icon{opacity:0.9}
.chev{transition:transform .18s ease}
.search-empty{font-size:13px;color:var(--muted);padding:8px}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo">LH</div>
      <div class="title">
        <h1>Lufthansa Group Virtual</h1>
        <p class="small">Генератор рейсов — улучшенный просмотр флота по компаниям</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="openDemo" class="btn btn-ghost">Демо</button>
      <button id="about" class="btn btn-ghost">О проекте</button>
    </div>
  </header>

  <div class="layout">
    <main class="main-col">
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">Генерация и подтверждение рейса</h3>
            <div class="small" style="margin-top:6px">Поиск сначала по авиакомпании; затем резерв и подтверждение</div>
          </div>
          <div class="small">Демо-данные</div>
        </div>

        <div class="controls" style="margin-top:12px">
          <div style="min-width:320px;flex:1 1 420px">
            <h4 style="margin:0;color:var(--muted)">Авиакомпания</h4>
            <div id="airlines" class="airline-groups" style="margin-top:8px"></div>
          </div>

          <div style="min-width:220px">
            <h4 style="margin:0;color:var(--muted)">Длительность</h4>
            <div id="durations" class="durations" style="margin-top:8px"></div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
          <button id="gen" class="btn btn-primary">Сгенерировать и зарезервировать</button>
          <button id="demoGen" class="btn btn-ghost">Быстро: SunExpress</button>
          <button id="reset" class="btn btn-ghost">Сброс</button>
          <div style="flex:1"></div>
          <div class="small">Выбрано: <strong id="selectedInfo">—</strong></div>
        </div>

        <div id="result" class="result" role="status" aria-live="polite"></div>
      </section>

      <section id="confirmedSection"></section>
    </main>

    <aside class="aside">
      <div class="panel fleet-panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900">Флот</div>
            <div class="small">По компаниям, поиск и фильтрация</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="refreshFleet" class="btn btn-ghost">Обновить</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <input id="fleetSearch" class="input" placeholder="Поиск по ID, типу, городу" style="flex:1"/>
          <select id="statusFilter" class="input" style="width:140px">
            <option value="all">Все статусы</option>
            <option value="idle">Idle</option>
            <option value="reserved">Reserved</option>
            <option value="inFlight">InFlight</option>
          </select>
        </div>

        <div class="fleet-groups" id="fleetGroups" style="margin-top:10px"></div>

        <div class="footer-note">Подсказка: нажми на группу авиакомпании, чтобы свернуть/развернуть её. Резерв и подтверждение работают как раньше.</div>
      </div>

      <div class="panel">
        <h4 style="margin:0;color:var(--muted)">Инфо</h4>
        <div class="small" style="margin-top:8px">Всего маршрутов: <strong id="routesCount">—</strong></div>
        <h4 style="margin-top:12px;color:var(--muted)">Журнал назначений</h4>
        <div id="assignLog" class="small" style="margin-top:8px;max-height:220px;overflow:auto">Пока пусто</div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="showFleetLog" class="btn btn-ghost">Лог в консоли</button>
          <button id="clearLog" class="btn btn-ghost">Очистить журнал</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
/* ---------------- Demo data (unchanged semantics) ---------------- */
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Lufthansa Technik", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Milan", toICAO:"LIMC", durationMinutes:95 },
  { airline: "Lufthansa Cargo", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Dubai", toICAO:"OMDB", durationMinutes:420 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 },
  { airline: "Brussels Airlines", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Brussels", toICAO:"EBBR", durationMinutes:75 },
  { airline: "ITA Airways", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Rome", toICAO:"LIRF", durationMinutes:120 }
];
ROUTES.forEach(r=>{ r.durationMinutes = Number.isFinite(Number(r.durationMinutes)) ? Number(r.durationMinutes) : NaN; });

const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM","EDDH"] },
  { name: "Lufthansa CityLine", hubs: ["EDDF","EDDM"] },
  { name: "Lufthansa Cargo", hubs: ["EDDF"] },
  { name: "Lufthansa Technik", hubs: ["EDDF"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] },
  { name: "Brussels Airlines", hubs: ["EDDF"] },
  { name: "ITA Airways", hubs: ["LIRF"] }
];

const AIRPORTS = {
  "EDDF": { city:"Frankfurt", lat:50.0379, lon:8.5622 },
  "EDDM": { city:"Munich", lat:48.3538, lon:11.7861 },
  "ENGM": { city:"Oslo", lat:59.6498, lon:10.9198 },
  "EHAM": { city:"Amsterdam", lat:52.3105, lon:4.7683 },
  "LTAI": { city:"Antalya", lat:36.8969, lon:30.8001 },
  "LIMC": { city:"Milan", lat:45.6301, lon:8.7231 },
  "OMDB": { city:"Dubai", lat:25.2532, lon:55.3657 },
  "LSZH": { city:"Zurich", lat:47.4581, lon:8.5610 },
  "EBBR": { city:"Brussels", lat:50.9014, lon:4.4844 },
  "LIRF": { city:"Rome", lat:41.8003, lon:12.2389 }
};

/* ---------------- Expanded fleet with airline field ---------------- */
const FLEET = [
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A321-02', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A350-01', airline:'Lufthansa', type:'A350', rangeKm:15000, seats:300, turnaround:90, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-787-01', airline:'Lufthansa', type:'B787', rangeKm:14140, seats:270, turnaround:75, status:'idle', locationICAO:'EDDF', availableAt:0 },

  { id:'LC-747F-01', airline:'Lufthansa Cargo', type:'B747F', rangeKm:8000, seats:0, turnaround:120, status:'idle', locationICAO:'EDDF', availableAt:0 },

  { id:'LT-CRJ-01', airline:'Lufthansa Technik', type:'CRJ', rangeKm:2500, seats:70, turnaround:25, status:'idle', locationICAO:'EDDF', availableAt:0 },

  { id:'EW-A320-01', airline:'Eurowings', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'EW-A321-02', airline:'Eurowings', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },

  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'SX-B737-02', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDM', availableAt:0 },

  { id:'SN-A320-01', airline:'Brussels Airlines', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'AZ-A320-01', airline:'ITA Airways', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // extras to make groups denser
  { id:'LH-E190-01', airline:'Lufthansa CityLine', type:'E190', rangeKm:4000, seats:100, turnaround:30, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'LH-A321-03', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'SX-A320-03', airline:'SunExpress', type:'A320', rangeKm:6100, seats:180, turnaround:35, status:'idle', locationICAO:'EDDF', availableAt:0 }
];

const FLEET_LOG = [];

/* ---------------- State ---------------- */
let chosenAirIndex = null;
let chosenDur = null;
let lastGenerated = null; // { route, aircraftId, token }
const LOCAL_USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
const RESERVATION_TTL_MS = 120 * 1000;

/* ---------------- Helpers ---------------- */
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pad(n){ return String(n).padStart(2,'0'); }
function nowMs(){ return Date.now(); }
function getAirportInfo(icao){ return AIRPORTS[icao] || null; }

/* ---------------- Render UI pieces ---------------- */
const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const genBtn = document.getElementById('gen');
const demoGenBtn = document.getElementById('demoGen');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');
const fleetGroupsEl = document.getElementById('fleetGroups');
const fleetSearchEl = document.getElementById('fleetSearch');
const statusFilterEl = document.getElementById('statusFilter');
const routesCountEl = document.getElementById('routesCount');
const assignLogEl = document.getElementById('assignLog');
const confirmedSection = document.getElementById('confirmedSection');

/* Durations */
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480},
  {label:"9–10ч",min:540,max:600},
  {label:"10+ч",min:601,max:1200}
];
function renderDurations(){
  durationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn = document.createElement('button');
    btn.className='btn-chip';
    btn.type='button'; btn.textContent = d.label;
    btn.addEventListener('click', ()=>{ selectDur(i); });
    durationsWrap.appendChild(btn);
  });
}

/* Airlines (compact cards) */
function renderAirlines(){
  airlinesWrap.innerHTML='';
  const sorted = AIRLINES.slice().sort((a,b)=> a.name.localeCompare(b.name,'ru'));
  sorted.forEach((a,idx)=>{
    const card = document.createElement('div'); card.className='airline-card';
    card.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between">
      <div><div style="font-weight:900">${esc(a.name)}</div><div class="small" style="margin-top:4px">Хабы: ${a.hubs.join(', ')}</div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end">
        <button class="btn btn-ghost" data-idx="${idx}">Выбрать</button>
      </div>
    </div>`;
    const btn = card.querySelector('button');
    btn.addEventListener('click', ()=>{ selectAir(AIRLINES.indexOf(a)); document.querySelectorAll('.airline-card').forEach(n=>n.style.boxShadow='none'); card.style.boxShadow='0 10px 30px rgba(255,215,0,0.06)'; });
    airlinesWrap.appendChild(card);
  });
}

/* Fleet grouping: group by airline name, collapse/expand */
function groupFleet(){
  const byAir = {};
  FLEET.forEach(ac=>{
    const k = ac.airline || 'Other';
    if(!byAir[k]) byAir[k]=[];
    byAir[k].push(ac);
  });
  // Order groups by AIRLINES order first, then others
  const orderedKeys = AIRLINES.map(a=>a.name).filter(k=>byAir[k]).concat(Object.keys(byAir).filter(k => !AIRLINES.some(a=>a.name===k)).sort());
  fleetGroupsEl.innerHTML='';
  orderedKeys.forEach(key=>{
    const group = document.createElement('div'); group.className='group';
    const head = document.createElement('div'); head.className='group-head';
    const count = byAir[key].length;
    head.innerHTML = `<div class="title"><div style="font-weight:900">${esc(key)}</div><div class="small">${count} шт.</div></div><div class="chev">▾</div>`;
    const body = document.createElement('div'); body.className='group-body';
    // add plane cards
    byAir[key].forEach(ac => {
      const card = document.createElement('div'); card.className='card-plane';
      card.dataset.id = ac.id;
      card.dataset.type = ac.type;
      card.dataset.location = ac.locationICAO;
      card.dataset.airline = ac.airline || '';
      card.dataset.status = ac.status;
      card.innerHTML = `
        <div class="plane-type">${esc(ac.type)}</div>
        <div class="plane-info">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="font-weight:900;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ac.id)}</div>
            <div class="tag-airline" style="font-size:11px">${esc(ac.airline)}</div>
          </div>
          <div class="plane-meta">
            <div>${esc(ac.locationICAO)}</div>
            <div>·</div>
            <div>${ac.rangeKm} km</div>
            <div>·</div>
            <div>${ac.seats} seats</div>
          </div>
        </div>
        <div class="status">
          ${ac.status==='idle' ? '<div class="idle">idle</div>' : ac.status==='reserved' ? '<div class="reserved">reserved</div>' : '<div class="inflight">inFlight</div>'}
        </div>
      `;
      // click plane to show quick actions (reserve/cancel/inspect)
      card.addEventListener('click', ()=>{
        // highlight
        document.querySelectorAll('.card-plane').forEach(n=>n.style.outline='none');
        card.style.outline='2px solid rgba(255,215,0,0.12)';
        showPlaneQuick(card.dataset.id);
      });
      body.appendChild(card);
    });
    group.appendChild(head);
    group.appendChild(body);
    // collapse behavior (start expanded)
    let collapsed=false;
    head.addEventListener('click', ()=>{
      const chev = head.querySelector('.chev');
      if(collapsed){
        body.style.height = 'auto'; chev.style.transform='rotate(0deg)'; collapsed=false;
      } else {
        body.style.height = body.scrollHeight + 'px';
        requestAnimationFrame(()=>{ body.style.height = '0px'; });
        chev.style.transform='rotate(-90deg)'; collapsed=true;
        // restore auto after animation
        body.addEventListener('transitionend', function _t(e){ if(e.propertyName==='height'){ if(!collapsed) body.style.height='auto'; body.removeEventListener('transitionend', _t); } });
      }
    });
    fleetGroupsEl.appendChild(group);
  });
  applyFleetFilters(); // apply search/filter immediately
}

/* Show plane quick card in result area */
function showPlaneQuick(planeId){
  const ac = FLEET.find(a=>a.id===planeId);
  if(!ac) return;
  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div class="head"><div class="title">Инспекция самолёта</div><div style="margin-left:auto" class="small">${esc(ac.airline)}</div></div>
    <div class="result-grid">
      <div>
        <div class="label">ID</div><div class="value">${esc(ac.id)}</div>
        <div class="label" style="margin-top:6px">Тип</div><div class="value">${esc(ac.type)}</div>
        <div class="label" style="margin-top:6px">Локация</div><div class="value">${esc(ac.locationICAO)}</div>
      </div>
      <div>
        <div class="label">Дальность</div><div class="value">${ac.rangeKm} km</div>
        <div class="label" style="margin-top:6px">Места</div><div class="value">${ac.seats}</div>
        <div class="label" style="margin-top:6px">Статус</div>
        <div class="value">${ac.status}</div>
      </div>
    </div>
    <div class="actions">
      <button id="inspectReserve" class="btn btn-primary">Резерв для теста</button>
      <button id="inspectCancel" class="btn btn-ghost">Отменить резерв</button>
      <button id="inspectInspect" class="btn btn-ghost">Больше деталей</button>
      <div style="flex:1"></div>
    </div>
  `;
  document.getElementById('inspectReserve').onclick = ()=> {
    const res = reserveAircraft(ac, LOCAL_USER_ID);
    if(!res.ok) alert('Не удалось зарезервировать: ' + res.reason);
    else { lastGenerated = { route:null, aircraftId: ac.id, token: res.token, reservedAt: nowMs() }; renderReservationResult(lastGenerated); }
  };
  document.getElementById('inspectCancel').onclick = ()=> {
    if(ac.reservedToken) { cancelReservationByToken(ac.reservedToken); renderReservationResult(null); } else alert('Нет резерва у этого самолёта');
  };
}

/* Apply fleet search / status filter */
function applyFleetFilters(){
  const q = (fleetSearchEl.value||'').trim().toLowerCase();
  const status = statusFilterEl.value;
  document.querySelectorAll('.card-plane').forEach(card=>{
    const id = card.dataset.id.toLowerCase();
    const type = card.dataset.type.toLowerCase();
    const loc = card.dataset.location.toLowerCase();
    const airline = card.dataset.airline.toLowerCase();
    const st = card.dataset.status;
    let visible = true;
    if(q){
      visible = id.includes(q) || type.includes(q) || loc.includes(q) || airline.includes(q);
    }
    if(visible && status!=='all'){
      visible = st === status;
    }
    card.style.display = visible ? 'flex' : 'none';
  });
  // if all cards hidden, show message per group
  document.querySelectorAll('.group').forEach(gr=>{
    const any = gr.querySelectorAll('.card-plane').length > 0 && Array.from(gr.querySelectorAll('.card-plane')).some(c=>c.style.display!=='none');
    if(!any){
      let msg = gr.querySelector('.search-empty');
      if(!msg){
        msg = document.createElement('div'); msg.className='search-empty';
        msg.textContent = 'Нет подходящих самолётов в этой группе';
        gr.querySelector('.group-body').appendChild(msg);
      }
      msg.style.display='block';
    } else {
      const msg = gr.querySelector('.search-empty');
      if(msg) msg.style.display='none';
    }
  });
}

/* ---------------- Core reservation & assignment logic (same as before) ---------------- */
function reserveAircraft(ac, ownerId, ttlMs = RESERVATION_TTL_MS){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved';
  ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  renderFleetGroups(); // refresh view
  return { ok:true, token: ac.reservedToken };
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  ac.status = 'idle';
  renderFleetGroups();
  renderAssignLog();
  return true;
}
function confirmReservation(token, route){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };
  const now = nowMs();
  const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight';
  ac.availableAt = now + durationMs + ac.turnaround*60*1000;
  ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes });
  renderFleetGroups();
  renderAssignLog();
  renderConfirmedFlight(ac, route);
  return { ok:true, aircraft: ac };
}

/* Expire reservations & complete flights */
function expireReservations(){
  const now = nowMs();
  let changed=false;
  FLEET.forEach(ac=>{
    if(ac.status === 'reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status = 'idle';
      delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event:'reservation_expired', aircraft: ac.id });
      changed=true;
    }
    if(ac.status === 'inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status = 'idle';
      if(ac.nextLocation) ac.locationICAO = ac.nextLocation;
      delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO });
      changed=true;
    }
  });
  if(changed){ renderFleetGroups(); renderAssignLog(); }
}

/* Generate flight (airline-first), reserve best candidate */
function generateFlight(){
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  if(chosenDur===null){ alert('Выберите длительность'); return; }
  const airlineName = AIRLINES[chosenAirIndex].name;
  // primary: explicit routes
  let pool = ROUTES.filter(r => String(r.airline||'').toLowerCase() === airlineName.toLowerCase());
  if(pool.length===0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length===0){ showNoRoutes(airlineName); return; }
  if(typeof chosenDur === 'number'){
    const interval = DURATIONS[chosenDur];
    const filtered = pool.filter(r => Number.isFinite(r.durationMinutes) && r.durationMinutes >= interval.min && r.durationMinutes <= interval.max);
    if(filtered.length>0) pool = filtered;
  }
  const route = pool[randInt(0,pool.length-1)];
  // choose candidate: prefer same-airline idle at hub, then any idle at hub
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase() === airlineName.toLowerCase());
  if(candidates.length===0){
    candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  }
  if(candidates.length===0){ showNoAircraft(route); return; }
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];
  const reserveRes = reserveAircraft(candidate, LOCAL_USER_ID);
  if(!reserveRes.ok){ alert('Не удалось зарезервировать самолёт: ' + reserveRes.reason); return; }
  lastGenerated = { route, aircraftId: candidate.id, token: reserveRes.token, reservedAt: nowMs() };
  renderReservationResult(lastGenerated);
  renderFleetGroups();
}

/* UI helpers for no routes / no aircraft */
function showNoRoutes(airlineName){
  resultEl.style.display='block';
  resultEl.innerHTML = `<div class="head"><div class="title">Нет маршрутов</div><div style="margin-left:auto" class="small">${esc(airlineName)}</div></div>
    <div class="result-grid"><div><div class="label">Причина</div><div class="value">В демо нет маршрутов для этой авиакомпании или её хабов</div></div></div>`;
}
function showNoAircraft(route){
  resultEl.style.display='block';
  resultEl.innerHTML = `<div class="head"><div class="title">Нет свободных самолётов</div><div style="margin-left:auto" class="small">Хаб: ${esc(route.fromICAO)}</div></div>
    <div class="result-grid"><div><div class="label">Причина</div><div class="value">Нет idle самолётов в хабе</div></div></div>`;
}

/* Reservation result rendering (with confirm/cancel) */
function renderReservationResult(gen){
  if(!gen){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  if(!ac){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const route = gen.route;
  const remaining = ac.reservedUntil ? Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000)) : 0;
  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div class="head"><div class="title">Резерв создан</div><div style="margin-left:auto" class="small">${esc(ac.airline)}</div></div>
    <div class="result-grid">
      <div><div class="label">Откуда</div><div class="value">${route ? esc(route.fromCity)+' ('+esc(route.fromICAO)+')' : esc(ac.locationICAO)}</div></div>
      <div><div class="label">Куда</div><div class="value">${route ? esc(route.toCity)+' ('+esc(route.toICAO)+')' : '—'}</div></div>
      <div><div class="label">Самолёт</div><div class="value">${esc(ac.id)} · ${esc(ac.type)}</div></div>
      <div><div class="label">Резерв истечёт</div><div class="value"><span id="reserveCountdown">${remaining}</span> с</div></div>
    </div>
    <div class="actions">
      <button id="confirmBtn" class="btn btn-primary">Подтвердить полёт</button>
      <button id="cancelBtn" class="btn btn-ghost">Отменить резерв</button>
      <div style="flex:1"></div>
    </div>
  `;
  document.getElementById('confirmBtn').onclick = ()=>{
    if(!gen.route){ alert('Нет маршрута для подтверждения'); return; }
    const res = confirmReservation(gen.token, gen.route);
    if(!res.ok) alert('Не удалось подтвердить: ' + (res.reason||'unknown'));
    else { lastGenerated=null; renderReservationResult(null); }
  };
  document.getElementById('cancelBtn').onclick = ()=>{
    cancelReservationByToken(gen.token);
    lastGenerated=null;
    renderReservationResult(null);
  };
}

/* Confirmed flight card */
function renderConfirmedFlight(ac, route){
  confirmedSection.innerHTML='';
  const now = nowMs();
  const depart = new Date(now).toLocaleString();
  const flightMs = (Number(route.durationMinutes)||120)*60*1000;
  const eta = new Date(now + flightMs).toLocaleString();
  const card = document.createElement('div'); card.className='confirmed-card';
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900;color:var(--ok)">Рейс подтверждён</div><div class="small">${esc(ac.id)} · ${esc(ac.airline)}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <div><div class="label">Авиакомпания</div><div class="value">${esc(route.airline||'—')}</div></div>
      <div><div class="label">Статус</div><div class="value" style="color:var(--ok);font-weight:900">inFlight</div></div>
      <div><div class="label">Отправление</div><div class="value">${esc(route.fromCity)} (${esc(route.fromICAO)})</div><div class="small" style="margin-top:6px">Время: ${esc(depart)}</div></div>
      <div><div class="label">Прибытие</div><div class="value">${esc(route.toCity)} (${esc(route.toICAO)})</div><div class="small" style="margin-top:6px">ETA: ${esc(eta)}</div></div>
      <div><div class="label">Длительность</div><div class="value">${formatDuration(route.durationMinutes)}</div></div>
      <div><div class="label">Путь самолёта</div><div class="value">${esc(ac.locationICAO)} → ${esc(ac.nextLocation || route.toICAO)}</div></div>
    </div>
    <div class="small" style="margin-top:8px">Запись добавлена в журнал назначений</div>
  `;
  confirmedSection.appendChild(card);
}

/* Utilities */
function formatDuration(min){ if(!Number.isFinite(min)) return 'n/a'; const hh=Math.floor(min/60), mm=min%60; return pad(hh)+':'+pad(mm); }

/* Assignment helpers (distance used only for info) */
function estimateDistanceKm(fromICAO,toICAO){
  const a=getAirportInfo(fromICAO), b=getAirportInfo(toICAO);
  if(!a||!b||!a.lat||!b.lat) return null;
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const la=toRad(a.lat), lb=toRad(b.lat);
  const sinDlat=Math.sin(dLat/2), sinDlon=Math.sin(dLon/2);
  const c=2*Math.asin(Math.sqrt(sinDlat*sinDlat + Math.cos(la)*Math.cos(lb)*sinDlon*sinDlon));
  return Math.round(R*c);
}

/* find suitable aircraft (not used directly in grouped UI but kept) */
function findSuitableAircraftSmart(route){
  const distanceKm = estimateDistanceKm(route.fromICAO, route.toICAO);
  const safety=0.95;
  const basePool = FLEET.filter(ac=>{
    if(ac.status==='inFlight') return false;
    if((ac.locationICAO||'').toUpperCase() !== (route.fromICAO||'').toUpperCase()) return false;
    if(distanceKm===null) return true;
    return ac.rangeKm * safety >= distanceKm;
  });
  basePool.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  return { distanceKm, candidates: basePool };
}

/* Render assign log */
function renderAssignLog(){
  const items = FLEET_LOG.slice(-60).reverse();
  if(items.length===0){ assignLogEl.textContent='Пока пусто'; return; }
  assignLogEl.innerHTML = items.map(it=>{
    const t = new Date(it.ts).toLocaleTimeString();
    if(it.event==='assign') return `${t} — assign ${it.aircraft} ${it.route} (${it.durationMin||'n/a'} min)`;
    if(it.event==='assign_confirmed') return `${t} — confirmed ${it.aircraft} ${it.route}`;
    if(it.event==='reservation_expired') return `${t} — reservation_expired ${it.aircraft}`;
    if(it.event==='available') return `${t} — available ${it.aircraft} @ ${it.location}`;
    return `${t} — ${it.event}`;
  }).map(s=>`<div style="margin-bottom:6px">${esc(s)}</div>`).join('');
}

/* Wrapper renders */
function renderFleetGroups(){ groupFleet(); } // grouping will call filters
function renderAll(){
  renderAirlines();
  renderDurations();
  renderFleetGroups();
  renderAssignLog();
  routesCountEl.textContent = ROUTES.length;
}

/* housekeeping */
setInterval(()=>{
  expireReservations();
  if(lastGenerated){
    const ac = FLEET.find(a=>a.id=== lastGenerated.aircraftId);
    if(ac && ac.reservedUntil){
      const el = document.getElementById('reserveCountdown'); if(el) el.textContent = Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000));
    } else { lastGenerated=null; renderReservationResult(null); }
  }
},1000);

/* Events & bindings */
fleetSearchEl.addEventListener('input', ()=> applyFleetFilters());
statusFilterEl.addEventListener('change', ()=> applyFleetFilters());
document.getElementById('refreshFleet').addEventListener('click', ()=> renderFleetGroups());
document.getElementById('showFleetLog').addEventListener('click', ()=>{ console.table(FLEET_LOG.slice(-100)); alert('Лог в консоли'); });
document.getElementById('clearLog').addEventListener('click', ()=>{ FLEET_LOG.length=0; renderAssignLog(); });
genBtn.addEventListener('click', ()=> {
  if(lastGenerated && lastGenerated.token){
    if(!confirm('У вас уже есть активный резерв. Создать новый резерв отменит старый?')) return;
    cancelReservationByToken(lastGenerated.token); lastGenerated=null; renderReservationResult(null);
  }
  generateFlight();
});
demoGenBtn.addEventListener('click', ()=> {
  const idx = AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0){ selectAir(idx); selectDur(2); }
  generateFlight();
});
resetBtn.addEventListener('click', ()=> {
  chosenAirIndex=null; chosenDur=null; lastGenerated=null;
  selectedInfo.textContent='—'; resultEl.style.display='none'; resultEl.innerHTML=''; confirmedSection.innerHTML=''; document.querySelectorAll('.airline-card').forEach(n=>n.style.boxShadow='none');
  document.querySelectorAll('.btn-chip').forEach(n=>n.classList.remove('selected'));
});

/* select helpers used from airline cards */
function selectAir(origIndex){
  chosenAirIndex = origIndex;
  selectedInfo.textContent = AIRLINES[origIndex].name + ' · ' + AIRLINES[origIndex].hubs.join(',');
  document.querySelectorAll('.airline-card').forEach(n=>n.style.boxShadow='none');
}
function selectDur(i){
  chosenDur = i;
  document.querySelectorAll('.btn-chip').forEach((b,idx)=> b.classList.toggle('selected', idx===i));
}

/* reservation helpers re-exported to UI actions */
function renderReservationResultLocal(gen){ renderReservationResult(gen); }

/* init */
renderAll();

/* expose some functions for quick console testing (optional) */
window._debug = { FLEET, ROUTES, AIRLINES, reserveAircraft, cancelReservationByToken, confirmReservation, renderFleetGroups, renderAssignLog };

</script>
</body>
</html>
