<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Group Virtual — restored main UI + grouped fleet</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg-1:#041528; --bg-2:#073044; --accent:#ffd700; --muted:#9fb6d6; --text:#eaf4ff;
  --card:#072033; --glass:rgba(255,255,255,0.03); --radius:12px; --shadow:0 14px 40px rgba(2,8,20,0.6);
  --ok:#bff2be; --warn:#fff0b8; --reserved:#c8b7ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);padding:18px;display:flex;justify-content:center}
.wrap{width:100%;max-width:1200px}
.hero{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#03243a,#063a59);box-shadow:var(--shadow)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:52px;height:52px;border-radius:8px;background:linear-gradient(180deg,#063a59,#012938);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
h1{margin:0;color:var(--accent)}
.subtitle{margin:0;color:var(--muted)}
.btn{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer}
.btn-ghost{border:1px solid rgba(255,255,255,0.06)}
.btn-primary{background:var(--accent);color:#04202a;font-weight:800}
.card{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card),#043044);box-shadow:var(--shadow)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}
h3{margin:0;color:var(--muted);font-size:13px}
.small{font-size:13px;color:var(--muted)}
.airline-groups{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
@media(max-width:1100px){.airline-groups{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.airline-groups{grid-template-columns:1fr}}
.airline-group{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.004),transparent)}
.airline-group-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
.airline-badge{width:36px;height:36;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
.chev{transition:transform .22s;color:var(--muted)}
.airline-list{overflow:hidden;transition:max-height .22s cubic-bezier(.2,.9,.2,1);max-height:0}
.airline-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid rgba(255,255,255,0.01);cursor:pointer}
.airline-item:hover{background:rgba(255,255,255,0.01)}
.airline-item.selected{background:linear-gradient(90deg, rgba(255,215,0,0.06), rgba(255,215,0,0.02))}
.airline-item.disabled{opacity:0.45;pointer-events:none}

/* fleet (grouped) */
.fleet-panel{padding:12px;border-radius:10px;background:linear-gradient(180deg,#041f2a,#03222a);border:1px solid rgba(255,255,255,0.03)}
.fleet-controls{display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
.fleet-groups{display:flex;flex-direction:column;gap:10px;margin-top:12px;max-height:520px;overflow:auto;padding-right:6px}
.group{border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.group-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
.group-head .title{display:flex;align-items:center;gap:10px}
.group-body-wrapper{overflow:hidden;transition:max-height .22s cubic-bezier(.2,.9,.2,1);max-height:9999px}
.group-body{padding:10px;border-top:1px solid rgba(255,255,255,0.02);display:grid;grid-template-columns:1fr;gap:8px}
.card-plane{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.plane-type{width:56px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent)}
.plane-info{display:flex;flex-direction:column;min-width:0}
.plane-meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
.tag-airline{font-size:11px;background:var(--accent);color:#04202a;padding:3px 8px;border-radius:999px;font-weight:800;margin-left:8px}
.status{margin-left:auto}
.status .idle{background:#083b22;color:var(--ok);padding:6px 8px;border-radius:8px;font-weight:800}
.status .reserved{background:#3b2b6a;color:var(--reserved);padding:6px 8px;border-radius:8px;font-weight:800}
.status .inflight{background:#603f00;color:var(--warn);padding:6px 8px;border-radius:8px;font-weight:800}

/* result / reservation area */
.result{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#021923,#062733);border:1px solid rgba(255,255,255,0.03);display:none}
.res-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.res-title{font-weight:900;font-size:15px;color:var(--accent)}
.res-body{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.res-row{display:flex;flex-direction:column}
.res-label{font-size:12px;color:var(--muted)}
.res-value{font-weight:800}
.res-actions{display:flex;gap:8px;margin-top:12px;align-items:center}
.confirmed-card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#062733,#043c45);border:1px solid rgba(255,255,255,0.04)}

/* utility */
.hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <div class="logo">LH</div>
        <div>
          <h1>Lufthansa Group Virtual</h1>
          <div class="subtitle">Генератор рейсов — возвращён прежний вид, флот сгруппирован</div>
        </div>
      </div>
      <div>
        <button id="openDemo" class="btn btn-ghost">Открыть демо</button>
        <button id="about" class="btn btn-ghost">О проекте</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0;color:var(--accent)">Генерация рейса</h2>
          <div class="small" style="margin-top:6px">Сначала выбираем авиакомпанию → резерв → подтвердить</div>
        </div>
        <div class="small">Демо-данные</div>
      </div>

      <div class="grid">
        <div>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <h3>Авиакомпания</h3>
            <div id="airlines" class="airline-groups" aria-label="Список авиакомпаний"></div>

            <h3 style="margin-top:12px">Длительность</h3>
            <div id="durations"></div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
              <button id="gen" class="btn btn-primary">Сгенерировать и зарезервировать</button>
              <button id="demo" class="btn btn-ghost">Демо</button>
              <button id="reset" class="btn btn-ghost">Сброс</button>
              <div style="flex:1"></div>
              <div class="small">Выбрано: <strong id="selectedInfo">—</strong></div>
            </div>

            <div id="result" class="result" role="status" aria-live="polite"></div>
          </div>
        </div>

        <aside>
          <div class="fleet-panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:900">Флот</div>
                <div class="small" style="margin-top:4px">Группировка по авиакомпаниям — сворачивающиеся блоки</div>
              </div>
              <div style="display:flex;gap:8px">
                <button id="refreshFleet" class="btn btn-ghost">Обновить</button>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
              <input id="fleetSearch" class="input" placeholder="Поиск по ID/тип/город" style="flex:1"/>
              <select id="statusFilter" class="input" style="width:140px">
                <option value="all">Все статусы</option>
                <option value="idle">Idle</option>
                <option value="reserved">Reserved</option>
                <option value="inFlight">InFlight</option>
              </select>
            </div>

            <div id="fleetGroups" class="fleet-groups"></div>
          </div>

          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03);margin-top:12px">
            <h3>Инфо</h3>
            <div class="small" style="margin-top:8px">Всего маршрутов: <strong id="routesCount">—</strong></div>
            <h3 style="margin-top:12px">Журнал назначений</h3>
            <div id="assignLog" class="small" style="margin-top:8px">Пока пусто</div>
            <div style="margin-top:12px"><button id="clearLog" class="btn btn-ghost">Очистить журнал</button></div>
          </div>
        </aside>
      </div>
    </section>

    <section id="confirmedSection"></section>
  </div>

<script>
/* ---------------- DEMO DATA ---------------- */
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Lufthansa Technik", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Milan", toICAO:"LIMC", durationMinutes:95 },
  { airline: "Lufthansa Cargo", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Dubai", toICAO:"OMDB", durationMinutes:420 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 },
  { airline: "Brussels Airlines", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Brussels", toICAO:"EBBR", durationMinutes:75 },
  { airline: "ITA Airways", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Rome", toICAO:"LIRF", durationMinutes:120 }
];
ROUTES.forEach(r=>{ r.durationMinutes = Number.isFinite(Number(r.durationMinutes)) ? Number(r.durationMinutes) : NaN; });

const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM","EDDH"] },
  { name: "Lufthansa CityLine", hubs: ["EDDF","EDDM"] },
  { name: "Lufthansa Cargo", hubs: ["EDDF"] },
  { name: "Lufthansa Technik", hubs: ["EDDF"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] },
  { name: "Brussels Airlines", hubs: ["EDDF"] },
  { name: "ITA Airways", hubs: ["LIRF"] }
];

const AIRPORTS = {
  "EDDF": { city:"Frankfurt", lat:50.0379, lon:8.5622 },
  "EDDM": { city:"Munich", lat:48.3538, lon:11.7861 },
  "ENGM": { city:"Oslo", lat:59.6498, lon:10.9198 },
  "EHAM": { city:"Amsterdam", lat:52.3105, lon:4.7683 },
  "LTAI": { city:"Antalya", lat:36.8969, lon:30.8001 },
  "LIMC": { city:"Milan", lat:45.6301, lon:8.7231 },
  "OMDB": { city:"Dubai", lat:25.2532, lon:55.3657 },
  "LSZH": { city:"Zurich", lat:47.4581, lon:8.5610 },
  "EBBR": { city:"Brussels", lat:50.9014, lon:4.4844 },
  "LIRF": { city:"Rome", lat:41.8003, lon:12.2389 }
};

/* ---------------- EXPANDED FLEET ---------------- */
const FLEET = [
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A321-02', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A350-01', airline:'Lufthansa', type:'A350', rangeKm:15000, seats:300, turnaround:90, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-787-01', airline:'Lufthansa', type:'B787', rangeKm:14140, seats:270, turnaround:75, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LC-747F-01', airline:'Lufthansa Cargo', type:'B747F', rangeKm:8000, seats:0, turnaround:120, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LT-CRJ-01', airline:'Lufthansa Technik', type:'CRJ', rangeKm:2500, seats:70, turnaround:25, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'EW-A320-01', airline:'Eurowings', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'EW-A321-02', airline:'Eurowings', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'SX-B737-02', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'SN-A320-01', airline:'Brussels Airlines', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'AZ-A320-01', airline:'ITA Airways', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-E190-01', airline:'Lufthansa CityLine', type:'E190', rangeKm:4000, seats:100, turnaround:30, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'LH-A321-03', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'SX-A320-03', airline:'SunExpress', type:'A320', rangeKm:6100, seats:180, turnaround:35, status:'idle', locationICAO:'EDDF', availableAt:0 }
];

const FLEET_LOG = [];

/* ---------------- STATE ---------------- */
let chosenAirIndex = null;
let chosenDur = null;
let lastGenerated = null;
const LOCAL_USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
const RESERVATION_TTL_MS = 120 * 1000;

/* ---------------- HELPERS ---------------- */
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pad(n){ return String(n).padStart(2,'0'); }
function nowMs(){ return Date.now(); }
function getAirportInfo(icao){ return AIRPORTS[icao] || null; }

/* ---------------- UI refs ---------------- */
const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const genBtn = document.getElementById('gen');
const demoBtn = document.getElementById('demo');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');
const fleetGroupsEl = document.getElementById('fleetGroups');
const fleetSearchEl = document.getElementById('fleetSearch');
const statusFilterEl = document.getElementById('statusFilter');
const routesCountEl = document.getElementById('routesCount');
const assignLogEl = document.getElementById('assignLog');
const confirmedSection = document.getElementById('confirmedSection');

/* ---------------- RENDER durations and airlines (old compact UI) ---------------- */
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480},
  {label:"9–10ч",min:540,max:600},
  {label:"10+ч",min:601,max:1200}
];
function renderDurations(){
  durationsWrap.innerHTML = '';
  DURATIONS.forEach((d,i)=>{
    const el = document.createElement('button');
    el.className = 'btn btn-ghost';
    el.type = 'button';
    el.textContent = d.label;
    el.addEventListener('click', ()=> selectDur(i));
    durationsWrap.appendChild(el);
  });
}
function renderAirlines(){
  const copy = AIRLINES.map((a,idx)=> Object.assign({ __origIndex: idx }, a)).sort((a,b)=> a.name.localeCompare(b.name,'ru'));
  airlinesWrap.innerHTML='';
  copy.forEach(a=>{
    const div = document.createElement('div'); div.className='airline-group';
    const head = document.createElement('div'); head.className='airline-group-head';
    head.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div class="airline-badge">${esc(a.name.split(' ').map(x=>x[0]||'').slice(0,2).join(''))}</div><div><div style="font-weight:900">${esc(a.name)}</div><div class="small" style="margin-top:4px">Хабы: ${a.hubs.join(', ')}</div></div></div><div class="chev">▾</div>`;
    const list = document.createElement('div'); list.className='airline-list'; list.style.maxHeight='0px';
    const item = document.createElement('div'); item.className='airline-item';
    const btn = document.createElement('button'); btn.className='btn btn-ghost'; btn.textContent='Выбрать';
    btn.addEventListener('click', ()=> {
      const idx = AIRLINES.indexOf(a);
      selectAir(idx);
      document.querySelectorAll('.airline-item').forEach(n=>n.classList.remove('selected'));
      item.classList.add('selected');
    });
    item.appendChild(btn); list.appendChild(item);
    div.appendChild(head); div.appendChild(list);
    // ensure proper collapse: toggle a CSS class that flips max-height
    let collapsed = true;
    head.addEventListener('click', ()=>{
      const chev = head.querySelector('.chev');
      if(collapsed){
        // expand: set maxHeight to scrollHeight
        list.style.maxHeight = list.scrollHeight + 'px';
        chev.style.transform = 'rotate(0deg)';
        collapsed = false;
      } else {
        // collapse: set maxHeight to 0
        list.style.maxHeight = list.scrollHeight + 'px';
        requestAnimationFrame(()=>{ list.style.maxHeight = '0px'; });
        chev.style.transform = 'rotate(-90deg)';
        collapsed = true;
      }
    });
    airlinesWrap.appendChild(div);
  });
}

/* ---------------- FLEET grouping + correct collapsing (fixed) ---------------- */
function renderFleetGroups(){
  // group fleet by airline
  const groups = {};
  FLEET.forEach(ac=> { const k = ac.airline || 'Other'; if(!groups[k]) groups[k]=[]; groups[k].push(ac); });
  // order according to AIRLINES list
  const order = AIRLINES.map(a=>a.name).filter(k=>groups[k]).concat(Object.keys(groups).filter(k=>!AIRLINES.some(a=>a.name===k)).sort());
  fleetGroupsEl.innerHTML = '';
  order.forEach(key=>{
    const container = document.createElement('div'); container.className='group';
    const head = document.createElement('div'); head.className='group-head';
    const count = groups[key].length;
    head.innerHTML = `<div class="title"><div style="font-weight:900">${esc(key)}</div><div class="small">${count} шт.</div></div><div class="chev">▾</div>`;
    const bodyWrapper = document.createElement('div'); bodyWrapper.className='group-body-wrapper';
    const body = document.createElement('div'); body.className='group-body';
    groups[key].forEach(ac=>{
      const card = document.createElement('div'); card.className='card-plane';
      card.dataset.id = ac.id; card.dataset.type = ac.type; card.dataset.location = ac.locationICAO; card.dataset.airline = ac.airline; card.dataset.status = ac.status;
      card.innerHTML = `<div class="plane-type">${esc(ac.type)}</div>
        <div class="plane-info">
          <div style="display:flex;gap:8px;align-items:center"><div style="font-weight:900;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ac.id)}</div><div class="tag-airline">${esc(ac.airline)}</div></div>
          <div class="plane-meta"><div>${esc(ac.locationICAO)}</div><div>·</div><div>${ac.rangeKm} km</div><div>·</div><div>${ac.seats} seats</div></div>
        </div>
        <div class="status">${ac.status==='idle'?'<div class="idle">idle</div>':ac.status==='reserved'?'<div class="reserved">reserved</div>':'<div class="inflight">inFlight</div>'}</div>`;
      // select plane -> show quick actions
      card.addEventListener('click', ()=>{
        document.querySelectorAll('.card-plane').forEach(n=>n.style.outline='none');
        card.style.outline='2px solid rgba(255,215,0,0.12)';
        showPlaneQuick(ac.id);
      });
      body.appendChild(card);
    });
    bodyWrapper.appendChild(body);
    // set initial max-height so wrapper fits content (we use explicit maxHeight for smooth collapse)
    // we set to body.scrollHeight to ensure wrapper has correct size; but we keep it expanded initially
    bodyWrapper.style.maxHeight = body.scrollHeight + 'px';
    // collapse flag
    let collapsed = false;
    head.addEventListener('click', ()=>{
      const chev = head.querySelector('.chev');
      if(collapsed){
        // expand
        bodyWrapper.style.maxHeight = body.scrollHeight + 'px';
        chev.style.transform = 'rotate(0deg)';
        collapsed = false;
      } else {
        // collapse: set to its current scrollHeight then to 0 to trigger transition reliably
        bodyWrapper.style.maxHeight = body.scrollHeight + 'px';
        requestAnimationFrame(()=>{ bodyWrapper.style.maxHeight = '0px'; });
        chev.style.transform = 'rotate(-90deg)';
        collapsed = true;
      }
    });
    container.appendChild(head);
    container.appendChild(bodyWrapper);
    fleetGroupsEl.appendChild(container);
  });
  // after render, apply current filters
  applyFleetFilters();
}

/* ---------------- plane quick view (same as before) ---------------- */
function showPlaneQuick(planeId){
  const ac = FLEET.find(a=>a.id===planeId);
  if(!ac) return;
  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div class="res-header"><div class="res-title">Инспекция самолёта</div><div style="margin-left:auto;color:var(--muted)">${esc(ac.airline)}</div></div>
    <div class="res-body">
      <div class="res-row"><div class="res-label">ID</div><div class="res-value">${esc(ac.id)}</div><div class="res-label" style="margin-top:6px">Тип</div><div class="res-value">${esc(ac.type)}</div></div>
      <div class="res-row"><div class="res-label">Локация</div><div class="res-value">${esc(ac.locationICAO)}</div><div class="res-label" style="margin-top:6px">Статус</div><div class="res-value">${esc(ac.status)}</div></div>
    </div>
    <div class="res-actions">
      <button id="inspectReserve" class="btn btn-primary">Резерв</button>
      <button id="inspectCancel" class="btn btn-ghost">Отменить резерв</button>
      <div style="flex:1"></div>
    </div>
  `;
  document.getElementById('inspectReserve').onclick = ()=> {
    const res = reserveAircraft(ac, LOCAL_USER_ID);
    if(!res.ok) alert('Не удалось зарезервировать: ' + res.reason);
    else { lastGenerated = { route:null, aircraftId: ac.id, token: res.token, reservedAt: nowMs() }; renderReservationResult(lastGenerated); renderFleetGroups(); }
  };
  document.getElementById('inspectCancel').onclick = ()=> {
    if(ac.reservedToken){ cancelReservationByToken(ac.reservedToken); renderReservationResult(null); renderFleetGroups(); } else alert('У этого самолёта нет резерва');
  };
}

/* ---------------- filters for fleet (search + status) ---------------- */
function applyFleetFilters(){
  const q = (fleetSearchEl.value||'').trim().toLowerCase();
  const status = statusFilterEl.value;
  document.querySelectorAll('.card-plane').forEach(card=>{
    const id = card.dataset.id.toLowerCase(), type = card.dataset.type.toLowerCase(), loc = card.dataset.location.toLowerCase(), airline = card.dataset.airline.toLowerCase();
    const st = card.dataset.status;
    let visible = true;
    if(q){
      visible = id.includes(q) || type.includes(q) || loc.includes(q) || airline.includes(q);
    }
    if(visible && status !== 'all'){ visible = st === status; }
    card.style.display = visible ? 'flex' : 'none';
  });
}

/* ---------------- reservation / confirm logic (unchanged) ---------------- */
function reserveAircraft(ac, ownerId, ttlMs = RESERVATION_TTL_MS){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved';
  ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  renderFleetGroups();
  return { ok:true, token: ac.reservedToken };
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a => a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  ac.status = 'idle';
  renderFleetGroups(); renderAssignLog();
  return true;
}
function confirmReservation(token, route){
  const ac = FLEET.find(a => a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };
  const now = nowMs();
  const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight';
  ac.availableAt = now + durationMs + ac.turnaround*60*1000;
  ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes });
  renderFleetGroups(); renderAssignLog();
  renderConfirmedFlight(ac, route);
  return { ok:true, aircraft: ac };
}

/* expire reservations & process flights */
function expireReservations(){
  const now = nowMs();
  let changed=false;
  FLEET.forEach(ac=>{
    if(ac.status === 'reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status = 'idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event:'reservation_expired', aircraft: ac.id }); changed=true;
    }
    if(ac.status === 'inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status = 'idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO }); changed=true;
    }
  });
  if(changed){ renderFleetGroups(); renderAssignLog(); }
}

/* generate flight -> reserve candidate */
function generateFlight(){
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  if(chosenDur===null){ alert('Выберите длительность'); return; }
  const airlineName = AIRLINES[chosenAirIndex].name;
  let pool = ROUTES.filter(r => String(r.airline||'').toLowerCase() === airlineName.toLowerCase());
  if(pool.length===0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length===0){ showNoRoutes(airlineName); return; }
  if(typeof chosenDur === 'number'){
    const interval = DURATIONS[chosenDur];
    const filtered = pool.filter(r => Number.isFinite(r.durationMinutes) && r.durationMinutes >= interval.min && r.durationMinutes <= interval.max);
    if(filtered.length>0) pool = filtered;
  }
  const route = pool[randInt(0,pool.length-1)];
  // prefer same-airline idle at hub
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase() === airlineName.toLowerCase());
  if(candidates.length===0) candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  if(candidates.length===0){ showNoAircraft(route); return; }
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];
  const reserveRes = reserveAircraft(candidate, LOCAL_USER_ID);
  if(!reserveRes.ok){ alert('Не удалось зарезервировать: '+reserveRes.reason); return; }
  lastGenerated = { route, aircraftId: candidate.id, token: reserveRes.token, reservedAt: nowMs() };
  renderReservationResult(lastGenerated);
  renderFleetGroups();
}

/* reservation UI rendering */
function renderReservationResult(gen){
  if(!gen){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  if(!ac){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const route = gen.route;
  const remaining = ac.reservedUntil ? Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000)) : 0;
  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div class="res-header"><div class="res-title">Резерв создан</div><div style="margin-left:auto;color:var(--muted)">${esc(ac.airline)}</div></div>
    <div class="res-body">
      <div class="res-row"><div class="res-label">Отправление</div><div class="res-value">${route ? esc(route.fromCity)+' ('+esc(route.fromICAO)+')' : esc(ac.locationICAO)}</div></div>
      <div class="res-row"><div class="res-label">Прибытие</div><div class="res-value">${route ? esc(route.toCity)+' ('+esc(route.toICAO)+')' : '—'}</div></div>
      <div class="res-row"><div class="res-label">Самолёт</div><div class="res-value">${esc(ac.id)} · ${esc(ac.type)}</div></div>
      <div class="res-row"><div class="res-label">Резерв истечёт</div><div class="res-value"><span id="reserveCountdown">${remaining}</span> с</div></div>
    </div>
    <div class="res-actions"><button id="confirmBtn" class="btn btn-primary">Подтвердить полёт</button><button id="cancelBtn" class="btn btn-ghost">Отменить резерв</button></div>
  `;
  document.getElementById('confirmBtn').onclick = ()=>{
    if(!gen.route){ alert('Нет маршрута для подтверждения'); return; }
    const res = confirmReservation(gen.token, gen.route);
    if(!res.ok) alert('Не удалось подтвердить: ' + (res.reason||'unknown'));
    else { lastGenerated=null; renderReservationResult(null); }
  };
  document.getElementById('cancelBtn').onclick = ()=>{
    cancelReservationByToken(gen.token);
    lastGenerated=null; renderReservationResult(null);
  };
}

/* confirmed flight UI */
function renderConfirmedFlight(ac, route){
  confirmedSection.innerHTML = '';
  const now = nowMs();
  const depart = new Date(now).toLocaleString();
  const flightMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  const eta = new Date(now + flightMs).toLocaleString();
  const div = document.createElement('div'); div.className='confirmed-card';
  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900;color:var(--ok)">Рейс подтверждён</div><div class="small">${esc(ac.id)} · ${esc(ac.airline)}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <div><div class="res-label">Авиакомпания</div><div class="res-value">${esc(route.airline||'—')}</div></div>
      <div><div class="res-label">Статус</div><div class="res-value" style="color:var(--ok);font-weight:900">inFlight</div></div>
      <div><div class="res-label">Отправление</div><div class="res-value">${esc(route.fromCity)} (${esc(route.fromICAO)})</div><div class="small" style="margin-top:6px">Время: ${esc(depart)}</div></div>
      <div><div class="res-label">Прибытие</div><div class="res-value">${esc(route.toCity)} (${esc(route.toICAO)})</div><div class="small" style="margin-top:6px">ETA: ${esc(eta)}</div></div>
      <div><div class="res-label">Длительность</div><div class="res-value">${formatDuration(route.durationMinutes)}</div></div>
      <div><div class="res-label">Путь самолёта</div><div class="res-value">${esc(ac.locationICAO)} → ${esc(ac.nextLocation || route.toICAO)}</div></div>
    </div>
    <div class="small" style="margin-top:8px">Запись добавлена в журнал назначений</div>
  `;
  confirmedSection.appendChild(div);
}

/* log render */
function renderAssignLog(){
  const items = FLEET_LOG.slice(-40).reverse();
  if(items.length===0){ assignLogEl.textContent='Пока пусто'; return; }
  assignLogEl.innerHTML = items.map(it=>{
    const t = new Date(it.ts).toLocaleTimeString();
    if(it.event==='assign') return `${t} — assign ${it.aircraft} ${it.route} (${it.durationMin||'n/a'} min)`;
    if(it.event==='assign_confirmed') return `${t} — confirmed ${it.aircraft} ${it.route}`;
    if(it.event==='reservation_expired') return `${t} — reservation_expired ${it.aircraft}`;
    if(it.event==='available') return `${t} — available ${it.aircraft} @ ${it.location}`;
    return `${t} — ${it.event}`;
  }).map(s=>`<div style="margin-bottom:6px">${esc(s)}</div>`).join('');
}

/* utilities */
function formatDuration(min){ if(!Number.isFinite(min)) return 'n/a'; const hh=Math.floor(min/60), mm=min%60; return pad(hh)+':'+pad(mm); }
function showNoRoutes(airlineName){ resultEl.style.display='block'; resultEl.innerHTML = `<div class="res-header"><div class="res-title">Нет маршрутов</div><div style="margin-left:auto;color:var(--muted)">${esc(airlineName)}</div></div><div class="res-body"><div class="res-row"><div class="res-label">Причина</div><div class="res-value">В демо нет маршрутов для этой авиакомпании или её хабов</div></div></div>`; }
function showNoAircraft(route){ resultEl.style.display='block'; resultEl.innerHTML = `<div class="res-header"><div class="res-title">Нет свободных самолётов</div><div style="margin-left:auto;color:var(--muted)">Хаб: ${esc(route.fromICAO)}</div></div><div class="res-body"><div class="res-row"><div class="res-label">Причина</div><div class="res-value">Нет idle самолётов в хабе</div></div></div>`; }

/* housekeeping */
setInterval(()=>{
  expireReservations();
  if(lastGenerated){
    const ac = FLEET.find(a=>a.id === lastGenerated.aircraftId);
    if(ac && ac.reservedUntil){
      const el = document.getElementById('reserveCountdown'); if(el) el.textContent = Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000));
    } else { lastGenerated=null; renderReservationResult(null); }
  }
},1000);

/* event bindings */
fleetSearchEl.addEventListener('input', applyFleetFilters);
statusFilterEl.addEventListener('change', applyFleetFilters);
document.getElementById('refreshFleet').addEventListener('click', ()=> renderFleetGroups());
document.getElementById('clearLog').addEventListener('click', ()=>{ FLEET_LOG.length=0; renderAssignLog(); });
genBtn.addEventListener('click', ()=> {
  if(lastGenerated && lastGenerated.token){ if(!confirm('У вас уже есть активный резерв. Создать новый резерв отменит старый?')) return; cancelReservationByToken(lastGenerated.token); lastGenerated=null; renderReservationResult(null); }
  generateFlight();
});
demoBtn.addEventListener('click', ()=>{ const idx=AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0){ selectAir(idx); selectDur(2); } generateFlight(); });
resetBtn.addEventListener('click', ()=>{ chosenAirIndex=null; chosenDur=null; lastGenerated=null; document.getElementById('selectedInfo').textContent='—'; resultEl.style.display='none'; resultEl.innerHTML=''; confirmedSection.innerHTML=''; renderFleetGroups(); });

/* select helpers */
function selectAir(idx){ chosenAirIndex = idx; document.getElementById('selectedInfo').textContent = AIRLINES[idx].name + ' · ' + AIRLINES[idx].hubs.join(','); }
function selectDur(i){ chosenDur = i; Array.from(durationsWrap.children).forEach((b,idx)=> b.classList.toggle('selected', idx===i)); }

/* init render */
function renderAll(){ renderAirlines(); renderDurations(); renderFleetGroups(); renderAssignLog(); routesCountEl.textContent = ROUTES.length; }
renderAll();

/* expose for quick debug */
window._debug = { FLEET, ROUTES, AIRLINES, renderFleetGroups, reserveAircraft, cancelReservationByToken, confirmReservation };

</script>
</body>
</html>
