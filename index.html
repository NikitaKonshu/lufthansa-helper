<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lufthansa Helper — liquid glass</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#041026; --bg-2:#06263a; --text:#eaf4ff; --muted:rgba(234,244,255,0.68);
  --accent:#ffd54a; --accent2:#ffbf3a; --blue:#1E6FFF; --pink:#8A4BFF;
  --glass-border:rgba(255,255,255,0.06); --panel-bg1:rgba(255,255,255,0.035); --panel-bg2:rgba(8,12,18,0.94);
  --shadow-1:0 28px 100px rgba(2,8,18,0.6);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh; background:linear-gradient(160deg,var(--bg-1),var(--bg-2));
  color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.app{max-width:1280px;margin:28px auto;padding:18px;border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.012)),
             linear-gradient(180deg, rgba(0,6,18,0.55), rgba(0,6,18,0.7));
  border:1px solid rgba(255,255,255,0.04); box-shadow:var(--shadow-1); backdrop-filter:blur(10px) saturate(140%);
}
.header{display:flex;justify-content:space-between;align-items:center}
.logo{width:64px;height:64px;border-radius:14px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#062b34,#032029); font-weight:900;color:var(--accent); box-shadow:0 10px 36px rgba(0,0,0,0.54), inset 0 1px 0 rgba(255,255,255,0.02);
}
.subtitle{font-size:13px;color:var(--muted)}
.badge{font-size:13px;color:var(--muted)}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:12px;border:1px solid var(--glass-border);
  background:linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.01)); color:var(--text); font-weight:800; cursor:pointer;
  transition:transform .18s, box-shadow .18s, background .18s; box-shadow:0 10px 28px rgba(0,0,0,0.42); backdrop-filter:blur(8px) saturate(140%);
}
.btn:hover{transform:translateY(-2px)}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#072022; border-color:rgba(0,0,0,0.08); box-shadow:0 22px 64px rgba(255,170,40,0.12)}
.btn-ghost{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}

.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px}
.search{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);min-width:240px}

.panel{padding:14px;border-radius:12px;margin-top:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
  border:1px solid rgba(255,255,255,0.04); box-shadow:0 24px 80px rgba(2,8,18,0.45); backdrop-filter:blur(6px) saturate(130%); position:relative;
}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px}

.airline-grid{ margin-top:14px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; width:100%; max-height:520px; overflow:auto; padding:14px;
  border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03);
}
.airline{ position:relative; display:flex; gap:14px; align-items:center; padding:14px; border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 12px 36px rgba(0,0,0,0.45); cursor:pointer; transition:transform .22s, box-shadow .22s, filter .18s, background .18s; overflow:hidden;
}
.airline:hover{ transform: translateY(-6px) scale(1.01); box-shadow:0 44px 110px rgba(0,0,0,0.6); filter:brightness(1.03) }
.airline.selected{ outline:2px solid rgba(255,210,70,0.5); box-shadow:0 40px 120px rgba(255,190,70,0.22) }
.led{position:absolute; right:8px; top:8px; width:10px; height:10px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.2)), linear-gradient(180deg, var(--accent), var(--accent2)); box-shadow:0 0 24px rgba(255,180,60,0.6);
}

.kv{font-size:13px;color:var(--muted)}

.time-pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));cursor:pointer;font-weight:800}
.pill.active{outline:2px solid rgba(255,210,70,0.5)}

.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.56); z-index:17000; padding:20px;}
.modal-card{width:min(560px,94%); max-width:94%; border-radius:12px; padding:18px;
  background:linear-gradient(180deg, var(--panel-bg1), var(--panel-bg2));
  border:1px solid rgba(255,255,255,0.06); box-shadow:0 40px 120px rgba(0,0,0,0.6);
}

.splash{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; overflow:hidden;
  background:linear-gradient(180deg, rgba(0,6,18,0.95), rgba(2,14,30,0.98)); z-index:15000; transition:opacity .52s, transform .52s;
}
.splash.hidden{opacity:0; transform:translateY(-8px) scale(.996); pointer-events:none}
.splash-center{z-index:2; text-align:center}
.wave{position:absolute; left:0; right:0; bottom:0; height:200px; opacity:.9}
.clouds{position:absolute; top:0; left:0; right:0; height:160px; opacity:.5}

#inlineTour{display:none; opacity:0; transform:translateY(8px); transition: opacity .26s, transform .26s}
#inlineTour.show{display:block; opacity:1; transform:translateY(0)}

@media(max-width:740px){
  .grid{grid-template-columns:1fr}
  .airline-grid{grid-template-columns: repeat(auto-fit, minmax(160px,1fr));}
}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash" aria-modal="true">
  <svg class="clouds" viewBox="0 0 1200 180" preserveAspectRatio="xMidYMid slice">
    <defs><linearGradient id="gC" x1="0" x2="1"><stop offset="0" stop-color="#fff" stop-opacity="0.06"/><stop offset="1" stop-color="#fff" stop-opacity="0.02"/></linearGradient><filter id="blurC" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="16"/></filter></defs>
    <g filter="url(#blurC)" fill="url(#gC)"><ellipse cx="200" cy="50" rx="220" ry="40"/><ellipse cx="480" cy="40" rx="200" ry="36"/><ellipse cx="840" cy="60" rx="260" ry="46"/><ellipse cx="1060" cy="46" rx="160" ry="30"/></g>
  </svg>
  <div class="splash-center">
    <h2 style="margin:0 0 6px 0">Welcome to Lufthansa Group</h2>
    <div class="kv" style="margin-bottom:14px">Демо интерфейс</div>
    <button id="splashContinue" class="btn btn-primary">Дальше</button>
  </div>
  <div class="wave">
    <svg viewBox="0 0 1440 320" preserveAspectRatio="none" style="width:100%;height:100%">
      <defs><linearGradient id="waveGrad" x1="0" x2="1"><stop offset="0" stop-color="#ffd54a" stop-opacity="0.10"/><stop offset="1" stop-color="#00aaff" stop-opacity="0.06"/></linearGradient></defs>
      <path id="wavePath" d="M0,160 C300,240 600,80 900,160 C1200,240 1440,80 1440,80 L1440,320 L0,320 Z" fill="url(#waveGrad)"></path>
    </svg>
  </div>
</div>

<!-- Gate Modal -->
<div id="gateModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div style="font-weight:900">Вход в систему</div>
    <div class="kv" style="margin-top:8px">Введите позывной и пароль. Кодовое слово: <strong>quickaccess2025</strong></div>
    <div style="margin-top:10px"><input id="loginCall" class="search" placeholder="Позывной (callSign)" autocomplete="username"></div>
    <div style="margin-top:8px"><input id="loginPass" class="search" type="password" placeholder="Пароль или кодовое слово" autocomplete="current-password"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px;align-items:center">
      <button id="btnDemoQuick" class="btn btn-ghost">Быстрый вход</button>
      <button id="btnLogin" class="btn btn-primary">Войти</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="kv" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn btn-ghost">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="app">
  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">LH</div>
      <div>
        <div style="font-weight:900">Lufthansa Helper</div>
        <div class="subtitle">liquid glass · tactile · demo</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div id="sessionBadge" class="badge">Неавторизован</div>
      <button id="openGateBtn" class="btn btn-ghost">Вход</button>
      <button id="logoutBtn" class="btn btn-ghost" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="controls">
    <input id="airSearch" class="search" placeholder="Поиск авиакомпании или кода">
    <div style="display:flex;align-items:center;gap:10px;margin-left:auto">
      <button id="genBtn" class="btn btn-primary">СГЕНЕРИРОВАТЬ</button>
    </div>
  </div>

  <div id="inlineTour" class="panel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">Краткая инструкция</div>
      <div class="kv">Появляется после входа</div>
    </div>
    <div class="kv" style="margin-top:10px">
      1) Введите позывной и пароль; 2) Выберите авиакомпанию и интервал времени; 3) Нажмите «СГЕНЕРИРОВАТЬ»; 4) Подтвердите рейс.
    </div>
  </div>

  <div class="panel" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">Фильтры</div>
      <div class="kv">Выбор авиакомпании и времени</div>
    </div>
    <div id="durations" class="time-pills" style="margin-top:10px"></div>
    <div id="airGrid" class="airline-grid"></div>
  </div>

  <div class="grid">
    <main>
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Направления</div>
          <div class="kv">Список доступных маршрутов</div>
        </div>
        <div id="routesList" style="margin-top:12px"></div>
      </section>
      <section class="panel" style="margin-top:12px">
        <div style="font-weight:900">Флот</div>
        <div id="fleetList" style="margin-top:12px"></div>
      </section>
    </main>
    <aside>
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Пилоты</div>
          <div class="kv">Demo</div>
        </div>
        <div id="pilotList" style="margin-top:8px"></div>
      </section>
      <section class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Журнал</div>
          <div><button id="openGate2" class="btn btn-ghost">Вход</button></div>
        </div>
        <div id="log" class="kv" style="margin-top:8px;max-height:260px;overflow:auto">Пусто</div>
      </section>
    </aside>
  </div>
</div>

<script>
/* ====== Data & state ====== */
const CODEWORD = 'quickaccess2025';
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},{label:"6–7ч",min:360,max:420},{label:"7–8ч",min:420,max:480}
];
const AIRLINES = [
  {name:"Lufthansa",code:"LH",color:"#1E6FFF"},
  {name:"Lufthansa Cargo",code:"G0",color:"#0A63D6"},
  {name:"Swiss",code:"LX",color:"#D81E5B"},
  {name:"Austrian",code:"OS",color:"#DA291C"},
  {name:"Eurowings",code:"EW",color:"#8A4BFF"},
  {name:"Condor",code:"DE",color:"#FFD200"},
  {name:"Brussels",code:"SN",color:"#003399"},
  {name:"SunExpress",code:"SX",color:"#FF8A3D"}
];

let ROUTES = []; (function(){ let seq=100; const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","EBBR","LIRF","LOWW"]; AIRLINES.forEach((a,ai)=>{ for(let i=0;i<6;i++){ const from=base[(ai+i)%base.length]; const to=base[(ai+i+3)%base.length]; const dur=70+(i*30)+(ai*20); ROUTES.push({ id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code, fromICAO:from, toICAO:to, fromCity:'City-'+from, toCity:'City-'+to, durationMinutes:dur }); } }); })();

let FLEET = [
  {id:"LH-A320-01",airline:"Lufthansa",type:"A320",locationICAO:"EDDF",status:"idle",fuelMinutes:420,turnaround:35,reserveMargin:30},
  {id:"LX-A320-02",airline:"Swiss",type:"A320",locationICAO:"EDDF",status:"idle",fuelMinutes:380,turnaround:35,reserveMargin:30},
  {id:"DE-B767-01",airline:"Condor",type:"B767",locationICAO:"EDDF",status:"idle",fuelMinutes:780,turnaround:50,reserveMargin:60}
];

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = {pilotId:null};
let FLEET_LOG = [];
let CURRENT_FLIGHTS = [];

let chosenAirline = null;
let chosenDurationIdx = null;
let searchQuery = '';
let PENDING_RESERVATION = null;
let PENDING_RESERVATION_TEMP = null;
let appReady = false;

/* ====== DOM ====== */
const splash = document.getElementById('splash');
const splashContinue = document.getElementById('splashContinue');
const gateModal = document.getElementById('gateModal');
const confirmModal = document.getElementById('confirmModal');
const sessionBadge = document.getElementById('sessionBadge');
const airSearch = document.getElementById('airSearch');
const airGrid = document.getElementById('airGrid');
const durationsEl = document.getElementById('durations');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotList = document.getElementById('pilotList');
const logEl = document.getElementById('log');
const inlineTour = document.getElementById('inlineTour');

/* ====== Helpers ====== */
function nowMs(){ return Date.now(); }
function show(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function hide(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }
function pushLog(msg){ FLEET_LOG.unshift({ts:nowMs(), msg}); renderLog(); }

/* ====== Splash logic ====== */
(function animateWaves(){
  const path = document.getElementById('wavePath'); if(!path) return; let t=0;
  function step(){ t += 0.008; const amp = 12;
    const d1 = `M0,160 C300,${160+Math.sin(t*1.2)*amp+60} 600,${160+Math.cos(t*0.7)*amp+40} 900,${160+Math.sin(t*0.5)*amp+60} C1200,${160+Math.cos(t*0.9)*amp+40} 1440,${80+Math.sin(t*0.3)*amp} 1440,80 L1440,320 L0,320 Z`;
    path.setAttribute('d', d1); requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();

splashContinue.addEventListener('click', ()=>{
  splash.classList.add('hidden');
  setTimeout(()=>{ splash.style.display='none'; appReady=true; show(gateModal); }, 520);
});

/* ====== Login ====== */
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const cs = document.getElementById('loginCall').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!cs || !pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=> x.callSign.toLowerCase() === cs.toLowerCase());
  if(pass === CODEWORD || (p && p.password === pass)){
    SESSION.pilotId = p ? p.id : 'guest_'+Date.now();
    renderSession();
    hide(gateModal);
    // Show instruction after login
    inlineTour.classList.add('show'); inlineTour.setAttribute('aria-hidden','false');
  } else {
    alert('Неверный пароль');
  }
});
document.getElementById('btnDemoQuick').addEventListener('click', ()=>{
  document.getElementById('loginCall').value = PILOTS[0].callSign;
  document.getElementById('loginPass').value = CODEWORD;
  document.getElementById('btnLogin').click();
});
document.getElementById('openGateBtn').addEventListener('click', ()=>{ if(appReady) show(gateModal); });
document.getElementById('openGate2').addEventListener('click', ()=>{ if(appReady) show(gateModal); });
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  SESSION.pilotId = null; renderSession(); show(gateModal);
});

/* ====== Filters: durations & airlines ====== */
function renderDurations(){
  durationsEl.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn = document.createElement('div');
    btn.className = 'pill' + (chosenDurationIdx===i ? ' active' : '');
    btn.textContent = d.label;
    btn.addEventListener('click', ()=>{
      chosenDurationIdx = (chosenDurationIdx===i ? null : i);
      renderDurations(); renderRoutes();
    });
    durationsEl.appendChild(btn);
  });
}

function renderAirlines(){
  airGrid.innerHTML='';
  const filtered = AIRLINES.filter(a=>{
    if(!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return a.name.toLowerCase().includes(q) || a.code.toLowerCase().includes(q);
  });
  filtered.forEach(a=>{
    const card = document.createElement('div');
    card.className='airline' + (chosenAirline===a.name ? ' selected' : '');
    card.innerHTML = `
      <div style="width:18px;height:18px;border-radius:50%;background:${a.color}"></div>
      <div><div style="font-weight:900">${a.name}</div><div class="kv">${a.code}</div></div>
      <div class="led" aria-hidden="true"></div>
    `;
    card.addEventListener('click', ()=>{
      chosenAirline = (chosenAirline===a.name ? null : a.name);
      renderAirlines(); renderRoutes();
    });
    airGrid.appendChild(card);
  });
}

/* ====== Routes & fleet ====== */
function renderRoutes(){
  routesList.innerHTML='';
  const list = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML = '<div class="kv">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));';
    row.innerHTML = `
      <div>
        <div style="font-weight:900">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div>
        <div class="kv">${r.fromCity} → ${r.toCity}</div>
      </div>
      <div style="text-align:right">
        <div class="kv">${r.durationMinutes} мин</div>
        <div style="margin-top:8px"><button class="btn btn-primary" data-id="${r.id}">Выбрать</button></div>
      </div>
    `;
    routesList.appendChild(row);
  });
  Array.from(routesList.querySelectorAll('button[data-id]')).forEach(b=>{
    b.addEventListener('click', ()=>{
      const r = ROUTES.find(x=>x.id===b.dataset.id);
      if(!SESSION.pilotId){ show(gateModal); return; }
      openConfirmFromRoute(r);
    });
  });
}

function renderFleet(){
  fleetList.innerHTML='';
  FLEET.forEach(f=>{
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:8px';
    row.innerHTML = `<div style="font-weight:900">${f.id}</div><div class="kv">${f.airline} · ${f.type} · ${f.fuelMinutes} мин топлива · ${f.locationICAO}</div>`;
    fleetList.appendChild(row);
  });
}

/* ====== Pilots & log ====== */
function renderPilots(){
  pilotList.innerHTML='';
  PILOTS.forEach(p=>{
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:8px';
    row.innerHTML = `<div><div style="font-weight:900">${p.name}</div><div class="kv">${p.callSign} ${p.verified?'· Verified':''}</div></div><button class="btn btn-ghost">Войти</button>`;
    row.querySelector('button').addEventListener('click', ()=>{
      document.getElementById('loginCall').value = p.callSign;
      document.getElementById('loginPass').value = '';
      if(appReady) show(gateModal);
    });
    pilotList.appendChild(row);
  });
}

function renderLog(){
  logEl.innerHTML='';
  if(!FLEET_LOG.length){ logEl.textContent='Пусто'; return; }
  FLEET_LOG.slice(0,200).forEach(e=>{
    const d = document.createElement('div');
    d.style.marginTop='6px';
    d.textContent = `${new Date(e.ts).toLocaleString()} — ${e.msg}`;
    logEl.appendChild(d);
  });
}

/* ====== Session badge ====== */
function renderSession(){
  if(SESSION.pilotId){
    const p = PILOTS.find(x=>x.id===SESSION.pilotId);
    sessionBadge.textContent = p ? `Вошёл ${p.callSign}` : 'Вошёл';
    document.getElementById('logoutBtn').style.display='inline-flex';
    document.getElementById('openGateBtn').style.display='none';
  } else {
    sessionBadge.textContent = 'Неавторизован';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('openGateBtn').style.display='inline-flex';
  }
}

/* ====== Confirm flow ====== */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (ac.fuelMinutes >= dur + (ac.reserveMargin||30));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(can);
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0] || null;
}

function openConfirmFromRoute(route){
  const pilot = PILOTS.find(x=>x.id===SESSION.pilotId);
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }

  candidate.status='reserved';
  candidate.reservedBy = pilot.id;
  candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,6);
  candidate.reservedUntil = nowMs() + 120000;

  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:pilot.id, expires:candidate.reservedUntil };

  document.getElementById('confirmDetails').textContent =
    `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${pilot.callSign}`;
  show(confirmModal);
}

document.getElementById('confirmAccept').addEventListener('click', ()=>{
  if(!PENDING_RESERVATION){ hide(confirmModal); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); hide(confirmModal); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId);
  if(!(p && p.verified)){ alert('Пилот не верифицирован'); hide(confirmModal); return; }

  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status='inFlight';
  ac.availableAt = nowMs() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;

  const flight = {
    id: 'flt_'+Math.random().toString(36).slice(2,8),
    aircraftId: ac.id, airline: ac.airline,
    fromICAO: PENDING_RESERVATION.route.fromICAO, toICAO: PENDING_RESERVATION.route.toICAO,
    durationMinutes: PENDING_RESERVATION.route.durationMinutes, pilotId: p.id, pilotCallsign: p.callSign, ts: nowMs()
  };
  CURRENT_FLIGHTS.unshift(flight);
  pushLog(`Рейс подтверждён ${flight.aircraftId} ${flight.fromICAO}->${flight.toICAO} пилот ${flight.pilotCallsign}`);
  PENDING_RESERVATION = null;
  renderFleet(); renderRoutes();
  alert('Рейс подтверждён!');
  hide(confirmModal);
});

document.getElementById('confirmCancel').addEventListener('click', ()=>{
  if(PENDING_RESERVATION){
    const token = PENDING_RESERVATION.token;
    FLEET.forEach(a=>{
      if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; }
    });
    pushLog('Бронь отменена');
    PENDING_RESERVATION = null;
  }
  hide(confirmModal); renderFleet();
});

/* ====== Generate button ====== */
document.getElementById('genBtn').addEventListener('click', ()=>{
  if(!SESSION.pilotId){ show(gateModal); return; }
  const pool = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
});

/* ====== Search ====== */
airSearch.addEventListener('input', ()=>{ searchQuery = airSearch.value.trim(); renderAirlines(); });

/* ====== Periodic maintenance ====== */
setInterval(()=>{
  const now = nowMs();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil<=now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      pushLog(`Резервация истекла ${ac.id}`);
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt<=now){
      ac.status='idle'; delete ac.availableAt;
      pushLog(`Самолёт вернулся в сервис ${ac.id}`);
    }
  });
  renderFleet();
}, 2000);

/* ====== Init ====== */
function init(){
  renderSession();
  renderDurations();
  renderAirlines();
  renderRoutes();
  renderFleet();
  renderPilots();
  renderLog();
}
init();
</script>
</body>
</html>
