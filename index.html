<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Systems - Crew Portal v57</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --lh-blue: #05164d;
            --lh-blue-dark: #04123c;
            --lh-yellow: #ffb600;
            --lh-grey: #e6e9ed;
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #2d3748;
            --text-light: #718096;
            --header-h: 65px;
            --radius: 6px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-light: #9ca3af;
            --lh-grey: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode input, body.dark-mode select { background: #111827; color: white; border-color: #374151; }

        /* --- LAYOUT --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); padding-top: var(--header-h); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* HEADER */
        header {
            background: var(--lh-blue); height: var(--header-h); position: fixed; top:0; width:100%; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; padding: 0 5%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .logo { height: 26px; filter: brightness(0) invert(1); }
        .tools { display: flex; gap: 15px; align-items: center; color: white; opacity: 0; pointer-events: none; transition: 0.5s; }
        .tools.visible { opacity: 1; pointer-events: all; }

        /* NAVIGATION */
        .nav-wrap { background: var(--bg-card); border-bottom: 1px solid var(--lh-grey); position: sticky; top: var(--header-h); z-index: 900; }
        .nav-scroll { display: flex; overflow-x: auto; max-width: 1100px; margin: 0 auto; }
        .nav-item {
            padding: 18px 20px; background: none; border: none; font-size: 0.9rem; font-weight: 600;
            color: var(--text-light); border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .nav-item.active { color: var(--lh-blue); border-bottom-color: var(--lh-yellow); }
        body.dark-mode .nav-item.active { color: #60a5fa; }

        /* CONTENT */
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; flex: 1; }
        
        .card { 
            background: var(--bg-card); border-radius: var(--radius); padding: 25px; 
            box-shadow: var(--shadow); margin-bottom: 25px; animation: fadeUp 0.4s ease-out;
            border: 1px solid var(--lh-grey);
        }
        @keyframes fadeUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        
        h2 { font-weight: 300; font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid var(--lh-grey); padding-bottom: 10px; }
        
        /* CONTROLS */
        .inp-group { margin-bottom: 15px; }
        .label { display: block; font-size: 0.75rem; font-weight: bold; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; }
        .inp { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 1rem; outline: none; transition: 0.2s; }
        .inp:focus { border-color: var(--lh-blue); }
        
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 4px; font-weight: bold; 
            text-transform: uppercase; cursor: pointer; font-size: 0.9rem; letter-spacing: 0.5px; transition: 0.2s;
            background: var(--lh-blue); color: white;
        }
        .btn:hover { background: var(--lh-blue-dark); }
        .btn-y { background: var(--lh-yellow); color: var(--lh-blue); }
        .btn-y:hover { background: #eec111; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* ACTIVE FLIGHT BANNER */
        .af-card { border-left: 5px solid var(--lh-yellow); }
        .af-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .af-route { font-size: 2rem; font-weight: 300; line-height: 1; }
        .af-meta { font-family: 'Roboto Mono', monospace; color: var(--text-light); font-size: 0.9rem; margin-top: 5px; }
        .progress-track { height: 8px; background: var(--lh-grey); border-radius: 4px; overflow: hidden; margin: 20px 0 10px 0; }
        .progress-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }

        /* STATS GRID */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--bg-card); padding: 20px; border-radius: var(--radius); text-align: center; border: 1px solid var(--lh-grey); }
        .stat-val { font-size: 2rem; font-weight: 300; color: var(--lh-blue); }
        body.dark-mode .stat-val { color: white; }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); margin-top: 5px; }

        /* LISTS */
        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .flight-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--lh-grey); }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; color: white; background: var(--text-light); }
        .tag-urg { background: #dc2626; } .tag-inf { background: var(--lh-blue); }

        /* MODALS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5, 22, 77, 0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-card); width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: var(--radius); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        .briefing-data { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; background: var(--bg-body); padding: 15px; border-radius: 6px; }
        .data-item label { display: block; font-size: 0.65rem; font-weight: bold; color: var(--text-light); margin-bottom: 3px; }
        .data-item span { font-family: 'Roboto Mono', monospace; font-weight: 600; color: var(--lh-blue); font-size: 1rem; }
        body.dark-mode .data-item span { color: #60a5fa; }
        
        #map-container { height: 250px; background: #ddd; margin-bottom: 20px; border-radius: 4px; }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: var(--bg-card); padding: 40px; width: 90%; max-width: 400px; border-radius: var(--radius); border: 1px solid var(--lh-grey); text-align: center; box-shadow: var(--shadow); }

        /* GAMES (MINIMALIST) */
        #game-area { text-align: center; padding: 20px; background: #111; border-radius: 8px; color: white; margin-top: 10px; }
        canvas { border: 2px solid #333; margin: 10px auto; display: block; max-width: 100%; }

        @media (max-width: 768px) {
            .nav-scroll { justify-content: flex-start; }
            .stats { grid-template-columns: 1fr; }
            .stat-box { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
            .briefing-data { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="margin-bottom:30px; text-align:center;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Lufthansa_Logo_2018.svg/1200px-Lufthansa_Logo_2018.svg.png" style="height:40px; margin-bottom:10px;">
            <div style="font-size:0.9rem; letter-spacing:2px; text-transform:uppercase; color:var(--text-light);">Crew Operations Portal</div>
        </div>
        <div class="login-card">
            <h2 style="border:none; margin-bottom:10px;">Identification</h2>
            <div class="inp-group"><input type="text" id="callsign" class="inp" placeholder="Callsign (e.g. DLH001)"></div>
            <div class="inp-group"><input type="password" id="password" class="inp" placeholder="Password"></div>
            <button class="btn" onclick="app.login()">Log In</button>
            <p id="login-msg" style="color:#dc2626; margin-top:15px; font-size:0.9rem;"></p>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo">
        <div class="tools" id="toolbar">
            <span id="clock" style="font-family:'Roboto Mono'; margin-right:15px;">00:00 Z</span>
            <span style="cursor:pointer;" onclick="app.toggleTheme()">üåô</span>
        </div>
    </header>

    <div class="nav-wrap hidden" id="nav-wrap">
        <div class="nav-scroll">
            <button class="nav-item active" onclick="app.tab('dash', this)">Dashboard</button>
            <button class="nav-item" onclick="app.tab('fleet', this)">Fleet</button>
            <button class="nav-item" onclick="app.tab('schedule', this)">Schedule</button>
            <button class="nav-item" onclick="app.tab('generator', this)">Generator</button>
            <button class="nav-item" onclick="app.tab('rest', this)" style="margin-left:auto; opacity:0.7;">‚òï Rest Area</button>
        </div>
    </div>

    <div class="container hidden" id="main-app">
        
        <div id="mission-card" class="card" style="background: linear-gradient(135deg, #05164d 0%, #1a3c8a 100%); color:white;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="background:#ffb600; color:#05164d; font-size:0.7rem; padding:2px 6px; border-radius:4px; font-weight:bold;">DAILY MISSION</span>
                <span id="mission-date" style="font-size:0.8rem; opacity:0.8;"></span>
            </div>
            <div id="mission-txt" style="font-size:1.3rem; margin-top:10px; font-weight:300;">Loading...</div>
            <button class="btn" style="background:rgba(255,255,255,0.2); margin-top:15px; width:auto; padding:8px 20px;" onclick="app.acceptMission()">FLY</button>
        </div>

        <div id="active-card" class="card af-card hidden">
            <div class="af-header">
                <div>
                    <div class="label" style="color:var(--lh-yellow);">ACTIVE FLIGHT</div>
                    <div class="af-route"><span id="af-dep"></span> &rarr; <span id="af-arr"></span></div>
                    <div class="af-meta"><span id="af-num"></span> ‚Ä¢ <span id="af-ac"></span></div>
                </div>
                <div style="text-align:right;">
                    <div id="af-timer" style="font-size:1.5rem; font-weight:bold;">00:00</div>
                    <div style="font-size:0.8rem; color:var(--text-light);">REMAINING</div>
                </div>
            </div>
            <div class="progress-track"><div id="af-bar" class="progress-fill"></div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                <button class="btn btn-y hidden" id="btn-pirep" onclick="app.finishFlight()">FILE REPORT</button>
                <button class="btn" style="background:#ef4444; color:white;" onclick="app.cancelFlight()">CANCEL</button>
            </div>
        </div>

        <div id="tab-dash" class="tab-view">
            <div class="stats">
                <div class="stat-box"><div class="stat-val" id="st-fl">0</div><div class="stat-lbl">Flights</div></div>
                <div class="stat-box"><div class="stat-val" id="st-hr">0</div><div class="stat-lbl">Hours</div></div>
                <div class="stat-box"><div class="stat-val" id="st-rk" style="color:var(--lh-yellow)">-</div><div class="stat-lbl">Rank</div></div>
            </div>
            <div class="card">
                <h2>Operational Notices</h2>
                <div id="news-feed"></div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-view hidden">
            <div class="card">
                <h2>Fleet Overview</h2>
                <div class="grid-list" id="fleet-grid"></div>
            </div>
        </div>

        <div id="tab-schedule" class="tab-view hidden">
            <div class="card">
                <h2>Flight Schedule</h2>
                <div class="inp-group" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div><span class="label">Airline</span><select id="sch-al" class="inp" onchange="app.renderSchedule()"></select></div>
                    <div><span class="label">Flight Time</span><select id="sch-time" class="inp" onchange="app.renderSchedule()">
                        <option value="ALL">All Durations</option>
                        <option value="1-2">1 - 2 Hours</option>
                        <option value="3-4">3 - 4 Hours</option>
                        <option value="5-6">5 - 6 Hours</option>
                        <option value="7-8">7 - 8 Hours</option>
                        <option value="9-10">9 - 10 Hours</option>
                        <option value="10+">Ultra Long (10h+)</option>
                    </select></div>
                </div>
                <div class="grid-list" id="sch-grid"></div>
            </div>
        </div>

        <div id="tab-generator" class="tab-view hidden">
            <div class="card">
                <h2>Random Flight Dispatch</h2>
                <div class="inp-group"><span class="label">Operator</span><select id="gen-al" class="inp" onchange="app.updateHubs()"></select></div>
                <div class="inp-group"><span class="label">Hub</span><select id="gen-hub" class="inp" disabled></select></div>
                <div class="inp-group"><span class="label">Duration Target</span><select id="gen-time" class="inp">
                    <option value="ALL">Random</option>
                    <option value="1-2">Short (1-2h)</option>
                    <option value="3-4">Medium (3-4h)</option>
                    <option value="5-6">Long (5-6h)</option>
                    <option value="10+">Ultra (10h+)</option>
                </select></div>
                <button class="btn" onclick="app.generate()">Generate Plan</button>
            </div>
        </div>

        <div id="tab-rest" class="tab-view hidden">
            <div class="card">
                <h2>Crew Rest Area</h2>
                <p style="color:var(--text-light); margin-bottom:20px;">Relax during your layover.</p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn" onclick="game.startSnake()">Snake</button>
                    <button class="btn" onclick="game.startTetris()">Tetris</button>
                </div>
                <div id="game-area" class="hidden">
                    <div id="game-score" style="font-weight:bold; font-size:1.2rem; margin-bottom:10px; color:var(--lh-yellow);">0</div>
                    <canvas id="cvs-game"></canvas>
                    <div id="game-ctrls" style="margin-top:15px; display:none; gap:10px; justify-content:center;">
                        <button class="btn" style="width:50px;" onclick="game.input('l')">‚Üê</button>
                        <button class="btn" style="width:50px;" onclick="game.input('d')">‚Üì</button>
                        <button class="btn" style="width:50px;" onclick="game.input('r')">‚Üí</button>
                        <button class="btn" style="width:50px; background:var(--lh-yellow); color:black;" onclick="game.input('act')">‚ü≥</button>
                    </div>
                    <button class="btn" style="background:#333; margin-top:20px;" onclick="game.stop()">Exit Game</button>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-brief" class="modal-overlay hidden">
        <div class="modal-box">
            <div style="border-bottom:2px solid var(--lh-blue); margin-bottom:20px; padding-bottom:10px; display:flex; justify-content:space-between;">
                <h3>OFP BRIEFING</h3>
                <h3 id="br-num" style="color:var(--lh-blue);"></h3>
            </div>
            <div class="briefing-data">
                <div class="data-item"><label>ORIGIN</label><span id="br-dep"></span></div>
                <div class="data-item"><label>DESTINATION</label><span id="br-arr"></span></div>
                <div class="data-item"><label>ETE</label><span id="br-time"></span></div>
                <div class="data-item"><label>AIRCRAFT</label><span id="br-ac"></span></div>
                <div class="data-item"><label>PAX</label><span id="br-pax"></span></div>
                <div class="data-item"><label>ZFW</label><span id="br-zfw"></span></div>
                <div class="data-item"><label>GATE</label><span id="br-gate"></span></div>
                <div class="data-item"><label>CRUISE</label><span id="br-fl"></span></div>
            </div>
            <div id="map-container"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn btn-y" onclick="app.acceptBriefing()">ACCEPT</button>
                <button class="btn" style="background:#e5e7eb; color:#333;" onclick="document.getElementById('modal-brief').classList.add('hidden')">DECLINE</button>
            </div>
        </div>
    </div>

    <script>
        // === APP LOGIC ===
        const app = {
            data: {
                user: { call: "DLH001", pass: "1234" },
                stats: JSON.parse(localStorage.getItem('stats')) || { fl:0, hr:0 },
                fleet: [
                    { t:"Airbus A320neo", c:"S", s:180, r:6, op:["Lufthansa","Eurowings","Austrian","SAS"] },
                    { t:"Boeing 747-8", c:"L", s:364, r:14, op:["Lufthansa"] },
                    { t:"Airbus A350-900", c:"L", s:293, r:16, op:["Lufthansa","SAS"] },
                    { t:"Airbus A220", c:"S", s:145, r:6, op:["SWISS","AirBaltic"] }
                ],
                hubs: { "Lufthansa": ["EDDF","EDDM"], "SWISS": ["LSZH"], "Austrian": ["LOWW"], "Eurowings": ["EDDL"], "SAS": ["EKCH"], "AirBaltic": ["EVRA"] },
                routes: { // Extended DB for filters
                    "Lufthansa": [{c:"EGLL",t:1.5},{c:"CDG",t:1.2},{c:"MAD",t:2.5},{c:"LIS",t:3.2},{c:"TLV",t:4.1},{c:"DXB",t:6.2},{c:"JFK",t:8.5},{c:"LAX",t:11.5},{c:"EZE",t:13.8}],
                    "SWISS": [{c:"LHR",t:1.8},{c:"DXB",t:6.0},{c:"SIN",t:12.1}],
                    "Austrian": [{c:"FRA",t:1.1},{c:"LHR",t:2.2},{c:"BKK",t:10.5}],
                    "Eurowings": [{c:"PMI",t:2.2},{c:"LHR",t:1.4}],
                    "SAS": [{c:"LHR",t:1.9},{c:"EWR",t:8.8}],
                    "AirBaltic": [{c:"HEL",t:0.8},{c:"DXB",t:6.5}]
                },
                news: [
                    {t:"System Upgrade v57", d:"Optimization of flight scheduling filters."},
                    {t:"Winter Ops", d:"De-icing mandatory below 3¬∞C."}
                ]
            },
            coords: { "EDDF":[50.03,8.57], "EDDM":[48.35,11.78], "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "EGLL":[51.47,-0.46], "JFK":[40.64,-73.77], "LAX":[33.94,-118.40], "DXB":[25.25,55.36], "SIN":[1.36,103.98], "CDG":[49,2], "MAD":[40,-3], "EZE":[-34,-58], "PMI":[39,2], "BKK":[13,100], "HEL":[60,24] },
            
            state: { tempF: null, map: null, timer: null, mission: null },

            init: function() {
                if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
                setInterval(() => { const d=new Date(); document.getElementById('clock').innerText = d.getUTCHours().toString().padStart(2,'0')+':'+d.getUTCMinutes().toString().padStart(2,'0')+' Z'; }, 1000);
                this.renderUI();
                this.checkActiveFlight();
                this.genMission();
            },

            login: function() {
                const c = document.getElementById('callsign').value.toUpperCase();
                const p = document.getElementById('password').value;
                if(c === this.data.user.call && p === this.data.user.pass) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('nav-wrap').classList.remove('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('toolbar').classList.add('visible');
                } else { document.getElementById('login-msg').innerText = "Invalid credentials"; }
            },

            tab: function(id, btn) {
                document.querySelectorAll('.tab-view').forEach(e => e.classList.add('hidden'));
                document.getElementById('tab-'+id).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                if(btn) btn.classList.add('active');
            },

            renderUI: function() {
                // Stats
                document.getElementById('st-fl').innerText = this.data.stats.fl;
                document.getElementById('st-hr').innerText = Math.floor(this.data.stats.hr);
                document.getElementById('st-rk').innerText = this.data.stats.fl > 20 ? "Captain" : "FO";
                
                // Selects
                const s1=document.getElementById('sch-al'), s2=document.getElementById('gen-al');
                s1.innerHTML=''; s2.innerHTML='<option value="">-- Operator --</option>';
                Object.keys(this.data.hubs).forEach(k => { s1.add(new Option(k,k)); s2.add(new Option(k,k)); });
                
                // News
                document.getElementById('news-feed').innerHTML = this.data.news.map(n => 
                    `<div class="flight-row" style="display:block"><div style="font-weight:bold; color:var(--lh-blue)">${n.t}</div><div style="font-size:0.8rem; color:var(--text-light)">${n.d}</div></div>`
                ).join('');
                
                // Fleet
                document.getElementById('fleet-grid').innerHTML = this.data.fleet.map(f => 
                    `<div class="card" style="margin:0; padding:15px;">
                        <div style="font-weight:bold;">${f.t}</div>
                        <div style="font-size:0.85rem; color:var(--text-light)">${f.s} Pax ‚Ä¢ ${f.r}h Range</div>
                        <div style="margin-top:5px; font-size:0.75rem;"><span class="tag tag-inf">${f.c === 'L' ? 'Long Haul' : 'Short Haul'}</span></div>
                    </div>`
                ).join('');
                
                this.renderSchedule();
            },

            // --- FLIGHT LOGIC ---
            checkDuration: function(t, f) {
                if(f==='ALL') return true;
                if(f==='1-2') return t>=1 && t<3;
                if(f==='3-4') return t>=3 && t<5;
                if(f==='5-6') return t>=5 && t<7;
                if(f==='7-8') return t>=7 && t<9;
                if(f==='9-10') return t>=9 && t<11;
                if(f==='10+') return t>=10;
                return false;
            },

            renderSchedule: function() {
                const al = document.getElementById('sch-al').value;
                const tf = document.getElementById('sch-time').value;
                const grid = document.getElementById('sch-grid');
                
                if(!this.data.routes[al]) { grid.innerHTML="No routes"; return; }
                const res = this.data.routes[al].filter(r => this.checkDuration(r.t, tf));
                
                grid.innerHTML = res.length ? res.map(r => 
                    `<div class="card" style="margin:0; border-left:4px solid var(--lh-blue); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold; color:var(--lh-blue)">${this.data.hubs[al][0]} &rarr; ${r.c}</div>
                            <div style="font-family:'Roboto Mono'; font-size:0.85rem;">${r.t} Hours</div>
                        </div>
                        <button class="btn btn-y" style="width:auto; padding:8px 15px;" onclick="app.prepFlight('${al}','${this.data.hubs[al][0]}','${r.c}',${r.t})">SELECT</button>
                    </div>`
                ).join('') : "No flights match filters.";
            },

            updateHubs: function() {
                const al = document.getElementById('gen-al').value;
                const h = document.getElementById('gen-hub');
                h.innerHTML=''; 
                if(al) { h.disabled=false; this.data.hubs[al].forEach(x => h.add(new Option(x,x))); } 
                else h.disabled=true;
            },

            generate: function() {
                const al = document.getElementById('gen-al').value;
                const hub = document.getElementById('gen-hub').value;
                const tf = document.getElementById('gen-time').value;
                
                if(!al || !hub) return;
                const valid = this.data.routes[al].filter(r => this.checkDuration(r.t, tf));
                
                if(valid.length === 0) { alert("No routes match duration."); return; }
                const r = valid[Math.floor(Math.random() * valid.length)];
                this.prepFlight(al, hub, r.c, r.t);
            },

            getPlane: function(al, t) {
                const cat = t > 5 ? 'L' : 'S';
                let p = this.data.fleet.filter(f => f.op.includes(al) && f.c === cat);
                if(!p.length) p = this.data.fleet.filter(f => f.op.includes(al));
                return p.length ? p[Math.floor(Math.random()*p.length)] : null;
            },

            prepFlight: function(al, dep, arr, time) {
                const plane = this.getPlane(al, time);
                if(!plane) { alert("No aircraft available."); return; }
                
                this.state.tempF = {
                    dep, arr, time, ac: plane.t, 
                    num: "LH"+Math.floor(Math.random()*8999+1000),
                    pax: Math.floor(plane.s * 0.85),
                    zfw: (Math.random()*50+40).toFixed(1)+"T",
                    gate: (Math.random()>0.5?'A':'B') + Math.floor(Math.random()*40),
                    fl: "FL" + (Math.floor(Math.random()*8+32)*10)
                };
                
                document.getElementById('br-dep').innerText = dep;
                document.getElementById('br-arr').innerText = arr;
                document.getElementById('br-time').innerText = time + 'h';
                document.getElementById('br-ac').innerText = plane.t;
                document.getElementById('br-num').innerText = this.state.tempF.num;
                document.getElementById('br-pax').innerText = this.state.tempF.pax;
                document.getElementById('br-zfw').innerText = this.state.tempF.zfw;
                document.getElementById('br-gate').innerText = this.state.tempF.gate;
                document.getElementById('br-fl').innerText = this.state.tempF.fl;
                
                document.getElementById('modal-brief').classList.remove('hidden');
                
                setTimeout(() => {
                    if(this.state.map) this.state.map.remove();
                    this.state.map = L.map('map-container').setView([50,10], 3);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(this.state.map);
                    const c1 = this.coords[dep] || [50,10];
                    const c2 = this.coords[arr] || [40,-70];
                    L.polyline([c1,c2], {color:'#05164d', weight:3}).addTo(this.state.map);
                    this.state.map.fitBounds([c1,c2], {padding:[50,50]});
                    this.state.map.invalidateSize();
                }, 200);
            },

            acceptBriefing: function() {
                this.state.tempF.start = Date.now();
                localStorage.setItem('active', JSON.stringify(this.state.tempF));
                document.getElementById('modal-brief').classList.add('hidden');
                this.checkActiveFlight();
                this.tab('dash', document.querySelectorAll('.nav-item')[0]);
            },

            checkActiveFlight: function() {
                const s = localStorage.getItem('active');
                if(!s) {
                    document.getElementById('active-card').classList.add('hidden');
                    document.getElementById('mission-card').classList.remove('hidden');
                    return;
                }
                document.getElementById('active-card').classList.remove('hidden');
                document.getElementById('mission-card').classList.add('hidden');
                
                const f = JSON.parse(s);
                document.getElementById('af-dep').innerText = f.dep;
                document.getElementById('af-arr').innerText = f.arr;
                document.getElementById('af-num').innerText = f.num;
                document.getElementById('af-ac').innerText = f.ac;
                
                if(this.state.timer) clearInterval(this.state.timer);
                this.state.timer = setInterval(() => {
                    const el = Date.now() - f.start;
                    const dur = f.time * 10 * 1000; // 10sec per flight hour
                    const pct = Math.min(100, (el/dur)*100);
                    const rem = Math.max(0, Math.ceil((dur - el)/1000));
                    
                    document.getElementById('af-bar').style.width = pct + "%";
                    document.getElementById('af-timer').innerText = `00:${rem.toString().padStart(2,'0')}`;
                    
                    if(pct >= 100) {
                        document.getElementById('btn-pirep').classList.remove('hidden');
                        document.getElementById('af-timer').innerText = "ARRIVED";
                    }
                }, 1000);
            },

            finishFlight: function() {
                const f = JSON.parse(localStorage.getItem('active'));
                this.data.stats.fl++;
                this.data.stats.hr += f.time;
                localStorage.setItem('stats', JSON.stringify(this.data.stats));
                localStorage.removeItem('active');
                this.checkActiveFlight();
                this.renderUI();
            },
            cancelFlight: function() { localStorage.removeItem('active'); this.checkActiveFlight(); },

            genMission: function() {
                const seed = new Date().getDate();
                const al = "Lufthansa";
                const r = this.data.routes[al][seed % this.data.routes[al].length];
                document.getElementById('mission-date').innerText = new Date().toLocaleDateString();
                document.getElementById('mission-txt').innerText = `${this.data.hubs[al][0]} ‚ûù ${r.c}`;
                this.state.mission = { al, dep: this.data.hubs[al][0], arr: r.c, t: r.t };
            },
            acceptMission: function() { this.prepFlight(this.state.mission.al, this.state.mission.dep, this.state.mission.arr, this.state.mission.t); },
            toggleTheme: function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }
        };

        // === MINIMALIST GAME ENGINE ===
        const game = {
            ctx: null, w: 0, h: 0, running: false, type: null,
            state: {},
            init: function() {
                const c = document.getElementById('cvs-game');
                // Fit canvas to width of container, max 300px
                const ctr = document.getElementById('game-area');
                this.w = c.width = Math.min(300, ctr.offsetWidth - 40);
                this.h = c.height = (this.w / 10) * 20; // 2:1 ratio for Tetris/Snake
                this.ctx = c.getContext('2d');
                document.getElementById('game-area').classList.remove('hidden');
                document.getElementById('game-ctrls').style.display = 'flex';
                window.scrollTo(0, document.body.scrollHeight);
            },
            stop: function() { this.running = false; document.getElementById('game-area').classList.add('hidden'); },
            
            // SNAKE
            startSnake: function() {
                this.init(); this.type = 'snake'; this.running = true;
                this.state = { sn:[{x:5,y:5}], dx:1, dy:0, fd:{x:2,y:2}, bs: this.w/15, sc:0 };
                this.loopSnake();
            },
            loopSnake: function() {
                if(!this.running || this.type !== 'snake') return;
                const s = this.state;
                // Move
                const h = {x: s.sn[0].x + s.dx, y: s.sn[0].y + s.dy};
                s.sn.unshift(h);
                if(h.x === s.fd.x && h.y === s.fd.y) { s.sc++; document.getElementById('game-score').innerText = s.sc; s.fd = {x:Math.floor(Math.random()*15), y:Math.floor(Math.random()*20)}; }
                else s.sn.pop();
                
                // Draw
                this.ctx.fillStyle = '#111'; this.ctx.fillRect(0,0,this.w,this.h);
                this.ctx.fillStyle = '#ffb600'; this.ctx.fillRect(s.fd.x*s.bs, s.fd.y*s.bs, s.bs-1, s.bs-1);
                this.ctx.fillStyle = '#4ade80'; s.sn.forEach(p => this.ctx.fillRect(p.x*s.bs, p.y*s.bs, s.bs-1, s.bs-1));
                
                // Collision
                if(h.x<0 || h.x>=15 || h.y<0 || h.y>=25) this.stop();
                
                setTimeout(() => requestAnimationFrame(()=>this.loopSnake()), 150);
            },
            
            // TETRIS
            startTetris: function() {
                this.init(); this.type = 'tetris'; this.running = true;
                this.state = { bd:Array(20).fill().map(()=>Array(10).fill(0)), cur:null, bs:this.w/10, sc:0 };
                this.spawnT(); this.loopTetris();
            },
            spawnT: function() {
                const sh = [[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
                this.state.cur = { m: sh[Math.floor(Math.random()*sh.length)], x:3, y:0 };
                if(this.collT()) this.stop();
            },
            collT: function() {
                const {m,x,y} = this.state.cur;
                return m.some((r,dy) => r.some((v,dx) => v && (y+dy>=20 || x+dx<0 || x+dx>=10 || this.state.bd[y+dy][x+dx])));
            },
            loopTetris: function(t=0) {
                if(!this.running || this.type !== 'tetris') return;
                if(t - (this.last||0) > 500) {
                    this.state.cur.y++;
                    if(this.collT()) {
                        this.state.cur.y--;
                        this.state.cur.m.forEach((r,dy)=>r.forEach((v,dx)=>{ if(v) this.state.bd[this.state.cur.y+dy][this.state.cur.x+dx]=1; }));
                        // Line clear
                        this.state.bd = this.state.bd.filter(r => r.some(v=>!v));
                        while(this.state.bd.length < 20) { this.state.bd.unshift(Array(10).fill(0)); this.state.sc+=10; }
                        document.getElementById('game-score').innerText = this.state.sc;
                        this.spawnT();
                    }
                    this.last = t;
                }
                // Draw
                this.ctx.fillStyle='#111'; this.ctx.fillRect(0,0,this.w,this.h);
                const drawM = (m,ox,oy,c) => m.forEach((r,y)=>r.forEach((v,x)=>{ if(v) { this.ctx.fillStyle=c; this.ctx.fillRect((x+ox)*this.state.bs, (y+oy)*this.state.bs, this.state.bs-1, this.state.bs-1); }}));
                drawM(this.state.bd,0,0,'#333');
                drawM(this.state.cur.m, this.state.cur.x, this.state.cur.y, '#3b82f6');
                
                requestAnimationFrame((nm)=>this.loopTetris(nm));
            },
            
            input: function(k) {
                if(!this.running) return;
                if(this.type === 'snake') {
                    const s = this.state;
                    if(k==='l' && s.dx===0) {s.dx=-1; s.dy=0;} if(k==='r' && s.dx===0) {s.dx=1; s.dy=0;}
                    if(k==='u' && s.dy===0) {s.dy=-1; s.dx=0;} if(k==='d' && s.dy===0) {s.dy=1; s.dx=0;}
                }
                if(this.type === 'tetris') {
                    const s = this.state;
                    if(k==='l') {s.cur.x--; if(this.collT())s.cur.x++;}
                    if(k==='r') {s.cur.x++; if(this.collT())s.cur.x--;}
                    if(k==='d') {s.cur.y++; if(this.collT())s.cur.y--;}
                    if(k==='act') { // Rotate
                        const old = s.cur.m;
                        s.cur.m = s.cur.m[0].map((_,i) => s.cur.m.map(r => r[i]).reverse());
                        if(this.collT()) s.cur.m = old;
                    }
                }
            }
        };

        app.init();
    </script>
</body>
</html>
