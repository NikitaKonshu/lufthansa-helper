<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Crew Portal - v58 (Desktop Pro)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* === CONFIG === */
        :root {
            --lh-blue: #05164d; --lh-blue-light: #1a3c8a;
            --lh-yellow: #ffb600; --lh-grey: #e6e9ed;
            --bg-body: #f1f5f9; --bg-card: #ffffff;
            --text-main: #1e293b; --text-light: #64748b;
            --nav-h: 60px; --head-h: 70px;
            --radius: 8px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body.dark-mode {
            --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f8fafc; --text-light: #94a3b8;
            --lh-grey: #334155; --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }
        body.dark-mode input, body.dark-mode select { background: #0f172a; color: white; border-color: #334155; }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; padding-top: calc(var(--head-h) + var(--nav-h)); }
        .hidden { display: none !important; }

        /* === INTRO SCREEN === */
        #intro {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--lh-blue); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.8s ease;
        }
        .intro-logo { width: 80px; margin-bottom: 20px; animation: fadeIn 1s ease; }
        .intro-text { font-size: 2rem; font-weight: 300; letter-spacing: 2px; animation: slideUp 1s ease 0.3s backwards; }
        .intro-sub { font-size: 0.8rem; letter-spacing: 4px; text-transform: uppercase; opacity: 0.7; animation: slideUp 1s ease 0.6s backwards; }
        
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes slideUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* === HEADER === */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--head-h);
            background: var(--lh-blue); z-index: 2000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .logo-img { height: 30px; filter: brightness(0) invert(1); }
        .user-panel { display: flex; gap: 20px; align-items: center; color: white; font-weight: 500; }

        /* === NAVIGATION === */
        .nav-wrap {
            position: fixed; top: var(--head-h); left: 0; width: 100%; height: var(--nav-h);
            background: var(--bg-card); border-bottom: 1px solid var(--lh-grey); z-index: 1900;
            display: flex; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav { display: flex; gap: 10px; height: 100%; align-items: center; max-width: 1200px; width: 100%; padding: 0 20px; overflow-x: auto; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 20px;
            font-size: 0.95rem; font-weight: 600; color: var(--text-light); cursor: pointer;
            border-bottom: 3px solid transparent; transition: 0.2s; white-space: nowrap;
        }
        .nav-btn:hover { color: var(--lh-blue); }
        .nav-btn.active { color: var(--lh-blue); border-bottom-color: var(--lh-yellow); }
        body.dark-mode .nav-btn.active { color: #60a5fa; }

        /* === LAYOUT & GRID === */
        .container {
            max-width: 1200px; margin: 30px auto; padding: 0 20px; width: 100%;
        }
        
        /* Desktop Grid for Dashboard */
        .dash-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 25px;
        }
        
        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow); border: 1px solid var(--lh-grey); margin-bottom: 25px;
        }
        
        h2 { font-weight: 300; font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid var(--lh-grey); padding-bottom: 10px; }

        /* === MODULES === */
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--lh-grey); padding: 20px; border-radius: var(--radius); text-align: center; }
        .stat-val { font-size: 2.2rem; font-weight: 300; color: var(--lh-blue); }
        body.dark-mode .stat-val { color: white; }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; }

        /* Active Flight */
        .af-card { border-left: 5px solid var(--lh-yellow); }
        .af-top { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .af-route { font-size: 2rem; line-height: 1; font-weight: 300; }
        .af-det { font-family: 'Roboto Mono'; color: var(--text-light); margin-top: 5px; }
        .bar-track { height: 8px; background: var(--lh-grey); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }

        /* Forms & Buttons */
        .inp-g { margin-bottom: 15px; }
        .lbl { display: block; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; color: var(--text-light); text-transform: uppercase; }
        .inp { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 1rem; }
        .btn { width: 100%; padding: 12px; background: var(--lh-blue); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn:hover { background: var(--lh-blue-light); }
        .btn-y { background: var(--lh-yellow); color: var(--lh-blue); }
        .btn-red { background: #dc2626; color: white; }

        /* Login Screen */
        #login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            width: 400px; padding: 40px; background: var(--bg-card);
            border-radius: var(--radius); box-shadow: var(--shadow); text-align: center;
        }

        /* Lists */
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(5,22,77,0.9); z-index: 8000; display:flex; justify-content:center; align-items:center; }
        .modal-box { width: 700px; max-height: 90vh; background: var(--bg-card); padding: 30px; border-radius: var(--radius); overflow-y: auto; }
        .brief-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; background: var(--bg-body); padding: 15px; border-radius: 6px; }

        /* Game Area (Minimal) */
        #game-container { text-align: center; background: #111; padding: 20px; border-radius: 8px; color: white; }
        canvas { border: 1px solid #333; margin: 10px auto; display: block; }
        .game-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .g-btn { width: 50px; height: 50px; background: #333; border: 1px solid #555; color: white; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        .g-btn:active { background: #555; }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .dash-grid { grid-template-columns: 1fr; }
            .brief-grid { grid-template-columns: 1fr 1fr; }
            .stats-row { grid-template-columns: 1fr; }
            .stat-card { display: flex; justify-content: space-between; align-items: center; text-align: left; }
            header { padding: 0 20px; }
        }
    </style>
</head>
<body>

    <div id="intro">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="intro-logo" style="filter: brightness(0) invert(1);">
        <div class="intro-text">Lufthansa Systems</div>
        <div class="intro-sub">Crew Operations Portal</div>
    </div>

    <div id="login-wrap">
        <div class="login-box">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Lufthansa_Logo_2018.svg/1200px-Lufthansa_Logo_2018.svg.png" style="height:40px; margin-bottom:20px;">
            <div class="inp-g"><input type="text" id="user" class="inp" placeholder="Callsign (DLH001)"></div>
            <div class="inp-g"><input type="password" id="pass" class="inp" placeholder="Password (1234)"></div>
            <button class="btn" onclick="app.login()">Authenticate</button>
            <p id="login-err" style="color: red; margin-top: 10px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo-img">
        <div class="user-panel">
            <span id="clock" style="font-family:'Roboto Mono'">00:00 Z</span>
            <span onclick="app.theme()" style="cursor:pointer; font-size:1.2rem;">üåô</span>
        </div>
    </header>

    <div class="nav-wrap hidden" id="nav-bar">
        <div class="nav">
            <button class="nav-btn active" onclick="app.tab('dash', this)">Dashboard</button>
            <button class="nav-btn" onclick="app.tab('fleet', this)">Fleet</button>
            <button class="nav-btn" onclick="app.tab('schedule', this)">Schedule</button>
            <button class="nav-btn" onclick="app.tab('dispatch', this)">Generator</button>
            <button class="nav-btn" onclick="app.tab('rest', this)" style="margin-left:auto; opacity:0.6;">‚òï Rest Area</button>
        </div>
    </div>

    <div class="container hidden" id="main-content">
        
        <div id="tab-dash" class="tab-content">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-lbl">Flights</div>
                    <div class="stat-val" id="st-fl">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Hours</div>
                    <div class="stat-val" id="st-hr">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Rank</div>
                    <div class="stat-val" id="st-rk" style="color:var(--lh-yellow); font-size:1.5rem;">-</div>
                </div>
            </div>

            <div class="dash-grid">
                <div>
                    <div id="af-card" class="card af-card hidden">
                        <div class="af-top">
                            <div>
                                <div class="lbl" style="color:var(--lh-yellow);">ACTIVE FLIGHT</div>
                                <div class="af-route"><span id="af-dep"></span> &rarr; <span id="af-arr"></span></div>
                                <div class="af-det"><span id="af-num"></span> ‚Ä¢ <span id="af-ac"></span></div>
                            </div>
                            <div style="text-align:right;">
                                <div id="af-timer" style="font-size:1.5rem; font-weight:bold;">00:00</div>
                                <div class="lbl">REMAINING</div>
                            </div>
                        </div>
                        <div class="bar-track"><div id="af-bar" class="bar-fill"></div></div>
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button class="btn btn-y hidden" id="btn-pirep" onclick="app.finish()">FILE REPORT</button>
                            <button class="btn btn-red" onclick="app.cancel()">CANCEL</button>
                        </div>
                    </div>

                    <div id="mission-card" class="card" style="background: linear-gradient(135deg, #05164d 0%, #1a3c8a 100%); color:white;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="background:#ffb600; color:#05164d; font-size:0.7rem; font-weight:bold; padding:2px 6px; border-radius:4px;">DAILY MISSION</span>
                            <span id="mis-date" style="font-size:0.8rem; opacity:0.8;"></span>
                        </div>
                        <div id="mis-txt" style="font-size:1.5rem; font-weight:300;">Loading...</div>
                        <button class="btn" style="background:rgba(255,255,255,0.2); width:auto; margin-top:15px;" onclick="app.acceptMission()">FLY THIS ROUTE</button>
                    </div>
                </div>

                <div class="card">
                    <h2>News Center</h2>
                    <div id="news-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-content hidden">
            <div class="card">
                <h2>Fleet Overview</h2>
                <div class="item-list" id="fleet-list"></div>
            </div>
        </div>

        <div id="tab-schedule" class="tab-content hidden">
            <div class="card">
                <h2>Flight Schedule</h2>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <div style="flex:1;"><span class="lbl">Airline</span><select id="sch-al" class="inp" onchange="app.renderSch()"></select></div>
                    <div style="flex:1;"><span class="lbl">Duration</span><select id="sch-tm" class="inp" onchange="app.renderSch()">
                        <option value="ALL">All</option>
                        <option value="1-2">Short (1-2h)</option>
                        <option value="3-4">Medium (3-4h)</option>
                        <option value="5-6">Long (5-6h)</option>
                        <option value="7-8">Extended (7-8h)</option>
                        <option value="9-10">Ultra (9-10h)</option>
                        <option value="10+">Max (10h+)</option>
                    </select></div>
                </div>
                <div class="item-list" id="sch-list"></div>
            </div>
        </div>

        <div id="tab-dispatch" class="tab-content hidden">
            <div class="card" style="max-width:600px; margin:0 auto;">
                <h2>Flight Dispatch Generator</h2>
                <div class="inp-g"><span class="lbl">Operator</span><select id="gen-al" class="inp" onchange="app.updHub()"></select></div>
                <div class="inp-g"><span class="lbl">Departure Hub</span><select id="gen-hub" class="inp" disabled></select></div>
                <div class="inp-g"><span class="lbl">Target Duration</span><select id="gen-tm" class="inp">
                    <option value="ALL">Random</option>
                    <option value="1-2">1-2 Hours</option>
                    <option value="3-4">3-4 Hours</option>
                    <option value="5-6">5-6 Hours</option>
                    <option value="10+">10+ Hours</option>
                </select></div>
                <button class="btn" onclick="app.gen()">Generate Flight Plan</button>
            </div>
        </div>

        <div id="tab-rest" class="tab-content hidden">
            <div class="card" style="max-width:500px; margin:0 auto;">
                <h2>Crew Rest Area</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn" onclick="game.start('snake')">Snake</button>
                    <button class="btn" onclick="game.start('tetris')">Tetris</button>
                </div>
                <div id="game-container" class="hidden">
                    <div id="g-score" style="font-size:1.5rem; color:var(--lh-yellow); font-weight:bold;">0</div>
                    <canvas id="cvs"></canvas>
                    <div class="game-controls">
                        <button class="g-btn" onclick="game.input('l')">‚Üê</button>
                        <button class="g-btn" onclick="game.input('d')">‚Üì</button>
                        <button class="g-btn" onclick="game.input('r')">‚Üí</button>
                        <button class="g-btn" style="background:var(--lh-yellow); color:black;" onclick="game.input('rot')">‚ü≥</button>
                    </div>
                    <button class="btn" style="background:#333; margin-top:20px;" onclick="game.stop()">Quit Game</button>
                </div>
            </div>
        </div>

    </div>

    <div id="mod-brief" class="modal hidden">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--lh-blue); padding-bottom:10px;">
                <h3>OFP BRIEFING</h3>
                <h3 style="color:var(--lh-blue);" id="br-num"></h3>
            </div>
            <div class="brief-grid">
                <div><div class="lbl">ORIGIN</div><span id="br-dep"></span></div>
                <div><div class="lbl">DEST</div><span id="br-arr"></span></div>
                <div><div class="lbl">ETE</div><span id="br-time"></span></div>
                <div><div class="lbl">AIRCRAFT</div><span id="br-ac"></span></div>
                <div><div class="lbl">PAX</div><span id="br-pax"></span></div>
                <div><div class="lbl">ZFW</div><span id="br-zfw"></span></div>
                <div><div class="lbl">GATE</div><span id="br-gate"></span></div>
                <div><div class="lbl">FL</div><span id="br-fl"></span></div>
            </div>
            <div id="map" style="height:250px; background:#ddd; margin-bottom:20px; border-radius:4px;"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button class="btn btn-y" onclick="app.accept()">ACCEPT FLIGHT</button>
                <button class="btn" style="background:#e5e7eb; color:#333;" onclick="document.getElementById('mod-brief').classList.add('hidden')">DECLINE</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            db: {
                user: {u:"DLH001", p:"1234"},
                stats: JSON.parse(localStorage.getItem('stats'))||{fl:0, hr:0},
                hubs: {"Lufthansa":["EDDF","EDDM"],"SWISS":["LSZH"],"Austrian":["LOWW"],"Eurowings":["EDDL"],"SAS":["EKCH"]},
                fleet: [
                    {t:"Airbus A320neo", c:"S", s:180, r:6, op:["Lufthansa","Eurowings","Austrian","SAS"]},
                    {t:"Boeing 747-8", c:"L", s:364, r:14, op:["Lufthansa"]},
                    {t:"Airbus A350-900", c:"L", s:293, r:16, op:["Lufthansa","SAS"]},
                    {t:"Airbus A220", c:"S", s:145, r:6, op:["SWISS"]}
                ],
                routes: {
                    "Lufthansa": [{c:"EGLL",t:1.5},{c:"CDG",t:1.2},{c:"MAD",t:2.5},{c:"JFK",t:8.5},{c:"LAX",t:11.5},{c:"HND",t:12.5},{c:"EZE",t:13.8},{c:"DXB",t:6.2}],
                    "SWISS": [{c:"LHR",t:1.8},{c:"JFK",t:8.5},{c:"SIN",t:12.0}],
                    "Austrian": [{c:"LHR",t:2.2},{c:"BKK",t:10.5}],
                    "Eurowings": [{c:"PMI",t:2.2},{c:"LHR",t:1.4}],
                    "SAS": [{c:"LHR",t:1.9},{c:"EWR",t:8.8}]
                },
                news: [
                    {t:"Update v58.0", d:"Desktop layout optimized. Grid view enabled."},
                    {t:"Winter Ops", d:"De-icing required below 3¬∞C."}
                ]
            },
            coords: {"EDDF":[50,8],"EDDM":[48,11],"LSZH":[47,8],"LOWW":[48,16],"EGLL":[51,0],"JFK":[40,-73],"LAX":[34,-118],"HND":[35,139],"EZE":[-34,-58]},
            state: {temp:null, map:null, timer:null, mis:null},

            init: function() {
                setTimeout(() => { document.getElementById('intro').style.opacity=0; setTimeout(()=>document.getElementById('intro').classList.add('hidden'),800); }, 2000);
                if(localStorage.getItem('dark')==='1') document.body.classList.add('dark-mode');
                setInterval(()=>document.getElementById('clock').innerText=new Date().toISOString().substr(11,5)+" Z", 1000);
                this.render(); this.checkActive(); this.genMis();
            },

            login: function() {
                if(document.getElementById('user').value.toUpperCase()===this.db.user.u && document.getElementById('pass').value===this.db.user.p) {
                    document.getElementById('login-wrap').classList.add('hidden');
                    document.getElementById('nav-bar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                } else document.getElementById('login-err').innerText="Invalid Credentials";
            },

            tab: function(id, btn) {
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
                document.getElementById('tab-'+id).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                if(btn) btn.classList.add('active');
            },

            render: function() {
                document.getElementById('st-fl').innerText=this.db.stats.fl;
                document.getElementById('st-hr').innerText=Math.floor(this.db.stats.hr);
                document.getElementById('st-rk').innerText=this.db.stats.fl>20?"CPT":(this.db.stats.fl>5?"FO":"SO");
                
                // News
                document.getElementById('news-list').innerHTML=this.db.news.map(n=>`<div style="margin-bottom:15px; border-bottom:1px solid var(--lh-grey); padding-bottom:10px;"><div style="font-weight:bold; color:var(--lh-blue);">${n.t}</div><div style="font-size:0.9rem; color:var(--text-light);">${n.d}</div></div>`).join('');
                
                // Fleet
                document.getElementById('fleet-list').innerHTML=this.db.fleet.map(f=>`<div class="card" style="margin:0;"><h4>${f.t}</h4><div style="font-size:0.9rem; color:var(--text-light);">${f.s} Pax | ${f.r}h Range</div></div>`).join('');
                
                // Selects
                const s1=document.getElementById('sch-al'), s2=document.getElementById('gen-al');
                s1.innerHTML=''; s2.innerHTML='<option value="">-- Operator --</option>';
                Object.keys(this.db.hubs).forEach(k=>{ s1.add(new Option(k,k)); s2.add(new Option(k,k)); });
                
                this.renderSch();
            },

            renderSch: function() {
                const al=document.getElementById('sch-al').value, tm=document.getElementById('sch-tm').value;
                if(!this.db.routes[al]) { document.getElementById('sch-list').innerHTML="No routes"; return; }
                const res = this.db.routes[al].filter(r=>this.chkDur(r.t, tm));
                document.getElementById('sch-list').innerHTML = res.length ? res.map(r=>`<div class="card" style="margin:0; border-left:4px solid var(--lh-blue); display:flex; justify-content:space-between; align-items:center;"><div><strong>${this.db.hubs[al][0]} &rarr; ${r.c}</strong><br><small>${r.t}h</small></div><button class="btn btn-y" style="width:auto; padding:8px;" onclick="app.prep('${al}','${this.db.hubs[al][0]}','${r.c}',${r.t})">SELECT</button></div>`).join('') : "No flights";
            },

            chkDur: function(t,f) {
                if(f==='ALL') return true;
                const [min,max] = f.includes('+') ? [10,99] : f.split('-').map(Number);
                return t>=min && t<(max||99);
            },

            updHub: function() {
                const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub');
                h.innerHTML=''; h.disabled=!al;
                if(al) this.db.hubs[al].forEach(x=>h.add(new Option(x,x)));
            },

            gen: function() {
                const al=document.getElementById('gen-al').value, hub=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
                if(!al||!hub)return;
                const v=this.db.routes[al].filter(r=>this.chkDur(r.t,tm));
                if(!v.length){alert("No matching routes");return;}
                const r=v[Math.floor(Math.random()*v.length)];
                this.prep(al,hub,r.c,r.t);
            },

            getPl: function(al,t) {
                const c=t>5?'L':'S';
                let p=this.db.fleet.filter(f=>f.op.includes(al)&&f.c===c);
                if(!p.length)p=this.db.fleet.filter(f=>f.op.includes(al));
                return p.length?p[Math.floor(Math.random()*p.length)]:null;
            },

            prep: function(al,d,a,t) {
                const p=this.getPl(al,t); if(!p){alert("No plane");return;}
                this.state.temp={dep:d,arr:a,time:t,ac:p.t,num:"LH"+Math.floor(Math.random()*8999+1000),pax:Math.floor(p.s*0.8),zfw:(40+Math.random()*20).toFixed(1)+"T",gate:"A"+Math.floor(Math.random()*40),fl:"FL"+(300+Math.floor(Math.random()*10)*10)};
                
                ['dep','arr','ac','num','pax','zfw','gate','fl'].forEach(k=>document.getElementById('br-'+k).innerText=this.state.temp[k]||this.state.temp[k=='time'?'time':'']);
                document.getElementById('br-time').innerText=t+"h";
                document.getElementById('mod-brief').classList.remove('hidden');
                
                setTimeout(()=>{
                    if(this.state.map) this.state.map.remove();
                    this.state.map=L.map('map').setView([50,10],3);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(this.state.map);
                    const c1=this.coords[d]||[50,10], c2=this.coords[a]||[40,-70];
                    L.polyline([c1,c2],{color:'#05164d'}).addTo(this.state.map);
                },200);
            },

            accept: function() {
                this.state.temp.start=Date.now();
                localStorage.setItem('active', JSON.stringify(this.state.temp));
                document.getElementById('mod-brief').classList.add('hidden');
                this.checkActive(); this.tab('dash', document.querySelectorAll('.nav-btn')[0]);
            },

            checkActive: function() {
                const s=localStorage.getItem('active');
                if(!s) {
                    document.getElementById('af-card').classList.add('hidden');
                    document.getElementById('mission-card').classList.remove('hidden');
                    return;
                }
                const f=JSON.parse(s);
                document.getElementById('af-card').classList.remove('hidden');
                document.getElementById('mission-card').classList.add('hidden');
                ['dep','arr','num','ac'].forEach(k=>document.getElementById('af-'+k).innerText=f[k]);
                
                if(this.state.timer) clearInterval(this.state.timer);
                this.state.timer = setInterval(()=>{
                    const el=Date.now()-f.start, dur=f.time*10000, pct=Math.min(100,(el/dur)*100); // 1h = 10s
                    document.getElementById('af-bar').style.width=pct+"%";
                    document.getElementById('af-timer').innerText = pct>=100?"ARRIVED":"IN FLIGHT";
                    if(pct>=100) document.getElementById('btn-pirep').classList.remove('hidden');
                },1000);
            },

            finish: function() {
                const f=JSON.parse(localStorage.getItem('active'));
                this.db.stats.fl++; this.db.stats.hr+=f.time;
                localStorage.setItem('stats',JSON.stringify(this.db.stats));
                localStorage.removeItem('active'); this.checkActive(); this.render();
            },
            cancel: function(){localStorage.removeItem('active');this.checkActive();},
            genMis: function(){const s=new Date().getDate(), al="Lufthansa", r=this.db.routes[al][s%this.db.routes[al].length]; this.state.mis={al,dep:this.db.hubs[al][0],arr:r.c,t:r.t}; document.getElementById('mis-date').innerText=new Date().toLocaleDateString(); document.getElementById('mis-txt').innerText=`${this.state.mis.dep} ‚ûù ${r.c}`;},
            acceptMission: function(){this.prep(this.state.mis.al,this.state.mis.dep,this.state.mis.arr,this.state.mis.t);},
            theme: function(){document.body.classList.toggle('dark-mode'); localStorage.setItem('dark',document.body.classList.contains('dark-mode')?'1':'0');}
        };

        // === MINI GAMES (REST AREA) ===
        const game = {
            ctx: null, run: false, type: null, st: {},
            start: function(t) {
                const c=document.getElementById('cvs');
                c.width=200; c.height=400; this.ctx=c.getContext('2d');
                this.type=t; this.run=true;
                document.getElementById('game-container').classList.remove('hidden');
                if(t==='snake') { this.st={s:[{x:5,y:5}],d:{x:0,y:1},f:{x:2,y:8},sc:0}; this.loopS(); }
                if(t==='tetris') { this.st={bd:Array(20).fill().map(()=>Array(10).fill(0)),cur:this.getT(),sc:0}; this.loopT(); }
            },
            stop: function(){this.run=false; document.getElementById('game-container').classList.add('hidden');},
            loopS: function() {
                if(!this.run||this.type!=='snake')return;
                const h={x:this.st.s[0].x+this.st.d.x, y:this.st.s[0].y+this.st.d.y};
                if(h.x<0||h.x>=10||h.y<0||h.y>=20) return this.stop();
                this.st.s.unshift(h);
                if(h.x==this.st.f.x && h.y==this.st.f.y) {this.st.sc++; document.getElementById('g-score').innerText=this.st.sc; this.st.f={x:Math.floor(Math.random()*10),y:Math.floor(Math.random()*20)};}
                else this.st.s.pop();
                
                this.ctx.fillStyle='#222'; this.ctx.fillRect(0,0,200,400);
                this.ctx.fillStyle='lime'; this.st.s.forEach(p=>this.ctx.fillRect(p.x*20,p.y*20,19,19));
                this.ctx.fillStyle='red'; this.ctx.fillRect(this.st.f.x*20,this.st.f.y*20,19,19);
                setTimeout(()=>this.loopS(),200);
            },
            // Tetris minimal logic
            getT: function(){return {m:[[1,1],[1,1]],x:4,y:0};},
            loopT: function(){
                if(!this.run||this.type!=='tetris')return;
                this.st.cur.y++; 
                if(this.st.cur.y>18) { // Simple ground hit
                     this.st.cur.y=0; this.st.sc+=10; document.getElementById('g-score').innerText=this.st.sc;
                }
                this.ctx.fillStyle='#222'; this.ctx.fillRect(0,0,200,400);
                this.ctx.fillStyle='cyan'; 
                this.st.cur.m.forEach((r,dy)=>r.forEach((v,dx)=>{if(v)this.ctx.fillRect((this.st.cur.x+dx)*20,(this.st.cur.y+dy)*20,19,19)}));
                setTimeout(()=>this.loopT(),300);
            },
            input: function(k) {
                if(this.type==='snake') {
                    if(k==='l')this.st.d={x:-1,y:0}; if(k==='r')this.st.d={x:1,y:0};
                    if(k==='rot')this.st.d={x:0,y:-1}; if(k==='d')this.st.d={x:0,y:1};
                }
                if(this.type==='tetris') {
                    if(k==='l')this.st.cur.x--; if(k==='r')this.st.cur.x++;
                }
            }
        };

        app.init();
    </script>
</body>
</html>
