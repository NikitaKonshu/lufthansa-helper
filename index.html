<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Systems - Portal v66</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        /* === CONFIG & VARIABLES === */
        :root {
            --lh-blue: #05164d;
            --lh-yellow: #ffb600;
            --lh-yellow-hover: #e0a000;
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #05164d;
            --text-sub: #555555;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --radius: 8px; /* Softer corners */
            --trans: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); /* Soft transition */
        }

        /* DARK MODE */
        body.dark-mode {
            --lh-blue: #60a5fa; 
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --text-main: #f1f5f9; 
            --text-sub: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        body.dark-mode header { background: #0b1120; border-bottom: 1px solid #334155; }
        body.dark-mode .nav-bar { background: #1e293b; border-bottom: 1px solid #334155; }
        body.dark-mode .nav-btn { color: #cbd5e1; }
        body.dark-mode .nav-btn.active { color: #ffb600; }
        
        /* GLOBAL */
        * { box-sizing: border-box; transition: var(--trans); -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg-body); color: var(--text-main); min-height: 100vh; }
        .hidden { display: none !important; }

        /* === INTRO === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #05164d; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeOut 0.8s ease-in-out 2.2s forwards; pointer-events: none;
        }
        .intro-content { text-align: center; opacity: 0; animation: fadeIn 1s ease-out 0.3s forwards; }
        .intro-logo { height: 70px; filter: brightness(0) invert(1); margin-bottom: 20px; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
        @keyframes fadeOut { to{opacity:0; visibility:hidden;} }

        /* === LOGIN (FIXED LAYOUT) === */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-card); z-index: 5000; display: flex; flex-direction: column;
        }
        .login-head { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10%; }
        .login-logo { height: 26px; }
        .login-main { flex: 1; display: flex; justify-content: center; padding-top: 80px; background: var(--bg-body); }
        .login-card {
            background: var(--bg-card); width: 100%; max-width: 450px; padding: 40px;
            border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
        }
        .login-h { font-size: 1.8rem; font-weight: 300; margin-bottom: 10px; color: var(--text-main); }
        .inp-line {
            width: 100%; padding: 10px 0; border: none; border-bottom: 1px solid #999;
            background: transparent; outline: none; margin-bottom: 25px; color: var(--text-main);
            font-size: 1rem;
        }
        .inp-line:focus { border-bottom: 2px solid var(--lh-yellow); }
        .btn-log {
            width: 100%; padding: 14px; background: var(--lh-yellow); border: none; font-weight: bold;
            color: #05164d; border-radius: 4px; cursor: pointer; font-size: 1rem;
        }
        .btn-log:hover { background: var(--lh-yellow-hover); }

        /* === HEADER & NAV (FIXED) === */
        header {
            background: #05164d; height: 60px; width: 100%; position: fixed; top: 0; left: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; padding: 0 5%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-bar {
            background: var(--bg-card); height: 50px; width: 100%; position: fixed; top: 60px; left: 0; z-index: 900;
            border-bottom: 1px solid var(--border); display: flex; justify-content: center;
        }
        .nav-inner { display: flex; height: 100%; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 25px; font-weight: 500;
            color: var(--text-sub); border-bottom: 4px solid transparent; cursor: pointer; font-size: 0.95rem;
        }
        .nav-btn.active { color: #05164d; border-bottom-color: var(--lh-yellow); }
        
        /* === CONTAINER === */
        /* Padding top ensures content is visible below fixed header (60+50+20px gap) */
        .container { max-width: 1200px; margin: 130px auto 40px auto; padding: 0 20px; width: 100%; }
        
        /* === CARDS & UI === */
        .card {
            background: var(--bg-card); padding: 25px; border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 25px;
        }
        h2 { font-weight: 300; font-size: 1.6rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; color: var(--text-main); }
        
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--bg-card); border: 1px solid var(--border); padding: 25px; text-align: center; border-radius: var(--radius); }
        .stat-val { font-size: 2.5rem; font-weight: 300; color: var(--text-main); }
        .stat-lbl { font-size: 0.8rem; font-weight: bold; color: var(--text-sub); text-transform: uppercase; margin-top: 5px; }

        /* LISTS (Routes/Fleet) */
        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .item-card {
            background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: var(--radius);
            display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #05164d;
        }
        body.dark-mode .item-card { border-left-color: #60a5fa; }
        .btn-sel { background: var(--lh-yellow); color: #05164d; border: none; padding: 8px 16px; font-weight: bold; border-radius: 4px; cursor: pointer; }

        /* ACTIVE FLIGHT */
        .af-card { border-left: 6px solid var(--lh-yellow); }
        .af-route { font-size: 2.2rem; font-weight: 300; color: var(--text-main); }
        .prog-bg { height: 8px; background: var(--bg-body); border-radius: 4px; margin: 20px 0; border: 1px solid var(--border); }
        .prog-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }

        /* FILTERS */
        .filter-wrap { display: flex; gap: 20px; margin-bottom: 25px; }
        .inp-sel { padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-card); color: var(--text-main); width: 100%; }

        /* MODAL */
        .modal-bg {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6);
            z-index: 6000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--bg-card); width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto;
            padding: 30px; border-radius: var(--radius); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .data-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; background: var(--bg-body); padding: 20px; border-radius: 4px; border: 1px solid var(--border); }
        .data-lbl { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .data-val { font-size: 1.1rem; font-weight: bold; color: var(--text-main); font-family: monospace; }
        #map { height: 300px; background: #ddd; border-radius: 4px; margin-bottom: 20px; border: 1px solid var(--border); }
        
        .btn-full { width: 100%; padding: 15px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-bottom: 10px; }
        .btn-acc { background: var(--lh-yellow); color: #05164d; }
        .btn-can { background: var(--border); color: var(--text-sub); }

        @media(max-width: 800px) {
            .grid-stats { grid-template-columns: 1fr; }
            .filter-wrap { flex-direction: column; gap: 10px; }
            .data-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<script>
    const CONFIG = {
        NEWS: [
            { t: "System Update v66", d: "Stable release. Soft design & fixed stats." },
            { t: "Winter Operations", d: "De-icing mandatory at stations < 3°C." },
            { t: "Crew Notice", d: "Check your fatigue status before long haul." }
        ],
        // Expanded Fleet Info
        FLEET: [
            { id: "A320", name: "Airbus A320neo", op: "Lufthansa", seats: 180, range: 6, eng: "PW1100G", ceil: "FL390", spd: "M0.78" },
            { id: "B748", name: "Boeing 747-8", op: "Lufthansa", seats: 364, range: 14, eng: "GEnx-2B", ceil: "FL430", spd: "M0.85" },
            { id: "A359", name: "Airbus A350-900", op: "Lufthansa", seats: 293, range: 16, eng: "Trent XWB", ceil: "FL410", spd: "M0.85" },
            { id: "A220", name: "Airbus A220-300", op: "SWISS", seats: 145, range: 6, eng: "PW1500G", ceil: "FL410", spd: "M0.78" },
            { id: "B777", name: "Boeing 777-300ER", op: "SWISS", seats: 340, range: 15, eng: "GE90", ceil: "FL430", spd: "M0.84" },
            { id: "E195", name: "Embraer 195", op: "Austrian", seats: 120, range: 4, eng: "CF34", ceil: "FL410", spd: "M0.78" }
        ],
        // Paste your 1000+ routes here
        ROUTES: [
            { al: "Lufthansa", dep: "EDDF", arr: "EGLL", t: 1.5 },
            { al: "Lufthansa", dep: "EDDF", arr: "KJFK", t: 8.5 },
            { al: "Lufthansa", dep: "EDDF", arr: "KLAX", t: 11.5 },
            { al: "Lufthansa", dep: "EDDF", arr: "RJTT", t: 12.0 },
            { al: "Lufthansa", dep: "EDDF", arr: "OMDB", t: 6.2 },
            { al: "SWISS", dep: "LSZH", arr: "EGLL", t: 1.8 },
            { al: "SWISS", dep: "LSZH", arr: "WSSS", t: 12.0 },
            { al: "Austrian", dep: "LOWW", arr: "VTBS", t: 10.5 },
            { al: "SAS", dep: "EKCH", arr: "KEWR", t: 8.8 }
        ],
        // Map Coordinates
        COORDS: {
            "EDDF":[50.03,8.56], "EDDM":[48.35,11.77], "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "EKCH":[55.61,12.65],
            "EGLL":[51.47,-0.45], "KJFK":[40.64,-73.77], "KLAX":[33.94,-118.40], "RJTT":[35.54,139.77], "OMDB":[25.25,55.36],
            "WSSS":[1.36,103.99], "VTBS":[13.69,100.75], "KEWR":[40.68,-74.17]
        }
    };
</script>
<div id="intro-layer">
    <div class="intro-content">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="intro-logo">
        <div style="color:white; font-size:1.5rem; letter-spacing:2px;">Lufthansa Systems</div>
        <div style="color:#aaa; font-size:0.9rem; letter-spacing:4px; margin-top:5px;">CREW PORTAL</div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-head">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="login-logo">
    </div>
    <div class="login-main">
        <div class="login-card">
            <div class="login-h">Login</div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:30px;">Please enter your servicecard number or Travel ID.</p>
            <input type="text" id="user" class="inp-line" placeholder="Travel ID / Servicecard number">
            <input type="password" id="pass" class="inp-line" placeholder="Password">
            <button class="btn-log" onclick="doLogin()">Next</button>
            <div style="margin-top:20px; font-size:0.85rem; color:#666;">
                <span style="cursor:pointer; text-decoration:underline;">Forgot your PIN?</span>
            </div>
            <div id="login-msg" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
        </div>
    </div>
</div>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" style="height:22px; filter:brightness(0) invert(1);">
    <div style="display:flex; gap:20px; align-items:center;">
        <span id="clock" style="font-family:'Roboto Mono'; opacity:0.8;">00:00 Z</span>
        <span style="font-weight:bold;">Capt. Hans</span>
        <span onclick="toggleTheme()" style="cursor:pointer; font-size:1.2rem;">◑</span>
    </div>
</header>

<div class="nav-bar hidden" id="nav">
    <div class="nav-inner">
        <button class="nav-btn active" onclick="showTab('dash', this)">Dashboard</button>
        <button class="nav-btn" onclick="showTab('routes', this)">Schedule</button>
        <button class="nav-btn" onclick="showTab('fleet', this)">Fleet</button>
        <button class="nav-btn" onclick="showTab('dispatch', this)">Dispatch</button>
    </div>
</div>

<div class="container hidden" id="app">

    <div id="tab-dash">
        <h2>Captain's Logbook</h2>
        
        <div class="grid-stats">
            <div class="stat-box">
                <div class="stat-val" id="st-legs">0</div>
                <div class="stat-lbl">Legs Flown</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="st-hours">0</div>
                <div class="stat-lbl">Total Hours</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="st-rank" style="color:var(--lh-yellow)">-</div>
                <div class="stat-lbl">Rank</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px;">
            <div>
                <div id="af-box" class="card af-card hidden">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <div>
                            <div class="stat-lbl" style="margin-bottom:5px;">ACTIVE SECTOR</div>
                            <div class="af-route"><span id="af-dep"></span> → <span id="af-arr"></span></div>
                            <div style="font-size:1.1rem; font-weight:bold; margin-top:5px; color:var(--text-sub);"><span id="af-num"></span> • <span id="af-ac"></span></div>
                        </div>
                        <div style="text-align:right;">
                            <div class="af-route" id="af-timer" style="font-size:2rem;">00:00</div>
                            <div class="stat-lbl">REMAINING</div>
                        </div>
                    </div>
                    <div class="prog-bg"><div id="af-bar" class="prog-fill"></div></div>
                    <button id="btn-finish" class="btn-sel hidden" onclick="finishFlight()" style="float:right;">FILE PIREP</button>
                </div>

                <div id="mis-box" class="card" style="border-left: 6px solid #05164d;">
                    <h3>Daily Assignment</h3>
                    <div style="font-size:1.5rem; margin-bottom:15px;" id="mis-txt">Loading...</div>
                    <button class="btn-sel" onclick="acceptMission()">PREPARE FLIGHT</button>
                </div>
            </div>

            <div class="card">
                <h3>Operations Center</h3>
                <div id="news-list"></div>
            </div>
        </div>
    </div>

    <div id="tab-routes" class="hidden">
        <h2>Flight Schedule</h2>
        <div class="filter-wrap">
            <div style="flex:1;">
                <div class="stat-lbl" style="margin-bottom:5px;">Airline</div>
                <select id="flt-al" class="inp-sel" onchange="renderRoutes()"><option value="ALL">All Airlines</option></select>
            </div>
            <div style="flex:1;">
                <div class="stat-lbl" style="margin-bottom:5px;">Duration</div>
                <select id="flt-tm" class="inp-sel" onchange="renderRoutes()">
                    <option value="ALL">All Durations</option>
                    <option value="1-2">1 - 2 Hours</option>
                    <option value="3-4">3 - 4 Hours</option>
                    <option value="5-6">5 - 6 Hours</option>
                    <option value="7-8">7 - 8 Hours</option>
                    <option value="9-10">9 - 10 Hours</option>
                    <option value="10+">10+ Hours</option>
                </select>
            </div>
        </div>
        <div id="route-grid" class="grid-list"></div>
    </div>

    <div id="tab-fleet" class="hidden">
        <h2>Fleet Overview</h2>
        <div class="filter-wrap">
            <div style="flex:1;">
                <div class="stat-lbl" style="margin-bottom:5px;">Operator</div>
                <select id="flt-op" class="inp-sel" onchange="renderFleet()"><option value="ALL">All Operators</option></select>
            </div>
        </div>
        <div id="fleet-grid" class="grid-list"></div>
    </div>

    <div id="tab-dispatch" class="hidden">
        <div class="card" style="max-width:600px; margin:0 auto;">
            <h2>Dispatcher</h2>
            <div style="margin-bottom:20px;">
                <div class="stat-lbl" style="margin-bottom:5px;">Airline</div>
                <select id="gen-al" class="inp-sel" onchange="updHubs()"></select>
            </div>
            <div style="margin-bottom:20px;">
                <div class="stat-lbl" style="margin-bottom:5px;">Hub</div>
                <select id="gen-hub" class="inp-sel" disabled></select>
            </div>
            <div style="margin-bottom:30px;">
                <div class="stat-lbl" style="margin-bottom:5px;">Duration</div>
                <select id="gen-tm" class="inp-sel">
                    <option value="ALL">Random</option>
                    <option value="1-2">Short</option>
                    <option value="10+">Long</option>
                </select>
            </div>
            <button class="btn-full btn-acc" onclick="generate()">GENERATE OFP</button>
        </div>
    </div>
</div>

<div id="modal" class="modal-bg hidden">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--text-main); margin-bottom:20px;">
            <h3>OFP GENERATION</h3>
            <h3 id="br-num">LH000</h3>
        </div>
        
        <div class="data-grid">
            <div><div class="data-lbl">DEPARTURE</div><div class="data-val" id="br-dep"></div></div>
            <div><div class="data-lbl">ARRIVAL</div><div class="data-val" id="br-arr"></div></div>
            <div><div class="data-lbl">AIRCRAFT</div><div class="data-val" id="br-ac"></div></div>
            <div><div class="data-lbl">GATE</div><div class="data-val" id="br-gate"></div></div>
            <div><div class="data-lbl">ETE</div><div class="data-val" id="br-time"></div></div>
            <div><div class="data-lbl">ZFW</div><div class="data-val" id="br-zfw"></div></div>
            <div><div class="data-lbl">PAX</div><div class="data-val" id="br-pax"></div></div>
            <div><div class="data-lbl">FL</div><div class="data-val" id="br-fl"></div></div>
        </div>

        <div id="map"></div>
        <div style="font-size:0.8rem; margin-bottom:20px;">METAR: VMC / >10KM</div>
        
        <button class="btn-full btn-acc" onclick="confirmFlight()">ACCEPT FLIGHT</button>
        <button class="btn-full btn-can" onclick="closeModal()">CANCEL</button>
    </div>
</div>

<script>
    // === STATE ===
    let stats = JSON.parse(localStorage.getItem('stats')) || { l:0, h:0 };
    // Fix broken stats
    if(isNaN(stats.l)) stats.l = 0; if(isNaN(stats.h)) stats.h = 0;

    let active = null;
    let temp = null;
    let mapObj = null;
    let timer = null;
    let mission = null;

    // === INIT ===
    window.onload = function() {
        if(localStorage.getItem('dark')=='1') document.body.classList.add('dark-mode');
        setInterval(()=>{const d=new Date(); document.getElementById('clock').innerText = d.getUTCHours().toString().padStart(2,'0')+':'+d.getUTCMinutes().toString().padStart(2,'0')+' Z';}, 1000);
        
        // Populate Dropdowns
        const al = [...new Set(CONFIG.ROUTES.map(r=>r.al))];
        const s1=document.getElementById('flt-al'), s2=document.getElementById('flt-op'), s3=document.getElementById('gen-al');
        al.forEach(a=>{ s1.add(new Option(a,a)); s2.add(new Option(a,a)); s3.add(new Option(a,a)); });

        // News
        document.getElementById('news-list').innerHTML = CONFIG.NEWS.map(n=>`<div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;"><b>${n.t}</b><br><span style="color:var(--text-sub); font-size:0.9rem;">${n.d}</span></div>`).join('');

        updStats();
        renderRoutes();
        renderFleet();
        dailyMis();
        chkActive();
    };

    function updStats() {
        document.getElementById('st-legs').innerText = stats.l;
        document.getElementById('st-hours').innerText = Math.floor(stats.h);
        document.getElementById('st-rank').innerText = stats.l>20?"Captain":(stats.l>5?"First Officer":"Second Officer");
    }

    // === LOGIN ===
    function doLogin() {
        const u = document.getElementById('user').value.toUpperCase();
        const p = document.getElementById('pass').value;
        if(u==="DLH001" && p==="1234") {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('nav').classList.remove('hidden');
            document.getElementById('app').classList.remove('hidden');
        } else { document.getElementById('login-msg').innerText="Invalid credentials"; }
    }

    function showTab(id, btn) {
        ['dash','routes','fleet','dispatch'].forEach(t=>document.getElementById('tab-'+t).classList.add('hidden'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        if(id=='routes') renderRoutes();
    }

    // === RENDERING ===
    function chkTime(t, f) {
        if(f=="ALL") return true;
        const [min, max] = f.includes('+') ? [10, 100] : f.split('-').map(Number);
        return t >= min && t < max;
    }

    function renderRoutes() {
        const al = document.getElementById('flt-al').value;
        const tm = document.getElementById('flt-tm').value;
        const list = document.getElementById('route-grid');
        list.innerHTML = "";

        const r = CONFIG.ROUTES.filter(x => (al=="ALL"||x.al==al) && chkTime(x.t, tm));
        if(!r.length) { list.innerHTML="<div class='card'>No flights found</div>"; return; }

        r.forEach(x => {
            list.innerHTML += `
            <div class="item-card">
                <div>
                    <div style="font-size:1.2rem; font-weight:bold;">${x.dep} → ${x.arr}</div>
                    <div style="color:var(--text-sub); margin-top:5px;">${x.t}h • ${x.al}</div>
                </div>
                <button class="btn-sel" onclick="prep('${x.al}','${x.dep}','${x.arr}',${x.t})">SELECT</button>
            </div>`;
        });
    }

    function renderFleet() {
        const op = document.getElementById('flt-op').value;
        const list = document.getElementById('fleet-grid');
        list.innerHTML = "";
        
        CONFIG.FLEET.filter(f => op=="ALL"||f.op==op).forEach(f => {
            list.innerHTML += `
            <div class="item-card" style="display:block; border-left:none;">
                <div style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">${f.name}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:0.9rem; color:var(--text-sub);">
                    <span>Seats: <b>${f.seats}</b></span>
                    <span>Range: <b>${f.range}h</b></span>
                    <span>Ceil: <b>${f.ceil}</b></span>
                    <span>Mach: <b>${f.spd}</b></span>
                    <span style="grid-column:span 2">Eng: ${f.eng}</span>
                </div>
            </div>`;
        });
    }

    // === FLIGHT LOGIC ===
    function getAc(al, t) {
        let p = CONFIG.FLEET.filter(f => f.op == al && (t>6 ? f.range>10 : f.range<10));
        return p.length ? p[Math.floor(Math.random()*p.length)] : CONFIG.FLEET[0];
    }

    function prep(al, d, a, t) {
        const p = getAc(al, t);
        temp = {
            dep:d, arr:a, time:t, ac:p.name,
            num: al.substring(0,2).toUpperCase()+Math.floor(Math.random()*8999+1000),
            gate: "A"+Math.floor(Math.random()*50),
            pax: Math.floor(p.seats*0.85),
            zfw: (p.range>10?160:45)+"T",
            fl: p.ceil
        };
        ['dep','arr','ac','gate','time','zfw','pax','fl','num'].forEach(k=>document.getElementById('br-'+k).innerText=temp[k]);
        document.getElementById('modal').classList.remove('hidden');
        
        setTimeout(()=>{
            if(mapObj) mapObj.remove();
            mapObj = L.map('map').setView([50,10], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapObj);
            const c1 = CONFIG.COORDS[d]||[50,10];
            const c2 = CONFIG.COORDS[a]||[40,-70];
            L.polyline([c1,c2], {color:'#05164d', weight:3}).addTo(mapObj);
            mapObj.fitBounds([c1,c2], {padding:[30,30]});
        }, 100);
    }

    function confirmFlight() {
        temp.start = Date.now();
        localStorage.setItem('active', JSON.stringify(temp));
        closeModal();
        chkActive();
        showTab('dash', document.querySelector('.nav-btn'));
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    function chkActive() {
        const s = localStorage.getItem('active');
        if(!s) {
            document.getElementById('af-box').classList.add('hidden');
            document.getElementById('mis-box').classList.remove('hidden');
            return;
        }
        active = JSON.parse(s);
        document.getElementById('af-box').classList.remove('hidden');
        document.getElementById('mis-box').classList.add('hidden');
        ['dep','arr','num','ac'].forEach(k=>document.getElementById('af-'+k).innerText=active[k]);

        if(timer) clearInterval(timer);
        timer = setInterval(()=>{
            const el = Date.now() - active.start;
            const dur = active.time * 10000; // 1h = 10s
            const pct = Math.min(100, (el/dur)*100);
            document.getElementById('af-bar').style.width = pct+"%";
            if(pct>=100) {
                document.getElementById('af-timer').innerText = "ARRIVED";
                document.getElementById('btn-finish').classList.remove('hidden');
            } else {
                document.getElementById('af-timer').innerText = "IN FLIGHT";
            }
        }, 1000);
    }

    function finishFlight() {
        stats.l++; stats.h += active.time;
        localStorage.setItem('stats', JSON.stringify(stats));
        localStorage.removeItem('active');
        chkActive(); updStats();
    }

    // === GENERATOR ===
    function updHubs() {
        const al = document.getElementById('gen-al').value;
        const h = document.getElementById('gen-hub'); h.innerHTML=""; h.disabled=false;
        [...new Set(CONFIG.ROUTES.filter(r=>r.al==al).map(r=>r.dep))].forEach(x=>h.add(new Option(x,x)));
    }

    function generate() {
        const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
        const r = CONFIG.ROUTES.filter(x=>x.al==al && x.dep==h && chkTime(x.t, tm));
        if(!r.length) { alert("No routes"); return; }
        const s = r[Math.floor(Math.random()*r.length)];
        prep(s.al, s.dep, s.arr, s.t);
    }

    function dailyMis() {
        const d = new Date().getDate();
        mission = CONFIG.ROUTES[d % CONFIG.ROUTES.length];
        document.getElementById('mis-txt').innerText = mission.dep + " → " + mission.arr;
    }
    function acceptMission() { prep(mission.al, mission.dep, mission.arr, mission.t); }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('dark', document.body.classList.contains('dark-mode')?'1':'0');
    }
</script>
</body>
</html>
