<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Systems - Crew Portal v62</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* === VARIABLES === */
        :root {
            --lh-navy: #05164d;
            --lh-yellow: #ffb600;
            --lh-yellow-hov: #e0a000;
            --lh-bg: #f2f4f7;
            --lh-card: #ffffff;
            --lh-text: #05164d;
            --lh-border: #cccccc;
            --radius: 4px;
        }
        
        body.dark-mode {
            --lh-bg: #0f172a; --lh-card: #1e293b; --lh-text: #f1f5f9; 
            --lh-border: #334155; --lh-navy: #020b26;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--lh-bg); color: var(--lh-text); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* === INTRO === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--lh-navy); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: introFadeOut 0.8s ease-in-out 2s forwards;
            pointer-events: none;
        }
        .intro-content { text-align: center; color: white; animation: introFadeIn 1s ease-in-out 0.2s backwards; }
        .intro-logo { height: 60px; filter: brightness(0) invert(1); margin-bottom: 20px; }
        @keyframes introFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes introFadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        /* === HEADER === */
        header {
            background: var(--lh-navy); height: 60px; width: 100%;
            display: flex; justify-content: space-between; align-items: center; padding: 0 5%;
            position: fixed; top: 0; z-index: 2000;
        }
        .logo { height: 24px; filter: brightness(0) invert(1); }
        .user-panel { color: white; font-size: 0.9rem; display: flex; gap: 20px; align-items: center; }

        /* === NAV === */
        .nav-wrap {
            background: var(--lh-card); width: 100%; height: 50px;
            position: fixed; top: 60px; z-index: 1900;
            border-bottom: 1px solid #e6e6e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-inner { max-width: 1400px; margin: 0 auto; height: 100%; display: flex; align-items: center; padding: 0 20px; overflow-x: auto; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 25px;
            font-size: 0.95rem; font-weight: bold; color: var(--lh-navy); cursor: pointer;
            border-bottom: 4px solid transparent; transition: 0.2s; white-space: nowrap;
        }
        .nav-btn:hover { color: var(--lh-yellow-hov); }
        .nav-btn.active { border-bottom-color: var(--lh-yellow); }
        body.dark-mode .nav-btn { color: #ccc; } body.dark-mode .nav-btn.active { color: white; border-bottom-color: var(--lh-yellow); }

        /* === MAIN LAYOUT === */
        .container { max-width: 1400px; margin: 140px auto 40px auto; padding: 0 25px; flex: 1; width: 100%; }
        
        /* Grid Systems */
        .dash-grid { display: grid; grid-template-columns: 7fr 3fr; gap: 30px; }
        
        /* Responsive Grid for Lists - Aligns items properly */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        /* Card Styles */
        .card {
            background: var(--lh-card); border-radius: var(--radius); padding: 25px;
            border: 1px solid #dcdcdc; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 100%; display: flex; flex-direction: column; justify-content: space-between;
        }
        body.dark-mode .card { border-color: var(--lh-border); }
        
        h2 { font-weight: 300; font-size: 1.8rem; margin-bottom: 25px; color: var(--lh-navy); }
        body.dark-mode h2 { color: white; }
        
        /* === UI ELEMENTS === */
        .label { display: block; font-size: 0.85rem; font-weight: bold; color: var(--lh-text); margin-bottom: 8px; }
        .inp {
            width: 100%; padding: 12px; border: 1px solid #898989; border-radius: 4px;
            font-size: 1rem; margin-bottom: 20px; background: white; color: black;
        }
        .btn {
            width: 100%; padding: 14px 20px; border: none; border-radius: 4px;
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--lh-navy); color: white; text-align: center;
        }
        .btn-y { background: var(--lh-yellow); color: var(--lh-navy); }
        .btn-y:hover { background: var(--lh-yellow-hov); }
        .btn-red { background: #d50000; color: white; }

        /* === MODAL (BRIEFING) - CENTERED === */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(5, 22, 77, 0.85); z-index: 3000;
            display: flex; justify-content: center; align-items: center; /* Center Content */
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        .modal-box {
            background: var(--lh-card); width: 100%; max-width: 800px; max-height: 90vh;
            border-radius: var(--radius); overflow-y: auto; padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .brief-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--lh-navy); padding-bottom: 15px; margin-bottom: 20px; }
        .brief-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            background: var(--lh-bg); padding: 20px; border-radius: 4px; margin-bottom: 20px;
        }
        .brief-item label { display: block; font-size: 0.7rem; color: #666; font-weight: bold; }
        .brief-item span { font-family: 'Roboto Mono'; font-weight: bold; font-size: 1.1rem; color: var(--lh-navy); }
        #map { height: 300px; background: #eee; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ccc; }

        /* === LOGIN === */
        #login-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; background: white; display: flex; flex-direction: column; }
        .login-header { height: 80px; padding: 0 5%; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .login-body { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding-top: 80px; background: #f9f9f9; }
        .login-card { background: white; padding: 45px; width: 100%; max-width: 500px; border: 1px solid #e0e0e0; border-radius: 4px; }
        .forgot-link { color: #666; cursor: pointer; text-decoration: underline; margin-top: 15px; display: block; font-size: 0.9rem; }

        /* === ACTIVE FLIGHT === */
        .af-card { border-left: 7px solid var(--lh-yellow); }
        .af-route { font-size: 2.2rem; font-weight: 300; color: var(--lh-navy); }
        .bar-bg { height: 8px; background: #e6e6e6; margin: 20px 0; border-radius: 4px; }
        .bar-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .dash-grid { grid-template-columns: 1fr; }
            .brief-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="intro-layer">
        <div class="intro-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="intro-logo">
            <div style="font-size: 1.5rem; letter-spacing: 2px;">Lufthansa Systems</div>
            <div style="font-size: 0.9rem; letter-spacing: 3px; opacity: 0.8; margin-top: 5px;">CREW PORTAL</div>
        </div>
    </div>

    <div id="login-wrap">
        <div class="login-header"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Lufthansa_Logo_2018.svg/1200px-Lufthansa_Logo_2018.svg.png" style="height:30px;"></div>
        <div class="login-body">
            <div class="login-card">
                <h2 style="margin:0 0 10px 0; border:none;">Login</h2>
                <div style="font-size:0.95rem; margin-bottom:30px; color:#333;">Enter your Travel ID to access the system.</div>
                <input type="text" id="callsign" class="inp" style="border:none; border-bottom:1px solid #333; background:transparent;" placeholder="Travel ID / Callsign">
                <input type="password" id="password" class="inp" style="border:none; border-bottom:1px solid #333; background:transparent;" placeholder="Password">
                <button class="btn btn-y" onclick="doLogin()">Next</button>
                <p id="login-err" style="color:#d50000; font-weight:bold; margin-top:15px;"></p>
                <span class="forgot-link" onclick="alert('Contact administrator for reset.')">Forgot your PIN or password?</span>
            </div>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo">
        <div class="user-panel">
            <span id="clock" style="font-family:'Roboto Mono'; opacity:0.8;">00:00 Z</span>
            <span style="font-weight:bold;">Capt. Hans</span>
            <span onclick="toggleTheme()" style="cursor:pointer; font-size:1.3rem;">◑</span>
        </div>
    </header>

    <div class="nav-wrap hidden" id="nav-bar">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="tab('dash', this)">Dashboard</button>
            <button class="nav-btn" onclick="tab('fleet', this)">Fleet</button>
            <button class="nav-btn" onclick="tab('routes', this)">Schedule</button>
            <button class="nav-btn" onclick="tab('dispatch', this)">Dispatch</button>
        </div>
    </div>

    <div class="container hidden" id="main-app">
        
        <div id="tab-dash" class="tab-content">
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-bottom:30px;">
                <div class="card" style="padding:20px; text-align:center; display:block;">
                    <div style="font-size:2.5rem; color:var(--lh-navy); font-weight:300;" id="st-fl">0</div>
                    <div style="font-size:0.8rem; font-weight:bold; color:#666; margin-top:5px;">LEGS FLOWN</div>
                </div>
                <div class="card" style="padding:20px; text-align:center; display:block;">
                    <div style="font-size:2.5rem; color:var(--lh-navy); font-weight:300;" id="st-hr">0</div>
                    <div style="font-size:0.8rem; font-weight:bold; color:#666; margin-top:5px;">HOURS</div>
                </div>
                <div class="card" style="padding:20px; text-align:center; display:block;">
                    <div style="font-size:2.5rem; color:var(--lh-yellow); font-weight:300;" id="st-rk">-</div>
                    <div style="font-size:0.8rem; font-weight:bold; color:#666; margin-top:5px;">RANK</div>
                </div>
            </div>

            <div class="dash-grid">
                <div>
                    <div id="af-card" class="card af-card hidden">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div>
                                <div style="font-size:0.8rem; font-weight:bold; color:#999; letter-spacing:1px; margin-bottom:5px;">ACTIVE SECTOR</div>
                                <div class="af-route"><span id="af-dep"></span> &#8594; <span id="af-arr"></span></div>
                                <div style="font-family:'Roboto Mono'; font-weight:bold; margin-top:5px;"><span id="af-num"></span> &bull; <span id="af-ac"></span></div>
                            </div>
                            <div style="text-align:right;">
                                <div id="af-timer" style="font-size:2rem; font-weight:300; color:var(--lh-navy);">00:00</div>
                                <div style="font-size:0.75rem; color:#999; font-weight:bold;">REMAINING</div>
                            </div>
                        </div>
                        <div class="bar-bg"><div id="af-bar" class="bar-fill"></div></div>
                        <div style="display:flex; gap:15px;">
                            <button class="btn btn-y hidden" id="btn-pirep" onclick="finishFlight()">FILE PIREP</button>
                            <button class="btn btn-red" onclick="cancelFlight()">CANCEL</button>
                        </div>
                    </div>

                    <div id="mission-box" class="card" style="background:#05164d; color:white; display:block;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <span style="background:#ffb600; color:#05164d; padding:4px 8px; border-radius:2px; font-weight:bold; font-size:0.8rem;">DAILY ASSIGNMENT</span>
                            <span id="mis-date" style="opacity:0.8; font-size:0.9rem;"></span>
                        </div>
                        <div id="mis-txt" style="font-size:1.8rem; font-weight:300; margin-bottom:30px;">Loading...</div>
                        <button class="btn" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);" onclick="acceptMission()">PREPARE FLIGHT</button>
                    </div>
                </div>

                <div class="card" style="display:block;">
                    <h3 style="margin:0 0 20px 0; color:var(--lh-navy);">Notices</h3>
                    <div id="news-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-content hidden">
            <div class="card">
                <h2>Fleet</h2>
                <div style="margin-bottom:20px; max-width:300px;"><span class="label">Filter</span><select id="fl-filter" class="inp" onchange="renderFleet()"><option value="ALL">All</option></select></div>
                <div id="fleet-list" class="responsive-grid"></div>
            </div>
        </div>

        <div id="tab-routes" class="tab-content hidden">
            <div class="card">
                <h2>Schedule</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div><span class="label">Airline</span><select id="sch-al" class="inp" onchange="renderSchedule()"></select></div>
                    <div><span class="label">Time</span><select id="sch-tm" class="inp" onchange="renderSchedule()">
                        <option value="ALL">All</option><option value="1-2">1-2h</option><option value="3-4">3-4h</option><option value="5-6">5-6h</option><option value="10+">10h+</option>
                    </select></div>
                </div>
                <div id="sch-list" class="responsive-grid"></div>
            </div>
        </div>

        <div id="tab-dispatch" class="tab-content hidden">
            <div class="card" style="max-width:600px; margin:0 auto; display:block;">
                <h2>Dispatch</h2>
                <span class="label">Airline</span><select id="gen-al" class="inp" onchange="updateHubs()"></select>
                <span class="label">Hub</span><select id="gen-hub" class="inp" disabled></select>
                <span class="label">Duration</span><select id="gen-tm" class="inp">
                    <option value="ALL">Random</option><option value="1-2">1-2h</option><option value="3-4">3-4h</option><option value="10+">10h+</option>
                </select>
                <button class="btn btn-y" onclick="generate()">GENERATE OFP</button>
            </div>
        </div>

    </div>

    <div id="modal-brief" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="brief-header">
                <h3 style="margin:0; color:var(--lh-navy);">OFP BRIEFING</h3>
                <span id="br-num" style="font-weight:bold; font-size:1.2rem; color:var(--lh-navy);">LH000</span>
            </div>
            
            <div class="brief-grid">
                <div class="brief-item"><label>DEP</label><span id="br-dep"></span></div>
                <div class="brief-item"><label>ARR</label><span id="br-arr"></span></div>
                <div class="brief-item"><label>AC</label><span id="br-ac"></span></div>
                <div class="brief-item"><label>GATE</label><span id="br-gate"></span></div>
                <div class="brief-item"><label>ETE</label><span id="br-time"></span></div>
                <div class="brief-item"><label>PAX</label><span id="br-pax"></span></div>
                <div class="brief-item"><label>ZFW</label><span id="br-zfw"></span></div>
                <div class="brief-item"><label>FL</label><span id="br-fl"></span></div>
            </div>
            
            <div id="map"></div>
            
            <div style="display:flex; gap:15px; justify-content: flex-end;">
                <button class="btn" style="background:#e2e8f0; color:#333; width:auto;" onclick="document.getElementById('modal-brief').classList.add('hidden')">DECLINE</button>
                <button class="btn btn-y" style="width:auto;" onclick="acceptBriefing()">ACCEPT & FLY</button>
            </div>
        </div>
    </div>

    <script>
        // DATA
        const DB = {
            login: {u:"DLH001", p:"1234"},
            news: [{t:"System Status: Nominal", d:"Systems online."},{t:"Winter Ops", d:"De-icing required < 3°C."}],
            fleet: [
                {t:"Airbus A320neo", c:"S", s:180, r:6, op:["Lufthansa","Eurowings","Austrian","SAS"]},
                {t:"Boeing 747-8", c:"L", s:364, r:14, op:["Lufthansa"]},
                {t:"Airbus A350-900", c:"L", s:293, r:16, op:["Lufthansa","SAS"]},
                {t:"Airbus A220", c:"S", s:145, r:6, op:["SWISS"]}
            ],
            hubs: {"Lufthansa":["EDDF","EDDM"],"SWISS":["LSZH"],"Austrian":["LOWW"],"Eurowings":["EDDL"],"SAS":["EKCH"]},
            routes: {
                "Lufthansa": [{c:"EGLL",t:1.5},{c:"CDG",t:1.2},{c:"MAD",t:2.5},{c:"JFK",t:8.5},{c:"LAX",t:11.5},{c:"DXB",t:6.2},{c:"HND",t:12.5}],
                "SWISS": [{c:"LHR",t:1.8},{c:"JFK",t:8.5},{c:"SIN",t:12.0}],
                "Austrian": [{c:"LHR",t:2.2},{c:"BKK",t:10.5}],
                "Eurowings": [{c:"PMI",t:2.2},{c:"LHR",t:1.4}],
                "SAS": [{c:"LHR",t:1.9},{c:"EWR",t:8.8}]
            }
        };
        const COORDS = {"EDDF":[50,8],"EDDM":[48,11],"LSZH":[47,8],"LOWW":[48,16],"EGLL":[51,0],"JFK":[40,-73],"LAX":[34,-118],"HND":[35,139],"SIN":[1,103]};

        let stats=JSON.parse(localStorage.getItem('stats'))||{fl:0,hr:0}, tempF=null, map=null, misF=null, tmr=null;

        window.onload=()=>{
            if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark-mode');
            setInterval(()=>{const d=new Date();document.getElementById('clock').innerText=`${String(d.getUTCHours()).padStart(2,0)}:${String(d.getUTCMinutes()).padStart(2,0)} Z`},1000);
            render(); check(); genMis();
        };

        function doLogin(){
            if(document.getElementById('callsign').value.toUpperCase()===DB.login.u && document.getElementById('password').value===DB.login.p){
                document.getElementById('login-wrap').style.opacity=0;
                setTimeout(()=>{document.getElementById('login-wrap').classList.add('hidden'); document.getElementById('nav-bar').classList.remove('hidden'); document.getElementById('main-app').classList.remove('hidden');},500);
            } else document.getElementById('login-err').innerText="Invalid credentials.";
        }
        function tab(n,b){
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden')); document.getElementById('tab-'+n).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); if(b)b.classList.add('active');
        }

        // --- CORE ---
        function getPl(al,t){const c=t>5?'L':'S'; let p=DB.fleet.filter(f=>f.op.includes(al)&&f.c===c); if(!p.length)p=DB.fleet.filter(f=>f.op.includes(al)); return p.length?p[Math.floor(Math.random()*p.length)]:null;}
        function chkDur(t,f){if(f==='ALL')return true; if(f==='1-2')return t>=1&&t<3; if(f==='3-4')return t>=3&&t<5; if(f==='5-6')return t>=5&&t<7; if(f==='10+')return t>=10; return false;}
        
        function render(){
            document.getElementById('st-fl').innerText=stats.fl; document.getElementById('st-hr').innerText=Math.floor(stats.hr);
            document.getElementById('st-rk').innerText=stats.fl>20?"CPT":(stats.fl>5?"FO":"SO");
            const sA=document.getElementById('sch-al'), sD=document.getElementById('gen-al'), fF=document.getElementById('fl-filter');
            sA.innerHTML=''; sD.innerHTML='<option value="">-- Airline --</option>'; fF.innerHTML='<option value="ALL">All</option>';
            Object.keys(DB.hubs).forEach(k=>{sA.add(new Option(k,k)); sD.add(new Option(k,k)); fF.add(new Option(k,k));});
            document.getElementById('news-list').innerHTML=DB.news.map(n=>`<div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;"><strong>${n.t}</strong><div style="color:#666; font-size:0.9rem;">${n.d}</div></div>`).join('');
            renderFleet(); renderSch();
        }

        // FIXED LIST RENDERING (Stretches properly)
        function renderFleet(){
            const v=document.getElementById('fl-filter').value, c=document.getElementById('fleet-list'); c.innerHTML='';
            DB.fleet.filter(f=>v==='ALL'||f.op.includes(v)).forEach(f=>c.innerHTML+=`<div class="card" style="margin:0; justify-content:center;"><h3>${f.t}</h3><div style="color:#666; margin-top:5px;">${f.s} Pax | ${f.r}h Range</div></div>`);
        }
        function renderSch(){
            const al=document.getElementById('sch-al').value, tf=document.getElementById('sch-tm').value, g=document.getElementById('sch-list');
            if(!DB.routes[al]){g.innerHTML="<div class='card'>Select Airline</div>";return;}
            const r=DB.routes[al].filter(x=>chkDur(x.t,tf));
            g.innerHTML=r.length?r.map(x=>`<div class="card" style="margin:0; border-left:4px solid var(--lh-navy);"><div><strong>${DB.hubs[al][0]} &#8594; ${x.c}</strong><div style="color:#666;">${x.t}h</div></div><button class="btn btn-y" style="margin-top:15px;" onclick="prep('${al}','${DB.hubs[al][0]}','${x.c}',${x.t})">SELECT</button></div>`).join(''):"None";
        }

        // PREP & BRIEFING
        function prep(al,d,a,t){
            const p=getPl(al,t); if(!p){alert("No aircraft");return;}
            tempF={dep:d,arr:a,time:t,ac:p.t,num:"LH"+Math.floor(Math.random()*8999+1000),pax:Math.floor(p.s*0.8),zfw:"45.0T",gate:"A"+Math.floor(Math.random()*40),fl:"FL340"};
            ['dep','arr','ac','num','pax','zfw','gate','fl'].forEach(k=>document.getElementById('br-'+k).innerText=tempF[k]);
            document.getElementById('br-time').innerText=t+"h";
            document.getElementById('modal-brief').classList.remove('hidden');
            setTimeout(()=>{
                if(map)map.remove(); map=L.map('map').setView([50,10],3);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
                const c1=COORDS[d]||[50,10], c2=COORDS[a]||[40,-70]; L.polyline([c1,c2],{color:'#05164d'}).addTo(map);
            },200);
        }

        function generate(){
            const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
            if(!al||!h)return; const r=DB.routes[al].filter(x=>chkDur(x.t,tm)); if(!r.length){alert("No routes");return;}
            const s=r[Math.floor(Math.random()*r.length)]; prep(al,h,s.c,s.t);
        }
        function updateHubs(){const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub'); h.innerHTML=''; if(al){h.disabled=false; DB.hubs[al].forEach(x=>h.add(new Option(x,x)));}else h.disabled=true;}

        function acceptBriefing(){
            tempF.start=Date.now(); localStorage.setItem('active',JSON.stringify(tempF));
            document.getElementById('modal-brief').classList.add('hidden'); check(); tab('dash');
        }

        function check(){
            const s=localStorage.getItem('active');
            if(!s){document.getElementById('af-card').classList.add('hidden'); document.getElementById('mission-box').classList.remove('hidden'); return;}
            document.getElementById('af-card').classList.remove('hidden'); document.getElementById('mission-box').classList.add('hidden');
            const f=JSON.parse(s); ['dep','arr','num','ac'].forEach(k=>document.getElementById('af-'+k).innerText=f[k]);
            if(tmr)clearInterval(tmr);
            tmr=setInterval(()=>{
                const el=Date.now()-f.start, dur=f.time*10000, pct=Math.min(100,(el/dur)*100);
                document.getElementById('af-bar').style.width=pct+"%"; document.getElementById('af-timer').innerText=pct>=100?"ARRIVED":"IN FLIGHT";
                if(pct>=100)document.getElementById('btn-pirep').classList.remove('hidden');
            },1000);
        }
        function finishFlight(){const f=JSON.parse(localStorage.getItem('active')); stats.fl++; stats.hr+=f.time; localStorage.setItem('stats',JSON.stringify(stats)); localStorage.removeItem('active'); check(); render();}
        function cancelFlight(){localStorage.removeItem('active'); check();}
        
        // RANDOM DAILY MISSION logic (Uses date but picks from array)
        function genMis(){
            const d = new Date().getDate(); 
            const al="Lufthansa"; 
            // Ensures valid route even if date > routes.length
            const r=DB.routes[al][d % DB.routes[al].length]; 
            misF={al,dep:DB.hubs[al][0],arr:r.c,t:r.t};
            document.getElementById('mis-date').innerText=new Date().toLocaleDateString(); 
            document.getElementById('mis-txt').innerText=`${misF.dep} -> ${r.c}`;
        }
        function acceptMission(){prep(misF.al,misF.dep,misF.arr,misF.t);}
        function toggleTheme(){document.body.classList.toggle('dark-mode'); localStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light');}
    </script>
</body>
</html>
