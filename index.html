<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lufthansa Crew Portal v91</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        /* === VARIABLES === */
        :root {
            --lh-blue: #05164d;
            --lh-blue-glass: rgba(5, 22, 77, 0.95);
            --lh-yellow: #ffb600;
            --bg-body: #f3f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 30px -5px rgba(0,0,0,0.1);
            --radius: 14px;
            --header-h: 64px;
            --nav-h: 56px;
            --ease: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* DARK MODE */
        body.dark-mode {
            --lh-blue: #60a5fa; 
            --lh-blue-glass: rgba(15, 23, 42, 0.95);
            --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f1f5f9; --text-sub: #94a3b8;
            --border: #334155;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
        }
        body.dark-mode header { background: var(--lh-blue-glass); border-bottom: 1px solid var(--border); }
        body.dark-mode .nav-bar { background: var(--bg-card); border-bottom: 1px solid var(--border); }
        body.dark-mode .nav-btn { color: #94a3b8; }
        body.dark-mode .nav-btn.active { color: #ffb600; }
        
        /* DARK MODE LOGO FIX */
        body.dark-mode .login-nav img, 
        body.dark-mode .logo-img { filter: brightness(0) invert(1); opacity: 0.9; }

        /* BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); 
            transition: background 0.5s var(--ease), color 0.5s var(--ease); overflow-x: hidden;
            padding-top: calc(var(--header-h) + var(--nav-h)); padding-bottom: 40px;
        }
        .hidden { display: none !important; }

        /* === ANIMATIONS === */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        @keyframes pulseBar { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* === TAB TRANSITIONS === */
        .tab-content { animation: fadeIn 0.4s var(--ease) forwards; }
        .tab-content.exiting { animation: fadeOut 0.3s var(--ease) forwards; pointer-events: none; position: absolute; width: 100%; top: 0; left: 0; }

        /* === INTRO === */
        #intro {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            align-items: flex-start; justify-content: flex-end; padding: 40px; 
            font-family: 'JetBrains Mono', monospace; color: #0f0; overflow: hidden;
        }
        .boot-log { font-size: 0.8rem; color: #ccc; line-height: 1.6; margin-bottom: 20px; width: 100%; }
        .boot-highlight { color: #ffb600; }

        /* === PREPARING OVERLAY === */
        #takeoff-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-card); z-index: 7000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .cute-sticker { font-size: 5rem; margin-bottom: 20px; animation: bounce 2s infinite ease-in-out; text-shadow: 0 0 0 #fff, 2px 2px 0px rgba(0,0,0,0.1); }
        .taking-off #takeoff-screen { opacity: 1; pointer-events: all; }

        /* === LOGIN === */
        #login-wrap { 
            position:fixed; top:0; left:0; width:100vw; height:100vh; background:var(--bg-body); z-index:5000; 
            display:flex; flex-direction:column; transition: transform 0.6s var(--ease), opacity 0.6s var(--ease);
        }
        .login-nav { flex-shrink: 0; height: 70px; background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 30px; }
        .login-body { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 20px; width: 100%; }
        .login-card { width: 100%; max-width: 400px; background: var(--bg-card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-lg); margin-bottom: 50px; }
        #login-wrap.login-exit { pointer-events: none; animation: fadeOut 0.6s forwards; }

        /* === HEADER & NAV === */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 2000; display: flex; justify-content: space-between; align-items: center; padding: 0 24px;
            box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--border);
        }
        .logo-img { height: 24px; }
        .user-panel { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 500; display: flex; gap: 15px; align-items: center; }

        .nav-bar {
            position: fixed; top: var(--header-h); left: 0; width: 100%; height: var(--nav-h);
            background: var(--bg-card); border-bottom: 1px solid var(--border); z-index: 1900;
            overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;
        }
        .nav-inner { display: flex; height: 100%; margin: 0 auto; max-width: 1200px; padding: 0 10px; width: 100%; justify-content: center; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 24px;
            font-size: 0.9rem; font-weight: 600; color: var(--text-sub);
            cursor: pointer; position: relative; transition: color 0.3s;
        }
        .nav-btn.active { color: var(--lh-blue); }
        .nav-btn.active::after { content: ''; position: absolute; bottom: 0; left: 24px; right: 24px; height: 3px; background: var(--lh-yellow); border-radius: 3px 3px 0 0; }

        /* === LAYOUT === */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; width: 100%; position: relative; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); margin-bottom: 25px; }
        h2 { font-weight: 600; font-size: 1.5rem; margin-bottom: 25px; color: var(--text-main); }
        
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 25px; text-align: center; }
        .stat-val { font-size: 2.8rem; font-weight: 300; color: var(--text-main); }
        .stat-lbl { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-top: 8px; }
        
        .dash-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .af-card { border-left: 6px solid var(--lh-yellow); }
        .prog-track { height: 8px; background: var(--border); border-radius: 4px; margin: 25px 0; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; animation: pulseBar 2s infinite ease-in-out; }
        .af-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .af-route { font-size: 2.2rem; font-weight: 400; line-height: 1; }
        .af-det { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-sub); margin-top: 8px; }

        /* === DISPATCH === */
        .dispatch-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .d-map-wrap { height: 100%; min-height: 300px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); position: relative; }
        #dispatch-map { width: 100%; height: 100%; background: #e2e8f0; z-index: 1; }
        #dispatch-meme { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; z-index: 10; display: none; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px; backdrop-filter: blur(5px); }

        /* === LISTS === */
        .tickets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 15px; }
        .ticket {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px 30px;
            transition: all 0.2s var(--ease); cursor: pointer; position: relative;
        }
        .ticket:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--lh-yellow); }
        .ticket.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .t-loc { font-size: 1.8rem; font-weight: 700; letter-spacing: -1px; }
        .t-sub { font-size: 0.85rem; color: var(--text-sub); }
        .t-path { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 0 40px; }
        .t-dur { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; background: var(--bg-body); padding: 4px 10px; border-radius: 100px; margin-bottom: 8px; color: var(--text-sub); }
        .t-line-wrap { width: 100%; display: flex; align-items: center; gap: 10px; opacity: 0.4; }
        .t-line { flex: 1; height: 2px; background: currentColor; position: relative; }
        .t-plane { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); font-size: 1.2rem; } 
        .btn-select { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); background: transparent; color: var(--text-sub); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; }
        .ticket:not(.disabled):hover .btn-select { background: var(--lh-yellow); border-color: var(--lh-yellow); color: #05164d; }
        
        .t-mobile-arrow { display: none; }

        .crew-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .crew-row:last-child { border: none; }
        .crew-rank { font-weight: 700; color: var(--lh-blue); }
        body.dark-mode .crew-rank { color: var(--lh-yellow); }

        /* === FORM CONTROLS === */
        .form-group { margin-bottom: 20px; }
        .form-lbl { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; display: block; }
        .inp-sel { width: 100%; padding: 14px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; box-sizing: border-box; }
        .inp-sel:focus { border-color: var(--lh-blue); background: var(--bg-card); }
        .btn-main { width: 100%; padding: 16px; background: var(--lh-yellow); color: #05164d; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .btn-main:disabled { background: var(--border); color: var(--text-sub); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-main:not(:disabled):hover { transform: translateY(-1px); background: var(--lh-yellow-hover); }

        .filter-row { display: flex; gap: 10px; margin-bottom: 25px; }

        /* === MODAL === */
        .modal-wrap { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); z-index: 6000; 
            display: flex; justify-content: center; align-items: center; padding: 20px;
            opacity: 0; visibility: hidden; transition: opacity 0.3s var(--ease), visibility 0.3s;
        }
        .modal-wrap.visible { opacity: 1; visibility: visible; }
        .modal-c { width: 900px; max-width: 100%; max-height: 90vh; overflow-y: auto; background: var(--bg-card); padding: 30px; border-radius: 24px; box-shadow: var(--shadow-lg); transform: translateY(20px); transition: transform 0.4s var(--ease); }
        .modal-wrap.visible .modal-c { transform: translateY(0); }
        
        .ofp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: var(--bg-body); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid var(--border); }
        .ofp-lbl { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); margin-bottom: 5px; }
        .ofp-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 1.1rem; }
        #map { height: 300px; background: #e5e7eb; border-radius: 12px; margin-bottom: 25px; z-index: 1; border: 1px solid var(--border); }

        /* === MOBILE === */
        @media (max-width: 768px) {
            .nav-inner { justify-content: flex-start; }
            .grid-stats { grid-template-columns: 1fr; gap: 15px; }
            .dash-layout, .dispatch-layout { grid-template-columns: 1fr; gap: 25px; }
            
            .ticket { padding: 15px; gap: 12px; display: grid; grid-template-columns: 1fr auto 1fr auto; align-items: center; text-align: left; }
            .t-loc { font-size: 1.2rem; margin-bottom: 2px; }
            .t-sub { font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }
            .t-path { padding: 0; flex: none; width: auto; }
            .t-dur { display: block; font-size: 0.7rem; padding: 2px 6px; margin: 0; margin-bottom: 2px; }
            .t-line-wrap { display: none; }
            .t-mobile-arrow { display: block; font-size: 1.2rem; color: var(--lh-yellow); }
            .ticket > div:nth-child(3) { text-align: right; }
            .t-action { margin-left: 5px; }
            .btn-select { width: 40px; height: 40px; border-radius: 12px; }

            .filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .filter-row .inp-sel { width: 100%; margin: 0; }

            .ofp-grid { grid-template-columns: 1fr 1fr; }
            .d-map-wrap { height: 250px; min-height: 250px; }
            #intro { padding: 20px; justify-content: flex-end; }
            .login-card { margin-bottom: 0; }
        }
    </style>
</head>
<body>

<div id="intro"><div id="boot-text" class="boot-log"></div><div class="boot-log">> <span class="boot-cursor"></span></div></div>
<div id="takeoff-screen"><div class="cute-sticker">‚úàÔ∏è</div><div class="takeoff-txt">Please wait, preparing your flight...</div></div>

<div id="login-wrap">
    <div class="login-nav"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" style="height:28px;"></div>
    <div class="login-body">
        <div class="login-card">
            <h2 style="border:none; margin-bottom:10px;">Login</h2>
            <p style="color:var(--text-sub); margin-bottom:30px;">Enter your Travel ID (e.g. DLH001)</p>
            <input type="text" id="user" class="inp-sel" placeholder="Travel ID" style="margin-bottom:15px; background:transparent;">
            <input type="password" id="pass" class="inp-sel" placeholder="Password" style="margin-bottom:25px; background:transparent;">
            <button class="btn-main" onclick="app.login()">Next</button>
            <div id="login-msg" style="color:red; margin-top:15px; font-size:0.9rem;"></div>
        </div>
    </div>
</div>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo-img">
    <div class="user-panel">
        <span id="user-display">Pilot</span>
        <span id="clock">00:00 Z</span>
        <span onclick="app.theme()" style="cursor:pointer; font-size:1.4rem; margin-left:10px;">‚óë</span>
    </div>
</header>

<div class="nav-bar hidden" id="nav-bar">
    <div class="nav-inner">
        <button class="nav-btn active" onclick="app.tab('dash', this)">Dashboard</button>
        <button class="nav-btn" onclick="app.tab('routes', this)">Schedule</button>
        <button class="nav-btn" onclick="app.tab('fleet', this)">Fleet</button>
        <button class="nav-btn" onclick="app.tab('dispatch', this)">Dispatch</button>
    </div>
</div>

<div class="container hidden" id="app-cont">

    <div id="tab-dash" class="tab-content">
        <h2>Captain's Logbook</h2>
        <div class="grid-stats">
            <div class="stat-box"><div class="stat-val" id="st-l">0</div><div class="stat-lbl">Legs Flown</div></div>
            <div class="stat-box"><div class="stat-val" id="st-h">0</div><div class="stat-lbl">Total Hours</div></div>
            <div class="stat-box"><div class="stat-val" id="st-r" style="color:var(--lh-yellow)">-</div><div class="stat-lbl">Rank</div></div>
        </div>
        
        <div class="dash-layout">
            <div style="display:flex; flex-direction:column; gap:25px;">
                <div id="af-box" class="card af-card hidden">
                    <div class="af-row">
                        <div><div class="stat-lbl">ACTIVE SECTOR</div><div class="af-route"><span id="af-d"></span> &rarr; <span id="af-a"></span></div><div class="af-det"><span id="af-n"></span> ‚Ä¢ <span id="af-ac"></span></div></div>
                        <div style="text-align:right;"><div class="timer-display" id="af-t">00:00</div><div class="stat-lbl">REMAINING</div></div>
                    </div>
                    <div class="prog-track"><div id="af-bar" class="prog-fill"></div></div>
                    <button class="btn-main hidden" id="btn-end" onclick="app.finish()">FILE PIREP</button>
                    <button class="btn-main" style="background:var(--lh-red); color:white; margin-top:10px;" onclick="app.cancel()">CANCEL FLIGHT</button>
                </div>
                <div id="mis-box" class="card">
                    <h3>Daily Assignment</h3><div id="mis-txt" style="font-size:1.6rem; font-weight:300; margin-bottom:20px;">Loading...</div>
                    <button class="btn-main" style="width:auto; padding:12px 30px;" onclick="app.prepMis()">PREPARE FLIGHT</button>
                </div>
            </div>
            <div class="card">
                <h3>Operations Center</h3>
                <div id="news-list" style="margin-bottom:20px;"></div>
                <h4 style="color:var(--text-sub); font-size:0.8rem; text-transform:uppercase; margin-bottom:10px;">Active Crew (Editable in DB.PILOTS)</h4>
                <div id="pilot-list"></div>
            </div>
        </div>
    </div>

    <div id="tab-routes" class="tab-content hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 style="margin:0; border:none;">Flight Schedule</h2>
        </div>
        <div class="filter-row">
            <select id="flt-al" class="inp-sel" onchange="app.renderR()"></select>
            <select id="flt-tm" class="inp-sel" onchange="app.renderR()"></select>
        </div>
        <div id="list-routes" class="tickets-grid"></div>
    </div>

    <div id="tab-fleet" class="tab-content hidden">
        <h2>Fleet Overview</h2>
        <div class="filter-row">
            <select id="flt-op" class="inp-sel" onchange="app.renderF()"></select>
            <select id="flt-range" class="inp-sel" onchange="app.renderF()"></select>
        </div>
        <div id="list-fleet" class="tickets-grid"></div>
    </div>

    <div id="tab-dispatch" class="tab-content hidden">
        <div class="card">
            <h2>Flight Dispatcher</h2>
            <div class="dispatch-layout">
                <div class="dispatch-col">
                    <h3>Flight Parameters</h3>
                    <div class="form-group"><label class="form-lbl">Airline Operator</label><select id="gen-al" class="inp-sel" onchange="app.updHub()"></select></div>
                    <div class="form-group"><label class="form-lbl">Departure Hub</label><select id="gen-hub" class="inp-sel" disabled></select></div>
                    <div class="form-group"><label class="form-lbl">Estimated Duration</label><select id="gen-tm" class="inp-sel"></select></div>
                    <button id="btn-gen" class="btn-main" onclick="app.gen()">GENERATE OFP</button>
                </div>
                <div class="d-map-wrap">
                    <div id="dispatch-meme">
                        <img src="https://i.kym-cdn.com/entries/icons/original/000/021/807/ig9OJyE.jpg" style="max-width:80%; max-height:70%; border-radius:12px;">
                        <p style="margin-top:15px; font-weight:700; font-family:'JetBrains Mono'; font-size:1.2rem; text-shadow:0 2px 10px black;">ME CALCULATING FUEL WITH 2% BRAIN POWER</p>
                    </div>
                    <div id="dispatch-map"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="modal" class="modal-wrap">
    <div class="modal-c">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
            <h3 style="margin:0;">OFP BRIEFING</h3><h3 id="br-num" style="margin:0; color:var(--lh-blue);">LH000</h3>
        </div>
        <div class="ofp-grid">
            <div><div class="ofp-lbl">DEPARTURE</div><div class="ofp-val" id="br-dep"></div></div>
            <div><div class="ofp-lbl">ARRIVAL</div><div class="ofp-val" id="br-arr"></div></div>
            <div><div class="ofp-lbl">AIRCRAFT</div><div class="ofp-val" id="br-ac"></div></div>
            <div><div class="ofp-lbl">GATE</div><div class="ofp-val" id="br-gate"></div></div>
            <div><div class="ofp-lbl">ETE</div><div class="ofp-val" id="br-time"></div></div>
            <div><div class="ofp-lbl">ZFW</div><div class="ofp-val" id="br-zfw"></div></div>
            <div><div class="ofp-lbl">FL</div><div class="ofp-val" id="br-fl"></div></div>
            <div><div class="ofp-lbl">PAX</div><div class="ofp-val" id="br-pax"></div></div>
        </div>
        <div id="map"></div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
            <button class="btn-main" onclick="app.accept()">ACCEPT FLIGHT</button>
            <button class="btn-main" style="background:var(--bg-body); color:var(--text-main); box-shadow:none; border:1px solid var(--border);" onclick="app.closeM()">CANCEL</button>
        </div>
    </div>
</div>

<script>
    const DB = {
        // === EDIT PILOTS HERE ===
        PILOTS: [
            { id: "DLH001", pwd: "1234", name: "Capt. Mueller", rank: "Captain", base: "EDDF" },
            { id: "DLH002", pwd: "1234", name: "F.O. Weber", rank: "First Officer", base: "EDDM" },
            { id: "LX088", pwd: "1234", name: "Capt. Gerber", rank: "Captain", base: "LSZH" }
        ],

        // === EDIT AIRLINES HERE (NAME and ICAO CODE) ===
        AIRLINES: [
            { n: "Lufthansa", c: "LH" }, { n: "Swiss", c: "LX" }, { n: "Austrian", c: "OS" },
            { n: "AirBaltic", c: "BT" }, { n: "Brussels Airlines", c: "SN" }, { n: "Eurowings", c: "EW" },
            { n: "Discover Airlines", c: "4Y" }, { n: "Edelweiss Air", c: "WK" }, { n: "Lufthansa Cargo", c: "GEC" },
            { n: "Lufthansa CityLine", c: "CL" }, { n: "Air Dolomiti", c: "EN" }, { n: "ITA Airways", c: "AZ" },
            { n: "Wider√∏e", c: "WF" }, { n: "Norwegian", c: "DY" }, { n: "Finnair", c: "AY" },
            { n: "SAS", c: "SK" }, { n: "Condor", c: "DE" }, { n: "AeroLogic", c: "3S" },
            { n: "SunExpress", c: "XQ" }, { n: "Lufthansa Private Jet", c: "LPJ" }, { n: "Lufthansa Technik", c: "LT" }
        ],

        NEWS: [ { t: "System Update v91", d: "Time filters upgraded to ranges (1-2h, etc)." }, { t: "Winter Operations", d: "De-icing mandatory at stations < 3¬∞C." } ],
        
        FLEET: [
            { id: "A320L", t: "Airbus A320neo", op: "Lufthansa", s: 180, r: "6h 30m", fuel: "19.0t", cat: "Snack" },
            { id: "B748", t: "Boeing 747-8", op: "Lufthansa", s: 364, r: "14h 30m", fuel: "195.0t", cat: "Full Service" },
            { id: "A359", t: "Airbus A350-900", op: "Lufthansa", s: 293, r: "16h 00m", fuel: "110.0t", cat: "Full Service" },
            { id: "A333", t: "Airbus A330-300", op: "Swiss", s: 236, r: "10h 30m", fuel: "75.0t", cat: "Hot Meal" },
            { id: "B77W", t: "Boeing 777-300ER", op: "Swiss", s: 340, r: "15h 00m", fuel: "145.0t", cat: "Full Service" },
            { id: "A223", t: "Airbus A220-300", op: "Swiss", s: 145, r: "6h 00m", fuel: "17.0t", cat: "Snack" },
            { id: "B789", t: "Boeing 787-9", op: "Austrian", s: 294, r: "14h 00m", fuel: "101.0t", cat: "Full Service" }
        ],
        ROUTES: [
            { al: "Lufthansa", d: "EDDF", a: "EGLL", t: 1.5 }, { al: "Lufthansa", d: "EDDF", a: "KJFK", t: 8.5 }, { al: "Lufthansa", d: "EDDM", a: "LFPG", t: 1.2 }, { al: "Lufthansa", d: "EDDF", a: "OMDB", t: 6.2 }, { al: "Lufthansa", d: "EDDF", a: "KLAX", t: 11.5 },
            { al: "Swiss", d: "LSZH", a: "EGLL", t: 1.8 }, { al: "Swiss", d: "LSZH", a: "WSSS", t: 12.0 }, { al: "Swiss", d: "LSZH", a: "KJFK", t: 8.8 },
            { al: "Austrian", d: "LOWW", a: "VTBS", t: 10.5 }, { al: "Austrian", d: "LOWW", a: "EGLL", t: 2.2 },
            { al: "AirBaltic", d: "EVRA", a: "EDDL", t: 2.0 }, { al: "AirBaltic", d: "EVRA", a: "EGLL", t: 2.5 },
            { al: "Eurowings", d: "EDDL", a: "LEPA", t: 2.2 }, { al: "Eurowings", d: "EDDL", a: "EGLL", t: 1.2 },
            { al: "Discover Airlines", d: "EDDF", a: "FIMP", t: 11.0 }, { al: "Discover Airlines", d: "EDDF", a: "MCO", t: 10.0 },
            { al: "Lufthansa Cargo", d: "EDDF", a: "VHHH", t: 11.5 }, { al: "AeroLogic", d: "EDDP", a: "KCVG", t: 9.0 },
            { al: "ITA Airways", d: "LIRF", a: "KJFK", t: 9.0 }, { al: "ITA Airways", d: "LIRF", a: "EGLL", t: 2.5 },
            { al: "SAS", d: "EKCH", a: "KEWR", t: 8.5 }, { al: "Finnair", d: "EFHK", a: "RJTT", t: 13.0 },
            { al: "Norwegian", d: "ENGM", a: "LEPA", t: 3.5 }, { al: "Condor", d: "EDDF", a: "CUN", t: 11.0 },
            { al: "SunExpress", d: "LTAI", a: "EDDL", t: 3.5 }, { al: "Air Dolomiti", d: "EDDM", a: "LIPZ", t: 1.0 },
            { al: "Brussels Airlines", d: "EBBR", a: "KJFK", t: 8.0 }, { al: "Edelweiss Air", d: "LSZH", a: "CPT", t: 11.5 },
            { al: "Lufthansa CityLine", d: "EDDF", a: "LSZH", t: 0.8 }, { al: "Wider√∏e", d: "ENGM", a: "BGO", t: 0.9 },
            { al: "Lufthansa Private Jet", d: "EDDF", a: "NCE", t: 1.5 }, { al: "Lufthansa Technik", d: "EDDH", a: "EDDF", t: 1.0 }
        ],
        COORDS: {
            "EDDF":[50.03,8.56], "EDDM":[48.35,11.77], "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "EKCH":[55.61,12.65], "EGLL":[51.47,-0.45], "KJFK":[40.64,-73.77], "KLAX":[33.94,-118.40], "WSSS":[1.36,103.99], "VTBS":[13.69,100.75], "LFPG":[49.00,2.55], "KEWR":[40.68,-74.17], "EVRA":[56.92,23.97], "EDDL":[51.28,6.76], "LEPA":[39.55,2.73], "FIMP":[-20.43,57.68], "MCO":[28.43,-81.30], "VHHH":[22.30,113.91], "EDDP":[51.42,12.23], "KCVG":[39.04,-84.66], "LIRF":[41.80,12.24], "EFHK":[60.31,24.96], "RJTT":[35.54,139.77], "ENGM":[60.19,11.10], "CUN":[21.04,-86.87], "LTAI":[36.89,30.80], "LIPZ":[45.50,12.35], "EBBR":[50.90,4.48], "CPT":[-33.97,18.60], "EDDH":[53.63,9.98], "NCE":[43.66,7.21], "BGO":[60.29,5.21], "OMDB":[25.25,55.36]
        }
    };

    const app = {
        data: { stats: {l:0, h:0}, active: null, temp: null, mis: null, currentUser: null },
        tmr: null, map: null, dMap: null,

        init: function() {
            let s = JSON.parse(localStorage.getItem('stats'));
            if(!s || isNaN(s.l) || isNaN(s.h)) s = {l:0, h:0};
            this.data.stats = s;
            if(localStorage.getItem('dark')=='1') document.body.classList.add('dark-mode');
            setInterval(()=>{ const d=new Date(); document.getElementById('clock').innerText=`${String(d.getUTCHours()).padStart(2,0)}:${String(d.getUTCMinutes()).padStart(2,0)} Z`; }, 1000);
            
            const logs = ["Lufthansa Systems BIOS v91.0", "Initializing Kernel...", "Loading Database (DB.AIRLINES)...", "Loading Database (DB.PILOTS)...", "System READY."];
            let i = 0;
            const typeLog = () => {
                if(i < logs.length) {
                    const l = document.createElement('div');
                    l.innerHTML = `> <span class="boot-highlight">[OK]</span> ${logs[i]}`;
                    document.getElementById('boot-text').appendChild(l);
                    i++; setTimeout(typeLog, 300);
                } else {
                    setTimeout(()=>{ 
                        document.getElementById('intro').style.transform="translateY(-100%)";
                        document.getElementById('intro').style.transition="transform 0.8s cubic-bezier(0.16, 1, 0.3, 1)";
                    }, 800);
                }
            };
            setTimeout(typeLog, 500);

            this.updateDropdowns();
            this.renderPilots();
            document.getElementById('news-list').innerHTML = DB.NEWS.map(n=>`<div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:8px;"><b>${n.t}</b><br><span style="color:var(--text-sub); font-size:0.9rem;">${n.d}</span></div>`).join('');
            
            this.dMap = L.map('dispatch-map').setView([48, 10], 3);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(this.dMap);

            this.updStats(); this.renderR(); this.renderF(); this.dailyMis(); this.chkActive();
        },

        updateDropdowns: function() {
            // Populate Airlines from DB.AIRLINES
            const ops = DB.AIRLINES.map(x => x.n);
            const fill = (id, arr, t) => { const el=document.getElementById(id); el.innerHTML=`<option value="ALL">${t}</option>`; arr.forEach(x=>el.add(new Option(x,x))); };
            
            fill('flt-al', ops, 'All Airlines'); 
            fill('gen-al', ops, 'Select Airline'); 
            fill('flt-op', ops, 'All Operators');

            // Generate Range Options (1-2, 2-3, ... 10+)
            let opts = `<option value="ALL">All Durations</option>`;
            for(let i=1; i<10; i++) {
                opts += `<option value="${i}-${i+1}">${i}-${i+1} Hours</option>`;
            }
            opts += `<option value="10+">10+ Hours</option>`;
            
            document.querySelectorAll('#flt-tm, #gen-tm, #flt-range').forEach(el => {
                if(el.id === 'flt-range') el.innerHTML = opts.replace('All Durations', 'All Ranges');
                else el.innerHTML = opts;
            });
        },

        renderPilots: function() {
            const l = document.getElementById('pilot-list'); l.innerHTML = "";
            DB.PILOTS.forEach(p => {
                l.innerHTML += `<div class="crew-row"><div><b>${p.name}</b> <span style="color:var(--text-sub)">(${p.id})</span></div><div class="crew-rank">${p.rank}</div></div>`;
            });
        },

        login: function() {
            const u = document.getElementById('user').value.toUpperCase();
            const p = document.getElementById('pass').value;
            const pilot = DB.PILOTS.find(x => x.id === u && x.pwd === p);

            if(pilot){
                this.data.currentUser = pilot;
                document.getElementById('user-display').innerText = pilot.name;
                const loginWrap = document.getElementById('login-wrap');
                loginWrap.classList.add('login-exit');
                setTimeout(() => {
                     loginWrap.classList.add('hidden');
                     document.getElementById('nav-bar').classList.remove('hidden');
                     const cont = document.getElementById('app-cont');
                     cont.classList.remove('hidden');
                     cont.classList.add('fade-in');
                }, 600);
            } else document.getElementById('login-msg').innerText="Invalid Credentials";
        },

        tab: function(id, btn) {
            const current = document.querySelector('.tab-content:not(.hidden)');
            const next = document.getElementById('tab-'+id);
            if(current === next) return;

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');

            if (current) {
                current.classList.add('exiting');
                setTimeout(() => {
                    current.classList.add('hidden');
                    current.classList.remove('exiting');
                    next.classList.remove('hidden');
                }, 300);
            } else {
                next.classList.remove('hidden');
            }

            if(id=='routes') this.renderR();
            if(id=='dispatch') setTimeout(()=>this.dMap.invalidateSize(), 300);
        },

        parseTime: function(str) {
            if(typeof str === 'number') return str;
            if(!str) return 0;
            let h = 0, m = 0;
            const hMatch = str.match(/(\d+)h/);
            const mMatch = str.match(/(\d+)m/);
            if(hMatch) h = parseInt(hMatch[1]);
            if(mMatch) m = parseInt(mMatch[1]);
            if(!hMatch && !mMatch && !isNaN(parseFloat(str))) return parseFloat(str);
            return h + (m/60);
        },

        chkTime: function(val, filter) {
            if(filter === 'ALL') return true;
            const t = this.parseTime(val);
            if(filter === '10+') return t >= 10;
            // Check for range format "min-max"
            if(filter.includes('-')) {
                const [min, max] = filter.split('-').map(Number);
                return t >= min && t < max;
            }
            // Fallback
            return Math.floor(t) == filter;
        },

        renderF: function() {
            const op = document.getElementById('flt-op').value;
            const rng = document.getElementById('flt-range').value;
            const l = document.getElementById('list-fleet'); l.innerHTML="";
            
            DB.FLEET.filter(f => (op=='ALL'||f.op==op) && this.chkTime(f.r, rng)).forEach(f=>{ 
                l.innerHTML+=`<div class="ticket list-item" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="font-weight:700; font-size:1.1rem;">${f.t}</span>
                        <span style="font-family:'JetBrains Mono'; color:var(--text-sub);">${f.op}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85rem; color:var(--text-sub);">
                        <span>Pax: <b style="color:var(--text-main)">${f.s}</b></span> 
                        <span>Endurance: <b style="color:var(--text-main)">${f.r}</b></span>
                        <span>Max Fuel: <b style="color:var(--text-main)">${f.fuel}</b></span>
                        <span>Catering: <b style="color:var(--text-main)">${f.cat}</b></span>
                    </div>
                </div>`; 
            });
            if(l.innerHTML === "") l.innerHTML = "<div class='card'>No aircraft found matching filters.</div>";
        },
        
        updStats: function() {
            document.getElementById('st-l').innerText = this.data.stats.l;
            document.getElementById('st-h').innerText = Math.floor(this.data.stats.h);
            const l = this.data.stats.l;
            document.getElementById('st-r').innerText = l>20?"Captain":(l>5?"First Officer":"Second Officer");
            document.getElementById('st-r').style.color = l>20?"#ffb600":(l>5?"#60a5fa":"#9ca3af");
        },

        renderR: function() {
            const al=document.getElementById('flt-al').value, tm=document.getElementById('flt-tm').value;
            const l=document.getElementById('list-routes'); l.innerHTML="";
            const r=DB.ROUTES.filter(x=>(al=='ALL'||x.al==al) && this.chkTime(x.t, tm));
            if(!r.length) { l.innerHTML="<div class='card'>No flights found.</div>"; return; }
            const isActive = !!this.data.active;
            r.forEach((x, i)=>{ 
                l.innerHTML+=`
                <div class="ticket list-item ${isActive?'disabled':''}" style="animation-delay:${i*0.05}s" onclick="app.prep('${x.al}','${x.d}','${x.a}',${x.t})">
                    <div><div class="t-loc">${x.d}</div><div class="t-sub">${x.al}</div></div>
                    <div class="t-path"><div class="t-dur">${x.t}h</div><div class="t-line-wrap"><div class="t-dot"></div><div class="t-line"><div class="t-plane">‚úà</div></div><div class="t-dot"></div></div><div class="t-mobile-arrow">&rarr;</div></div>
                    <div><div class="t-loc">${x.a}</div><div class="t-sub">Arrival</div></div>
                    <div class="t-action"><div class="btn-select">${isActive?'üîí':'&rarr;'}</div></div>
                </div>`; 
            });
        },

        getAc: function(al, t) {
            let p = DB.FLEET.filter(f=>f.op==al);
            if(!p.length) return { t: "Airbus A320 (Generic)", s: 180, r: "6h 00m", ceil: "FL380" };
            return p[Math.floor(Math.random()*p.length)];
        },

        prep: function(al, d, a, t) {
            if(this.data.active) { alert("You already have an active flight! Please complete or cancel it first."); return; }
            const p = this.getAc(al, t);
            
            const airlineObj = DB.AIRLINES.find(x => x.n === al);
            const prefix = airlineObj ? airlineObj.c : "LH";
            
            const code = prefix + Math.floor(Math.random()*8999+1000);
            this.data.temp = { d, a, t, ac: p.t, n: code, gate: "A"+Math.floor(Math.random()*40+1), pax: Math.floor(p.s*0.85), zfw: (10 + Math.random()*20).toFixed(1)+"t", fl: "FL3"+Math.floor(Math.random()*9)+"0" };
            document.getElementById('br-num').innerText = code;
            ['dep','arr','ac','gate','time','zfw','pax','fl'].forEach(k=>document.getElementById('br-'+k).innerText=this.data.temp[{dep:'d',arr:'a',ac:'ac',gate:'gate',time:'t',zfw:'zfw',pax:'pax',fl:'fl'}[k]]);
            
            document.getElementById('modal').classList.add('visible');
            
            setTimeout(()=>{
                if(this.map) this.map.remove(); this.map = L.map('map').setView([50,10], 3);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                const c1=DB.COORDS[d]||[50,10], c2=DB.COORDS[a]||[40,-70];
                L.polyline([c1,c2],{color:'#05164d', weight:3}).addTo(this.map); this.map.fitBounds([c1,c2], {padding:[30,30]});
            },300);
        },

        accept: function() {
            this.data.temp.start = Date.now();
            localStorage.setItem('active', JSON.stringify(this.data.temp));
            this.closeM(); 
            const ts = document.getElementById('takeoff-screen');
            document.body.classList.add('taking-off');
            setTimeout(()=>{
                document.body.classList.remove('taking-off');
                this.chkActive(); 
                this.tab('dash', document.querySelector('.nav-btn'));
            }, 3000);
        },
        
        closeM: function() { document.getElementById('modal').classList.remove('visible'); },

        chkActive: function() {
            const s = localStorage.getItem('active');
            if(!s) { 
                this.data.active = null; document.getElementById('af-box').classList.add('hidden'); 
                document.getElementById('mis-box').classList.remove('hidden'); document.getElementById('btn-gen').disabled = false; return; 
            }
            this.data.active = JSON.parse(s);
            document.getElementById('af-box').classList.remove('hidden'); document.getElementById('mis-box').classList.add('hidden');
            document.getElementById('btn-gen').disabled = true;
            ['d','a','n','ac'].forEach(k=>document.getElementById('af-'+k).innerText=this.data.active[k]);
            if(this.tmr) clearInterval(this.tmr);
            this.tmr = setInterval(()=>{
                const el = Date.now() - this.data.active.start; const dur = this.data.active.t * 3600 * 1000; const pct = Math.min(100, (el/dur)*100);
                document.getElementById('af-bar').style.width=pct+"%";
                if(pct>=100) { document.getElementById('af-t').innerText="ARRIVED"; document.getElementById('btn-end').classList.remove('hidden'); } 
                else { const remMs = dur - el; const remHrs = Math.floor((remMs / (1000 * 60 * 60))); const remMins = Math.floor((remMs / (1000 * 60)) % 60);
                    document.getElementById('af-t').innerText = `${String(remHrs).padStart(2,'0')}:${String(remMins).padStart(2,'0')}`; }
            }, 1000);
        },

        finish: function() {
            this.data.stats.l++; this.data.stats.h+=this.data.active.t;
            localStorage.setItem('stats', JSON.stringify(this.data.stats));
            localStorage.removeItem('active'); this.chkActive(); this.updStats();
        },
        
        cancel: function() {
            if(confirm('Are you sure you want to cancel the flight?')) { localStorage.removeItem('active'); this.chkActive(); }
        },

        updHub: function() {
            const al=document.getElementById('gen-al').value; const h=document.getElementById('gen-hub'); h.innerHTML=""; h.disabled=false;
            [...new Set(DB.ROUTES.filter(r=>r.al==al).map(r=>r.d))].forEach(x=>h.add(new Option(x,x)));
        },
        gen: function() {
            if(this.data.active) { alert("Flight already in progress."); return; }
            const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
            const r=DB.ROUTES.filter(x=>x.al==al && x.d==h && this.chkTime(x.t, tm));
            if(!r.length) { alert("No routes match."); return; }
            const s=r[Math.floor(Math.random()*r.length)]; 
            
            document.getElementById('dispatch-meme').style.display = 'flex';

            const c1=DB.COORDS[s.d], c2=DB.COORDS[s.a];
            if(c1 && c2) {
                this.dMap.eachLayer((layer) => { if(!layer._url) this.dMap.removeLayer(layer); });
                L.polyline([c1,c2],{color:'#ffb600', weight:3, dashArray:'10,10'}).addTo(this.dMap); 
                this.dMap.fitBounds([c1,c2], {padding:[50,50]});
            }
            
            setTimeout(() => {
                document.getElementById('dispatch-meme').style.display = 'none';
                this.prep(s.al, s.d, s.a, s.t);
            }, 2000);
        },
        dailyMis: function() {
            const d=new Date().getDate(); this.data.mis = DB.ROUTES[d % DB.ROUTES.length];
            document.getElementById('mis-txt').innerText = `${this.data.mis.d} ‚Üí ${this.data.mis.a}`;
        },
        prepMis: function(){ this.prep(this.data.mis.al, this.data.mis.d, this.data.mis.a, this.data.mis.t); },
        theme: function() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('dark', document.body.classList.contains('dark-mode')?'1':'0');
        }
    };
    window.onload = ()=>app.init();
</script>
</body>
</html>
