<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lufthansa Crew Portal - Stable</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* --- 1. CONFIG --- */
        :root {
            --bg-color: #f2f4f7; --card-bg: #ffffff; --text-main: #1a1a1a; --text-sub: #595959;
            --border-color: #e0e0e0; --brand-blue: #05164d; --brand-yellow: #ffb600;
            --header-bg: #05164d; --input-bg: #ffffff; --metar-bg: #eee;
            --logo-brightness: brightness(0) invert(1);
        }

        body.dark-mode {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sub: #a0a0a0;
            --border-color: #333333; --brand-blue: #3a3a3a; --brand-yellow: #ffb600;
            --header-bg: #000000; --input-bg: #252525; --metar-bg: #2a2a2a;
            --logo-brightness: brightness(0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Open Sans', sans-serif; transition: 0.2s; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        
        /* Utility */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .mono-text { font-family: 'Roboto Mono', monospace; }

        /* Buttons & Inputs */
        .btn {
            background-color: var(--brand-blue); color: #fff; border: 1px solid transparent;
            padding: 14px 28px; font-size: 0.95rem; cursor: pointer; border-radius: 4px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center;
            width: 100%; /* Make buttons wide by default on mobile */
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-yellow { background-color: var(--brand-yellow); color: #05164d !important; border: none !important; }
        
        input, select {
            width: 100%; padding: 14px 15px; margin: 8px 0 20px 0;
            border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 1rem; background: var(--input-bg); color: var(--text-main);
        }

        /* Cards */
        .lh-card {
            background: var(--card-bg); padding: 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
            border-top: 4px solid var(--brand-blue);
        }
        body.dark-mode .lh-card { border-top-color: #555; }

        /* Header */
        header { background-color: var(--header-bg); padding: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo-white { filter: var(--logo-brightness); height: 40px; }
        .top-tools { display: flex; align-items: center; gap: 15px; color: white; }
        .theme-toggle { background: none; border: 1px solid rgba(255,255,255,0.3); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Navigation */
        .nav-bar { background: var(--card-bg); border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; }
        .nav-item { padding: 15px 20px; background: none; border: none; color: var(--text-sub); font-weight: 600; cursor: pointer; white-space: nowrap; position: relative; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--brand-yellow); }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; flex: 1; width: 100%; }

        /* Dashboard Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        /* Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 5000; 
            display: flex; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px);
        }
        .briefing-paper {
            background: var(--card-bg); width: 95%; max-width: 800px; padding: 25px; 
            border-radius: 6px; color: var(--text-main); max-height: 90vh; overflow-y: auto;
        }
        .briefing-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; font-size: 0.9rem; }
        .data-block label { display: block; font-size: 0.65rem; color: var(--text-sub); font-weight: bold; }
        .data-block span { font-weight: 600; font-family: 'Roboto Mono', monospace; }
        
        .metar-box { font-family: 'Roboto Mono', monospace; background: var(--metar-bg); padding: 10px; font-size: 0.8rem; margin-top: 5px; border-left: 4px solid var(--brand-yellow); color: var(--text-main); }
        #map { width: 100%; height: 200px; margin: 20px 0; border: 1px solid var(--border-color); }

        /* Fleet */
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .aircraft-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }

        /* Welcome Screen (Fix applied: pointer-events) */
        #welcome-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; 
            background: #05164d; color: white; display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 1s ease;
        }
        /* –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–∫–∞—Ç—å –°–ö–í–û–ó–¨ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —ç–∫—Ä–∞–Ω */
        #welcome-screen.hidden-visual {
            opacity: 0;
            pointer-events: none; 
        }

        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #05164d; }
        .login-box { background: white; padding: 40px 30px; width: 90%; max-width: 400px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1 style="font-size: 2.5rem; font-weight: 800; letter-spacing: 2px;">CREW OPS</h1>
        <p style="margin-top: 10px; opacity: 0.7;">INITIALIZING SYSTEMS...</p>
        <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); margin-top: 20px; border-radius: 2px;">
            <div style="width: 0%; height: 100%; background: #ffb600; animation: load 3s forwards;"></div>
        </div>
        <style> @keyframes load { to { width: 100%; } } </style>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-box fade-in">
            <h2 style="border:none; text-align:center; color:#333; margin-bottom: 10px;">Crew Access</h2>
            <p style="color:#666; margin-bottom:20px;">Use: DLH001 / 1234</p>
            <input type="text" id="callsign" placeholder="Callsign" style="background:#fff; color:#000; border:1px solid #ccc;">
            <input type="password" id="password" placeholder="Password" style="background:#fff; color:#000; border:1px solid #ccc;">
            <button class="btn btn-yellow" onclick="login()">Log In</button>
            <p id="login-error" style="color:red; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header>
            <div class="header-content">
                <div style="font-weight: 800; font-size: 1.2rem;">LUFTHANSA</div>
                <div class="top-tools">
                    <div id="zulu-clock" class="mono-text">00:00 Z</div>
                    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
                </div>
            </div>
        </header>

        <nav class="nav-bar">
            <div class="nav-content">
                <button class="nav-item active" onclick="showTab('home', this)">Dashboard</button>
                <button class="nav-item" onclick="showTab('dispatch', this)">Dispatch</button>
                <button class="nav-item" onclick="showTab('fleet', this)">Fleet</button>
            </div>
        </nav>

        <div class="container">
            <div id="active-flight-banner" class="lh-card hidden fade-in" style="border-left: 6px solid var(--brand-yellow);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:0.8rem; color:var(--text-sub);">CURRENT FLIGHT</div>
                        <div style="font-size:1.4rem; font-weight:800;"><span id="af-dep"></span> ‚ûù <span id="af-arr"></span></div>
                        <div style="font-weight:bold; color:var(--brand-yellow);" id="af-num"></div>
                    </div>
                    <button class="btn" style="width: auto;" onclick="completeFlight()">File Report</button>
                </div>
            </div>

            <div id="tab-home" class="tab-content fade-in">
                <h2>Captain's Logbook</h2>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val" id="stat-flights">0</div><div class="stat-label">Flights</div></div>
                    <div class="stat-box"><div class="stat-val" id="stat-hours">0</div><div class="stat-label">Hours</div></div>
                    <div class="stat-box"><div class="stat-val" id="stat-rank" style="color:var(--brand-yellow)">-</div><div class="stat-label">Rank</div></div>
                </div>
                <div class="lh-card">
                    <h3>Welcome Aboard</h3>
                    <p style="color:var(--text-sub); margin-top:10px;">System status is nominal. Use the Dispatch tab to generate new flights.</p>
                </div>
            </div>

            <div id="tab-dispatch" class="tab-content hidden fade-in">
                <h2>Flight Dispatch</h2>
                <div id="generator-form" class="lh-card">
                    <label>OPERATOR</label>
                    <select id="gen-airline" onchange="updateHubs()"><option value="">-- Select Airline --</option></select>
                    
                    <label>DEPARTURE HUB</label>
                    <select id="gen-hub" disabled><option>Select Airline First</option></select>
                    
                    <label>FLIGHT LENGTH</label>
                    <select id="gen-time">
                        <option value="short">Short (1-3h)</option>
                        <option value="medium">Medium (3-7h)</option>
                        <option value="long">Long (8h+)</option>
                    </select>

                    <button id="generate-btn" class="btn" onclick="generateFlight()">GENERATE FLIGHT PLAN</button>
                </div>
            </div>

            <div id="tab-fleet" class="tab-content hidden fade-in">
                <h2>Fleet</h2>
                <div id="fleet-container" class="fleet-grid"></div>
            </div>
        </div>
    </div>

    <div id="briefing-modal" class="modal-overlay hidden">
        <div class="briefing-paper fade-in">
            <div class="briefing-header">
                <h2>FLIGHT PLAN</h2>
                <div id="br-flight-num" style="font-weight:800; font-size:1.2rem;"></div>
            </div>

            <div class="briefing-grid">
                <div class="data-block"><label>DEP</label><span id="br-dep"></span></div>
                <div class="data-block"><label>ARR</label><span id="br-arr"></span></div>
                <div class="data-block"><label>AIRCRAFT</label><span id="br-ac"></span></div>
                <div class="data-block"><label>GATE DEP</label><span id="br-gate-dep"></span></div>
                <div class="data-block"><label>GATE ARR</label><span id="br-gate-arr"></span></div>
                <div class="data-block"><label>TIME</label><span id="br-time"></span></div>
                <div class="data-block"><label>PAX</label><span id="br-pax"></span></div>
                <div class="data-block"><label>CARGO</label><span id="br-cargo"></span></div>
                <div class="data-block"><label>ZFW</label><span id="br-zfw"></span></div>
            </div>

            <div id="map"></div>

            <div style="margin-top:20px;">
                <label style="font-size:0.7rem; font-weight:bold;">METAR (DEP)</label>
                <div class="metar-box" id="br-metar-dep">Loading...</div>
                <label style="font-size:0.7rem; font-weight:bold; margin-top:10px; display:block;">METAR (ARR)</label>
                <div class="metar-box" id="br-metar-arr">Loading...</div>
            </div>

            <button class="btn btn-yellow" style="margin-top:20px;" onclick="confirmBriefing()">ACCEPT FLIGHT</button>
        </div>
    </div>

    <script>
        // --- 1. ERROR HANDLER (If anything breaks, tell the user) ---
        window.onerror = function(msg, url, line) {
            alert("Error: " + msg + "\nLine: " + line);
            return false;
        };

        // --- 2. DATA ---
        const USERS = [{ callsign: "DLH001", pass: "1234", name: "Capt. Hans" }];
        
        const REAL_GATES = {
            "EDDF": ["A13", "A20", "Z50", "B24"], "EDDM": ["G08", "G30", "H12", "L11"],
            "KJFK": ["4", "8", "12"], "EGLL": ["A10", "B34"],
            "LOWW": ["F01", "G03"], "LSZH": ["A06", "E18"]
        };

        const AIRLINES = {
            "Lufthansa": { hubs: ["EDDF (Frankfurt)", "EDDM (Munich)"], code: "DLH" },
            "SWISS": { hubs: ["LSZH (Zurich)"], code: "SWR" },
            "Austrian": { hubs: ["LOWW (Vienna)"], code: "AUA" },
            "Eurowings": { hubs: ["EDDL (Dusseldorf)", "EDDH (Hamburg)"], code: "EWG" }
        };

        const FLEET = [
            { type: "Airbus A320neo", maxHours: 6, seats: 180, img: "https://upload.wikimedia.org/wikipedia/commons/e/e3/Lufthansa_Airbus_A320neo_D-AINA_FRA_2016.jpg" },
            { type: "Airbus A330-300", maxHours: 11, seats: 255, img: "https://upload.wikimedia.org/wikipedia/commons/c/c2/Lufthansa_A330-300_D-AIKQ_01.jpg" },
            { type: "Boeing 747-8", maxHours: 14, seats: 364, img: "https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Boeing_747-830_D-ABYT.jpg" }
        ];

        const DESTINATIONS = [
            { code: "KJFK", hours: 8.5, lat: 40.64, lon: -73.77, region: "NA" },
            { code: "EGLL", hours: 1.5, lat: 51.47, lon: -0.46, region: "EU" },
            { code: "OMDB", hours: 6.5, lat: 25.25, lon: 55.36, region: "ME" },
            { code: "RJTT", hours: 12, lat: 35.54, lon: 139.77, region: "AS" },
            { code: "FACT", hours: 11.5, lat: -33.97, lon: 18.60, region: "AF" }
        ];

        const HUB_COORDS = { 
            "EDDF": [50.03, 8.57], "EDDM": [48.35, 11.78], "LSZH": [47.45, 8.55], 
            "LOWW": [48.11, 16.56], "EDDL": [51.28, 6.76], "EDDH": [53.63, 9.98] 
        };

        // --- 3. SYSTEM LOGIC ---
        let pilotStats = { flights: 0, hours: 0 };
        let generatedFlightTemp = null;
        let mapObject = null;

        // Start
        setTimeout(() => {
            const w = document.getElementById('welcome-screen');
            w.classList.add('hidden-visual'); // Make it transparent AND unclickable
            setTimeout(() => { w.classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }, 1000);
        }, 3500);

        // Load Saved Stats
        const savedStats = localStorage.getItem('pilotStats');
        if(savedStats) pilotStats = JSON.parse(savedStats);
        updateStats();

        function updateStats() {
            document.getElementById('stat-flights').innerText = pilotStats.flights;
            document.getElementById('stat-hours').innerText = Math.floor(pilotStats.hours);
            let rank = "Cadet";
            if(pilotStats.flights > 5) rank = "First Officer";
            if(pilotStats.flights > 20) rank = "Captain";
            document.getElementById('stat-rank').innerText = rank;
        }

        function login() {
            const u = document.getElementById('callsign').value.toUpperCase();
            const p = document.getElementById('password').value;
            if(USERS.find(user => user.callsign === u && user.pass === p)) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                initApp();
            } else {
                document.getElementById('login-error').innerText = "Try DLH001 / 1234";
            }
        }

        function initApp() {
            // Fleet Populate
            const c = document.getElementById('fleet-container');
            FLEET.forEach(ac => {
                c.innerHTML += `<div class="lh-card aircraft-card"><img src="${ac.img}"><h4>${ac.type}</h4></div>`;
            });
            // Airline Select
            const s = document.getElementById('gen-airline');
            for(let a in AIRLINES) { let opt = document.createElement('option'); opt.value = a; opt.text = a; s.add(opt); }
            // Clock
            setInterval(() => {
                const d = new Date();
                document.getElementById('zulu-clock').innerText = `${String(d.getUTCHours()).padStart(2,'0')}:${String(d.getUTCMinutes()).padStart(2,'0')} Z`;
            }, 1000);
            
            checkActiveFlight();
        }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        
        function showTab(n, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-' + n).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function updateHubs() {
            const a = document.getElementById('gen-airline').value;
            const h = document.getElementById('gen-hub');
            h.innerHTML = "";
            if(!a) { h.disabled = true; return; }
            h.disabled = false;
            AIRLINES[a].hubs.forEach(hub => {
                let opt = document.createElement('option'); opt.value = hub; opt.text = hub; h.add(opt);
            });
        }

        // --- 4. GENERATOR ---
        function generateMETAR(icao) {
            const wind = Math.floor(Math.random()*36)*10;
            const spd = Math.floor(Math.random()*15)+3;
            return `${icao} ${new Date().getUTCDate()}1200Z ${wind.toString().padStart(3,'0')}${spd}KT 9999 SCT030 15/10 Q1013 NOSIG`;
        }

        function generateGate(icao) {
            if (REAL_GATES[icao]) return REAL_GATES[icao][Math.floor(Math.random() * REAL_GATES[icao].length)];
            return "A" + Math.floor(Math.random()*50+1);
        }

        function generateFlight() {
            const an = document.getElementById('gen-airline').value;
            const h = document.getElementById('gen-hub').value;
            const tp = document.getElementById('gen-time').value;

            if(!an || !h) { alert("Please select Airline and Hub"); return; }

            // Filter Fleet
            let minH=1, maxH=3; if(tp==='medium'){minH=3;maxH=7;} if(tp==='long'){minH=8;maxH=14;}
            const availAC = FLEET.filter(ac => (tp==='long'?ac.maxHours>=8:(tp==='short'?ac.maxHours<8:ac.maxHours>=3)));
            if(availAC.length === 0) { alert("No aircraft available for this range"); return; }
            
            const ac = availAC[Math.floor(Math.random()*availAC.length)];
            
            // Pick Dest
            const possibleDests = DESTINATIONS.filter(d => d.hours >= minH && d.hours <= maxH);
            const dest = possibleDests.length > 0 ? possibleDests[Math.floor(Math.random()*possibleDests.length)] : DESTINATIONS[0];
            const depCode = h.split(' ')[0];

            // Calc Data
            const pax = Math.floor(ac.seats * (0.6 + Math.random()*0.4));
            const cargo = Math.floor(Math.random()*5000)+1000;
            const zfw = 40000 + pax*85 + cargo;

            generatedFlightTemp = {
                dep: depCode, arr: dest.code, ac: ac.type,
                num: AIRLINES[an].code + (Math.floor(Math.random()*900)+100),
                time: (Math.random()*(maxH-minH)+minH).toFixed(1),
                pax: pax, cargo: cargo, zfw: zfw,
                gateDep: generateGate(depCode), gateArr: generateGate(dest.code),
                depLat: HUB_COORDS[depCode] ? HUB_COORDS[depCode][0] : 50.0,
                depLon: HUB_COORDS[depCode] ? HUB_COORDS[depCode][1] : 8.0,
                arrLat: dest.lat, arrLon: dest.lon,
                metarDep: generateMETAR(depCode), metarArr: generateMETAR(dest.code)
            };

            openBriefing();
        }

        function openBriefing() {
            const g = generatedFlightTemp;
            document.getElementById('br-flight-num').innerText = g.num;
            document.getElementById('br-dep').innerText = g.dep;
            document.getElementById('br-arr').innerText = g.arr;
            document.getElementById('br-ac').innerText = g.ac;
            document.getElementById('br-gate-dep').innerText = g.gateDep;
            document.getElementById('br-gate-arr').innerText = g.gateArr;
            document.getElementById('br-time').innerText = g.time + " h";
            document.getElementById('br-pax').innerText = g.pax;
            document.getElementById('br-cargo').innerText = g.cargo;
            document.getElementById('br-zfw').innerText = (g.zfw/1000).toFixed(1) + " T";
            document.getElementById('br-metar-dep').innerText = g.metarDep;
            document.getElementById('br-metar-arr').innerText = g.metarArr;

            document.getElementById('briefing-modal').classList.remove('hidden');

            // Map Logic (Protected)
            setTimeout(() => {
                try {
                    if(mapObject) { mapObject.off(); mapObject.remove(); }
                    mapObject = L.map('map').setView([g.depLat, g.depLon], 3);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapObject);
                    L.polyline([[g.depLat, g.depLon], [g.arrLat, g.arrLon]], {color: '#05164d', weight: 3}).addTo(mapObject);
                    L.marker([g.depLat, g.depLon]).addTo(mapObject);
                    L.marker([g.arrLat, g.arrLon]).addTo(mapObject);
                } catch(e) { console.log("Map error: " + e); }
            }, 300);
        }

        function confirmBriefing() {
            localStorage.setItem('activeFlight', JSON.stringify(generatedFlightTemp));
            document.getElementById('briefing-modal').classList.add('hidden');
            checkActiveFlight();
        }

        function checkActiveFlight() {
            const data = localStorage.getItem('activeFlight');
            if(data) {
                const f = JSON.parse(data);
                document.getElementById('active-flight-banner').classList.remove('hidden');
                document.getElementById('af-dep').innerText = f.dep;
                document.getElementById('af-arr').innerText = f.arr;
                document.getElementById('af-num').innerText = f.num;
                document.getElementById('generator-form').classList.add('hidden');
            } else {
                document.getElementById('active-flight-banner').classList.add('hidden');
                document.getElementById('generator-form').classList.remove('hidden');
            }
        }

        function completeFlight() {
            if(confirm("Complete Flight?")) {
                const f = JSON.parse(localStorage.getItem('activeFlight'));
                pilotStats.flights++;
                pilotStats.hours += parseFloat(f.time);
                localStorage.setItem('pilotStats', JSON.stringify(pilotStats));
                localStorage.removeItem('activeFlight');
                updateStats();
                checkActiveFlight();
            }
        }
    </script>
</body>
</html>
