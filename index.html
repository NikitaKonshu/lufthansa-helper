<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Systems - Crew Portal v60</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* === LUFTHANSA CORPORATE DESIGN VARIABLES === */
        :root {
            --lh-navy: #05164d;       /* Deep Blue Header */
            --lh-yellow: #ffb600;     /* Corporate Yellow */
            --lh-yellow-hov: #e0a000;
            --lh-bg: #f2f4f7;         /* Light Gray Background */
            --lh-card: #ffffff;
            --lh-text: #05164d;       /* Dark Text */
            --lh-subtext: #666666;
            --lh-border: #cccccc;
            --radius: 4px;            /* Slightly squared corners */
        }
        
        body.dark-mode {
            --lh-bg: #0f172a; --lh-card: #1e293b; --lh-text: #f1f5f9; 
            --lh-subtext: #94a3b8; --lh-border: #334155; --lh-navy: #020b26;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--lh-bg); color: var(--lh-text); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* === HEADER (Dark Blue) === */
        header {
            background: var(--lh-navy); height: 60px; width: 100%;
            display: flex; justify-content: space-between; align-items: center; padding: 0 5%;
            position: fixed; top: 0; z-index: 2000;
        }
        .logo { height: 24px; filter: brightness(0) invert(1); } /* White logo */
        .user-panel { color: white; font-size: 0.9rem; display: flex; gap: 20px; align-items: center; }

        /* === SUB-NAVIGATION (White Bar) === */
        .nav-wrap {
            background: var(--lh-card); width: 100%; height: 50px;
            position: fixed; top: 60px; z-index: 1900;
            border-bottom: 1px solid #e6e6e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-inner { max-width: 1200px; margin: 0 auto; height: 100%; display: flex; align-items: center; padding: 0 20px; overflow-x: auto; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 20px;
            font-size: 0.9rem; font-weight: bold; color: var(--lh-navy); cursor: pointer;
            border-bottom: 4px solid transparent; transition: 0.2s; white-space: nowrap;
        }
        .nav-btn:hover { color: var(--lh-yellow-hov); }
        .nav-btn.active { border-bottom-color: var(--lh-yellow); }
        body.dark-mode .nav-btn { color: #ccc; } body.dark-mode .nav-btn.active { color: white; border-bottom-color: var(--lh-yellow); }

        /* === CONTENT LAYOUT === */
        .container { max-width: 1200px; margin: 140px auto 40px auto; padding: 0 20px; flex: 1; }
        
        .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        
        /* CARD STYLE (Lufthansa Clean) */
        .card {
            background: var(--lh-card); border-radius: var(--radius); padding: 30px;
            border: 1px solid #dcdcdc; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        body.dark-mode .card { border-color: var(--lh-border); }
        
        h2 { font-weight: 300; font-size: 1.8rem; margin-bottom: 25px; color: var(--lh-navy); }
        body.dark-mode h2 { color: white; }
        
        /* === CONTROLS & INPUTS === */
        .label { display: block; font-size: 0.85rem; font-weight: bold; color: var(--lh-text); margin-bottom: 8px; }
        .inp {
            width: 100%; padding: 12px; border: 1px solid #898989; border-radius: 4px;
            font-size: 1rem; margin-bottom: 20px; background: white; color: black;
        }
        .inp:focus { outline: 2px solid var(--lh-navy); border-color: transparent; }
        
        /* BUTTONS (Yellow Corporate) */
        .btn {
            width: 100%; padding: 12px 20px; border: none; border-radius: 4px;
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--lh-navy); color: white;
        }
        .btn-y { background: var(--lh-yellow); color: var(--lh-navy); } /* Primary Action */
        .btn-y:hover { background: var(--lh-yellow-hov); }
        .btn-red { background: #d50000; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--lh-navy); color: var(--lh-navy); }

        /* === LOGIN SCREEN (Based on Image) === */
        #login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000;
            background: white; display: flex; flex-direction: column;
        }
        .login-header { height: 80px; padding: 0 5%; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .login-logo { height: 30px; }
        .login-body { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding-top: 60px; background: #f9f9f9; }
        .login-card {
            background: white; padding: 40px; width: 100%; max-width: 480px;
            border: 1px solid #e0e0e0; border-radius: 4px;
        }
        .login-h { font-size: 1.8rem; margin-bottom: 10px; font-weight: 300; color: #05164d; }
        .login-sub { font-size: 0.9rem; margin-bottom: 30px; color: #333; }
        .login-inp { border:none; border-bottom: 1px solid #333; border-radius:0; padding: 10px 0; background: transparent; }
        .login-inp:focus { outline:none; border-bottom: 2px solid #05164d; }

        /* === MODULES === */
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--lh-card); border: 1px solid #ddd; padding: 25px; text-align: center; border-radius: 4px; }
        .stat-val { font-size: 2.5rem; font-weight: 300; color: var(--lh-navy); }
        .stat-lbl { font-size: 0.8rem; text-transform: uppercase; color: #666; margin-top: 5px; letter-spacing: 1px; }

        /* Active Flight Card */
        .af-card { border-left: 6px solid var(--lh-yellow); }
        .af-route { font-size: 2rem; font-weight: 300; color: var(--lh-navy); }
        .bar-bg { height: 6px; background: #e6e6e6; margin: 25px 0; border-radius: 3px; }
        .bar-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }
        
        /* Games (Minimalist Dark) */
        .game-area { background: #1a1a1a; padding: 20px; border-radius: 8px; color: white; text-align: center; margin-top: 20px; }
        canvas { border: 1px solid #444; margin: 0 auto; display: block; }

        /* Footer */
        footer { background: var(--lh-navy); color: white; padding: 40px 5%; margin-top: auto; }
        .foot-links { display: flex; gap: 30px; font-size: 0.9rem; font-weight: bold; }
        
        /* Mobile */
        @media (max-width: 850px) {
            .grid-layout { grid-template-columns: 1fr; }
            .container { margin-top: 120px; }
            .stats-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-wrap">
        <div class="login-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Lufthansa_Logo_2018.svg/1200px-Lufthansa_Logo_2018.svg.png" class="login-logo">
        </div>
        <div class="login-body">
            <div class="login-card">
                <div class="login-h">Login</div>
                <div class="login-sub">Please enter your servicecard number or Travel ID.</div>
                
                <div style="margin-bottom: 25px;">
                    <input type="text" id="callsign" class="inp login-inp" placeholder="Travel ID / Callsign">
                </div>
                <div style="margin-bottom: 35px;">
                    <input type="password" id="password" class="inp login-inp" placeholder="Password">
                </div>

                <button class="btn btn-y" onclick="doLogin()">Next</button>
                <div style="margin-top:20px; font-size:0.85rem; color:#666;">
                    <p id="login-err" style="color:#d50000; font-weight:bold;"></p>
                    <br>Forgot your PIN or password?
                </div>
            </div>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo">
        <div class="user-panel">
            <span id="clock" style="font-family:'Roboto Mono'; opacity:0.8;">00:00 Z</span>
            <span style="font-weight:bold; margin-left:15px;">Capt. User</span>
            <span onclick="toggleTheme()" style="cursor:pointer; margin-left:15px; font-size:1.2rem;">‚óë</span>
        </div>
    </header>

    <div class="nav-wrap hidden" id="nav-bar">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="tab('dash', this)">Dashboard</button>
            <button class="nav-btn" onclick="tab('fleet', this)">Fleet</button>
            <button class="nav-btn" onclick="tab('routes', this)">Schedule</button>
            <button class="nav-btn" onclick="tab('dispatch', this)">Dispatch</button>
            <button class="nav-btn" onclick="tab('games', this)">Rest Area</button>
        </div>
    </div>

    <div class="container hidden" id="main-app">
        
        <div id="tab-dash" class="tab-content">
            <div class="card" style="padding: 20px;">
                <h3 style="margin:0; font-weight:bold; color:var(--lh-navy);">Captain's Logbook</h3>
            </div>

            <div class="stats-row">
                <div class="stat-box"><div class="stat-val" id="st-fl">0</div><div class="stat-lbl">Legs Flown</div></div>
                <div class="stat-box"><div class="stat-val" id="st-hr">0</div><div class="stat-lbl">Total Hours</div></div>
                <div class="stat-box"><div class="stat-val" id="st-rk" style="color:var(--lh-yellow)">-</div><div class="stat-lbl">Rank</div></div>
            </div>

            <div class="grid-layout">
                <div>
                    <div id="af-card" class="card af-card hidden">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div>
                                <div style="font-size:0.75rem; font-weight:bold; color:#999; margin-bottom:5px;">ACTIVE FLIGHT</div>
                                <div class="af-route"><span id="af-dep"></span> &#8594; <span id="af-arr"></span></div>
                                <div style="font-family:'Roboto Mono'; margin-top:5px; font-weight:bold;"><span id="af-num"></span> &bull; <span id="af-ac"></span></div>
                            </div>
                            <div style="text-align:right;">
                                <div id="af-timer" style="font-size:1.6rem; font-weight:300; color:var(--lh-navy);">00:00</div>
                                <div style="font-size:0.7rem; color:#999;">REMAINING</div>
                            </div>
                        </div>
                        <div class="bar-bg"><div id="af-bar" class="bar-fill"></div></div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-y hidden" id="btn-pirep" onclick="finishFlight()" style="width:auto;">FILE PIREP</button>
                            <button class="btn btn-red" onclick="cancelFlight()" style="width:auto;">CANCEL FLIGHT</button>
                        </div>
                    </div>

                    <div id="mission-box" class="card" style="background:#05164d; color:white;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <span style="background:#ffb600; color:#05164d; padding:3px 8px; border-radius:2px; font-weight:bold; font-size:0.75rem;">DAILY MISSION</span>
                            <span id="mis-date" style="font-size:0.8rem; opacity:0.7;"></span>
                        </div>
                        <div id="mis-txt" style="font-size:1.4rem; font-weight:300; margin-bottom:20px;">Loading...</div>
                        <button class="btn" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); width:auto;" onclick="acceptMission()">Create This Flight</button>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h4 style="margin:0; color:var(--lh-navy);">Operational Notices</h4>
                        <span style="background:#05164d; color:white; font-size:0.6rem; padding:2px 5px;">ALL NEWS</span>
                    </div>
                    <div id="news-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-content hidden">
            <div class="card">
                <h2>Fleet Overview</h2>
                <div style="margin-bottom:20px;">
                    <span class="label">Filter Airline</span>
                    <select id="fl-filter" class="inp" onchange="renderFleet()" style="max-width:300px;"><option value="ALL">All Operators</option></select>
                </div>
                <div id="fleet-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
            </div>
        </div>

        <div id="tab-routes" class="tab-content hidden">
            <div class="card">
                <h2>Flight Schedule</h2>
                <div class="grid-layout" style="margin-bottom:20px;">
                    <div><span class="label">Airline</span><select id="sch-al" class="inp" onchange="renderSchedule()"></select></div>
                    <div><span class="label">Flight Duration</span><select id="sch-tm" class="inp" onchange="renderSchedule()">
                        <option value="ALL">Show All</option>
                        <option value="1-2">1-2 Hours</option>
                        <option value="3-4">3-4 Hours</option>
                        <option value="5-6">5-6 Hours</option>
                        <option value="7-8">7-8 Hours</option>
                        <option value="9-10">9-10 Hours</option>
                        <option value="10+">10+ Hours</option>
                    </select></div>
                </div>
                <div id="sch-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:20px;"></div>
            </div>
        </div>

        <div id="tab-dispatch" class="tab-content hidden">
            <div class="card" style="max-width:600px; margin:0 auto;">
                <h2>Flight Dispatcher</h2>
                <p style="color:#666; margin-bottom:20px;">Generate a random flight plan based on criteria.</p>
                
                <span class="label">Operator</span>
                <select id="gen-al" class="inp" onchange="updateHubs()"></select>
                
                <span class="label">Departure Hub</span>
                <select id="gen-hub" class="inp" disabled></select>
                
                <span class="label">Target Duration</span>
                <select id="gen-tm" class="inp">
                    <option value="ALL">Any Duration</option>
                    <option value="1-2">Short (1-2 Hours)</option>
                    <option value="3-4">Medium (3-4 Hours)</option>
                    <option value="5-6">Long (5-6 Hours)</option>
                    <option value="10+">Ultra Long (10+ Hours)</option>
                </select>
                
                <button class="btn btn-y" onclick="generate()">Generate OFP</button>
            </div>
        </div>

        <div id="tab-games" class="tab-content hidden">
            <div class="card" style="max-width:800px; margin:0 auto;">
                <h2>Rest Area</h2>
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button class="btn btn-outline" onclick="startGamePlane()">‚úàÔ∏è Sky Aviator</button>
                    <button class="btn btn-outline" onclick="startGameSnake()">üêç Snake</button>
                    <button class="btn btn-outline" onclick="startGameTetris()">üì¶ Cargo Tetris</button>
                </div>

                <div id="game-ui-plane" class="hidden">
                    <div class="game-area">
                        <h3 style="margin-bottom:10px;">Sky Aviator</h3>
                        <canvas id="cvs-plane"></canvas>
                        <div id="score-plane" style="font-size:1.5rem; color:var(--lh-yellow); margin-top:10px;">Score: 0</div>
                        <p style="font-size:0.8rem; color:#999; margin-top:5px;">Tap or Click to fly</p>
                        <button class="btn btn-red" style="width:auto; margin-top:15px;" onclick="stopGame('plane')">Exit</button>
                    </div>
                </div>

                <div id="game-ui-snake" class="hidden">
                    <div class="game-area">
                        <h3 style="margin-bottom:10px;">Runway Snake</h3>
                        <canvas id="cvs-snake"></canvas>
                        <div id="score-snake" style="font-size:1.5rem; color:var(--lh-yellow); margin-top:10px;">Score: 0</div>
                        <p style="font-size:0.8rem; color:#999; margin-top:5px;">Click edges/Arrows to turn</p>
                        <button class="btn btn-red" style="width:auto; margin-top:15px;" onclick="stopGame('snake')">Exit</button>
                    </div>
                </div>

                <div id="game-ui-tetris" class="hidden">
                    <div class="game-area">
                        <h3 style="margin-bottom:10px;">Cargo Loader</h3>
                        <canvas id="cvs-tetris"></canvas>
                        <div id="score-tetris" style="font-size:1.5rem; color:var(--lh-yellow); margin-top:10px;">Score: 0</div>
                        <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
                            <button class="btn" style="width:50px;" onclick="tetrisInput('l')">‚Üê</button>
                            <button class="btn" style="width:50px;" onclick="tetrisInput('d')">‚Üì</button>
                            <button class="btn" style="width:50px;" onclick="tetrisInput('r')">‚Üí</button>
                            <button class="btn btn-y" style="width:50px;" onclick="tetrisInput('rot')">‚ü≥</button>
                        </div>
                        <button class="btn btn-red" style="width:auto; margin-top:15px;" onclick="stopGame('tetris')">Exit</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <footer>
        <div class="foot-links">
            <span>Help & Contact</span>
            <span>Imprint</span>
            <span>Terms of Use</span>
            <span>Data Protection</span>
            <span>Corporate</span>
        </div>
        <div style="margin-top:20px; font-size:0.8rem; opacity:0.6;">
            &copy; 2024 Lufthansa Systems. Internal use only.
        </div>
    </footer>

    <div id="modal-brief" class="modal hidden">
        <div class="modal-c">
            <div style="border-bottom:2px solid var(--lh-navy); padding-bottom:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--lh-navy);">OFP GENERATION</h3>
                <span id="br-num" style="font-weight:bold; font-size:1.2rem;"></span>
            </div>
            
            <div class="briefing-grid">
                <div><div class="label">DEPARTURE</div><span id="br-dep" style="font-weight:bold;"></span></div>
                <div><div class="label">ARRIVAL</div><span id="br-arr" style="font-weight:bold;"></span></div>
                <div><div class="label">AIRCRAFT</div><span id="br-ac" style="font-weight:bold;"></span></div>
                <div><div class="label">GATE (DEP)</div><span id="br-gate" style="font-family:'Roboto Mono';"></span></div>
                <div><div class="label">ETE</div><span id="br-time" style="font-family:'Roboto Mono';"></span></div>
                <div><div class="label">ZFW (EST)</div><span id="br-zfw" style="font-family:'Roboto Mono';"></span></div>
                <div><div class="label">FLIGHT LEVEL</div><span id="br-fl" style="font-family:'Roboto Mono';"></span></div>
                <div><div class="label">PAX</div><span id="br-pax" style="font-family:'Roboto Mono';"></span></div>
            </div>
            
            <div id="map"></div>
            
            <div style="margin-top:20px; display:flex; gap:15px;">
                <button class="btn btn-y" onclick="acceptBriefing()">ACCEPT FLIGHT</button>
                <button class="btn" style="background:#e0e0e0; color:#333;" onclick="document.getElementById('modal-brief').classList.add('hidden')">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // === RESTORED LOGIC FROM V56/59 ===
        const DB = {
            login: { u: "DLH001", p: "1234" },
            news: [{t:"System Update v60", d:"New Corporate Design applied."}, {t:"Winter Operations", d:"De-icing required when temp < 3¬∞C."}],
            fleet: [
                { type: "Airbus A320neo", cat: "S", seats: 180, range: 6, operators: ["Lufthansa", "Eurowings", "Austrian", "SAS"] },
                { type: "Boeing 747-8", cat: "L", seats: 364, range: 14, operators: ["Lufthansa"] },
                { type: "Airbus A350-900", cat: "L", seats: 293, range: 16, operators: ["Lufthansa", "SAS"] },
                { type: "Airbus A220", cat: "S", seats: 145, range: 6, operators: ["SWISS", "AirBaltic"] }
            ],
            hubs: { "Lufthansa": ["EDDF", "EDDM"], "SWISS": ["LSZH"], "Austrian": ["LOWW"], "Eurowings": ["EDDL"], "SAS": ["EKCH"], "AirBaltic": ["EVRA"] },
            routes: {
                "Lufthansa": [ {c:"EGLL",t:1.5}, {c:"CDG",t:1.2}, {c:"MAD",t:2.5}, {c:"DXB",t:6.0}, {c:"KJFK",t:8.5}, {c:"KLAX",t:11.5}, {c:"RJTT",t:12.0}, {c:"EZE",t:13.5} ],
                "SWISS": [ {c:"LHR",t:1.8}, {c:"JFK",t:8.5}, {c:"SIN",t:12.0} ],
                "Austrian": [ {c:"FRA",t:1.1}, {c:"BKK",t:10.5}, {c:"LHR",t:2.2} ],
                "Eurowings": [ {c:"PMI",t:2.2}, {c:"LHR",t:1.4} ],
                "SAS": [ {c:"LHR",t:1.9}, {c:"EWR",t:8.8} ],
                "AirBaltic": [ {c:"HEL",t:0.8}, {c:"DXB",t:6.5} ]
            }
        };
        const COORDS = { "EDDF":[50,8], "EDDM":[48,11], "LSZH":[47,8], "LOWW":[48,16], "KJFK":[40,-73], "EGLL":[51,-0], "KLAX":[34,-118], "RJTT":[35,139], "DXB":[25,55], "EZE":[-34,-58], "CDG":[49,2], "MAD":[40,-3], "PMI":[39,2], "HEL":[60,24], "SIN":[1,103], "BKK":[13,100] };

        let stats = JSON.parse(localStorage.getItem('stats')) || { fl:0, hr:0 };
        let tempFlight=null, mapObject=null, missionFlight=null, timer=null;

        window.onload = () => {
            if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
            setInterval(() => { const d=new Date(); document.getElementById('clock').innerText=`${String(d.getUTCHours()).padStart(2,0)}:${String(d.getUTCMinutes()).padStart(2,0)} Z`; }, 1000);
            renderUI(); checkFlight(); generateDailyMission();
            initGames();
        };

        // --- AUTH ---
        function doLogin(){
            if(document.getElementById('callsign').value.toUpperCase()===DB.login.u && document.getElementById('password').value===DB.login.p){
                document.getElementById('login-wrap').classList.add('hidden');
                document.getElementById('nav-bar').classList.remove('hidden');
                document.getElementById('main-app').classList.remove('hidden');
            } else document.getElementById('login-err').innerText="The credentials you entered are incorrect.";
        }
        function tab(n,b){
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden'));
            document.getElementById('tab-'+n).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            if(b)b.classList.add('active');
        }

        // --- LOGIC ---
        function generateGate(){return (Math.random()>0.5?'A':'B')+Math.floor(Math.random()*40+1);}
        function checkDuration(t,f){if(f==='ALL')return true;if(f==='1-2')return t>=1&&t<3;if(f==='3-4')return t>=3&&t<5;if(f==='5-6')return t>=5&&t<7;if(f==='7-8')return t>=7&&t<9;if(f==='9-10')return t>=9&&t<11;if(f==='10+')return t>=10;return false;}
        function getSmartPlane(al,t){const cat=t>5?'L':'S';let p=DB.fleet.filter(f=>f.operators.includes(al)&&f.cat===cat);if(!p.length)p=DB.fleet.filter(f=>f.operators.includes(al));return p.length?p[Math.floor(Math.random()*p.length)]:null;}
        
        function renderUI() {
            document.getElementById('st-fl').innerText=stats.fl; document.getElementById('st-hr').innerText=Math.floor(stats.hr);
            document.getElementById('st-rk').innerText=stats.fl>20?"Captain":(stats.fl>5?"First Officer":"Second Officer");
            const sA=document.getElementById('sch-al'), sD=document.getElementById('gen-al'), fF=document.getElementById('fl-filter');
            sA.innerHTML=''; sD.innerHTML='<option value="">-- Operator --</option>'; fF.innerHTML='<option value="ALL">All Operators</option>';
            Object.keys(DB.hubs).forEach(a=>{sA.add(new Option(a,a)); sD.add(new Option(a,a)); fF.add(new Option(a,a));});
            document.getElementById('news-list').innerHTML=DB.news.map(n=>`<div style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee;"><strong>${n.t}</strong><div style="font-size:0.9rem; color:#666;">${n.d}</div></div>`).join('');
            renderFleet(); renderSchedule();
        }

        function renderFleet() {
            const v=document.getElementById('fl-filter').value, c=document.getElementById('fleet-list'); c.innerHTML='';
            DB.fleet.filter(f=>v==='ALL'||f.operators.includes(v)).forEach(f=>c.innerHTML+=`<div class="card" style="margin:0; padding:20px;"><h4>${f.type}</h4><div style="font-size:0.9rem;">${f.seats} Pax | ${f.range}h Range</div></div>`);
        }

        function renderSchedule() {
            const al=document.getElementById('sch-al').value, tf=document.getElementById('sch-tm').value, g=document.getElementById('sch-list');
            if(!DB.routes[al]) { g.innerHTML="No routes"; return; }
            const res=DB.routes[al].filter(r=>checkDuration(r.t, tf));
            g.innerHTML=res.length?res.map(r=>`<div class="card" style="margin:0; border-left:4px solid var(--lh-navy); display:flex; justify-content:space-between; align-items:center;"><div><strong>${DB.hubs[al][0]} &#8594; ${r.c}</strong><br><small style="color:#666;">Duration: ${r.t}h</small></div><button class="btn btn-y" style="width:auto; padding:8px 15px;" onclick="prep('${al}','${DB.hubs[al][0]}','${r.c}',${r.t})">SELECT</button></div>`).join(''):"No flights found.";
        }

        function prep(al,d,a,t) {
            const p=getSmartPlane(al,t); if(!p){alert("No aircraft available");return;}
            tempFlight={dep:d,arr:a,time:t,ac:p.type,num:"LH"+Math.floor(Math.random()*8999+1000),pax:Math.floor(p.seats*0.85),zfw:"48.5T",gate:generateGate(),fl:"FL360"};
            ['dep','arr','time','ac','num','pax','zfw','gate','fl'].forEach(k=>document.getElementById('br-'+k).innerText=tempFlight[k]||(k=='time'?tempFlight.time+'h':''));
            document.getElementById('modal-brief').classList.remove('hidden');
            setTimeout(()=>{
                if(mapObject)mapObject.remove(); mapObject=L.map('map').setView([50,10],3);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapObject);
                const c1=COORDS[d]||[50,10], c2=COORDS[a]||[40,-70];
                L.polyline([c1,c2],{color:'#05164d', weight:3}).addTo(mapObject);
            },200);
        }

        function generate(){
            const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
            if(!al||!h)return;
            const r=DB.routes[al].filter(x=>checkDuration(x.t,tm));
            if(!r.length){alert("No routes match duration");return;}
            const s=r[Math.floor(Math.random()*r.length)];
            prep(al,h,s.c,s.t);
        }
        function updateHubs(){const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub'); h.innerHTML=''; if(al){h.disabled=false;DB.hubs[al].forEach(x=>h.add(new Option(x,x)));}else h.disabled=true;}
        function acceptBriefing(){tempFlight.start=Date.now(); localStorage.setItem('active',JSON.stringify(tempFlight)); document.getElementById('modal-brief').classList.add('hidden'); checkFlight(); tab('dash');}
        
        function checkFlight(){
            const s=localStorage.getItem('active');
            if(!s){document.getElementById('af-card').classList.add('hidden'); document.getElementById('mission-box').classList.remove('hidden'); return;}
            document.getElementById('af-card').classList.remove('hidden'); document.getElementById('mission-box').classList.add('hidden');
            const f=JSON.parse(s);
            ['dep','arr','num','ac'].forEach(k=>document.getElementById('af-'+k).innerText=f[k]);
            if(timer)clearInterval(timer);
            timer=setInterval(()=>{
                const el=Date.now()-f.start, dur=f.time*10000, pct=Math.min(100,(el/dur)*100);
                document.getElementById('af-bar').style.width=pct+"%";
                document.getElementById('af-timer').innerText=pct>=100?"ARRIVED":"IN FLIGHT";
                if(pct>=100) document.getElementById('btn-pirep').classList.remove('hidden');
            },1000);
        }
        function finishFlight(){const f=JSON.parse(localStorage.getItem('active')); stats.fl++; stats.hr+=f.time; localStorage.setItem('stats',JSON.stringify(stats)); localStorage.removeItem('active'); checkFlight(); renderUI();}
        function cancelFlight(){localStorage.removeItem('active'); checkFlight();}
        function generateDailyMission(){const s=new Date().getDate(), al="Lufthansa", r=DB.routes[al][s%DB.routes[al].length]; missionFlight={al,dep:DB.hubs[al][0],arr:r.c,t:r.t}; document.getElementById('mis-date').innerText=new Date().toLocaleDateString(); document.getElementById('mis-txt').innerText=`${missionFlight.dep} -> ${r.c}`; }
        function acceptMission(){prep(missionFlight.al,missionFlight.dep,missionFlight.arr,missionFlight.t);}
        function toggleTheme(){document.body.classList.toggle('dark-mode'); localStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light');}

        // --- GAME LOGIC (RESTORED V56) ---
        let pg={act:false,ctx:null,w:0,h:0,y:150,v:0,cl:[],sc:0,run:false};
        let sg={act:false,ctx:null,w:0,h:0,sn:[],fd:{},dx:20,dy:0,sc:0};
        let tg={act:false,ctx:null,bd:[],cur:null,sc:0,w:10,h:20,bs:30};

        function initGames() {
            const pc=document.getElementById('cvs-plane'); const jump=(e)=>{e.preventDefault(); if(pg.act){pg.run=true; pg.v=-4;}}; pc.addEventListener('mousedown',jump); pc.addEventListener('touchstart',jump);
            const sc=document.getElementById('cvs-snake'); sc.addEventListener('mousedown',(e)=>{
                if(!sg.act)return; const r=sc.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
                if(x<sg.w*0.3&&sg.dx===0){sg.dx=-20;sg.dy=0;} else if(x>sg.w*0.7&&sg.dx===0){sg.dx=20;sg.dy=0;}
                else if(y<sg.h*0.3&&sg.dy===0){sg.dy=-20;sg.dx=0;} else if(y>sg.h*0.7&&sg.dy===0){sg.dy=20;sg.dx=0;}
            });
        }

        function stopGame(t) {
            document.getElementById('game-ui-'+t).classList.add('hidden');
            if(t=='plane')pg.act=false; if(t=='snake')sg.act=false; if(t=='tetris')tg.act=false;
        }

        function startGamePlane() {
            const c=document.getElementById('cvs-plane'); pg.ctx=c.getContext('2d'); pg.w=c.width=300; pg.h=c.height=400;
            pg.y=200; pg.v=0; pg.cl=[]; pg.sc=0; pg.act=true; pg.run=false;
            document.getElementById('game-ui-plane').classList.remove('hidden'); loopPlane();
        }
        function loopPlane() {
            if(!pg.act)return; const ctx=pg.ctx; ctx.clearRect(0,0,pg.w,pg.h); ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,pg.w,pg.h);
            if(pg.run){ pg.v+=0.15; pg.y+=pg.v; if(pg.sc%100===0 && Math.random()<0.05)pg.cl.push({x:pg.w,y:Math.random()*350,w:30,h:30}); }
            else { pg.y=200+Math.sin(Date.now()/300)*5; ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText("TAP TO FLY",150,240); }
            ctx.save(); ctx.translate(50,pg.y+10); ctx.rotate(Math.min(0.5,Math.max(-0.5,pg.v*0.1))); ctx.fillStyle="#ffb600"; ctx.fillRect(-15,-10,30,20); ctx.restore();
            pg.cl.forEach((c,i)=>{c.x-=2; ctx.fillStyle='red'; ctx.fillRect(c.x,c.y,c.w,c.h); if(c.x<-30){pg.cl.splice(i,1); pg.sc++; document.getElementById('score-plane').innerText="Score: "+pg.sc;} if(50>c.x && 50<c.x+c.w && pg.y>c.y && pg.y<c.y+c.h) pg.run=false; });
            if(pg.y<0||pg.y>pg.h) pg.run=false;
            requestAnimationFrame(loopPlane);
        }

        function startGameSnake() {
            const c=document.getElementById('cvs-snake'); sg.ctx=c.getContext('2d'); sg.w=c.width=300; sg.h=c.height=400;
            sg.sn=[{x:100,y:100}]; sg.dx=20; sg.dy=0; sg.sc=0; sg.act=true; sg.fd={x:140,y:140};
            document.getElementById('game-ui-snake').classList.remove('hidden'); setTimeout(loopSnake,100);
        }
        function loopSnake() {
            if(!sg.act)return; const h={x:sg.sn[0].x+sg.dx, y:sg.sn[0].y+sg.dy}; sg.sn.unshift(h);
            if(h.x==sg.fd.x && h.y==sg.fd.y){sg.sc++; document.getElementById('score-snake').innerText="Score: "+sg.sc; sg.fd={x:Math.floor(Math.random()*15)*20, y:Math.floor(Math.random()*20)*20};} else sg.sn.pop();
            if(h.x<0||h.x>=300||h.y<0||h.y>=400) sg.act=false;
            const ctx=sg.ctx; ctx.fillStyle="#222"; ctx.fillRect(0,0,300,400); ctx.fillStyle="lime"; sg.sn.forEach(p=>ctx.fillRect(p.x,p.y,18,18)); ctx.fillStyle="red"; ctx.fillRect(sg.fd.x,sg.fd.y,18,18);
            setTimeout(loopSnake,100);
        }

        function startGameTetris() {
            const c=document.getElementById('cvs-tetris'); tg.ctx=c.getContext('2d'); tg.w=c.width=200; tg.h=c.height=400; tg.bs=20;
            tg.bd=Array(20).fill().map(()=>Array(10).fill(0)); tg.sc=0; tg.act=true; spawnT();
            document.getElementById('game-ui-tetris').classList.remove('hidden'); updateT();
        }
        const SH=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]]];
        function spawnT(){tg.cur={m:SH[Math.floor(Math.random()*SH.length)],x:3,y:0}; if(collT())tg.act=false;}
        function collT(){return tg.cur.m.some((r,dy)=>r.some((v,dx)=>v&&(tg.cur.y+dy>=20||tg.cur.x+dx<0||tg.cur.x+dx>=10||tg.bd[tg.cur.y+dy][tg.cur.x+dx])));}
        function updateT(){
            if(!tg.act)return; tg.cur.y++; if(collT()){tg.cur.y--; tg.cur.m.forEach((r,dy)=>r.forEach((v,dx)=>{if(v)tg.bd[tg.cur.y+dy][tg.cur.x+dx]=1;})); 
            tg.bd=tg.bd.filter(r=>r.some(v=>!v)); while(tg.bd.length<20)tg.bd.unshift(Array(10).fill(0)); tg.sc+=10; document.getElementById('score-tetris').innerText="Score: "+tg.sc; spawnT();}
            const ctx=tg.ctx; ctx.fillStyle="#000"; ctx.fillRect(0,0,200,400); 
            const dr=(m,ox,oy,c)=>m.forEach((r,y)=>r.forEach((v,x)=>{if(v){ctx.fillStyle=c; ctx.fillRect((x+ox)*20,(y+oy)*20,19,19);}}));
            dr(tg.bd,0,0,'gray'); dr(tg.cur.m,tg.cur.x,tg.cur.y,'cyan');
            setTimeout(updateT,300);
        }
        function tetrisInput(k){
            if(!tg.act)return; if(k=='l')tg.cur.x--; if(k=='r')tg.cur.x++; if(k=='d')tg.cur.y++; 
            if(collT()){if(k=='l')tg.cur.x++; if(k=='r')tg.cur.x--; if(k=='d')tg.cur.y--;}
        }
    </script>
</body>
</html>
