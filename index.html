<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lufthansa Group Virtual — Pilots & Flights</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg-1:#041528; --bg-2:#073044; --accent:#ffd700; --muted:#9fb6d6; --text:#eaf4ff;
  --card:#072033; --shadow:0 14px 40px rgba(2,8,20,0.6); --radius:12px;
  --ok:#bff2be; --warn:#fff0b8; --reserved:#c8b7ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);padding:18px;display:flex;justify-content:center}
.wrap{width:100%;max-width:1200px}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#03243a,#063a59);box-shadow:var(--shadow)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:52px;height:52px;border-radius:8px;background:linear-gradient(180deg,#063a59,#012938);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
h1{margin:0;color:var(--accent)}
.small{font-size:13px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}
.card{padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card),#043044);box-shadow:var(--shadow)}
.section-title{font-weight:900;color:var(--accent);margin:0}
.input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer}
.btn-ghost{border:1px solid rgba(255,255,255,0.06)}
.btn-primary{background:var(--accent);color:#04202a;font-weight:800}
.pilot-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.pilot-row{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.tag{background:var(--accent);color:#04202a;padding:4px 8px;border-radius:999px;font-weight:800}
.muted{color:var(--muted)}
.pilot-meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
.log{margin-top:10px;padding:10px;border-radius:8px;background:linear-gradient(180deg,#021923,#062733);border:1px solid rgba(255,255,255,0.03);max-height:220px;overflow:auto}
.confirmed-card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#062733,#043c45);border:1px solid rgba(255,255,255,0.04)}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.search-inline{display:flex;gap:8px;align-items:center}
.small-muted{font-size:12px;color:var(--muted)}
.csv-btn{margin-left:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <div class="logo">LH</div>
        <div>
          <h1>Lufthansa Group Virtual</h1>
          <div class="small">Пилоты и журнал рейсов — демо</div>
        </div>
      </div>
      <div>
        <button id="resetAll" class="btn btn-ghost">Сброс данных</button>
      </div>
    </header>

    <section class="card" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 class="section-title">Генерация рейса и подтверждение</h2>
          <div class="small-muted">Теперь можно назначать пилота при подтверждении</div>
        </div>
        <div class="small muted">Демо-данные</div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <h3 style="margin:0">Авиакомпания и длительность</h3>
            <div id="airlines" style="margin-top:8px"></div>
            <div id="durations" style="margin-top:10px;display:flex;gap:8px"></div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
              <button id="gen" class="btn btn-primary">Сгенерировать и зарезервировать</button>
              <button id="demo" class="btn btn-ghost">Демо</button>
              <button id="reset" class="btn btn-ghost">Сброс</button>
              <div style="flex:1"></div>
              <div class="small">Выбрано: <strong id="selectedInfo">—</strong></div>
            </div>

            <div id="result" style="margin-top:12px;display:none"></div>
          </div>

          <div id="confirmedSection"></div>
        </div>

        <aside>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,#041f2a,#03222a);border:1px solid rgba(255,255,255,0.03)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><div style="font-weight:900">Пилоты</div><div class="small-muted" style="margin-top:6px">Регистрируй и управляй пилотами</div></div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="exportCSV" class="btn btn-ghost csv-btn">Экспорт CSV</button>
              </div>
            </div>

            <div style="margin-top:10px">
              <form id="pilotForm" onsubmit="return false;">
                <div style="display:flex;gap:8px;margin-bottom:8px">
                  <input id="pilotName" class="input" placeholder="Имя" required />
                  <input id="pilotCall" class="input" placeholder="Позывной" required />
                </div>
                <div style="display:flex;gap:8px;margin-bottom:8px">
                  <input id="pilotRank" class="input" placeholder="Рейтинг (например: ATPL)" />
                  <input id="pilotBase" class="input" placeholder="Базовый аэропорт (ICAO)" />
                </div>
                <div style="display:flex;gap:8px">
                  <button id="addPilot" class="btn btn-primary">Добавить пилота</button>
                  <button id="clearForm" class="btn btn-ghost">Очистить</button>
                </div>
              </form>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <input id="pilotSearch" class="input" placeholder="Поиск по имени или позывному" />
              <select id="pilotFilterBase" class="input" style="width:140px">
                <option value="all">Все базы</option>
              </select>
            </div>

            <div id="pilotList" class="pilot-list"></div>
            <div id="pilotEmpty" class="small-muted" style="margin-top:8px">Пилотов ещё нет</div>
          </div>

          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03);margin-top:12px">
            <h3 style="margin:0">Журнал назначений</h3>
            <div id="assignLog" class="log small" style="margin-top:8px">Пока пусто</div>
          </div>
        </aside>
      </div>
    </section>
  </div>

<script>
/* ---------------- ПЕРВОНАЧАЛЬНЫЕ ДАННЫЕ (ROUTES, AIRLINES, FLEET) ---------------- */
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Lufthansa Technik", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Milan", toICAO:"LIMC", durationMinutes:95 },
  { airline: "Lufthansa Cargo", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Dubai", toICAO:"OMDB", durationMinutes:420 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 }
];
const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] },
  { name: "Lufthansa Cargo", hubs: ["EDDF"] },
  { name: "Lufthansa Technik", hubs: ["EDDF"] }
];
const FLEET = [
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF' },
  { id:'LH-A321-02', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF' },
  { id:'EW-A320-01', airline:'Eurowings', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDM' },
  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDF' }
];
const AIRPORTS = { "EDDF":{city:'Frankfurt'}, "EDDM":{city:'Munich'}, "ENGM":{city:'Oslo'}, "EHAM":{city:'Amsterdam'}, "LTAI":{city:'Antalya'}, "LIMC":{city:'Milan'}, "OMDB":{city:'Dubai'}, "LSZH":{city:'Zurich'} };

/* ---------------- ХРАНИЛИЩЕ ПИЛОТОВ И ЖУРНАЛ ----------------
   В демо данные хранятся в памяти; для простоты ключи: pilot.id, flights[] в логах
*/
let PILOTS = []; // { id, name, callSign, rank, baseICAO, createdAt }
let PILOT_LOG = []; // { ts, pilotId, aircraftId, route, durationMin, note }

/* ---------------- Состояние UI ---------------- */
let chosenAirIndex = null;
let chosenDur = null;
let lastGenerated = null; // { route, aircraftId, token }
const LOCAL_USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
const RESERVATION_TTL_MS = 120 * 1000;

/* ---------------- УТИЛИТЫ ---------------- */
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function nowMs(){ return Date.now(); }
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

/* ---------------- UI refs ---------------- */
const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const genBtn = document.getElementById('gen');
const demoBtn = document.getElementById('demo');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');
const confirmedSection = document.getElementById('confirmedSection');

const pilotForm = document.getElementById('pilotForm');
const pilotName = document.getElementById('pilotName');
const pilotCall = document.getElementById('pilotCall');
const pilotRank = document.getElementById('pilotRank');
const pilotBase = document.getElementById('pilotBase');
const addPilotBtn = document.getElementById('addPilot');
const clearFormBtn = document.getElementById('clearForm');

const pilotListEl = document.getElementById('pilotList');
const pilotEmpty = document.getElementById('pilotEmpty');
const pilotSearch = document.getElementById('pilotSearch');
const pilotFilterBase = document.getElementById('pilotFilterBase');

const assignLogEl = document.getElementById('assignLog');
const exportCSVBtn = document.getElementById('exportCSV');
const resetAllBtn = document.getElementById('resetAll');

/* ---------------- РЕНДЕР: AIRLINES и DURATIONS ---------------- */
function renderDurations(){
  durationsWrap.innerHTML = '';
  const DURATIONS = [
    {label:"1–2ч",min:60,max:120},
    {label:"3–4ч",min:180,max:240},
    {label:"5–6ч",min:300,max:360},
    {label:"7–8ч",min:420,max:480}
  ];
  DURATIONS.forEach((d,i)=>{
    const b = document.createElement('button'); b.className='btn btn-ghost'; b.textContent=d.label;
    b.addEventListener('click', ()=>{ chosenDur = i; Array.from(durationsWrap.children).forEach((n,idx)=> n.classList.toggle('selected', idx===i)); });
    durationsWrap.appendChild(b);
  });
}
function renderAirlines(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach((a,idx)=>{
    const div = document.createElement('div'); div.style.marginBottom='8px';
    const btn = document.createElement('button'); btn.className='btn btn-ghost'; btn.textContent = a.name;
    btn.addEventListener('click', ()=>{ chosenAirIndex = idx; document.getElementById('selectedInfo').textContent = a.name + ' · ' + a.hubs.join(','); });
    div.appendChild(btn); airlinesWrap.appendChild(div);
  });
}

/* ---------------- ПИЛОТЫ: CRUD и UI ---------------- */
function addPilot({ name, callSign, rank, base }){
  const id = uid('pilot');
  PILOTS.push({ id, name, callSign, rank:rank||'', baseICAO: base||'', createdAt: nowMs() });
  renderPilots();
  return id;
}
function editPilot(id, data){
  const p = PILOTS.find(x=>x.id===id); if(!p) return false;
  Object.assign(p, data); renderPilots(); return true;
}
function removePilot(id){
  PILOTS = PILOTS.filter(p=>p.id!==id);
  // очистим записи PILOT_LOG связанные с удалённым пилотом (в демо)
  PILOT_LOG = PILOT_LOG.filter(l=>l.pilotId !== id);
  renderPilots(); renderPilotFilterOptions(); renderAssignLog();
}
function renderPilots(){
  pilotListEl.innerHTML = '';
  const q = (pilotSearch.value||'').trim().toLowerCase();
  const baseFilter = pilotFilterBase.value;
  const list = PILOTS.filter(p=>{
    if(q){
      const s = (p.name + ' ' + p.callSign).toLowerCase();
      if(!s.includes(q)) return false;
    }
    if(baseFilter && baseFilter !== 'all' && p.baseICAO !== baseFilter) return false;
    return true;
  });
  if(list.length===0){ pilotEmpty.style.display='block'; } else { pilotEmpty.style.display='none'; }
  list.forEach(p=>{
    const row = document.createElement('div'); row.className='pilot-row';
    row.innerHTML = `<div style="min-width:0"><div style="font-weight:900">${esc(p.name)} <span class="small-muted">(${esc(p.callSign)})</span></div><div class="pilot-meta">${esc(p.rank||'—')} · ${esc(p.baseICAO||'—')}</div></div>`;
    const viewBtn = document.createElement('button'); viewBtn.className='btn btn-ghost'; viewBtn.textContent='Просмотр';
    viewBtn.addEventListener('click', ()=> showPilotDetail(p.id));
    const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Ред.';
    editBtn.addEventListener('click', ()=> openEditPilot(p.id));
    const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.textContent='Уд.';
    delBtn.addEventListener('click', ()=> { if(confirm('Удалить пилота?')) removePilot(p.id); });
    row.appendChild(viewBtn); row.appendChild(editBtn); row.appendChild(delBtn);
    pilotListEl.appendChild(row);
  });
}

/* Обновление списка ICAO баз в фильтре (динамически) */
function renderPilotFilterOptions(){
  const bases = Array.from(new Set(PILOTS.map(p=>p.baseICAO).filter(Boolean)));
  pilotFilterBase.innerHTML = '<option value="all">Все базы</option>';
  bases.forEach(b=>{
    const o = document.createElement('option'); o.value=b; o.textContent = b; pilotFilterBase.appendChild(o);
  });
}

/* Показать детальную карточку пилота и его рейсов */
function showPilotDetail(pilotId){
  const p = PILOTS.find(x=>x.id===pilotId); if(!p) return;
  const flights = PILOT_LOG.filter(l=>l.pilotId===pilotId).slice().reverse();
  const el = document.createElement('div'); el.className='confirmed-card';
  el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">${esc(p.name)} <span class="small-muted">(${esc(p.callSign)})</span></div><div class="small-muted">${esc(p.rank||'—')} · ${esc(p.baseICAO||'—')}</div></div><div><button class="btn btn-ghost" id="closePilot">Закрыть</button></div></div>`;
  const flightsHtml = flights.length ? flights.map(f=>`<div style="margin-top:8px"><div style="font-weight:800">${esc(f.route)}</div><div class="small-muted">${new Date(f.ts).toLocaleString()} · ${f.aircraftId} · ${f.durationMin||'—'} мин</div></div>`).join('') : '<div class="small-muted" style="margin-top:8px">Пилот ещё не летал</div>';
  const listWrap = document.createElement('div'); listWrap.innerHTML = flightsHtml;
  el.appendChild(listWrap);
  // вставляем в confirmedSection (показывается под генератором)
  confirmedSection.innerHTML = ''; confirmedSection.appendChild(el);
  document.getElementById('closePilot').addEventListener('click', ()=> { confirmedSection.innerHTML=''; });
}

/* Открыть редактирование пилота (быстрое) */
function openEditPilot(pilotId){
  const p = PILOTS.find(x=>x.id===pilotId); if(!p) return;
  pilotName.value = p.name; pilotCall.value = p.callSign; pilotRank.value = p.rank; pilotBase.value = p.baseICAO;
  addPilotBtn.textContent = 'Сохранить'; addPilotBtn.dataset.editId = pilotId;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* Обработчик формы пилота */
pilotForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const name = pilotName.value.trim(), call = pilotCall.value.trim(), rank = pilotRank.value.trim(), base = pilotBase.value.trim().toUpperCase();
  if(!name || !call){ alert('Введите имя и позывной'); return; }
  const editId = addPilotBtn.dataset.editId;
  if(editId){
    editPilot(editId, { name, callSign:call, rank, baseICAO: base }); addPilotBtn.textContent='Добавить пилота'; delete addPilotBtn.dataset.editId;
  } else {
    addPilot({ name, callSign:call, rank, base });
  }
  pilotForm.reset(); renderPilotFilterOptions();
});
clearFormBtn.addEventListener('click', (e)=>{ e.preventDefault(); pilotForm.reset(); addPilotBtn.textContent='Добавить пилота'; delete addPilotBtn.dataset.editId; });
pilotSearch.addEventListener('input', renderPilots);
pilotFilterBase.addEventListener('change', renderPilots);

/* ---------------- PILOT LOG (запись при подтверждении) ---------------- */
function recordPilotAssignment(pilotId, aircraftId, route){
  const entry = { ts: nowMs(), pilotId, aircraftId, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes };
  PILOT_LOG.push(entry);
  // также в общий FLEET_LOG для видимости
  FLEET_LOG.push(Object.assign({}, entry, { event:'pilot_assigned' }));
  renderAssignLog();
}

/* ---------------- ЖУРНАЛЫ ---------------- */
const FLEET_LOG = []; // уже упоминался выше
function renderAssignLog(){
  const items = FLEET_LOG.slice(-200).reverse();
  if(items.length===0){ assignLogEl.textContent='Пока пусто'; return; }
  assignLogEl.innerHTML = items.map(it=>{
    const t = new Date(it.ts).toLocaleTimeString();
    if(it.event==='assign_confirmed') return `${t} — confirmed ${it.aircraft} ${it.route} (${it.durationMin||'n/a'} min)`;
    if(it.event==='reservation_expired') return `${t} — reservation_expired ${it.aircraft}`;
    if(it.event==='pilot_assigned') return `${t} — pilot_assigned ${it.pilotId} → ${it.aircraft} ${it.route}`;
    if(it.event==='available') return `${t} — available ${it.aircraft} @ ${it.location}`;
    return `${t} — ${it.event || JSON.stringify(it)}`;
  }).map(s=>`<div style="margin-bottom:6px">${esc(s)}</div>`).join('');
}

/* ---------------- РЕЗЕРВЫ / ПОДТВЕРЖДЕНИЕ (упрощённо) ---------------- */
function reserveAircraft(ac, ownerId, ttlMs = RESERVATION_TTL_MS){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved';
  ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  renderFleetView();
  return { ok:true, token: ac.reservedToken };
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  ac.status = 'idle';
  renderFleetView(); renderAssignLog();
  return true;
}
function confirmReservation(token, route, pilotId){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };
  const now = nowMs();
  const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight';
  ac.availableAt = now + durationMs + ac.turnaround*60*1000 || now + durationMs;
  ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes });
  // если указан пилот — привязать запись
  if(pilotId){
    recordPilotAssignment(pilotId, ac.id, route);
  }
  renderFleetView(); renderAssignLog(); renderPilots();
  renderConfirmedFlight(ac, route, pilotId);
  return { ok:true, aircraft: ac };
}

/* ---------------- ИСПОЛЬЗОВАНИЕ: генерация рейса и резерв ---------------- */
let lastReservation = null; // { route, aircraftId, token }
function generateFlight(){
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  const airlineName = AIRLINES[chosenAirIndex].name;
  let pool = ROUTES.filter(r=> r.airline.toLowerCase() === airlineName.toLowerCase());
  if(pool.length===0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length===0){ resultEl.style.display='block'; resultEl.innerHTML=`<div class="small-muted">Нет маршрутов для ${esc(airlineName)}</div>`; return; }
  const route = pool[randInt(0,pool.length-1)];
  // candidates: same-airline at hub or any at hub
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase()===airlineName.toLowerCase());
  if(candidates.length===0) candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  if(candidates.length===0){ resultEl.style.display='block'; resultEl.innerHTML=`<div class="small-muted">Нет idle самолётов в хабе ${esc(route.fromICAO)}</div>`; return; }
  const candidate = candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180))[0];
  const res = reserveAircraft(candidate, LOCAL_USER_ID);
  if(!res.ok){ alert('Не удалось зарезервировать: ' + res.reason); return; }
  lastReservation = { route, aircraftId: candidate.id, token: res.token };
  renderReservationCard(lastReservation);
  renderFleetView();
}

/* Отрисовка карточки резерва с выбором пилота */
function renderReservationCard(gen){
  if(!gen){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  const route = gen.route;
  // список пилотов для выбора (фильтр — база = маршрут.fromICAO или все)
  const relevant = PILOTS.filter(p => !p.baseICAO || p.baseICAO === route.fromICAO);
  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900">Резерв создан</div><div class="small-muted">${esc(ac.airline)}</div></div>
    <div style="margin-top:8px" class="small-muted">Маршрут: ${esc(route.fromICAO)} → ${esc(route.toICAO)} · ${route.durationMinutes} мин</div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <label class="small-muted">Назначить пилота</label>
      <select id="selectPilot" class="input" style="min-width:160px">
        <option value="">Не назначать</option>
        ${relevant.map(p=>`<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)}) ${p.baseICAO? '· ' + esc(p.baseICAO): ''}</option>`).join('')}
      </select>
      <button id="confirmBtn" class="btn btn-primary">Подтвердить полёт</button>
      <button id="cancelBtn" class="btn btn-ghost">Отменить резерв</button>
    </div>
  `;
  document.getElementById('confirmBtn').addEventListener('click', ()=>{
    const sel = document.getElementById('selectPilot').value || null;
    const res = confirmReservation(gen.token, gen.route, sel);
    if(!res.ok) alert('Не удалось подтвердить: ' + (res.reason||'unknown'));
    else { lastReservation = null; renderReservationCard(null); }
  });
  document.getElementById('cancelBtn').addEventListener('click', ()=>{
    cancelReservationByToken(gen.token); lastReservation=null; renderReservationCard(null);
  });
}

/* Подтверждённый рейс — показ и информация о назначенном пилоте */
function renderConfirmedFlight(ac, route, pilotId){
  const pilot = pilotId ? PILOTS.find(p=>p.id===pilotId) : null;
  const now = new Date().toLocaleString();
  const flightMs = (Number(route.durationMinutes)||120) * 60 * 1000;
  const eta = new Date(Date.now() + flightMs).toLocaleString();
  const card = document.createElement('div'); card.className='confirmed-card';
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:900;color:var(--ok)">Рейс подтверждён</div><div class="small-muted">${esc(ac.id)} · ${esc(ac.airline)}</div></div>
    <div style="margin-top:8px" class="small-muted">Отправление: ${esc(route.fromICAO)} · ETA: ${esc(eta)}</div>
    <div style="margin-top:6px" class="small-muted">Пилот: ${pilot ? esc(pilot.name) + ' (' + esc(pilot.callSign) + ')' : 'Не назначен'}</div>
  `;
  confirmedSection.innerHTML=''; confirmedSection.appendChild(card);
}

/* expire reservations и завершение полётов */
function expireReservations(){
  const now = nowMs();
  let changed=false;
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event:'reservation_expired', aircraft: ac.id }); changed=true;
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status='idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO }); changed=true;
    }
  });
  if(changed){ renderFleetView(); renderAssignLog(); renderPilots(); }
}

/* ---------------- FLEET VIEW (упрощён) ---------------- */
function renderFleetView(){
  // простой визуальный список в result (для компактности)
  // но основной флот уже отображается в другом месте; здесь — обновление видимости
  // приложение использует FLEET массив напрямую, поэтому ничего дополнительного не требуется
}

/* ---------------- CSV экспорт пилотов ---------------- */
function exportPilotsCSV(){
  const headers = ['id','name','callSign','rank','baseICAO','createdAt'];
  const rows = PILOTS.map(p => headers.map(h=> JSON.stringify(p[h]||'')).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  // простая загрузка: создаём blob и скачиваем (работает локально)
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pilots.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------------- ИНИЦИАЛИЗАЦИЯ И СВЯЗКИ ---------------- */
renderAirlines(); renderDurations(); renderPilots(); renderPilotFilterOptions(); renderAssignLog();

genBtn.addEventListener('click', ()=> {
  if(lastReservation && lastReservation.token){
    if(!confirm('У вас уже есть активный резерв. Создать новый резерв отменит старый?')) return;
    cancelReservationByToken(lastReservation.token); lastReservation=null; renderReservationCard(null);
  }
  generateFlight();
});
demoBtn.addEventListener('click', ()=> {
  const idx = AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0) chosenAirIndex=idx; generateFlight();
});
resetBtn.addEventListener('click', ()=> {
  chosenAirIndex=null; chosenDur=null; lastReservation=null; document.getElementById('selectedInfo').textContent='—'; resultEl.style.display='none'; resultEl.innerHTML=''; confirmedSection.innerHTML='';
  renderPilots(); renderAssignLog();
});
exportCSVBtn.addEventListener('click', exportPilotsCSV);
resetAllBtn.addEventListener('click', ()=> {
  if(!confirm('Очистить всех пилотов и журнал?')) return;
  PILOTS = []; PILOT_LOG = []; FLEET.forEach(a=>{ a.status='idle'; delete a.reservedToken; delete a.reservedUntil; delete a.availableAt; delete a.nextLocation; });
  renderPilots(); renderPilotFilterOptions(); renderAssignLog(); confirmedSection.innerHTML=''; resultEl.innerHTML=''; alert('Сброшено');
});

/* Добавление тестовых пилотов (пример) */
addPilot({ name:'Ivan Petrov', callSign:'IPET', rank:'ATPL', base:'EDDF' });
addPilot({ name:'Anna Müller', callSign:'AMUL', rank:'CPL', base:'EDDM' });
renderPilots(); renderPilotFilterOptions();

/* периодическое обслуживание */
setInterval(()=>{ expireReservations(); }, 1000);

/* expose (debug) */
window._demo = { PILOTS, PILOT_LOG, FLEET, ROUTES, addPilot, editPilot, removePilot, recordPilotAssignment };
</script>
</body>
</html>
