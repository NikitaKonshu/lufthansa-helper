<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lufthansa Crew Portal v73</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        /* === SYSTEM VARIABLES === */
        :root {
            --lh-blue: #05164d;
            --lh-yellow: #ffb600;
            --lh-yellow-hover: #e6a500;
            --lh-red: #d50000;
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --radius: 12px;
            --header-h: 60px;
            --nav-h: 54px;
        }

        /* DARK MODE */
        body.dark-mode {
            --lh-blue: #3b82f6; 
            --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f3f4f6; --text-sub: #9ca3af;
            --border: #374151;
        }
        body.dark-mode header { background: #0b1120; border-bottom: 1px solid #1f2937; }
        body.dark-mode .nav-bar { background: #111827; border-bottom: 1px solid #1f2937; }
        body.dark-mode .nav-btn { color: #9ca3af; }
        body.dark-mode .nav-btn.active { color: #ffb600; }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); 
            transition: background 0.4s ease, color 0.4s ease; overflow-x: hidden;
            padding-top: calc(var(--header-h) + var(--nav-h)); padding-bottom: 40px;
        }
        .hidden { display: none !important; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .tab-content { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* === INTRO === */
        #intro {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #05164d; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        .intro-logo-wrap { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        .intro-logo { width: 160px; filter: brightness(0) invert(1); opacity: 0; animation: logoFade 1.2s ease 0.5s forwards; }
        .intro-line {
            position: absolute; bottom: 0; left: 0; height: 4px; background: #ffb600;
            width: 0%; animation: lineDraw 1.5s ease-in-out forwards;
        }
        .intro-txt {
            color: white; font-size: 1.5rem; letter-spacing: 5px; font-weight: 300; margin-top: 40px;
            opacity: 0; animation: txtUp 1s ease 1.2s forwards;
        }
        @keyframes lineDraw { 0% { width:0; left:50%; } 100% { width:100%; left:0; } }
        @keyframes logoFade { to { opacity: 1; transform: scale(1.1); } }
        @keyframes txtUp { to { opacity: 0.8; transform: translateY(-5px); } }

        /* === HEADER === */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: #05164d; z-index: 2000;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .logo-img { height: 22px; filter: brightness(0) invert(1); }
        .user-panel { display: flex; align-items: center; gap: 15px; color: white; font-size: 0.85rem; font-weight: 600; }

        /* === NAV BAR === */
        .nav-bar {
            position: fixed; top: var(--header-h); left: 0; width: 100%; height: var(--nav-h);
            background: var(--bg-card); border-bottom: 1px solid var(--border); z-index: 1900;
            overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;
        }
        .nav-bar::-webkit-scrollbar { display: none; }
        .nav-inner { display: flex; height: 100%; margin: 0 auto; max-width: 1200px; padding: 0 10px; width: 100%; justify-content: center; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 20px;
            font-size: 0.9rem; font-weight: 600; color: var(--text-sub);
            cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .nav-btn.active { color: var(--lh-blue); border-bottom-color: var(--lh-yellow); }

        /* === LAYOUT === */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; width: 100%; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px; transition: transform 0.2s ease; }
        h2 { font-weight: 400; font-size: 1.4rem; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }

        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; }
        .stat-val { font-size: 2.2rem; font-weight: 300; color: var(--text-main); letter-spacing: -1px; line-height: 1; }
        .stat-lbl { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-top: 8px; }

        .af-card { border-left: 6px solid var(--lh-yellow); }
        .af-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .af-route { font-size: 2rem; font-weight: 400; color: var(--text-main); line-height: 1; }
        .af-det { font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: var(--text-sub); margin-top: 8px; }
        .prog-track { height: 6px; background: var(--border); border-radius: 3px; margin: 20px 0; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }
        .timer-display { font-size: 1.5rem; font-family: 'Roboto Mono', monospace; }

        .filter-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .inp-sel { flex: 1; padding: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); border-radius: var(--radius); font-size: 0.95rem; outline: none; -webkit-appearance: none; }
        
        .list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 15px; }
        .list-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-sm { padding: 10px 18px; font-size: 0.85rem; font-weight: 600; background: var(--lh-yellow); border: none; border-radius: 6px; cursor: pointer; color: #05164d; white-space: nowrap; transition: 0.2s; }
        .btn-sm:hover { background: var(--lh-yellow-hover); }

        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 6000; display: flex; justify-content: center; align-items: center; padding: 10px; }
        .modal-c { width: 800px; max-width: 100%; max-height: 100%; overflow-y: auto; background: var(--bg-card); padding: 25px; border-radius: var(--radius); box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .ofp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: var(--bg-body); padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid var(--border); }
        .ofp-lbl { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); margin-bottom: 4px; }
        .ofp-val { font-family: 'Roboto Mono', monospace; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        #map { height: 250px; background: #eee; border-radius: 8px; margin-bottom: 20px; z-index: 1; border: 1px solid var(--border); }
        .btn-main { width: 100%; padding: 15px; background: var(--lh-yellow); color: #05164d; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .btn-main:hover { background: var(--lh-yellow-hover); }
        .btn-red { width: 100%; padding: 15px; background: var(--lh-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: filter 0.2s; }
        .btn-red:hover { filter: brightness(1.1); }

        /* Login */
        #login-wrap { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-body); z-index: 5000; display: flex; flex-direction: column; }
        .login-nav { height: 60px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; }
        .login-nav img { height: 32px; } 
        .login-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { width: 100%; max-width: 400px; background: var(--bg-card); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); animation: slideUp 0.5s ease-out; }
        .inp-float { width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid #aaa; background: transparent; color: var(--text-main); font-size: 1rem; margin-bottom: 20px; outline: none; border-radius: 0; transition: border-color 0.3s; }
        .inp-float:focus { border-bottom-color: var(--lh-yellow); }

        @media (max-width: 768px) {
            .nav-inner { justify-content: flex-start; } .grid-3, .dash-layout, .ofp-grid, .list-grid { grid-template-columns: 1fr; } 
            .filter-row { flex-direction: column; gap: 10px; } .modal-c { height: 100%; border-radius: 0; padding: 20px; } .af-route { font-size: 1.8rem; }
            .ofp-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<script>
    // === EXACT FLIGHT CODES ===
    const CODES = {
        "Lufthansa": "LH", "Swiss": "LX", "Austrian": "OS", "AirBaltic": "BT",
        "Brussels Airlines": "SN", "Eurowings": "EW", "Discover Airlines": "4Y",
        "Edelweiss Air": "WK", "Lufthansa Cargo": "GEC", "Lufthansa CityLine": "CL",
        "Lufthansa City Airlines": "VL", "Lufthansa Technik": "LT", "Air Dolomiti": "EN",
        "Lufthansa Private Jet": "LPJ", "ITA Airways": "AZ", "Widerøe": "WF",
        "Norwegian": "DY", "Finnair": "AY", "SAS": "SK", "Condor": "DE",
        "AeroLogic": "3S", "SunExpress": "XQ"
    };

    const DB = {
        NEWS: [
            { t: "System Update v73", d: "Airline database expanded. Flight codes aligned." },
            { t: "Winter Operations", d: "De-icing mandatory at stations < 3°C." }
        ],
        FLEET: [
            { id: "A320L", t: "Airbus A320neo", op: "Lufthansa", s: 180, r: 6, eng: "PW1100G", ceil: "FL390", spd: "M0.78" },
            { id: "B748", t: "Boeing 747-8", op: "Lufthansa", s: 364, r: 14, eng: "GEnx-2B", ceil: "FL430", spd: "M0.85" },
            { id: "A359", t: "Airbus A350-900", op: "Lufthansa", s: 293, r: 16, eng: "Trent XWB", ceil: "FL410", spd: "M0.85" },
            { id: "A333", t: "Airbus A330-300", op: "Swiss", s: 236, r: 10, eng: "Trent 700", ceil: "FL410", spd: "M0.82" },
            { id: "B77W", t: "Boeing 777-300ER", op: "Swiss", s: 340, r: 15, eng: "GE90", ceil: "FL430", spd: "M0.84" },
            { id: "A223", t: "Airbus A220-300", op: "Swiss", s: 145, r: 6, eng: "PW1500G", ceil: "FL410", spd: "M0.78" },
            { id: "B789", t: "Boeing 787-9", op: "Austrian", s: 294, r: 14, eng: "GEnx", ceil: "FL430", spd: "M0.85" },
            { id: "E195", t: "Embraer 195", op: "Austrian", s: 120, r: 4, eng: "CF34", ceil: "FL410", spd: "M0.78" },
            { id: "A220B", t: "Airbus A220-300", op: "AirBaltic", s: 145, r: 6, eng: "PW1500G", ceil: "FL410", spd: "M0.78" },
            { id: "A320E", t: "Airbus A320", op: "Eurowings", s: 180, r: 5, eng: "CFM56", ceil: "FL390", spd: "M0.78" },
            { id: "A330D", t: "Airbus A330-300", op: "Discover Airlines", s: 280, r: 10, eng: "Trent 700", ceil: "FL410", spd: "M0.82" },
            { id: "A350I", t: "Airbus A350-900", op: "ITA Airways", s: 300, r: 16, eng: "Trent XWB", ceil: "FL410", spd: "M0.85" },
            { id: "A330N", t: "Airbus A330neo", op: "Condor", s: 310, r: 12, eng: "Trent 7000", ceil: "FL410", spd: "M0.82" },
            { id: "B738", t: "Boeing 737-800", op: "Norwegian", s: 189, r: 6, eng: "CFM56", ceil: "FL410", spd: "M0.78" },
            { id: "A359F", t: "Airbus A350-900", op: "Finnair", s: 297, r: 15, eng: "Trent XWB", ceil: "FL410", spd: "M0.85" },
            { id: "A320S", t: "Airbus A320neo", op: "SAS", s: 180, r: 6, eng: "LEAP-1A", ceil: "FL390", spd: "M0.78" },
            { id: "B77L", t: "Boeing 777F", op: "AeroLogic", s: 2, r: 10, eng: "GE90", ceil: "FL430", spd: "M0.84" },
            { id: "B738S", t: "Boeing 737-800", op: "SunExpress", s: 189, r: 5, eng: "CFM56", ceil: "FL410", spd: "M0.78" }
        ],
        ROUTES: [
            // Lufthansa
            { al: "Lufthansa", d: "EDDF", a: "EGLL", t: 1.5 }, { al: "Lufthansa", d: "EDDF", a: "KJFK", t: 8.5 },
            { al: "Lufthansa", d: "EDDM", a: "LFPG", t: 1.2 }, { al: "Lufthansa", d: "EDDF", a: "OMDB", t: 6.2 },
            // Swiss
            { al: "Swiss", d: "LSZH", a: "EGLL", t: 1.8 }, { al: "Swiss", d: "LSZH", a: "WSSS", t: 12.0 },
            { al: "Swiss", d: "LSZH", a: "KJFK", t: 8.8 },
            // Austrian
            { al: "Austrian", d: "LOWW", a: "VTBS", t: 10.5 }, { al: "Austrian", d: "LOWW", a: "EGLL", t: 2.2 },
            // AirBaltic
            { al: "AirBaltic", d: "EVRA", a: "EDDL", t: 2.0 }, { al: "AirBaltic", d: "EVRA", a: "EGLL", t: 2.5 },
            // Eurowings
            { al: "Eurowings", d: "EDDL", a: "LEPA", t: 2.2 }, { al: "Eurowings", d: "EDDL", a: "EGLL", t: 1.2 },
            // Discover
            { al: "Discover Airlines", d: "EDDF", a: "FIMP", t: 11.0 }, { al: "Discover Airlines", d: "EDDF", a: "MCO", t: 10.0 },
            // Cargo & Others
            { al: "Lufthansa Cargo", d: "EDDF", a: "VHHH", t: 11.5 }, { al: "AeroLogic", d: "EDDP", a: "KCVG", t: 9.0 },
            { al: "ITA Airways", d: "LIRF", a: "KJFK", t: 9.0 }, { al: "ITA Airways", d: "LIRF", a: "EGLL", t: 2.5 },
            { al: "SAS", d: "EKCH", a: "KEWR", t: 8.5 }, { al: "Finnair", d: "EFHK", a: "RJTT", t: 13.0 },
            { al: "Norwegian", d: "ENGM", a: "LEPA", t: 3.5 }, { al: "Condor", d: "EDDF", a: "CUN", t: 11.0 },
            { al: "SunExpress", d: "LTAI", a: "EDDL", t: 3.5 }, { al: "Air Dolomiti", d: "EDDM", a: "LIPZ", t: 1.0 },
            { al: "Brussels Airlines", d: "EBBR", a: "KJFK", t: 8.0 }, { al: "Edelweiss Air", d: "LSZH", a: "CPT", t: 11.5 },
            { al: "Lufthansa CityLine", d: "EDDF", a: "LSZH", t: 0.8 }, { al: "Widerøe", d: "ENGM", a: "BGO", t: 0.9 },
            { al: "Lufthansa Private Jet", d: "EDDF", a: "NCE", t: 1.5 }, { al: "Lufthansa Technik", d: "EDDH", a: "EDDF", t: 1.0 }
        ],
        COORDS: {
            "EDDF":[50.03,8.56], "EDDM":[48.35,11.77], "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "EKCH":[55.61,12.65],
            "EGLL":[51.47,-0.45], "KJFK":[40.64,-73.77], "KLAX":[33.94,-118.40], "WSSS":[1.36,103.99], "VTBS":[13.69,100.75], 
            "LFPG":[49.00,2.55], "KEWR":[40.68,-74.17], "EVRA":[56.92,23.97], "EDDL":[51.28,6.76], "LEPA":[39.55,2.73], 
            "FIMP":[-20.43,57.68], "MCO":[28.43,-81.30], "VHHH":[22.30,113.91], "EDDP":[51.42,12.23], "KCVG":[39.04,-84.66], 
            "LIRF":[41.80,12.24], "EFHK":[60.31,24.96], "RJTT":[35.54,139.77], "ENGM":[60.19,11.10], "CUN":[21.04,-86.87], 
            "LTAI":[36.89,30.80], "LIPZ":[45.50,12.35], "EBBR":[50.90,4.48], "CPT":[-33.97,18.60], "EDDH":[53.63,9.98], 
            "NCE":[43.66,7.21], "BGO":[60.29,5.21]
        }
    };
</script>

<div id="intro">
    <div class="intro-logo-wrap">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="intro-logo">
        <div class="intro-line"></div>
    </div>
    <div class="intro-txt">Lufthansa Systems</div>
</div>

<div id="login-wrap">
    <div class="login-nav"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg"></div>
    <div class="login-body">
        <div class="login-card">
            <h2 style="border:none; margin-bottom:10px;">Login</h2>
            <p style="color:var(--text-sub); margin-bottom:30px; font-size:0.9rem;">Please enter your Travel ID.</p>
            <input type="text" id="user" class="inp-float" placeholder="Travel ID">
            <input type="password" id="pass" class="inp-float" placeholder="Password">
            <button class="btn-main" onclick="app.login()">Next</button>
            <div id="login-msg" style="color:red; margin-top:15px; font-size:0.9rem;"></div>
            <div style="margin-top:25px; font-size:0.85rem; color:var(--text-sub);">
                <div style="margin-bottom:8px; cursor:pointer; text-decoration:underline;" onclick="alert('Please contact your system administrator to reset your credentials.')">Forgot your PIN or password?</div>
            </div>
        </div>
    </div>
</div>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo-img">
    <div class="user-panel">
        <span id="clock" style="font-family:'Roboto Mono'; opacity:0.8;">00:00 Z</span>
        <span onclick="app.theme()" style="cursor:pointer; font-size:1.4rem;">◑</span>
    </div>
</header>

<div class="nav-bar hidden" id="nav-bar">
    <div class="nav-inner">
        <button class="nav-btn active" onclick="app.tab('dash', this)">Dashboard</button>
        <button class="nav-btn" onclick="app.tab('routes', this)">Schedule</button>
        <button class="nav-btn" onclick="app.tab('fleet', this)">Fleet</button>
        <button class="nav-btn" onclick="app.tab('dispatch', this)">Dispatch</button>
    </div>
</div>

<div class="container hidden" id="app-cont">

    <div id="tab-dash" class="tab-content">
        <h2>Captain's Logbook</h2>
        <div class="grid-3">
            <div class="stat-box"><div class="stat-val" id="st-l">0</div><div class="stat-lbl">Legs Flown</div></div>
            <div class="stat-box"><div class="stat-val" id="st-h">0</div><div class="stat-lbl">Total Hours</div></div>
            <div class="stat-box"><div class="stat-val" id="st-r" style="color:var(--lh-yellow)">-</div><div class="stat-lbl">Rank</div></div>
        </div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;" class="dash-layout">
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div id="af-box" class="card af-card hidden">
                    <div class="af-row">
                        <div><div class="stat-lbl" style="margin-bottom:5px;">ACTIVE SECTOR</div><div class="af-route"><span id="af-d"></span> &rarr; <span id="af-a"></span></div><div class="af-det"><span id="af-n"></span> • <span id="af-ac"></span></div></div>
                        <div style="text-align:right;"><div class="af-route timer-display" id="af-t">00:00</div><div class="stat-lbl">REMAINING</div></div>
                    </div>
                    <div class="prog-track"><div id="af-bar" class="prog-fill"></div></div>
                    <button class="btn-main hidden" id="btn-end" onclick="app.finish()">FILE PIREP</button>
                    <button class="btn-red" onclick="app.cancel()">CANCEL FLIGHT</button>
                </div>
                <div id="mis-box" class="card" style="border-left: 5px solid #05164d;">
                    <h3>Daily Assignment</h3><div id="mis-txt" style="font-size:1.6rem; font-weight:300; margin-bottom:20px;">Loading...</div>
                    <button class="btn-sm" style="font-size:0.95rem; padding:12px 20px;" onclick="app.prepMis()">PREPARE FLIGHT</button>
                </div>
            </div>
            <div class="card"><h3>Operations Center</h3><div id="news-list"></div></div>
        </div>
    </div>

    <div id="tab-routes" class="tab-content hidden">
        <h2>Flight Schedule</h2>
        <div class="filter-row">
            <select id="flt-al" class="inp-sel" onchange="app.renderR()"></select>
            <select id="flt-tm" class="inp-sel" onchange="app.renderR()">
                <option value="ALL">All Durations</option><option value="1-2">Short (1-2h)</option><option value="3-4">Medium (3-4h)</option><option value="5-6">Long (5-6h)</option><option value="10+">Ultra (10h+)</option>
            </select>
        </div>
        <div id="list-routes" class="list-grid"></div>
    </div>

    <div id="tab-fleet" class="tab-content hidden">
        <h2>Fleet Overview</h2>
        <div class="filter-row"><select id="flt-op" class="inp-sel" onchange="app.renderF()"></select></div>
        <div id="list-fleet" class="list-grid"></div>
    </div>

    <div id="tab-dispatch" class="tab-content hidden">
        <div class="card" style="max-width:600px; margin:0 auto;">
            <h2>Flight Dispatcher</h2>
            <div style="margin-bottom:20px;"><div class="stat-lbl" style="margin-bottom:5px;">Operator</div><select id="gen-al" class="inp-sel" onchange="app.updHub()"></select></div>
            <div style="margin-bottom:20px;"><div class="stat-lbl" style="margin-bottom:5px;">Hub</div><select id="gen-hub" class="inp-sel" disabled></select></div>
            <div style="margin-bottom:30px;"><div class="stat-lbl" style="margin-bottom:5px;">Duration</div><select id="gen-tm" class="inp-sel"><option value="ALL">Random</option><option value="1-2">1-2h</option><option value="3-4">3-4h</option><option value="5-6">5-6h</option><option value="10+">10h+</option></select></div>
            <button class="btn-main" onclick="app.gen()">GENERATE OFP</button>
        </div>
    </div>

</div>

<div id="modal" class="modal-wrap hidden">
    <div class="modal-c">
        <div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--text-main); margin-bottom:20px; padding-bottom:10px;"><h3>OFP BRIEFING</h3><h3 id="br-num">LH000</h3></div>
        <div class="ofp-grid">
            <div><div class="ofp-lbl">DEPARTURE</div><div class="ofp-val" id="br-dep"></div></div>
            <div><div class="ofp-lbl">ARRIVAL</div><div class="ofp-val" id="br-arr"></div></div>
            <div><div class="ofp-lbl">AIRCRAFT</div><div class="ofp-val" id="br-ac"></div></div>
            <div><div class="ofp-lbl">GATE</div><div class="ofp-val" id="br-gate"></div></div>
            <div><div class="ofp-lbl">ETE</div><div class="ofp-val" id="br-time"></div></div>
            <div><div class="ofp-lbl">ZFW</div><div class="ofp-val" id="br-zfw"></div></div>
            <div><div class="ofp-lbl">FL</div><div class="ofp-val" id="br-fl"></div></div>
            <div><div class="ofp-lbl">PAX</div><div class="ofp-val" id="br-pax"></div></div>
        </div>
        <div id="map"></div>
        <div style="font-size:0.8rem; font-weight:600; color:var(--text-sub); margin-bottom:20px;">METAR: VMC / >10KM / NOSIG</div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
            <button class="btn-main" onclick="app.accept()">ACCEPT FLIGHT</button>
            <button class="btn-main" style="background:#ddd; color:#333;" onclick="app.closeM()">CANCEL</button>
        </div>
    </div>
</div>

<script>
    const app = {
        data: { stats: {l:0, h:0}, active: null, temp: null, mis: null },
        tmr: null, map: null,

        init: function() {
            let s = JSON.parse(localStorage.getItem('stats'));
            if(!s || isNaN(s.l) || isNaN(s.h)) s = {l:0, h:0};
            this.data.stats = s;
            if(localStorage.getItem('dark')=='1') document.body.classList.add('dark-mode');
            setInterval(()=>{ const d=new Date(); document.getElementById('clock').innerText=`${String(d.getUTCHours()).padStart(2,0)}:${String(d.getUTCMinutes()).padStart(2,0)} Z`; }, 1000);
            setTimeout(()=>{ document.getElementById('intro').style.opacity=0; setTimeout(()=>document.getElementById('intro').classList.add('hidden'),800); }, 2500);

            const uq = (k) => [...new Set(DB[k].map(x=>x[k=='ROUTES'?'al':'op']))];
            const ops = uq('ROUTES'), flt = uq('FLEET');
            const fill = (id, arr, t) => { const el=document.getElementById(id); el.innerHTML=`<option value="ALL">${t}</option>`; arr.forEach(x=>el.add(new Option(x,x))); };
            fill('flt-al', ops, 'All Airlines'); fill('gen-al', ops, 'Select Airline'); fill('flt-op', flt, 'All Operators');
            document.getElementById('news-list').innerHTML = DB.NEWS.map(n=>`<div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:8px;"><b>${n.t}</b><br><span style="color:var(--text-sub); font-size:0.9rem;">${n.d}</span></div>`).join('');
            this.updStats(); this.renderR(); this.renderF(); this.dailyMis(); this.chkActive();
        },

        login: function() {
            if(document.getElementById('user').value.toUpperCase()==='DLH001' && document.getElementById('pass').value==='1234'){
                document.getElementById('login-wrap').classList.add('hidden');
                document.getElementById('nav-bar').classList.remove('hidden');
                document.getElementById('app-cont').classList.remove('hidden');
            } else document.getElementById('login-msg').innerText="Invalid Credentials";
        },

        tab: function(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            if(id=='routes') this.renderR();
        },

        updStats: function() {
            document.getElementById('st-l').innerText = this.data.stats.l;
            document.getElementById('st-h').innerText = Math.floor(this.data.stats.h);
            const l = this.data.stats.l;
            document.getElementById('st-r').innerText = l>20?"Captain":(l>5?"First Officer":"Second Officer");
        },

        chkTime: function(t, f) {
            if(f=='ALL') return true;
            if(f.includes('+')) return t>=parseInt(f);
            const [min,max] = f.split('-').map(Number);
            return t>=min && t<max;
        },

        renderR: function() {
            const al=document.getElementById('flt-al').value, tm=document.getElementById('flt-tm').value;
            const l=document.getElementById('list-routes'); l.innerHTML="";
            const r=DB.ROUTES.filter(x=>(al=='ALL'||x.al==al) && this.chkTime(x.t, tm));
            if(!r.length) { l.innerHTML="<div class='card'>No flights found.</div>"; return; }
            r.forEach(x=>{ l.innerHTML+=`<div class="list-item"><div><div style="font-size:1.1rem; font-weight:700;">${x.d} &rarr; ${x.a}</div><div style="color:var(--text-sub); font-size:0.9rem; margin-top:4px;">${x.t}h • ${x.al}</div></div><button class="btn-sm" onclick="app.prep('${x.al}','${x.d}','${x.a}',${x.t})">SELECT</button></div>`; });
        },

        renderF: function() {
            const op=document.getElementById('flt-op').value;
            const l=document.getElementById('list-fleet'); l.innerHTML="";
            DB.FLEET.filter(f=>op=='ALL'||f.op==op).forEach(f=>{ l.innerHTML+=`<div class="list-item" style="display:block;"><div style="font-weight:700; font-size:1.1rem; margin-bottom:10px;">${f.t}</div><div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:0.85rem; color:var(--text-sub);"><span>Seats: <b>${f.s}</b></span> <span>Range: <b>${f.r}h</b></span><span>Ceil: <b>${f.ceil}</b></span> <span>Mach: <b>${f.spd}</b></span><span style="grid-column:span 2">Eng: ${f.eng}</span></div></div>`; });
        },

        getAc: function(al, t) {
            let p = DB.FLEET.filter(f=>f.op==al && (t>6 ? f.r>10 : f.r<10));
            if(!p.length) return { t: "Airbus A320 (Generic)", s: 180, r: 6, ceil: "FL380" };
            return p[Math.floor(Math.random()*p.length)];
        },

        prep: function(al, d, a, t) {
            const p = this.getAc(al, t);
            // === CORRECT CODE GENERATION ===
            const prefix = CODES[al] || "LH";
            const code = prefix + Math.floor(Math.random()*8999+1000);
            
            this.data.temp = { d, a, t, ac: p.t, n: code, gate: "A"+Math.floor(Math.random()*40+1), pax: Math.floor(p.s*0.85), zfw: (p.r>10?160:45)+"T", fl: p.ceil };
            
            // Explicitly set Header
            document.getElementById('br-num').innerText = code;
            
            ['dep','arr','ac','gate','time','zfw','pax','fl'].forEach(k=>document.getElementById('br-'+k).innerText=this.data.temp[{dep:'d',arr:'a',ac:'ac',gate:'gate',time:'t',zfw:'zfw',pax:'pax',fl:'fl'}[k]]);
            document.getElementById('modal').classList.remove('hidden');
            setTimeout(()=>{
                if(this.map) this.map.remove(); this.map = L.map('map').setView([50,10], 3);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                const c1=DB.COORDS[d]||[50,10], c2=DB.COORDS[a]||[40,-70];
                L.polyline([c1,c2],{color:'#05164d', weight:3}).addTo(this.map); this.map.fitBounds([c1,c2], {padding:[30,30]});
            },100);
        },

        accept: function() {
            this.data.temp.start = Date.now();
            localStorage.setItem('active', JSON.stringify(this.data.temp));
            this.closeM(); this.chkActive(); this.tab('dash', document.querySelector('.nav-btn'));
        },
        closeM: function() { document.getElementById('modal').classList.add('hidden'); },

        chkActive: function() {
            const s = localStorage.getItem('active');
            if(!s) { document.getElementById('af-box').classList.add('hidden'); document.getElementById('mis-box').classList.remove('hidden'); return; }
            this.data.active = JSON.parse(s);
            document.getElementById('af-box').classList.remove('hidden'); document.getElementById('mis-box').classList.add('hidden');
            ['d','a','n','ac'].forEach(k=>document.getElementById('af-'+k).innerText=this.data.active[k]);

            if(this.tmr) clearInterval(this.tmr);
            this.tmr = setInterval(()=>{
                const el = Date.now() - this.data.active.start;
                const dur = this.data.active.t * 3600 * 1000; 
                const pct = Math.min(100, (el/dur)*100);
                document.getElementById('af-bar').style.width=pct+"%";
                if(pct>=100) {
                    document.getElementById('af-t').innerText="ARRIVED";
                    document.getElementById('btn-end').classList.remove('hidden');
                } else {
                    const remMs = dur - el;
                    const remMins = Math.floor((remMs / (1000 * 60)) % 60);
                    const remHrs = Math.floor((remMs / (1000 * 60 * 60)));
                    document.getElementById('af-t').innerText = `${String(remHrs).padStart(2,'0')}:${String(remMins).padStart(2,'0')}`;
                }
            }, 1000);
        },

        finish: function() {
            this.data.stats.l++; this.data.stats.h+=this.data.active.t;
            localStorage.setItem('stats', JSON.stringify(this.data.stats));
            localStorage.removeItem('active');
            this.chkActive(); this.updStats();
        },
        
        cancel: function() {
            if(confirm('Are you sure you want to cancel the flight?')) {
                localStorage.removeItem('active');
                this.chkActive();
            }
        },

        updHub: function() {
            const al=document.getElementById('gen-al').value;
            const h=document.getElementById('gen-hub'); h.innerHTML=""; h.disabled=false;
            [...new Set(DB.ROUTES.filter(r=>r.al==al).map(r=>r.d))].forEach(x=>h.add(new Option(x,x)));
        },
        gen: function() {
            const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
            const r=DB.ROUTES.filter(x=>x.al==al && x.d==h && this.chkTime(x.t, tm));
            if(!r.length) { alert("No routes match."); return; }
            const s=r[Math.floor(Math.random()*r.length)]; this.prep(s.al, s.d, s.a, s.t);
        },
        dailyMis: function() {
            const d=new Date().getDate(); this.data.mis = DB.ROUTES[d % DB.ROUTES.length];
            document.getElementById('mis-txt').innerText = `${this.data.mis.d} → ${this.data.mis.a}`;
        },
        prepMis: function(){ this.prep(this.data.mis.al, this.data.mis.d, this.data.mis.a, this.data.mis.t); },
        theme: function() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('dark', document.body.classList.contains('dark-mode')?'1':'0');
        }
    };
    window.onload = ()=>app.init();
</script>
</body>
</html>
