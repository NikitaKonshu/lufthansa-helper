<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lufthansa Group Virtual — expanded fleet</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg-1:#041528; --bg-2:#073044; --accent:#ffd700; --muted:#9fb6d6; --text:#eaf4ff;
      --card:#072033; --glass:rgba(255,255,255,0.03); --radius:12px; --shadow:0 14px 40px rgba(2,8,20,0.6);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);padding:18px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:1200px}
    .hero{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,#03243a,#063a59);box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:52px;height:52px;border-radius:8px;background:linear-gradient(180deg,#063a59,#012938);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
    h1{margin:0;color:var(--accent)}
    .subtitle{margin:0;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .btn-ghost{border:1px solid rgba(255,255,255,0.06)}
    .btn-primary{background:var(--accent);color:#04202a;font-weight:800}
    .card{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card),#043044);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:12px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    h3{margin:0;color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .airline-groups{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .airline-group{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.004),transparent)}
    .airline-group-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
    .airline-badge{width:36px;height:36;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
    .chev{transition:transform .22s;color:var(--muted)}
    .airline-list{overflow:hidden;transition:height .22s cubic-bezier(.2,.9,.2,1)}
    .airline-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid rgba(255,255,255,0.01);cursor:pointer}
    .airline-item:hover{background:rgba(255,255,255,0.01)}
    .airline-item.selected{background:linear-gradient(90deg, rgba(255,215,0,0.06), rgba(255,215,0,0.02))}
    .airline-item.disabled{opacity:0.45;pointer-events:none}
    #durations{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .opt{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.008));border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .opt.selected{border-color:rgba(255,215,0,0.22);box-shadow:0 12px 30px rgba(255,215,0,0.06)}
    .icon{width:36px;height:36;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent)}
    .fleet-panel{padding:12px;border-radius:10px;background:linear-gradient(180deg,#041f2a,#03222a);border:1px solid rgba(255,255,255,0.03)}
    .fleet-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:520px;overflow:auto;padding-right:6px}
    .fleet-row{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .plane-type{width:56px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent)}
    .fleet-main{display:flex;flex-direction:column;min-width:0}
    .fleet-name{font-weight:800}
    .fleet-sub{font-size:12px;color:var(--muted)}
    .fleet-right{margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .status-badge{padding:6px 8px;border-radius:8px;font-weight:800;font-size:12px}
    .reserved-badge{background:#2c2a6a;color:#dcdcff;padding:6px 8px;border-radius:8px;font-weight:800}
    .airline-tag{font-size:11px;color:#04202a;background:#ffd700;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:8px}
    .result{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#021923,#062733);border:1px solid rgba(255,255,255,0.03);display:none}
    .res-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .res-title{font-weight:900;font-size:15px;color:var(--accent)}
    .res-body{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .res-row{display:flex;flex-direction:column}
    .res-label{font-size:12px;color:var(--muted)}
    .res-value{font-weight:800}
    .res-actions{display:flex;gap:8px;margin-top:12px;align-items:center}
    .muted{color:var(--muted)}
    .confirmed-card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,#062733,#043c45);border:1px solid rgba(255,255,255,0.04)}
    .confirmed-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .confirmed-title{font-weight:900;color:#bff2be}
    @media(max-width:520px){.res-body{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <div class="logo">LH</div>
        <div>
          <h1>Lufthansa Group Virtual</h1>
          <div class="subtitle">Expanded fleet — aircraft assigned to airlines</div>
        </div>
      </div>
      <div>
        <button id="openDemo" class="btn btn-ghost">Открыть демо</button>
        <button id="about" class="btn btn-ghost">О проекте</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0;color:var(--accent)">Генерация рейса</h2>
          <div class="small" style="margin-top:6px">Резерв → Подтверждение. Флот разделён по авиакомпаниям</div>
        </div>
        <div class="small">Демо-данные</div>
      </div>

      <div class="grid">
        <div>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <h3>Авиакомпания</h3>
            <div id="airlines" class="airline-groups" aria-label="Список авиакомпаний"></div>

            <h3 style="margin-top:12px">Длительность</h3>
            <div id="durations"></div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
              <button id="gen" class="btn btn-primary">Сгенерировать и зарезервировать</button>
              <button id="demo" class="btn btn-ghost">Демо</button>
              <button id="reset" class="btn btn-ghost">Сброс</button>
              <div style="flex:1"></div>
              <div class="small">Выбрано: <strong id="selectedInfo">—</strong></div>
            </div>

            <div id="result" class="result" role="status" aria-live="polite"></div>
          </div>
        </div>

        <aside>
          <div class="fleet-panel" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:900">Флот</div>
                <div class="small" style="margin-top:4px">Город (ICAO) · авиакомпания · дальность · места · статус</div>
              </div>
              <div style="display:flex;gap:8px">
                <button id="refreshFleet" class="btn btn-ghost">Обновить</button>
                <button id="showFleetLog" class="btn btn-ghost">Показать лог</button>
              </div>
            </div>
            <div id="fleetList" class="fleet-list"></div>
          </div>

          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03)">
            <h3>Инфо</h3>
            <div class="small" style="margin-top:8px">Всего маршрутов: <strong id="routesCount">—</strong></div>
            <div class="small" style="margin-top:6px">Хабы: EDDF — Frankfurt, EDDM — Munich</div>

            <h3 style="margin-top:12px">Журнал назначений</h3>
            <div id="assignLog" class="small" style="margin-top:8px">Пока пусто</div>
            <div style="margin-top:12px"><button id="clearLog" class="btn btn-ghost">Очистить журнал</button></div>
          </div>
        </aside>
      </div>
    </section>

    <section id="confirmedSection" style="max-width:1200px;margin-top:12px"></section>
  </div>

<script>
/* ---------------- DEMO DATA ---------------- */
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Lufthansa Technik", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Milan", toICAO:"LIMC", durationMinutes:95 },
  { airline: "Lufthansa Cargo", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Dubai", toICAO:"OMDB", durationMinutes:420 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 },
  { airline: "Brussels Airlines", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Brussels", toICAO:"EBBR", durationMinutes:75 },
  { airline: "ITA Airways", fromCity:"Frankfurt am Main", fromICAO:"EDDF", toCity:"Rome", toICAO:"LIRF", durationMinutes:120 }
];
ROUTES.forEach(r=>{ r.durationMinutes = Number.isFinite(Number(r.durationMinutes)) ? Number(r.durationMinutes) : NaN; });

const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM","EDDH"] },
  { name: "Discover", hubs: ["EDDF"] },
  { name: "Lufthansa CityLine", hubs: ["EDDF","EDDM"] },
  { name: "AirDolomiti", hubs: ["EDDM"] },
  { name: "Wideroe", hubs: ["ENBR"] },
  { name: "SAS", hubs: ["EKCH","EKTB"] },
  { name: "Austrian", hubs: ["LOWW"] },
  { name: "Brussels Airlines", hubs: ["EBBR"] },
  { name: "Edelweiss", hubs: ["LSZH"] },
  { name: "Lufthansa City", hubs: ["EDDM"] },
  { name: "Lufthansa Private Jet", hubs: ["EDDF"] },
  { name: "Norwegian Airlines", hubs: ["ENGM","ENBR"] },
  { name: "Condor", hubs: ["EDDH","EDDF"] },
  { name: "Swiss", hubs: ["LSZH"] },
  { name: "AirBaltic", hubs: ["EVRA","EVRA"] },
  { name: "Lufthansa Cargo", hubs: ["EDDF"] },
  { name: "Lufthansa Technik", hubs: ["EDDF"] },
  { name: "ITA Airways", hubs: ["LIRF"] },
  { name: "Finnair", hubs: ["EFHK"] },
  { name: "AeroLogic", hubs: ["EDDF"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] }
];

const AIRPORTS = {
  "EDDF": { city:"Frankfurt", lat:50.0379, lon:8.5622 },
  "EDDM": { city:"Munich", lat:48.3538, lon:11.7861 },
  "ENGM": { city:"Oslo", lat:59.6498, lon:10.9198 },
  "EHAM": { city:"Amsterdam", lat:52.3105, lon:4.7683 },
  "LTAI": { city:"Antalya", lat:36.8969, lon:30.8001 },
  "LIMC": { city:"Milan", lat:45.6301, lon:8.7231 },
  "OMDB": { city:"Dubai", lat:25.2532, lon:55.3657 },
  "LSZH": { city:"Zurich", lat:47.4581, lon:8.5610 },
  "EBBR": { city:"Brussels", lat:50.9014, lon:4.4844 },
  "LIRF": { city:"Rome", lat:41.8003, lon:12.2389 }
};

/* ---------------- EXPANDED FLEET (each aircraft assigned an airline) ----------------
   - aircraft objects include .airline and .locationICAO so they visually map to carriers/hubs
*/
const FLEET = [
  // Lufthansa narrowbodies @ EDDF
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A321-02', airline:'Lufthansa', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-E190-01', airline:'Lufthansa CityLine', type:'E190', rangeKm:4000, seats:100, turnaround:30, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // Lufthansa longhaul @ EDDF
  { id:'LH-787-01', airline:'Lufthansa', type:'B787', rangeKm:14140, seats:270, turnaround:75, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'LH-A350-01', airline:'Lufthansa', type:'A350', rangeKm:15000, seats:300, turnaround:90, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // Lufthansa Technik (special) - based at EDDF, tech operations
  { id:'LT-CRJ-01', airline:'Lufthansa Technik', type:'CRJ', rangeKm:2500, seats:70, turnaround:25, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // Cargo / widebody
  { id:'LC-747F-01', airline:'Lufthansa Cargo', type:'B747F', rangeKm:8000, seats:0, turnaround:120, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // Eurowings @ EDDM and EDDF
  { id:'EW-A320-01', airline:'Eurowings', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDM', availableAt:0 },
  { id:'EW-A321-02', airline:'Eurowings', type:'A321', rangeKm:6100, seats:200, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // SunExpress @ EDDF/EDDM (short/medium-haul)
  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDF', availableAt:0 },
  { id:'SX-B737-02', airline:'SunExpress', type:'737-800', rangeKm:5600, seats:189, turnaround:35, status:'idle', locationICAO:'EDDM', availableAt:0 },

  // Brussels Airlines @ EDDF (operates from FRA too)
  { id:'SN-A320-01', airline:'Brussels Airlines', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // ITA Airways
  { id:'AZ-A320-01', airline:'ITA Airways', type:'A320', rangeKm:6100, seats:180, turnaround:40, status:'idle', locationICAO:'EDDF', availableAt:0 },

  // Small regional AirDolomiti @ EDDM
  { id:'AD-CRJ-01', airline:'AirDolomiti', type:'CRJ', rangeKm:2500, seats:90, turnaround:30, status:'idle', locationICAO:'EDDM', availableAt:0 }
];

const FLEET_LOG = [];

/* ---------------- STATE ---------------- */
let chosenAirIndex = null;
let chosenDur = null;
let lastGenerated = null; // { route, aircraftId, token }

/* ---------------- HELPERS ---------------- */
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pad(n){ return String(n).padStart(2,'0'); }
function getAirportInfo(icao){ return AIRPORTS[icao] || null; }
function nowMs(){ return Date.now(); }

/* ---------------- UI refs ---------------- */
const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const genBtn = document.getElementById('gen');
const demoBtn = document.getElementById('demo');
const resetBtn = document.getElementById('reset');
const resultEl = document.getElementById('result');
const fleetListEl = document.getElementById('fleetList');
const routesCount = document.getElementById('routesCount');
const refreshFleetBtn = document.getElementById('refreshFleet');
const showFleetLogBtn = document.getElementById('showFleetLog');
const assignLogEl = document.getElementById('assignLog');
const clearLogBtn = document.getElementById('clearLog');
const selectedInfo = document.getElementById('selectedInfo');
const confirmedSection = document.getElementById('confirmedSection');

/* ---------------- DURATIONS ---------------- */
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480},
  {label:"9–10ч",min:540,max:600},
  {label:"10+ч",min:601,max:1200}
];
function renderDurations(){
  durationsWrap.innerHTML = '';
  DURATIONS.forEach((d,i)=>{
    const avg = Math.round(((d.min + d.max)/2)/60);
    const el = document.createElement('button');
    el.className = 'opt';
    el.type = 'button';
    el.innerHTML = `<div class="icon">⌛</div><div style="min-width:0"><div style="font-weight:900">${esc(d.label)}</div><div style="font-size:12px;color:var(--muted);margin-top:4px">~ ${avg} ч</div></div>`;
    el.addEventListener('click', ()=> selectDur(i));
    durationsWrap.appendChild(el);
  });
}

/* ---------------- AIRLINES render ---------------- */
function renderAirlines(){
  const copy = AIRLINES.map((a,idx)=> Object.assign({ __origIndex: idx }, a)).sort((a,b)=> a.name.localeCompare(b.name,'ru'));
  const groups = {};
  copy.forEach(a=>{
    const hub = (Array.isArray(a.hubs) && a.hubs[0]) ? a.hubs[0] : '—';
    if(!groups[hub]) groups[hub] = [];
    groups[hub].push(a);
  });
  const hubs = Object.keys(groups).sort((x,y)=>{
    const pref=['EDDF','EDDM']; const xi=pref.indexOf(x), yi=pref.indexOf(y);
    if(xi!==-1||yi!==-1) return (xi===-1?99:xi)-(yi===-1?99:yi);
    return x.localeCompare(y,'ru');
  });

  airlinesWrap.innerHTML = '';
  hubs.forEach(hub=>{
    const items = groups[hub];
    const groupEl = document.createElement('div'); groupEl.className='airline-group';
    const head = document.createElement('div'); head.className='airline-group-head';
    head.innerHTML = `<div style="display:flex;align-items:center;gap:12px"><div class="airline-badge">${esc(hub)}</div><div><div style="font-weight:900">${esc(hub)}</div><div class="small" style="margin-top:4px">${items.length} авиакомпаний</div></div></div><div class="chev">▾</div>`;
    const list = document.createElement('div'); list.className='airline-list'; list.style.height='0px';
    const frag = document.createDocumentFragment();
    items.forEach(a=>{
      const item = document.createElement('div'); item.className='airline-item';
      item.dataset.origIndex = String(a.__origIndex);
      item.dataset.hubs = a.hubs.map(h=>h.toUpperCase()).join(',');
      const hasExplicit = ROUTES.some(r=> String(r.airline||'').toLowerCase() === String(a.name||'').toLowerCase());
      const hasHubRoute = a.hubs.some(h=> ROUTES.some(r=> (r.fromICAO||'').toUpperCase() === String(h).toUpperCase() ));
      if(!hasExplicit && !hasHubRoute) item.classList.add('disabled');

      const initials = (a.name.split(' ').map(x=>x[0]||'').slice(0,2).join('')).toUpperCase();
      item.innerHTML = `<div class="airline-badge" aria-hidden="true">${esc(initials)}</div><div style="min-width:0"><div style="font-weight:900">${esc(a.name)}</div><div class="small" style="margin-top:4px">Хабы: ${a.hubs.join(', ')}</div></div>`;
      item.addEventListener('click', ()=> {
        if(item.classList.contains('disabled')) return;
        const idx = Number(item.dataset.origIndex);
        selectAir(idx);
        document.querySelectorAll('.airline-item').forEach(n=>n.classList.toggle('selected', n===item));
      });
      frag.appendChild(item);
    });
    list.appendChild(frag); groupEl.appendChild(head); groupEl.appendChild(list); airlinesWrap.appendChild(groupEl);
    const chev = head.querySelector('.chev'); chev.style.transform='rotate(-90deg)';
    let collapsed = true;
    head.addEventListener('click', ()=>{
      if(collapsed){ list.style.height = list.scrollHeight + 'px'; chev.style.transform='rotate(0deg)'; collapsed=false; }
      else { list.style.height = list.scrollHeight + 'px'; requestAnimationFrame(()=>list.style.height='0px'); chev.style.transform='rotate(-90deg)'; collapsed=true; }
    });
    list.addEventListener('transitionend', (e)=>{ if(e.propertyName==='height' && !collapsed) list.style.height='auto'; });
  });
}

/* ---------------- FLEET render (shows airline tag) ---------------- */
function renderFleetList(){
  fleetListEl.innerHTML = '';
  const now = nowMs();
  FLEET.forEach(ac=>{
    const div = document.createElement('div'); div.className='fleet-row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.gap='12px'; left.style.alignItems='center';
    const typeBox = document.createElement('div'); typeBox.className='plane-type'; typeBox.textContent = ac.type;
    const main = document.createElement('div'); main.className='fleet-main';
    const nm = document.createElement('div'); nm.className='fleet-name'; nm.textContent = ac.id;
    const sub = document.createElement('div'); sub.className='fleet-sub';
    const info=getAirportInfo(ac.locationICAO);
    sub.textContent = info? `${info.city} (${ac.locationICAO})` : ac.locationICAO;
    main.appendChild(nm);
    // airline tag
    const tag = document.createElement('span'); tag.className='airline-tag'; tag.textContent = ac.airline || '—';
    const subWrap = document.createElement('div'); subWrap.style.display='flex'; subWrap.style.alignItems='center'; subWrap.appendChild(sub); subWrap.appendChild(tag);
    main.appendChild(subWrap);
    left.appendChild(typeBox); left.appendChild(main);

    const right = document.createElement('div'); right.className='fleet-right';
    const meta = document.createElement('div'); meta.className='fleet-meta'; meta.textContent = `${ac.rangeKm} km · ${ac.seats} seats`;
    const status = document.createElement('div');

    if(ac.status === 'inFlight'){
      const remaining = ac.availableAt ? Math.max(0, Math.ceil((ac.availableAt - now)/1000)) : 'n/a';
      status.innerHTML = `<span class="status-badge" style="background:#603f00;color:#fff0b8">inFlight • ${remaining}s</span>`;
    } else if(ac.status === 'reserved'){
      const remaining = ac.reservedUntil ? Math.max(0, Math.ceil((ac.reservedUntil - now)/1000)) : 0;
      status.innerHTML = `<span class="reserved-badge">reserved • ${remaining}s</span>`;
    } else {
      status.innerHTML = `<span class="status-badge" style="background:#083b22;color:#bff2be">idle</span>`;
    }

    right.appendChild(meta); right.appendChild(status);
    div.appendChild(left); div.appendChild(right);
    fleetListEl.appendChild(div);
  });
}

/* ---------------- Reservation / Confirm flow ---------------- */
const LOCAL_USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
const RESERVATION_TTL_MS = 120 * 1000; // 2 minutes

function reserveAircraft(ac, ownerId, ttlMs = RESERVATION_TTL_MS){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved';
  ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  renderFleetList();
  return { ok:true, token: ac.reservedToken };
}

function cancelReservationByToken(token){
  const ac = FLEET.find(a => a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  ac.status = 'idle';
  renderFleetList();
  renderAssignLog();
  return true;
}

function confirmReservation(token, route){
  const ac = FLEET.find(a => a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };
  const now = nowMs();
  const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight';
  ac.availableAt = now + durationMs + ac.turnaround*60*1000;
  ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes });
  renderFleetList();
  renderAssignLog();
  renderConfirmedFlight(ac, route);
  return { ok:true, aircraft: ac };
}

/* ---------------- expire reservations & complete flights ---------------- */
function expireReservations(){
  const now = nowMs();
  let changed = false;
  FLEET.forEach(ac=>{
    if(ac.status === 'reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status = 'idle';
      delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event: 'reservation_expired', aircraft: ac.id });
      changed = true;
    }
    if(ac.status === 'inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status = 'idle';
      if(ac.nextLocation) ac.locationICAO = ac.nextLocation;
      delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO });
      changed = true;
    }
  });
  if(changed) { renderFleetList(); renderAssignLog(); }
}

/* ---------------- Generate flight (reserves candidate) ---------------- */
function generateFlight(){
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  if(chosenDur===null){ alert('Выберите длительность'); return; }
  const airlineName = AIRLINES[chosenAirIndex].name;
  // primary: explicit airline routes
  let pool = ROUTES.filter(r => String(r.airline||'').toLowerCase() === String(airlineName).toLowerCase());
  // fallback: by hubs
  if(pool.length === 0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>String(h).toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length === 0){
    resultEl.style.display='block';
    resultEl.innerHTML = `<div class="res-header"><div class="res-title">Нет маршрутов</div></div><div class="res-body"><div class="res-row"><div class="res-label">Авиакомпания</div><div class="res-value">${esc(airlineName)}</div></div><div class="res-row"><div class="res-label">Причина</div><div class="res-value">Нет маршрутов</div></div></div>`;
    return;
  }
  if(typeof chosenDur === 'number'){
    const interval = DURATIONS[chosenDur];
    const filtered = pool.filter(r => Number.isFinite(r.durationMinutes) && r.durationMinutes >= interval.min && r.durationMinutes <= interval.max);
    if(filtered.length>0) pool = filtered;
  }
  const route = pool[randInt(0, pool.length-1)];
  const now = nowMs();
  // prioritise aircraft of same airline at hub, then any idle at hub
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase() === airlineName.toLowerCase());
  if(candidates.length === 0){
    candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  }
  if(candidates.length === 0){
    resultEl.style.display='block';
    resultEl.innerHTML = `<div class="res-header"><div class="res-title">Нет свободных самолётов</div></div><div class="res-body"><div class="res-row"><div class="res-label">Отправление</div><div class="res-value">${esc(route.fromCity)} (${esc(route.fromICAO)})</div></div><div class="res-row"><div class="res-label">Причина</div><div class="res-value">Нет доступных idle самолётов в этом хабе</div></div></div>`;
    return;
  }
  // choose best candidate (seat closeness)
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];
  const reserveRes = reserveAircraft(candidate, LOCAL_USER_ID);
  if(!reserveRes.ok){
    resultEl.style.display='block';
    resultEl.innerHTML = `<div class="res-header"><div class="res-title">Ошибка резервирования</div></div><div class="res-body"><div class="res-row"><div class="res-label">Причина</div><div class="res-value">Не удалось зарезервировать самолёт (${reserveRes.reason})</div></div></div>`;
    return;
  }
  lastGenerated = { route, aircraftId: candidate.id, token: reserveRes.token, reservedAt: nowMs() };
  renderReservationResult(lastGenerated);
  renderFleetList();
}

/* ---------------- reservation result card ---------------- */
function renderReservationResult(gen){
  if(!gen){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const ac = FLEET.find(a => a.id === gen.aircraftId);
  if(!ac){ resultEl.style.display='none'; resultEl.innerHTML=''; return; }
  const route = gen.route;
  const token = gen.token;
  const remaining = ac.reservedUntil ? Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000)) : 0;

  resultEl.style.display='block';
  resultEl.innerHTML = `
    <div class="res-header">
      <div class="res-title">Резерв создан</div>
      <div style="margin-left:auto;color:var(--muted)">${esc(AIRLINES[chosenAirIndex].name)}</div>
    </div>
    <div class="res-body">
      <div class="res-row"><div class="res-label">Отправление</div><div class="res-value">${esc(route.fromCity)} <span style="color:var(--accent)">(${esc(route.fromICAO)})</span></div></div>
      <div class="res-row"><div class="res-label">Прибытие</div><div class="res-value">${esc(route.toCity)} <span style="color:var(--accent)">(${esc(route.toICAO)})</span></div></div>
      <div class="res-row"><div class="res-label">Время в полёте</div><div class="res-value">${formatDuration(route.durationMinutes)}</div></div>
      <div class="res-row"><div class="res-label">Резервированный самолёт</div><div class="res-value">${esc(ac.id)} · ${esc(ac.type)} · <span style="font-weight:700">${esc(ac.airline)}</span></div></div>
    </div>
    <div class="res-actions">
      <button id="confirmBtn" class="btn btn-primary">Подтвердить полёт</button>
      <button id="cancelBtn" class="btn btn-ghost">Отменить резерв</button>
      <div style="flex:1"></div>
      <div class="muted">Резерв истечёт через <span id="reserveCountdown">${remaining}</span> с</div>
    </div>
  `;
  document.getElementById('confirmBtn').onclick = ()=> {
    const res = confirmReservation(token, route);
    if(!res.ok){ alert('Не удалось подтвердить: ' + (res.reason || 'unknown')); return; }
    lastGenerated = null;
    renderReservationResult(null);
  };
  document.getElementById('cancelBtn').onclick = ()=> {
    cancelReservationByToken(token);
    lastGenerated = null;
    renderReservationResult(null);
  };
}

/* ---------------- render confirmed flight ---------------- */
function renderConfirmedFlight(ac, route){
  confirmedSection.innerHTML = '';
  const now = nowMs();
  const departTime = new Date(now).toLocaleString();
  const flightMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  const eta = new Date(now + flightMs).toLocaleString();
  const div = document.createElement('div');
  div.className = 'confirmed-card';
  div.innerHTML = `
    <div class="confirmed-header"><div class="confirmed-title">Рейс подтверждён</div><div style="margin-left:auto;color:var(--muted)">Самолёт: ${esc(ac.id)} · ${esc(ac.airline)}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div>
        <div style="font-size:12px;color:var(--muted)">Авиакомпания</div>
        <div style="font-weight:900">${esc(AIRLINES[chosenAirIndex].name)}</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted)">Статус</div>
        <div style="font-weight:900;color:#bff2be">inFlight</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted)">Отправление</div>
        <div style="font-weight:900">${esc(route.fromCity)} <span style="color:var(--accent)">(${esc(route.fromICAO)})</span></div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">Время отправления</div>
        <div style="font-weight:700">${esc(departTime)}</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted)">Прибытие</div>
        <div style="font-weight:900">${esc(route.toCity)} <span style="color:var(--accent)">(${esc(route.toICAO)})</span></div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">Ожидаемое прибытие</div>
        <div style="font-weight:700">${esc(eta)}</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted)">Длительность</div>
        <div style="font-weight:900">${formatDuration(route.durationMinutes)}</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted)">Местоположение самолёта</div>
        <div style="font-weight:900">${esc(ac.locationICAO)} → ${esc(ac.nextLocation || route.toICAO)}</div>
      </div>
    </div>
    <div style="margin-top:10px;color:var(--muted);font-size:13px">Лог: запись добавлена в журнал назначений</div>
  `;
  confirmedSection.appendChild(div);
}

/* ---------------- Utilities ---------------- */
function formatDuration(min){
  if(!Number.isFinite(min)) return 'n/a';
  const hh = Math.floor(min/60), mm = min%60;
  return pad(hh) + ':' + pad(mm);
}

/* ---------------- assignment helpers ---------------- */
function estimateDistanceKm(fromICAO, toICAO){
  const a=getAirportInfo(fromICAO), b=getAirportInfo(toICAO);
  if(!a||!b||!a.lat||!b.lat) return null;
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const la=toRad(a.lat), lb=toRad(b.lat);
  const sinDlat=Math.sin(dLat/2), sinDlon=Math.sin(dLon/2);
  const c=2*Math.asin(Math.sqrt(sinDlat*sinDlat + Math.cos(la)*Math.cos(lb)*sinDlon*sinDlon));
  return Math.round(R*c);
}

function findSuitableAircraftSmart(route, nowTs=Date.now()){
  const distanceKm = estimateDistanceKm(route.fromICAO, route.toICAO);
  const safety = 0.95;
  const basePool = FLEET.filter(ac=>{
    if(ac.status === 'inFlight' && ac.availableAt > nowTs) return false;
    if(ac.status === 'reserved') return false;
    if((ac.locationICAO||'').toUpperCase() !== (route.fromICAO||'').toUpperCase()) return false;
    if(distanceKm === null) return true;
    return ac.rangeKm * safety >= distanceKm;
  });
  basePool.sort((a,b)=>Math.abs(a.seats-180)-Math.abs(b.seats-180));
  return { distanceKm, candidates: basePool };
}

function assignAircraftToRouteSmart(route){
  const now = Date.now();
  const { distanceKm, candidates } = findSuitableAircraftSmart(route, now);
  if(candidates.length === 0){
    FLEET_LOG.push({ ts: now, event:'assign_failed', route: `${route.fromICAO}->${route.toICAO}`, distanceKm });
    renderAssignLog();
    return { ok:false, reason:'no_suitable', distanceKm };
  }
  const ac = candidates[0];
  const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight';
  ac.availableAt = now + durationMs + ac.turnaround*60*1000;
  ac.nextLocation = route.toICAO;
  FLEET_LOG.push({ ts: now, event:'assign', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes, distanceKm });
  renderFleetList();
  renderAssignLog();
  return { ok:true, aircraft: ac, distanceKm };
}

function renderAssignLog(){
  const items = FLEET_LOG.slice(-40).reverse();
  if(items.length===0){ assignLogEl.textContent='Пока пусто'; return; }
  assignLogEl.innerHTML = items.map(it=>{
    const t = new Date(it.ts).toLocaleTimeString();
    if(it.event === 'assign') return `${t} — assign ${it.aircraft} ${it.route} (${it.durationMin} min, ${it.distanceKm || 'n/a'} km)`;
    if(it.event === 'assign_confirmed') return `${t} — confirmed ${it.aircraft} ${it.route} (${it.durationMin || 'n/a'} min)`;
    if(it.event === 'reservation_expired') return `${t} — reservation_expired ${it.aircraft}`;
    if(it.event === 'available') return `${t} — available ${it.aircraft} @ ${it.location}`;
    if(it.event === 'assign_failed') return `${t} — assign_failed ${it.route} (dist ${it.distanceKm || 'n/a'})`;
    return `${t} — ${it.event}`;
  }).map(s=>`<div style="margin-bottom:6px">${esc(s)}</div>`).join('');
}

/* ---------------- housekeeping interval ---------------- */
setInterval(()=>{
  expireReservations();
  if(lastGenerated){
    const ac = FLEET.find(a=>a.id === lastGenerated.aircraftId);
    if(ac && ac.reservedUntil){
      const el = document.getElementById('reserveCountdown');
      if(el) el.textContent = Math.max(0, Math.ceil((ac.reservedUntil - nowMs())/1000));
    } else {
      lastGenerated = null;
      renderReservationResult(null);
    }
  }
}, 1000);

/* ---------------- UI actions ---------------- */
function selectAir(origIndex){
  chosenAirIndex = origIndex;
  selectedInfo.textContent = AIRLINES[origIndex].name + ' · ' + AIRLINES[origIndex].hubs.join(',');
  document.querySelectorAll('.airline-item').forEach(n=> n.classList.toggle('selected', Number(n.dataset.origIndex)===origIndex) );
  document.querySelectorAll('.airline-group').forEach(group=>{
    const badge = group.querySelector('.airline-badge');
    const hubCode = badge ? badge.textContent.trim().toUpperCase() : '';
    const airlineHubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    const list = group.querySelector('.airline-list');
    const chev = group.querySelector('.chev');
    if(airlineHubs.includes(hubCode)){
      list.style.height = list.scrollHeight + 'px'; if(chev) chev.style.transform='rotate(0deg)';
      list.addEventListener('transitionend', function _once(e){ if(e.propertyName==='height') list.style.height='auto'; list.removeEventListener('transitionend', _once); });
    } else {
      list.style.height = list.scrollHeight + 'px'; requestAnimationFrame(()=>list.style.height='0px'); if(chev) chev.style.transform='rotate(-90deg)';
    }
  });
  resultEl.style.display='none';
  resultEl.innerHTML='';
}

function selectDur(i){
  chosenDur = i;
  Array.from(durationsWrap.children).forEach((n,idx)=> n.classList.toggle('selected', idx===i));
  resultEl.style.display='none';
}

document.getElementById('gen').addEventListener('click', ()=> {
  if(lastGenerated && lastGenerated.token){
    if(!confirm('У вас уже есть активный резерв. Создать новый резерв отменит старый?')) return;
    cancelReservationByToken(lastGenerated.token);
    lastGenerated = null;
    renderReservationResult(null);
  }
  generateFlight();
});
document.getElementById('demo').addEventListener('click', ()=>{ const idx=AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0){ selectAir(idx); selectDur(2); } generateFlight(); });
document.getElementById('reset').addEventListener('click', ()=>{ chosenAirIndex=null; chosenDur=null; lastGenerated=null; selectedInfo.textContent='—'; document.querySelectorAll('.airline-item').forEach(n=>n.classList.remove('selected')); document.querySelectorAll('#durations .opt').forEach(n=>n.classList.remove('selected')); resultEl.style.display='none'; resultEl.innerHTML=''; confirmedSection.innerHTML=''; });
refreshFleetBtn.addEventListener('click', ()=>{ renderFleetList(); renderAssignLog(); });
showFleetLogBtn.addEventListener('click', ()=>{ console.table(FLEET_LOG.slice(-50)); alert('Лог флота в консоли'); });
clearLogBtn && clearLogBtn.addEventListener('click', ()=>{ FLEET_LOG.length=0; renderAssignLog(); });

/* ---------------- INIT ---------------- */
function renderAll(){
  renderAirlines();
  renderDurations();
  renderFleetList();
  renderAssignLog();
  routesCount.textContent = ROUTES.length;
}
renderAll();
</script>
</body>
</html>
