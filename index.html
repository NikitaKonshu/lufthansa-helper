<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lufthansa Crew Portal - v19</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* CONFIG */
        :root {
            --bg-color: #f2f4f7; --card-bg: #ffffff; --text-main: #1a1a1a; --text-sub: #595959;
            --border-color: #e0e0e0; --brand-blue: #05164d; --brand-yellow: #ffb600;
            --header-bg: #05164d; --input-bg: #ffffff; --metar-bg: #eee;
            --logo-brightness: brightness(0) invert(1);
        }

        body.dark-mode {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sub: #a0a0a0;
            --border-color: #333333; --brand-blue: #3a3a3a; --brand-yellow: #ffb600;
            --header-bg: #000000; --input-bg: #252525; --metar-bg: #2a2a2a;
            --logo-brightness: brightness(0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Open Sans', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .mono-text { font-family: 'Roboto Mono', monospace; }

        /* UI Elements */
        .btn {
            background-color: var(--brand-blue); color: #fff; border: 1px solid transparent;
            padding: 12px 28px; font-size: 0.9rem; cursor: pointer; border-radius: 4px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center;
        }
        body.dark-mode .btn { border-color: #444; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; color: #666; }
        .btn-yellow { background-color: var(--brand-yellow); color: #05164d !important; border: none !important; }
        .btn-yellow:hover { background-color: #ffcc33; }
        
        input, select {
            width: 100%; padding: 14px 15px; margin: 8px 0 20px 0;
            border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 1rem; background: var(--input-bg); color: var(--text-main);
        }
        input:focus, select:focus { outline: none; border-color: var(--brand-yellow); }

        .lh-card {
            background: var(--card-bg); padding: 30px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
            border-top: 4px solid transparent;
        }
        .border-brand { border-top-color: var(--brand-blue); }
        body.dark-mode .border-brand { border-top-color: #555; }

        h2 { color: var(--text-main); font-weight: 300; font-size: 1.8rem; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }

        header { background-color: var(--header-bg); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 25px; display: flex; justify-content: space-between; align-items: center; }
        .logo-white { filter: var(--logo-brightness); }
        
        .top-tools { display: flex; align-items: center; gap: 20px; color: white; }
        .zulu-clock { font-family: 'Roboto Mono', monospace; font-weight: 500; font-size: 1rem; opacity: 0.8; }
        .theme-toggle { background: none; border: 1px solid rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Nav */
        .nav-bar { background: var(--card-bg); border-bottom: 1px solid var(--border-color); }
        .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 25px; display: flex; overflow-x: auto; }
        .nav-item { padding: 20px 25px; background: none; border: none; color: var(--text-sub); font-weight: 600; cursor: pointer; white-space: nowrap; position: relative; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--brand-yellow); }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 25px; flex: 1; width: 100%; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-sub); letter-spacing: 1px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .briefing-paper {
            background: var(--card-bg); width: 95%; max-width: 850px; padding: 30px; border-radius: 6px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.7); color: var(--text-main); position: relative; max-height: 95vh; overflow-y: auto;
        }
        .briefing-header { display: flex; justify-content: space-between; border-bottom: 3px solid #05164d; padding-bottom: 10px; margin-bottom: 20px; }
        body.dark-mode .briefing-header { border-color: var(--brand-yellow); }
        .briefing-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; font-size: 0.9rem; }
        .data-block label { display: block; font-size: 0.7rem; color: var(--text-sub); font-weight: bold; }
        .data-block span { font-weight: 600; font-family: 'Roboto Mono', monospace; }
        .metar-box { font-family: 'Roboto Mono', monospace; background: var(--metar-bg); padding: 10px; font-size: 0.85rem; margin-top: 5px; border-left: 4px solid var(--brand-yellow); color: var(--text-main); min-height: 40px; display: flex; align-items: center; }
        #map { width: 100%; height: 250px; margin: 20px 0; border: 1px solid var(--border-color); z-index: 1; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid var(--brand-yellow); width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Fleet & Progress */
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .aircraft-card { min-height: 200px; display: flex; flex-direction: column; }
        
        .aircraft-data-box { 
            background: var(--bg-color); 
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        .aircraft-data-box p {
            font-size: 0.9rem;
            line-height: 1.8;
            color: var(--text-sub);
        }
        .aircraft-data-box strong {
            color: var(--text-main);
            font-weight: 600;
            float: right;
        }

        .progress-container { width: 100%; background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--brand-yellow); width: 0%; transition: width 1s linear; }
        .flight-timer { font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; text-align: right; }

        /* WELCOME SCREEN */
        #welcome-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') center/cover no-repeat; display: flex; align-items: center; justify-content: center; }
        .welcome-overlay { background: rgba(10, 10, 10, 0.92); width: 100%; height: 100%; position: absolute; backdrop-filter: blur(5px); }
        .welcome-content { position: relative; z-index: 2; text-align: center; color: white; padding: 20px; }
        .loader-bar { width: 300px; height: 2px; background: rgba(255,255,255,0.1); margin: 30px auto; overflow: hidden; }
        .loader-progress { height: 100%; background: #fff; width: 0%; animation: loadProgress 5s ease-in-out forwards; }
        @keyframes loadProgress { 0% { width: 0%; } 100% { width: 100%; } }
        .system-status-text { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; opacity: 0.7; min-height: 1.2em; }

        /* REDESIGNED LOGIN SCREEN V19: HIGH CONTRAST CORPORATE LOOK */
        #login-screen { 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-color: var(--brand-blue); /* Deep Blue LH background */
        }
        .login-box { 
            background: #ffffff; /* Crisp White Background */
            padding: 50px 40px; 
            width: 100%; 
            max-width: 400px; 
            border-radius: 8px; 
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            border-top: 5px solid var(--brand-yellow); /* Strong Yellow Accent */
            color: var(--text-main); /* Dark text on white background */
        }
        .login-box h2 {
            color: var(--brand-blue); /* Use deep blue for title */
            font-weight: 600; 
            border-bottom: 1px solid var(--border-color); /* Light grey separator */
            padding-bottom: 15px;
            font-size: 1.6rem;
        }
        .login-box input {
            background: var(--input-bg); /* White input background */
            border: 1px solid var(--border-color); 
            color: var(--text-main); /* Dark text */
            margin-bottom: 25px; 
        }
        .login-box input:focus {
            border-color: var(--brand-blue); /* Focus blue */
            background: #f8f8f8;
        }
        .login-box input::placeholder {
            color: var(--text-sub); /* Grey placeholder text */
        }
        /* Ensure the logo is the COLORED (non-filtered) version on white background */
        .login-box img {
            filter: none; 
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="welcome-overlay"></div>
        <div class="welcome-content">
            <div style="margin-bottom: 40px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo-white" alt="LH Logo" width="220">
            </div>
            <div style="font-weight: 300; font-size: 1.1rem; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 15px; opacity: 0.7;">Lufthansa Group</div>
            <h1 style="font-weight: 800; font-size: 2.5rem; letter-spacing: 2px; margin: 0;">CREW OPS</h1>
            <div style="margin-top: 20px; height: 60px; display: flex; flex-direction: column; justify-content: flex-end;">
                 <div class="system-status-text" id="sys-status-1">Initializing Datalink...</div>
                 <div class="system-status-text" id="sys-status-2">Syncing Schedule...</div>
            </div>
            <div class="loader-bar"><div class="loader-progress"></div></div>
        </div>
    </div>

    <div id="login-screen" class="hidden">
        <div class="login-box fade-in">
            <div style="margin-bottom: 25px; display: flex; justify-content: center;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" width="140" alt="LH Logo">
            </div>
            <h2 style="text-align:center; margin-bottom: 25px;">CREW ACCESS PORTAL</h2>
            <div style="text-align: left;">
                <input type="text" id="callsign" placeholder="Callsign (e.g. DLH001)">
                <input type="password" id="password" placeholder="Password">
            </div>
            <button class="btn btn-yellow" style="width:100%; margin-top: 5px;" onclick="login()">Log In</button>
            <p id="login-error" style="color:#dc2626; margin-top:20px; font-size:0.9rem; font-weight: 600;"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header>
            <div class="header-content">
                <div class="logo-block">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo-white" alt="LH" height="45">
                </div>
                <div class="top-tools">
                    <div class="zulu-clock" id="zulu-clock">00:00 Z</div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Night Mode">üåô</button>
                    <div id="user-display" style="font-size:0.9rem; font-weight: 600;">Guest</div>
                </div>
            </div>
        </header>

        <nav class="nav-bar">
            <div class="nav-content">
                <button class="nav-item active" onclick="showTab('about', this)">Dashboard</button>
                <button class="nav-item" onclick="showTab('rules', this)">Regulations</button>
                <button class="nav-item" onclick="showTab('fleet', this)">Fleet</button>
                <button class="nav-item" onclick="showTab('routes', this)">Hubs</button>
                <button class="nav-item" onclick="showTab('generator', this)">Dispatch</button>
            </div>
        </nav>

        <div class="container">
            <div id="active-flight-banner" class="lh-card hidden fade-in" style="padding: 25px 35px; border-left: 6px solid var(--brand-yellow);">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:30px;">
                        <div>
                            <div style="text-transform:uppercase; font-size:0.75rem; color:var(--text-sub);">Current Leg</div>
                            <div style="font-size:1.5rem; font-weight:800; color:var(--text-main);"><span id="af-dep"></span> ‚ûù <span id="af-arr"></span></div>
                            <div style="font-size:1rem; color:var(--brand-yellow); font-weight:bold;" id="af-num"></div>
                        </div>
                        <div style="border-left: 2px solid var(--border-color); padding-left: 30px;">
                            <div style="text-transform:uppercase; font-size:0.75rem; color:var(--text-sub);">Equipment</div>
                            <div style="font-weight:bold; color:var(--text-main); font-size: 1.1rem;" id="af-ac"></div>
                        </div>
                        <div style="border-left: 2px solid var(--border-color); padding-left: 30px;">
                            <div style="text-transform:uppercase; font-size:0.75rem; color:var(--text-sub);">Load</div>
                            <div style="font-weight:600;" id="af-pax"></div>
                        </div>
                    </div>
                    <div>
                        <button class="btn" style="padding: 10px 20px;" onclick="completeFlight()">File PIREP (Arrival)</button>
                    </div>
                </div>
                <div class="progress-container">
                    <div id="flight-progress-bar" class="progress-bar"></div>
                </div>
                <div id="flight-timer" class="flight-timer">On Ground</div>
            </div>

            <div id="tab-about" class="tab-content fade-in">
                <h2>Captain's Logbook</h2>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val" id="stat-flights">0</div><div class="stat-label">Legs Flown</div></div>
                    <div class="stat-box"><div class="stat-val" id="stat-hours">0</div><div class="stat-label">Total Hours</div></div>
                    <div class="stat-box"><div class="stat-val" id="stat-rank" style="color:var(--brand-yellow)">-</div><div class="stat-label">Rank</div></div>
                </div>
                <div class="lh-card border-brand">
                    <h3 style="color:var(--text-main); margin-bottom:15px;">Operations Center</h3>
                    <p style="line-height:1.7; color:var(--text-sub);">Welcome back, Captain. System status is nominal.</p>
                    <br><button class="btn btn-yellow" onclick="showTab('generator', document.querySelectorAll('.nav-item')[4])">Dispatch New Flight</button>
                </div>
            </div>

            <div id="tab-rules" class="tab-content hidden fade-in">
                <h2>Regulations</h2>
                <div class="lh-card border-brand">
                    <ul style="margin-left:25px; line-height:2; color:var(--text-sub);">
                        <li>Maintain professional standards on VATSIM/IVAO.</li>
                        <li>Depart only from designated hubs.</li>
                        <li>Maintain proper flight time simulation as per system rules.</li>
                    </ul>
                </div>
            </div>

            <div id="tab-fleet" class="tab-content hidden fade-in">
                <h2>Fleet</h2>
                <div class="lh-card border-brand" style="padding: 15px 30px; margin-bottom: 20px;">
                    <label style="font-size:0.8rem; font-weight:bold; color:var(--text-main);">FILTER BY AIRLINE</label>
                    <select id="fleet-filter-airline" onchange="populateFleet()" style="margin-bottom: 0;">
                        <option value="ALL">ALL OPERATORS</option>
                        </select>
                </div>
                <div id="fleet-container" class="fleet-grid"></div>
            </div>

            <div id="tab-routes" class="tab-content hidden fade-in">
                <h2>Hub Network</h2>
                <div class="lh-card border-brand"><ul id="hub-list-display" style="margin-left:25px; line-height:2;"></ul></div>
            </div>

            <div id="tab-generator" class="tab-content hidden fade-in">
                <h2>Flight Dispatch</h2>
                <div id="generator-locked" class="lh-card hidden" style="text-align:center; background-color: rgba(255, 182, 0, 0.1); border-color: var(--brand-yellow);">
                    <h3 style="color: var(--brand-yellow);">Aircraft Airborne</h3>
                    <p style="color:var(--text-sub)">Complete current sector first.</p>
                </div>
                <div id="generator-form" class="lh-card border-brand">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div><label style="font-size:0.8rem; font-weight:bold; color:var(--text-main);">OPERATOR</label>
                        <select id="gen-airline" onchange="updateHubs()"><option value="">-- Select Airline --</option></select></div>
                        <div><label style="font-size:0.8rem; font-weight:bold; color:var(--text-main);">DEPARTURE HUB</label>
                        <select id="gen-hub" disabled><option value="">Select Airline First</option></select></div>
                    </div>
                    <label style="font-size:0.8rem; font-weight:bold; color:var(--text-main);">RANGE PREFERENCE</label>
                    <select id="gen-time">
                        <option value="short">Short Haul (1-3 hrs)</option>
                        <option value="medium">Medium Haul (3-7 hrs)</option>
                        <option value="long">Long Haul (8-14 hrs)</option>
                    </select>
                    <button id="generate-btn" class="btn" style="width:100%; margin-top:20px;" onclick="generateFlight()">Generate OFP (Live WX)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="briefing-modal" class="modal-overlay hidden">
        <div class="briefing-paper fade-in">
            <div class="briefing-header">
                <div>
                    <h2 style="margin:0; font-size:1.5rem; border:none; padding:0;">OPERATIONAL FLIGHT PLAN</h2>
                    <div style="font-size:0.9rem; opacity:0.7;">Lufthansa Systems | Live Data</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:1.2rem;" id="br-flight-num"></div>
                    <div style="color:#d00; font-weight:bold; font-size:0.8rem;">OFFICIAL</div>
                </div>
            </div>

            <div class="briefing-grid">
                <div class="data-block"><label>DEPARTURE</label><span id="br-dep"></span></div>
                <div class="data-block"><label>ARRIVAL</label><span id="br-arr"></span></div>
                <div class="data-block"><label>AIRCRAFT</label><span id="br-ac"></span></div>
                
                <div class="data-block"><label>GATE (DEP)</label><span id="br-gate-dep"></span></div>
                <div class="data-block"><label>GATE (ARR)</label><span id="br-gate-arr"></span></div>
                <div class="data-block"><label>ETE</label><span id="br-time"></span></div>

                <div class="data-block"><label>FLIGHT LEVEL</label><span id="br-fl"></span></div>
                <div class="data-block"><label>ALTERNATE</label><span id="br-altn"></span></div>
                <div class="data-block"><label>PAX / CAP</label><span id="br-pax"></span></div>
                
                <div class="data-block"><label>CARGO</label><span id="br-cargo"></span></div>
                <div class="data-block"><label>ZFW (EST)</label><span id="br-zfw"></span></div>
            </div>

            <div id="map"></div>

            <div style="margin-bottom:20px;">
                <h4 style="margin-bottom:5px;">LIVE METAR REPORT (AVWX API)</h4>
                <div class="metar-box" id="br-metar-dep"><div class="spinner"></div> Fetching live weather...</div>
                <div class="metar-box" id="br-metar-arr"><div class="spinner"></div> Fetching live weather...</div>
            </div>

            <button class="btn btn-yellow" style="width:100%;" onclick="confirmBriefing()">ACCEPT & FILE FLIGHT PLAN</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const USERS = [{ callsign: "DLH001", pass: "1234", name: "Capt. Hans" }];
        // 1 Flight Hour = 30 Real Seconds (Game Speed)
        const SECONDS_PER_FLIGHT_HOUR = 30; 

        const REAL_GATES = {
            "EDDF": ["A13", "A20", "Z50", "B24"], "EDDM": ["G08", "G30", "H12", "L11"],
            "KJFK": ["4", "8", "12"], "EGLL": ["A10", "B34"],
            "LOWW": ["F01", "G03"], "LSZH": ["A06", "E18"]
        };

        // –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–ü–ò–°–û–ö –ê–í–ò–ê–ö–û–ú–ü–ê–ù–ò–ô –ò –•–ê–ë–û–í
        const AIRLINES = {
            // Lufthansa Group
            "Lufthansa": { hubs: ["EDDF (Frankfurt)", "EDDM (Munich)"], code: "DLH" },
            "SWISS": { hubs: ["LSZH (Zurich)"], code: "SWR" },
            "Austrian Airlines": { hubs: ["LOWW (Vienna)"], code: "AUA" },
            "Brussels Airlines": { hubs: ["EBBR (Brussels)"], code: "BEL" },
            "Eurowings": { hubs: ["EDDL (Dusseldorf)", "EDDH (Hamburg)"], code: "EWG" },
            "Discover Airlines": { hubs: ["EDDF (Frankfurt)"], code: "OCN" },
            "Edelweiss Air": { hubs: ["LSZH (Zurich)"], code: "EDW" },
            "Lufthansa Cargo": { hubs: ["EDDF (Frankfurt)", "EDDP (Leipzig)"], code: "GEC" },
            "Lufthansa CityLine": { hubs: ["EDDM (Munich)"], code: "CLH" },
            "Lufthansa City Airlines": { hubs: ["EDDM (Munich)"], code: "MLA" },
            "Air Dolomiti": { hubs: ["LIPZ (Venice)", "EDDM (Munich)"], code: "DLA" },
            "AeroLogic": { hubs: ["EDDP (Leipzig)", "EDDF (Frankfurt)"], code: "BOX" }, // Cargo
            
            // Other Partners/Airlines
            "AirBaltic": { hubs: ["EVRA (Riga)", "EYVI (Vilnius)", "EETN (Tallinn)"], code: "BTI" },
            "Wider√∏e": { hubs: ["ENZV (Stavanger)", "ENGM (Oslo)"], code: "WIF" },
            "Norwegian Airlines": { hubs: ["ENGM (Oslo)"], code: "NAX" },
            "Finnair": { hubs: ["EFHK (Helsinki)"], code: "FIN" },
            "SAS Scandinavian Airlines": { hubs: ["EKCH (Copenhagen)", "ESSA (Stockholm)", "ENGM (Oslo)"], code: "SAS" },
            "Condor": { hubs: ["EDDF (Frankfurt)"], code: "CFG" },
            "SunExpress": { hubs: ["LTBA (Istanbul)", "EDDV (Hannover)"], code: "SXS" },
            "ITA Airways": { hubs: ["LIRF (Rome)"], code: "ITY" } 
        };

        // –§–õ–û–¢ –° –ü–†–ò–í–Ø–ó–ö–û–ô –ö –û–ü–ï–†–ê–¢–û–†–ê–ú
        const FLEET = [
            // Narrowbody
            { type: "Airbus A319", maxHours: 5, seats: 138, fuelReserve: "6,500 KG", layoutImg: "https://i.imgur.com/example_a319_layout.png", operators: ["Lufthansa", "SWISS", "Austrian Airlines", "Brussels Airlines", "Lufthansa CityLine", "Lufthansa City Airlines"] },
            { type: "Airbus A320neo", maxHours: 6, seats: 180, fuelReserve: "7,200 KG", layoutImg: "https://i.imgur.com/example_a320_layout.png", operators: ["Lufthansa", "Eurowings", "Air Dolomiti", "SAS Scandinavian Airlines", "ITA Airways"] },
            { type: "Airbus A220-300", maxHours: 6.5, seats: 145, fuelReserve: "8,000 KG", layoutImg: "https://i.imgur.com/example_a220_layout.png", operators: ["AirBaltic", "SWISS"] },
            { type: "Boeing 737-800", maxHours: 6, seats: 189, fuelReserve: "7,000 KG", layoutImg: "https://i.imgur.com/example_b738_layout.png", operators: ["Norwegian Airlines", "SunExpress", "Condor"] },
            { type: "Embraer 190-E2", maxHours: 5.5, seats: 114, fuelReserve: "5,500 KG", layoutImg: "https://i.imgur.com/example_e190_layout.png", operators: ["Wider√∏e"] },
            
            // Widebody & Long Haul
            { type: "Airbus A330-300", maxHours: 11, seats: 255, fuelReserve: "18,000 KG", layoutImg: "https://i.imgur.com/example_a330_layout.png", operators: ["Lufthansa", "SWISS", "Austrian Airlines", "Edelweiss Air", "Finnair", "ITA Airways"] },
            { type: "Airbus A350-900", maxHours: 16, seats: 293, fuelReserve: "22,000 KG", layoutImg: "https://i.imgur.com/example_a350_layout.png", operators: ["Lufthansa", "Finnair", "Discover Airlines"] },
            { type: "Boeing 747-8", maxHours: 14, seats: 364, fuelReserve: "30,000 KG", layoutImg: "https://i.imgur.com/example_b748_layout.png", operators: ["Lufthansa"] },

            // Cargo
            { type: "Boeing 777F", maxHours: 10, seats: 0, fuelReserve: "25,000 KG", layoutImg: "N/A (Cargo)", operators: ["Lufthansa Cargo", "AeroLogic"] },
        ];

        const DESTINATIONS = [
            { code: "KJFK", city: "New York", hours: 8.5, region: "NA", lat: 40.64, lon: -73.77 },
            { code: "EGLL", city: "London", hours: 1.5, region: "EU", lat: 51.47, lon: -0.46 },
            { code: "OMDB", city: "Dubai", hours: 6.5, region: "ME", lat: 25.25, lon: 55.36 },
            { code: "RJTT", city: "Tokyo", hours: 12, region: "AS", lat: 35.54, lon: 139.77 },
            { code: "UUEE", city: "Moscow", hours: 3, region: "EU", lat: 55.97, lon: 37.41 },
            { code: "FACT", city: "Cape Town", hours: 11.5, region: "AF", lat: -33.97, lon: 18.60 },
            { code: "WSSS", city: "Singapore", hours: 12.5, region: "AS", lat: 1.36, lon: 103.98 }
        ];

        const HUB_COORDS = { "EDDF": [50.03, 8.57], "EDDM": [48.35, 11.78], "LSZH": [47.45, 8.55], "LOWW": [48.11, 16.56], "EVRA": [56.92, 23.97], "EBBR": [50.9, 4.4], "EDDL": [51.28, 6.76], "EDDH": [53.63, 9.99], "LIPZ": [45.5, 12.35], "ENZV": [58.88, 5.63], "ENGM": [60.20, 11.10], "EFHK": [60.32, 24.97], "EKCH": [55.62, 12.65], "ESSA": [59.65, 17.92], "EDDP": [51.42, 12.23], "LTBA": [40.98, 28.82], "LIRF": [41.8, 12.23], "EYVI": [54.64, 25.28], "EETN": [59.41, 24.83], "EDDV": [52.46, 9.68] };

        let currentUser = null;
        let generatedFlightTemp = null;
        let pilotStats = { flights: 0, hours: 0 };
        let mapObject = null;
        let progressInterval = null;

        window.onload = function() {
            simulateBootSequence();
            populateAirlinesSelect();
            populateFleetFilter(); 
            populateFleet();
            populateHubsInfo();
            loadStats();
            startClock();
        };

        function simulateBootSequence() {
            setTimeout(() => { document.getElementById('sys-status-1').innerText = "ACARS: OK. Datalink: ESTABLISHED."; }, 1500);
            setTimeout(() => { document.getElementById('sys-status-2').innerText = "Weather Radar: SELF-TEST OK."; }, 3000);
            setTimeout(() => { goToLogin(); }, 4500); 
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('zulu-clock').innerText = `${String(now.getUTCHours()).padStart(2,'0')}:${String(now.getUTCMinutes()).padStart(2,'0')} Z`;
            }, 1000);
        }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        
        function showTab(n, b) {
            const tabs = document.getElementsByClassName('tab-content');
            for(let t of tabs) t.classList.add('hidden');
            document.getElementById(`tab-${n}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(b) b.classList.add('active');
        }

        function goToLogin() {
            const w = document.getElementById('welcome-screen');
            w.style.opacity = '0';
            w.style.pointerEvents = 'none'; 
            setTimeout(() => { 
                w.classList.add('hidden'); 
                document.getElementById('login-screen').classList.remove('hidden'); 
            }, 800);
        }

        function login() {
            const c = document.getElementById('callsign').value.toUpperCase();
            const p = document.getElementById('password').value;
            if(USERS.find(u => u.callsign === c && u.pass === p)){ 
                document.getElementById('user-display').innerText = USERS.find(u => u.callsign === c).name; 
                document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('dashboard').classList.remove('hidden'); 
                checkActiveFlight();
            } else { 
                document.getElementById('login-error').innerText = "Try DLH001 / 1234"; 
            }
        }

        function loadStats() { 
            const s = localStorage.getItem('pilotStats'); 
            if(s) pilotStats = JSON.parse(s); 
            updateStatsUI(); 
        }
        function updateStatsUI() {
            document.getElementById('stat-flights').innerText = pilotStats.flights;
            document.getElementById('stat-hours').innerText = Math.floor(pilotStats.hours);
            let rank = "Second Officer";
            if(pilotStats.flights > 5) rank = "First Officer";
            if(pilotStats.flights > 20) rank = "Captain";
            document.getElementById('stat-rank').innerText = rank;
        }

        function openLayout(type, url) {
            if (url.includes('example')) {
                alert(`Layout for ${type} is not yet available. Please replace the placeholder link with a real image link for ${type} in the FLEET data.`);
            } else {
                window.open(url, '_blank');
            }
        }

        function populateFleetFilter() {
            const s = document.getElementById('fleet-filter-airline');
            while (s.options.length > 1) {
                s.remove(1);
            }
            const sortedAirlines = Object.keys(AIRLINES).sort();
            sortedAirlines.forEach(a => {
                let o = document.createElement('option'); 
                o.value = a; 
                o.text = a; 
                s.add(o);
            });
        }

        function populateFleet() {
            const c = document.getElementById('fleet-container'); 
            const filterValue = document.getElementById('fleet-filter-airline').value;
            c.innerHTML = '';

            const filteredFleet = FLEET.filter(ac => 
                filterValue === "ALL" || ac.operators.includes(filterValue)
            );

            if (filteredFleet.length === 0) {
                c.innerHTML = `<div class="lh-card" style="grid-column: 1 / -1; text-align: center; color: var(--text-sub);">
                                    –ù–µ—Ç —Ç–∏–ø–æ–≤ –≤–æ–∑–¥—É—à–Ω—ã—Ö —Å—É–¥–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö ${filterValue}.
                                </div>`;
                return;
            }

            filteredFleet.forEach(ac => { 
                c.innerHTML += `
                <div class="lh-card aircraft-card border-brand">
                    <h4 style="color:var(--text-main);">${ac.type}</h4>
                    <div class="aircraft-data-box">
                        <p>Max Passengers: <strong>${ac.seats}</strong></p>
                        <p>Max Flight Time: <strong>${ac.maxHours}h</strong></p>
                        <p>Fuel Reserve Req.: <strong>${ac.fuelReserve}</strong></p>
                    </div>
                    <button class="btn btn-yellow" style="width:100%; padding:10px;" 
                            onclick="openLayout('${ac.type}', '${ac.layoutImg}')">
                        Seating Layout / –†–∞—Åc–∞–¥–∫–∞
                    </button>
                    <div style="font-size:0.75rem; color:var(--text-sub); margin-top:10px;">
                        –û–ø–µ—Ä–∞—Ç–æ—Ä—ã: ${ac.operators.slice(0, 3).join(', ')}${ac.operators.length > 3 ? '...' : ''}
                    </div>
                </div>`; 
            });
        }
        
        function populateAirlinesSelect() { 
            const s = document.getElementById('gen-airline'); 
            // Clear all existing options first, keeping the default empty one.
            s.innerHTML = '<option value="">-- Select Airline --</option>';
            const sortedAirlines = Object.keys(AIRLINES).sort();
            sortedAirlines.forEach(a => { 
                let o = document.createElement('option'); 
                o.value=a; 
                o.text=a; 
                s.add(o); 
            });
        }
        function populateHubsInfo() { 
            const l = document.getElementById('hub-list-display'); 
            l.innerHTML = "";
            const sortedAirlines = Object.keys(AIRLINES).sort();
            sortedAirlines.forEach(a => { 
                l.innerHTML += `<li><strong style="color:var(--text-main)">${a}:</strong> ${AIRLINES[a].hubs.join(", ")}</li>`; 
            });
        }
        function updateHubs() {
            const a = document.getElementById('gen-airline').value, h = document.getElementById('gen-hub'); 
            h.innerHTML = "";
            if(!a){ h.disabled=true; return; } h.disabled=false;
            AIRLINES[a].hubs.forEach(x => { let o = document.createElement('option'); o.value=x; o.text=x; h.add(o); });
        }

        // --- FLIGHT LOGIC ---

        async function fetchSafeMETAR(icao) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);

            try {
                const r = await fetch(`https://avwx.rest/api/metar/${icao}?options=summary&format=json`, { signal: controller.signal });
                clearTimeout(timeoutId);
                if(!r.ok) throw new Error("API Fail");
                const d = await r.json(); 
                return d.raw;
            } catch (err) {
                return `${icao} METAR UNAVAILABLE (OFFLINE)`;
            }
        }

        function generateGate(icao) {
            if (REAL_GATES[icao]) return REAL_GATES[icao][Math.floor(Math.random() * REAL_GATES[icao].length)];
            const zones = ['A','B','C','Z']; 
            return zones[Math.floor(Math.random()*zones.length)] + Math.floor(Math.random()*40+1);
        }

        async function generateFlight() {
            const btn = document.getElementById('generate-btn');
            
            try {
                const an = document.getElementById('gen-airline').value;
                const h = document.getElementById('gen-hub').value;
                const tp = document.getElementById('gen-time').value;

                if(!an || !h){ alert("Select Airline & Hub"); return; }
                
                btn.disabled = true; 
                btn.innerHTML = '<div class="spinner"></div> Computing...';

                let minH = 1, maxH = 3; 
                if(tp === 'medium'){ minH = 3; maxH = 7; } 
                if(tp === 'long'){ minH = 8; maxH = 14; }
                
                // Filter fleet by selected airline and range preference
                const availAC = FLEET.filter(ac => 
                    ac.operators.includes(an) &&
                    (tp === 'long' ? ac.maxHours >= 8 : (tp === 'short' ? ac.maxHours < 8 : ac.maxHours >= 3))
                );

                if(availAC.length === 0){ alert(`No suitable aircraft found for ${an} in the selected range.`); btn.disabled = false; btn.innerText = 'Generate OFP (Live WX)'; return; }

                const ac = availAC[Math.floor(Math.random() * availAC.length)];
                const dests = DESTINATIONS.filter(d => d.hours >= minH && d.hours <= maxH);
                const dest = dests.length > 0 ? dests[Math.floor(Math.random() * dests.length)] : DESTINATIONS[0];
                const depIcao = h.split(' ')[0];

                const loadFactor = 0.6 + Math.random() * 0.4;
                const pax = Math.floor(ac.seats * loadFactor);
                const cargo = Math.floor(Math.random() * 5000) + 1000;
                const zfw = 40000 + (pax * 85) + cargo;
                
                const flightTimeHours = (Math.random() * (maxH - minH) + minH).toFixed(1);

                generatedFlightTemp = {
                    dep: depIcao, arr: dest.code, ac: ac.type, 
                    time: flightTimeHours,
                    num: AIRLINES[an].code + (Math.floor(Math.random() * 900) + 100),
                    fl: "FL" + (Math.floor(Math.random() * 6) * 20 + 320), altn: "EDDK",
                    depLat: HUB_COORDS[depIcao] ? HUB_COORDS[depIcao][0] : 50.0, 
                    depLon: HUB_COORDS[depIcao] ? HUB_COORDS[depIcao][1] : 8.0,
                    arrLat: dest.lat, arrLon: dest.lon,
                    pax: pax, cargo: cargo, zfw: zfw,
                    gateDep: generateGate(depIcao), gateArr: generateGate(dest.code),
                    metarDep: "Loading...", metarArr: "Loading..."
                };

                showBriefingModal(true);

                const [m1, m2] = await Promise.all([
                    fetchSafeMETAR(generatedFlightTemp.dep), 
                    fetchSafeMETAR(generatedFlightTemp.arr)
                ]);
                
                generatedFlightTemp.metarDep = m1; 
                generatedFlightTemp.metarArr = m2;
                updateBriefingWeather();

            } catch (error) {
                alert("System Error: " + error.message);
            } finally {
                btn.disabled = false; 
                btn.innerText = 'Generate OFP (Live WX)';
            }
        }

        function showBriefingModal(loading) {
            if(!generatedFlightTemp) return;
            const g = generatedFlightTemp;
            
            document.getElementById('br-dep').innerText = g.dep; 
            document.getElementById('br-arr').innerText = g.arr;
            document.getElementById('br-ac').innerText = g.ac; 
            document.getElementById('br-flight-num').innerText = g.num;
            document.getElementById('br-time').innerText = g.time + " h"; 
            document.getElementById('br-fl').innerText = g.fl;
            document.getElementById('br-altn').innerText = g.altn;
            document.getElementById('br-gate-dep').innerText = g.gateDep; 
            document.getElementById('br-gate-arr').innerText = g.gateArr;
            document.getElementById('br-pax').innerText = `${g.pax} PAX`;
            document.getElementById('br-cargo').innerText = `${g.cargo} KG`;
            document.getElementById('br-zfw').innerText = `${(g.zfw/1000).toFixed(1)} T`;

            if(loading) {
                document.getElementById('br-metar-dep').innerHTML = '<div class="spinner"></div> Connecting...';
                document.getElementById('br-metar-arr').innerHTML = '<div class="spinner"></div> Connecting...';
            }
            
            document.getElementById('briefing-modal').classList.remove('hidden');

            setTimeout(() => {
                if(mapObject) { mapObject.off(); mapObject.remove(); }
                mapObject = L.map('map').setView([g.depLat, g.depLon], 3);
                
                let tileUrl = document.body.classList.contains('dark-mode') 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                    : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

                L.tileLayer(tileUrl, { attribution: '&copy; OSM &copy; CARTO' }).addTo(mapObject);

                L.marker([g.depLat, g.depLon]).addTo(mapObject).bindPopup("DEP"); 
                L.marker([g.arrLat, g.arrLon]).addTo(mapObject).bindPopup("ARR");
                
                const route = L.polyline([[g.depLat, g.depLon], [g.arrLat, g.arrLon]], { 
                    color: document.body.classList.contains('dark-mode') ? '#ffb600' : '#05164d', 
                    weight: 3 
                }).addTo(mapObject);
                
                try { mapObject.fitBounds(route.getBounds(), {padding:[50,50]}); } catch(e){}
            }, 300);
        }

        function updateBriefingWeather() {
            if(document.getElementById('br-metar-dep')) {
                document.getElementById('br-metar-dep').innerText = generatedFlightTemp.metarDep;
                document.getElementById('br-metar-arr').innerText = generatedFlightTemp.metarArr;
            }
        }

        function confirmBriefing() {
            document.getElementById('briefing-modal').classList.add('hidden');
            
            generatedFlightTemp.startTime = Date.now();
            generatedFlightTemp.durationMs = generatedFlightTemp.time * SECONDS_PER_FLIGHT_HOUR * 1000;
            
            localStorage.setItem('activeFlight', JSON.stringify(generatedFlightTemp)); 
            checkActiveFlight();
        }

        function checkActiveFlight() {
            const d = localStorage.getItem('activeFlight');
            if(d) {
                const f = JSON.parse(d);
                document.getElementById('active-flight-banner').classList.remove('hidden');
                document.getElementById('af-dep').innerText = f.dep; 
                document.getElementById('af-arr').innerText = f.arr;
                document.getElementById('af-num').innerText = f.num; 
                document.getElementById('af-ac').innerText = f.ac;
                document.getElementById('af-pax').innerText = `${f.pax} PAX`;
                
                document.getElementById('generator-form').classList.add('hidden'); 
                document.getElementById('generator-locked').classList.remove('hidden');

                if(progressInterval) clearInterval(progressInterval);
                progressInterval = setInterval(updateFlightProgress, 1000);
                updateFlightProgress();

            } else {
                document.getElementById('active-flight-banner').classList.add('hidden');
                document.getElementById('generator-form').classList.remove('hidden'); 
                document.getElementById('generator-locked').classList.add('hidden');
                if(progressInterval) clearInterval(progressInterval);
            }
        }

        function updateFlightProgress() {
            const d = localStorage.getItem('activeFlight');
            if(!d) return;
            const f = JSON.parse(d);
            
            const elapsed = Date.now() - f.startTime;
            const progress = Math.min((elapsed / f.durationMs) * 100, 100);
            
            document.getElementById('flight-progress-bar').style.width = progress + "%";
            
            const remainingMs = Math.max(0, f.durationMs - elapsed);
            const remainingSec = Math.ceil(remainingMs / 1000);
            
            if(progress >= 100) {
                document.getElementById('flight-timer').innerText = "ARRIVED - READY TO PIREP";
                document.getElementById('flight-timer').style.color = "#00c853";
            } else {
                document.getElementById('flight-timer').innerText = `IN FLIGHT (${remainingSec}s remain)`;
                document.getElementById('flight-timer').style.color = "var(--text-sub)";
            }
        }

        function completeFlight() {
            const d = localStorage.getItem('activeFlight');
            if(!d) return;
            const f = JSON.parse(d);

            const elapsed = Date.now() - f.startTime;
            
            if(elapsed < f.durationMs) {
                alert(`Cannot file PIREP yet! Aircraft is still airborne.\nTime remaining: ${Math.ceil((f.durationMs - elapsed)/1000)}s`);
                return;
            }

            if(confirm("Confirm Arrival and File PIREP?")) {
                pilotStats.flights++; 
                pilotStats.hours += parseFloat(f.time); 
                localStorage.setItem('pilotStats', JSON.stringify(pilotStats)); 
                updateStatsUI(); 
                
                localStorage.removeItem('activeFlight'); 
                checkActiveFlight();
            }
        }
    </script>
</body>
</html>
