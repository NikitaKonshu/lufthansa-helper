<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lufthansa Systems - Crew Portal v61</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* === LUFTHANSA CORPORATE VARIABLES === */
        :root {
            --lh-navy: #05164d;       /* Deep Blue */
            --lh-yellow: #ffb600;     /* Corporate Yellow */
            --lh-yellow-hov: #e0a000;
            --lh-bg: #f2f4f7;         /* Light Gray Background */
            --lh-card: #ffffff;
            --lh-text: #05164d;       /* Dark Text */
            --lh-border: #cccccc;
            --radius: 4px;
        }
        
        body.dark-mode {
            --lh-bg: #0f172a; --lh-card: #1e293b; --lh-text: #f1f5f9; 
            --lh-border: #334155; --lh-navy: #020b26;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--lh-bg); color: var(--lh-text); min-height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* === INTRO ANIMATION === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--lh-navy); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: introFadeOut 1s ease-in-out 2.5s forwards; /* Fades out after 2.5s */
            pointer-events: none; /* Allows clicks to pass through once fading starts */
        }
        .intro-content {
            text-align: center; color: white; opacity: 0;
            animation: introFadeIn 1s ease-in-out 0.5s forwards; /* Fades in after 0.5s */
        }
        .intro-logo { height: 60px; filter: brightness(0) invert(1); margin-bottom: 20px; }
        .intro-title { font-size: 1.5rem; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; }
        
        @keyframes introFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes introFadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        /* === HEADER (Fixed Top) === */
        header {
            background: var(--lh-navy); height: 60px; width: 100%;
            display: flex; justify-content: space-between; align-items: center; padding: 0 5%;
            position: fixed; top: 0; z-index: 2000;
        }
        .logo { height: 24px; filter: brightness(0) invert(1); }
        .user-panel { color: white; font-size: 0.9rem; display: flex; gap: 20px; align-items: center; }

        /* === NAVIGATION (Fixed below header) === */
        .nav-wrap {
            background: var(--lh-card); width: 100%; height: 50px;
            position: fixed; top: 60px; z-index: 1900;
            border-bottom: 1px solid #e6e6e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-inner { max-width: 1400px; margin: 0 auto; height: 100%; display: flex; align-items: center; padding: 0 20px; overflow-x: auto; }
        .nav-btn {
            background: none; border: none; height: 100%; padding: 0 25px;
            font-size: 0.95rem; font-weight: bold; color: var(--lh-navy); cursor: pointer;
            border-bottom: 4px solid transparent; transition: 0.2s; white-space: nowrap;
        }
        .nav-btn:hover { color: var(--lh-yellow-hov); }
        .nav-btn.active { border-bottom-color: var(--lh-yellow); }
        body.dark-mode .nav-btn { color: #ccc; } body.dark-mode .nav-btn.active { color: white; border-bottom-color: var(--lh-yellow); }

        /* === MAIN LAYOUT === */
        .container { max-width: 1400px; margin: 140px auto 40px auto; padding: 0 25px; flex: 1; width: 100%; }
        
        /* Dashboard Grid (2 columns on desktop, 1 on mobile) */
        .dash-grid { display: grid; grid-template-columns: 7fr 3fr; gap: 30px; }
        
        /* Responsive Grid for Lists (Fleet/Schedule) - Stretches nicely */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Auto-fit stretches items */
            gap: 25px;
        }

        /* Standard Card */
        .card {
            background: var(--lh-card); border-radius: var(--radius); padding: 30px;
            border: 1px solid #dcdcdc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 30px;
            height: 100%; /* Ensures cards in a grid row are same height */
        }
        body.dark-mode .card { border-color: var(--lh-border); }
        
        h2 { font-weight: 300; font-size: 1.8rem; margin-bottom: 25px; color: var(--lh-navy); }
        body.dark-mode h2 { color: white; }
        
        /* === CONTROLS === */
        .label { display: block; font-size: 0.85rem; font-weight: bold; color: var(--lh-text); margin-bottom: 8px; }
        .inp {
            width: 100%; padding: 12px; border: 1px solid #898989; border-radius: 4px;
            font-size: 1rem; margin-bottom: 20px; background: white; color: black;
        }
        .inp:focus { outline: 2px solid var(--lh-navy); border-color: transparent; }
        
        .btn {
            width: 100%; padding: 14px 20px; border: none; border-radius: 4px;
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--lh-navy); color: white;
        }
        .btn-y { background: var(--lh-yellow); color: var(--lh-navy); }
        .btn-y:hover { background: var(--lh-yellow-hov); }
        .btn-red { background: #d50000; color: white; }

        /* === LOGIN SCREEN === */
        #login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000;
            background: white; display: flex; flex-direction: column;
        }
        .login-header { height: 80px; padding: 0 5%; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .login-logo { height: 30px; }
        .login-body { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding-top: 80px; background: #f9f9f9; }
        .login-card {
            background: white; padding: 45px; width: 100%; max-width: 500px;
            border: 1px solid #e0e0e0; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .login-h { font-size: 1.8rem; margin-bottom: 10px; font-weight: 300; color: #05164d; }
        .login-inp { border:none; border-bottom: 1px solid #333; border-radius:0; padding: 10px 0; background: transparent; }
        .login-inp:focus { outline:none; border-bottom: 2px solid #05164d; }
        .forgot-link { color: #666; cursor: pointer; text-decoration: underline; }
        .forgot-link:hover { color: var(--lh-navy); }

        /* === MODULE STYLES === */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px; }
        .stat-box { background: var(--lh-card); border: 1px solid #ddd; padding: 25px; text-align: center; border-radius: 4px; }
        .stat-val { font-size: 2.8rem; font-weight: 300; color: var(--lh-navy); line-height: 1.2; }
        .stat-lbl { font-size: 0.85rem; text-transform: uppercase; color: #666; margin-top: 10px; letter-spacing: 1px; font-weight: bold; }

        .af-card { border-left: 7px solid var(--lh-yellow); }
        .af-route { font-size: 2.2rem; font-weight: 300; color: var(--lh-navy); }
        .bar-bg { height: 8px; background: #e6e6e6; margin: 30px 0; border-radius: 4px; }
        .bar-fill { height: 100%; background: var(--lh-yellow); width: 0%; transition: width 1s linear; }
        
        /* === RESPONSIVE === */
        @media (max-width: 1024px) {
             .dash-grid { grid-template-columns: 1fr; } /* Stack dashboard on smaller screens */
        }
        @media (max-width: 850px) {
            .container { margin-top: 120px; padding: 0 15px; }
            .stats-row { grid-template-columns: 1fr; } /* Stack stats on mobile */
            .card { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="intro-layer">
        <div class="intro-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="intro-logo">
            <div class="intro-title">Lufthansa Systems</div>
            <div style="font-size: 0.9rem; letter-spacing: 3px; margin-top: 10px; opacity: 0.8;">CREW PORTAL</div>
        </div>
    </div>

    <div id="login-wrap">
        <div class="login-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/Lufthansa_Logo_2018.svg/1200px-Lufthansa_Logo_2018.svg.png" class="login-logo">
        </div>
        <div class="login-body">
            <div class="login-card">
                <div class="login-h">Login</div>
                <div style="font-size: 0.95rem; margin-bottom: 35px; color: #333;">Please enter your Servicecard number or Travel ID.</div>
                
                <div style="margin-bottom: 25px;">
                    <input type="text" id="callsign" class="inp login-inp" placeholder="Travel ID / Callsign (e.g., DLH001)">
                </div>
                <div style="margin-bottom: 40px;">
                    <input type="password" id="password" class="inp login-inp" placeholder="Password">
                </div>

                <button class="btn btn-y" onclick="doLogin()">Next</button>
                
                <div style="margin-top:25px; font-size:0.9rem; color:#666;">
                    <p id="login-err" style="color:#d50000; font-weight:bold; margin-bottom: 15px;"></p>
                    <span class="forgot-link" onclick="alert('Please contact your system administrator to reset your credentials.')">Forgot your PIN or password?</span>
                </div>
            </div>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/Lufthansa_Logo_2018.svg" class="logo">
        <div class="user-panel">
            <span id="clock" style="font-family:'Roboto Mono'; opacity:0.8;">00:00 Z</span>
            <span style="font-weight:bold; margin-left:20px;">Capt. Hans</span>
            <span onclick="toggleTheme()" style="cursor:pointer; margin-left:20px; font-size:1.3rem;">◑</span>
        </div>
    </header>

    <div class="nav-wrap hidden" id="nav-bar">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="tab('dash', this)">Dashboard</button>
            <button class="nav-btn" onclick="tab('fleet', this)">Fleet Overview</button>
            <button class="nav-btn" onclick="tab('routes', this)">Flight Schedule</button>
            <button class="nav-btn" onclick="tab('dispatch', this)">Dispatch Center</button>
        </div>
    </div>

    <div class="container hidden" id="main-app">
        
        <div id="tab-dash" class="tab-content">
            <div class="stats-row">
                <div class="stat-box"><div class="stat-val" id="st-fl">0</div><div class="stat-lbl">Legs Flown</div></div>
                <div class="stat-box"><div class="stat-val" id="st-hr">0</div><div class="stat-lbl">Total Hours</div></div>
                <div class="stat-box"><div class="stat-val" id="st-rk" style="color:var(--lh-yellow)">-</div><div class="stat-lbl">Current Rank</div></div>
            </div>

            <div class="dash-grid">
                <div>
                    <div id="af-card" class="card af-card hidden" style="display: flex; flex-direction: column; justify-content: space-between;">
                        <div>
                             <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                <div>
                                    <div style="font-size:0.8rem; font-weight:bold; color:#999; margin-bottom:10px; letter-spacing:1px;">ACTIVE FLIGHT</div>
                                    <div class="af-route"><span id="af-dep"></span> &#8594; <span id="af-arr"></span></div>
                                    <div style="font-family:'Roboto Mono'; margin-top:10px; font-weight:bold; font-size:1.1rem;"><span id="af-num"></span> &bull; <span id="af-ac"></span></div>
                                </div>
                                <div style="text-align:right;">
                                    <div id="af-timer" style="font-size:2rem; font-weight:300; color:var(--lh-navy);">00:00</div>
                                    <div style="font-size:0.75rem; color:#999; font-weight:bold;">REMAINING</div>
                                </div>
                            </div>
                            <div class="bar-bg"><div id="af-bar" class="bar-fill"></div></div>
                        </div>
                       
                        <div style="display:flex; gap:15px; margin-top: auto;">
                            <button class="btn btn-y hidden" id="btn-pirep" onclick="finishFlight()">FILE PIREP</button>
                            <button class="btn btn-red" onclick="cancelFlight()">CANCEL FLIGHT</button>
                        </div>
                    </div>

                    <div id="mission-box" class="card" style="background:#05164d; color:white; display: flex; flex-direction: column; justify-content: space-between;">
                        <div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                                <span style="background:#ffb600; color:#05164d; padding:4px 10px; border-radius:2px; font-weight:bold; font-size:0.8rem;">DAILY ASSIGNMENT</span>
                                <span id="mis-date" style="font-size:0.9rem; opacity:0.8;"></span>
                            </div>
                            <div id="mis-txt" style="font-size:1.8rem; font-weight:300; margin-bottom:30px;">Loading...</div>
                        </div>
                        <button class="btn" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.4);" onclick="acceptMission()">ACCEPT ASSIGNMENT</button>
                    </div>
                </div>

                <div class="card" style="height: auto;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:2px solid #f0f0f0; padding-bottom:15px;">
                        <h3 style="margin:0; color:var(--lh-navy); font-weight:bold;">Operations Center</h3>
                    </div>
                    <div id="news-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-content hidden">
            <div class="card">
                <h2>Fleet Overview</h2>
                <div style="margin-bottom:30px; max-width: 400px;">
                    <span class="label">Filter by Operator</span>
                    <select id="fl-filter" class="inp" onchange="renderFleet()"><option value="ALL">Show All Operators</option></select>
                </div>
                <div id="fleet-list" class="responsive-grid"></div>
            </div>
        </div>

        <div id="tab-routes" class="tab-content hidden">
            <div class="card">
                <h2>Flight Schedule</h2>
                <div class="grid-layout" style="margin-bottom:30px; gap: 20px;">
                    <div><span class="label">Airline</span><select id="sch-al" class="inp" onchange="renderSchedule()"></select></div>
                    <div><span class="label">Flight Duration Range</span><select id="sch-tm" class="inp" onchange="renderSchedule()">
                        <option value="ALL">Show All Durations</option>
                        <option value="1-2">Short (1-2 Hours)</option>
                        <option value="3-4">Medium (3-4 Hours)</option>
                        <option value="5-6">Long (5-6 Hours)</option>
                        <option value="7-8">Extended (7-8 Hours)</option>
                        <option value="9-10">Ultra (9-10 Hours)</option>
                        <option value="10+">Maximum (10+ Hours)</option>
                    </select></div>
                </div>
                 <div id="sch-list" class="responsive-grid"></div>
            </div>
        </div>

        <div id="tab-dispatch" class="tab-content hidden">
            <div class="card" style="max-width:700px; margin:0 auto;">
                <h2>Flight Dispatcher</h2>
                <p style="color:#666; margin-bottom:30px; font-size: 1.1rem;">Generate an Operational Flight Plan (OFP) based on specific criteria.</p>
                
                <div style="display: grid; gap: 20px;">
                    <div>
                        <span class="label">Operator</span>
                        <select id="gen-al" class="inp" onchange="updateHubs()"></select>
                    </div>
                    
                    <div>
                        <span class="label">Departure Hub</span>
                        <select id="gen-hub" class="inp" disabled></select>
                    </div>
                    
                    <div>
                        <span class="label">Target Duration</span>
                        <select id="gen-tm" class="inp">
                            <option value="ALL">Random Duration</option>
                            <option value="1-2">Short (1-2 Hours)</option>
                            <option value="3-4">Medium (3-4 Hours)</option>
                            <option value="5-6">Long (5-6 Hours)</option>
                            <option value="10+">Ultra Long (10+ Hours)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-y" onclick="generate()" style="margin-top: 20px;">GENERATE OFP</button>
            </div>
        </div>

    </div>
    <script>
        // === DATA & LOGIC (Kept from previous versions) ===
        const DB = {
            login: { u: "DLH001", p: "1234" },
            news: [
                {t:"System Status: Nominal", d:"Welcome back to the official Crew Portal. All systems are operating normally."},
                {t:"Winter Operations Update", d:"Mandatory de-icing procedures in effect for stations reporting temperatures below 3°C."},
                {t:"Crew Notice: A350 Fleet", d:"Updated operating manuals for A350-900 are now available in the document library."}
            ],
            fleet: [
                { type: "Airbus A320neo", cat: "S", seats: 180, range: 6, operators: ["Lufthansa", "Eurowings", "Austrian", "SAS"] },
                { type: "Boeing 747-8", cat: "L", seats: 364, range: 14, operators: ["Lufthansa"] },
                { type: "Airbus A350-900", cat: "L", seats: 293, range: 16, operators: ["Lufthansa", "SAS"] },
                { type: "Airbus A220", cat: "S", seats: 145, range: 6, operators: ["SWISS", "AirBaltic"] }
            ],
            hubs: { "Lufthansa": ["EDDF", "EDDM"], "SWISS": ["LSZH"], "Austrian": ["LOWW"], "Eurowings": ["EDDL"], "SAS": ["EKCH"], "AirBaltic": ["EVRA"] },
            routes: {
                "Lufthansa": [ {c:"EGLL",t:1.5}, {c:"CDG",t:1.2}, {c:"MAD",t:2.5}, {c:"DXB",t:6.0}, {c:"KJFK",t:8.5}, {c:"KLAX",t:11.5}, {c:"RJTT",t:12.0}, {c:"EZE",t:13.5} ],
                "SWISS": [ {c:"LHR",t:1.8}, {c:"JFK",t:8.5}, {c:"SIN",t:12.0} ],
                "Austrian": [ {c:"FRA",t:1.1}, {c:"BKK",t:10.5}, {c:"LHR",t:2.2} ],
                "Eurowings": [ {c:"PMI",t:2.2}, {c:"LHR",t:1.4} ],
                "SAS": [ {c:"LHR",t:1.9}, {c:"EWR",t:8.8} ],
                "AirBaltic": [ {c:"HEL",t:0.8}, {c:"DXB",t:6.5} ]
            }
        };
        // Coords removed as map modal was not explicitly requested to be fixed, but logic remains just in case.

        let stats = JSON.parse(localStorage.getItem('stats')) || { fl:0, hr:0 };
        let tempFlight=null, missionFlight=null, timer=null;

        window.onload = () => {
            // Intro animation handled by CSS animations on load
            if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
            setInterval(() => { const d=new Date(); document.getElementById('clock').innerText=`${String(d.getUTCHours()).padStart(2,0)}:${String(d.getUTCMinutes()).padStart(2,0)} Z`; }, 1000);
            renderUI(); checkFlight(); generateDailyMission();
        };

        // --- AUTH ---
        function doLogin(){
            const userIn = document.getElementById('callsign').value.toUpperCase();
            const passIn = document.getElementById('password').value;
            if(userIn === DB.login.u && passIn === DB.login.p){
                document.getElementById('login-wrap').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-wrap').classList.add('hidden');
                    document.getElementById('nav-bar').classList.remove('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                }, 500);
            } else {
                 document.getElementById('login-err').innerText="The credentials you entered are incorrect. Please try again.";
            }
        }
        function tab(n,b){
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('hidden'));
            document.getElementById('tab-'+n).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            if(b)b.classList.add('active');
        }

        // --- LOGIC ---
        function checkDuration(t,f){if(f==='ALL')return true;if(f==='1-2')return t>=1&&t<3;if(f==='3-4')return t>=3&&t<5;if(f==='5-6')return t>=5&&t<7;if(f==='7-8')return t>=7&&t<9;if(f==='9-10')return t>=9&&t<11;if(f==='10+')return t>=10;return false;}
        function getSmartPlane(al,t){const cat=t>5?'L':'S';let p=DB.fleet.filter(f=>f.operators.includes(al)&&f.cat===cat);if(!p.length)p=DB.fleet.filter(f=>f.operators.includes(al));return p.length?p[Math.floor(Math.random()*p.length)]:null;}
        
        function renderUI() {
            document.getElementById('st-fl').innerText=stats.fl; document.getElementById('st-hr').innerText=Math.floor(stats.hr);
            document.getElementById('st-rk').innerText=stats.fl>20?"Captain":(stats.fl>5?"First Officer":"Second Officer");
            const sA=document.getElementById('sch-al'), sD=document.getElementById('gen-al'), fF=document.getElementById('fl-filter');
            sA.innerHTML=''; sD.innerHTML='<option value="">-- Select Operator --</option>'; fF.innerHTML='<option value="ALL">Show All Operators</option>';
            Object.keys(DB.hubs).forEach(a=>{sA.add(new Option(a,a)); sD.add(new Option(a,a)); fF.add(new Option(a,a));});
            document.getElementById('news-list').innerHTML=DB.news.map(n=>`<div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;"><strong>${n.t}</strong><div style="font-size:0.95rem; color:#666; margin-top:5px;">${n.d}</div></div>`).join('');
            renderFleet(); renderSchedule();
        }

        // Updated to use responsive-grid class and better padding
        function renderFleet() {
            const v=document.getElementById('fl-filter').value, c=document.getElementById('fleet-list'); c.innerHTML='';
            DB.fleet.filter(f=>v==='ALL'||f.operators.includes(v)).forEach(f=>c.innerHTML+=`<div class="card" style="margin:0; padding:25px; display:flex; flex-direction:column; justify-content:center;">    <h3 style="margin:0 0 10px 0; color:var(--lh-navy);">${f.type}</h3>    <div style="font-size:1rem; color:#666;">Generating operators: ${f.operators.join(', ')}</div>    <div style="margin-top:15px; font-weight:bold; color:var(--lh-navy);">${f.seats} Seats | ${f.range}h Range</div></div>`);
        }

        // Updated to use responsive-grid class and stretch nicely
        function renderSchedule() {
            const al=document.getElementById('sch-al').value, tf=document.getElementById('sch-tm').value, g=document.getElementById('sch-list');
            if(!DB.routes[al]) { g.innerHTML="<div class='card'>Please select an airline above.</div>"; return; }
            const res=DB.routes[al].filter(r=>checkDuration(r.t, tf));
            g.innerHTML=res.length?res.map(r=>`
                <div class="card" style="margin:0; border-left:5px solid var(--lh-navy); display:flex; flex-direction:column; justify-content:space-between;">
                    <div style="margin-bottom:20px;">
                        <div style="font-size:1.4rem; font-weight:300; color:var(--lh-navy);">${DB.hubs[al][0]} &#8594; ${r.c}</div>
                        <div style="color:#666; margin-top:5px; font-weight:bold;">Flight Time: ${r.t} Hours</div>
                    </div>
                    <button class="btn btn-y" onclick="quickDispatch('${al}','${DB.hubs[al][0]}','${r.c}',${r.t})">SELECT FLIGHT</button>
                </div>`).join(''):"<div class='card'>No flights found for these criteria.</div>";
        }

        // Simplified dispatch for this version (skips modal to keep code shorter, starts immediately)
        function quickDispatch(al,d,a,t) {
            const p=getSmartPlane(al,t); if(!p){alert("No suitable aircraft found.");return;}
            tempFlight={dep:d,arr:a,time:t,ac:p.type,num:"LH"+Math.floor(Math.random()*8999+1000),start:Date.now()};
            localStorage.setItem('active',JSON.stringify(tempFlight)); checkFlight(); tab('dash');
        }

        function generate(){
            const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub').value, tm=document.getElementById('gen-tm').value;
            if(!al||!h)return;
            const r=DB.routes[al].filter(x=>checkDuration(x.t,tm));
            if(!r.length){alert("No routes match criteria");return;}
            const s=r[Math.floor(Math.random()*r.length)];
            quickDispatch(al,h,s.c,s.t);
        }
        function updateHubs(){const al=document.getElementById('gen-al').value, h=document.getElementById('gen-hub'); h.innerHTML=''; if(al){h.disabled=false;DB.hubs[al].forEach(x=>h.add(new Option(x,x)));}else h.disabled=true;}
        
        function checkFlight(){
            const s=localStorage.getItem('active');
            if(!s){document.getElementById('af-card').classList.add('hidden'); document.getElementById('mission-box').classList.remove('hidden'); return;}
            document.getElementById('af-card').classList.remove('hidden'); document.getElementById('mission-box').classList.add('hidden');
            const f=JSON.parse(s);
            ['dep','arr','num','ac'].forEach(k=>document.getElementById('af-'+k).innerText=f[k]);
            if(timer)clearInterval(timer);
            timer=setInterval(()=>{
                const el=Date.now()-f.start, dur=f.time*10000, pct=Math.min(100,(el/dur)*100);
                document.getElementById('af-bar').style.width=pct+"%";
                document.getElementById('af-timer').innerText=pct>=100?"ARRIVED":"IN FLIGHT";
                if(pct>=100) document.getElementById('btn-pirep').classList.remove('hidden');
            },1000);
        }
        function finishFlight(){const f=JSON.parse(localStorage.getItem('active')); stats.fl++; stats.hr+=f.time; localStorage.setItem('stats',JSON.stringify(stats)); localStorage.removeItem('active'); checkFlight(); renderUI();}
        function cancelFlight(){localStorage.removeItem('active'); checkFlight();}
        function generateDailyMission(){const s=new Date().getDate(), al="Lufthansa", r=DB.routes[al][s%DB.routes[al].length]; missionFlight={al,dep:DB.hubs[al][0],arr:r.c,t:r.t}; document.getElementById('mis-date').innerText=new Date().toLocaleDateString(); document.getElementById('mis-txt').innerText=`${missionFlight.dep} -> ${r.c}`; }
        function acceptMission(){quickDispatch(missionFlight.al,missionFlight.dep,missionFlight.arr,missionFlight.t);}
        function toggleTheme(){document.body.classList.toggle('dark-mode'); localStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light');}
    </script>
</body>
</html>
