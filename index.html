<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#041026; --bg-2:#06263a; --text:#eaf4ff; --muted:rgba(234,244,255,0.68);
  --accent-yellow:#ffd54a; --accent-yellow-2:#ffbf3a;
  --glass-border: rgba(255,255,255,0.06);
  --primary-dark:#072022;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
}
@media (prefers-reduced-motion: reduce){ *{ animation-duration: 1ms !important; transition-duration: 1ms !important; } }
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));color:var(--text);
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow-y:auto;
}

/* Layout + visual */
.app-root{display:flex;justify-content:center;align-items:flex-start;padding:20px;min-height:100vh}
.container{width:100%;max-width:1280px}
.hero{ margin-top:28px;border-radius:16px;padding:18px;position:relative;overflow:visible;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.012)),
    linear-gradient(180deg, rgba(0,6,18,0.55), rgba(0,6,18,0.7));
  border:1px solid rgba(255,255,255,0.04); box-shadow:0 28px 100px rgba(2,8,18,0.6); backdrop-filter: blur(10px) saturate(140%);
}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.logo{ width:64px;height:64px;border-radius:14px; background: linear-gradient(180deg,#062b34,#032029); display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent-yellow);font-size:18px; box-shadow: 0 10px 36px rgba(0,0,0,0.54), inset 0 1px 0 rgba(255,255,255,0.02); }
.subtitle{font-size:13px;color:var(--muted)}
.tabs{display:flex;gap:10px;margin-top:14px;position:relative;flex-wrap:wrap}
.tab{padding:10px 16px;border-radius:12px;font-weight:800;color:var(--text);background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .18s,box-shadow .18s}
.tab.active{ transform: translateY(-6px) scale(1.02); box-shadow: 0 20px 60px rgba(0,0,0,0.45)}
.liquid-underline{ position:absolute; height:9px; bottom:-12px; border-radius:8px; background: linear-gradient(90deg,var(--accent-yellow),var(--accent-yellow-2)); transition:left 220ms,width 220ms,opacity 220ms; box-shadow:0 12px 36px rgba(255,160,60,0.14); opacity:0; }

.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px}
.search{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);min-width:240px}
.durations{display:flex;gap:8px;flex-wrap:wrap}
.panel{ padding:14px;border-radius:12px;margin-top:12px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));border:1px solid rgba(255,255,255,0.04);box-shadow:0 24px 80px rgba(2,8,18,0.45);backdrop-filter: blur(6px) saturate(130%); position:relative; }
.airline-grid{ margin-top:14px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; width:100%; max-height:520px; overflow:auto; padding:14px; border-radius:16px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03); }
.airline{ position:relative; display:flex;gap:14px;align-items:center;padding:14px;border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 12px 36px rgba(0,0,0,0.45); cursor:pointer; transition: transform .22s, box-shadow .22s, filter .18s, background .18s; overflow:hidden; }
.airline:hover{ transform: translateY(-8px) scale(1.016); box-shadow: 0 44px 110px rgba(0,0,0,0.6); filter:brightness(1.03); }
.time-pill{ padding:8px 12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.04); cursor:pointer; display:flex; align-items:center; gap:10px; font-weight:800; }

.btn{ display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:12px;border:1px solid var(--glass-border); background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.01)); color:var(--text); font-weight:800; cursor:pointer; transition: transform .18s ease, box-shadow .18s ease, background .18s; box-shadow: 0 10px 28px rgba(0,0,0,0.42); backdrop-filter: blur(8px) saturate(140%); }
.btn-primary{ background: linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2)); color:var(--primary-dark); border:1px solid rgba(0,0,0,0.08); box-shadow: 0 22px 64px rgba(255,170,40,0.12); }
.btn-neutral{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:var(--text); border:1px solid rgba(255,255,255,0.04); }
.ripple{ position:absolute; border-radius:50%; transform:scale(0); pointer-events:none; opacity:0.38; background:rgba(255,255,255,0.92); }

/* Layers */
.splash-back{ position:fixed; inset:0; z-index:15000; display:flex; align-items:center; justify-content:center; overflow:hidden; background: linear-gradient(180deg, rgba(0,6,18,0.95), rgba(2,14,30,0.98)); transition: opacity .52s, transform .52s; }
.splash-hidden{ opacity:0; transform: translateY(-8px) scale(.996); pointer-events:none; }
.modal-back{ display:flex !important; align-items:center; justify-content:center; position:fixed; inset:0; z-index:17000; background: rgba(0,0,0,0.56); padding:20px; transition: opacity .22s ease, visibility .22s ease; }
.modal{ width:min(560px,94%); max-width:94%; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(8,12,18,0.94)); border:1px solid rgba(255,255,255,0.06); box-shadow: 0 40px 120px rgba(0,0,0,0.6); }
#confirmModal{ z-index:17500 !important; }

/* Inline tour: part of doc flow under modals */
#inlineTour { position:relative; z-index:12000; display:none; opacity:0; transform: translateY(8px); transition: opacity 260ms ease, transform 260ms ease; pointer-events:auto; }
#inlineTour.show { display:block; opacity:1; transform: translateY(0); }

.kv{font-size:13px;color:var(--muted)}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:var(--text)}
.row{display:flex;gap:8px;align-items:center;margin-top:10px}
@media(max-width:740px){ .airline-grid{ grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } }
</style>
</head>
<body>
<div id="appRoot" class="app-root" aria-hidden="false">
  <div class="container">
    <div id="appHero" class="hero" role="main" aria-label="Main app" tabindex="-1">
      <div class="header">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo">LH</div>
          <div>
            <div style="font-weight:900">Lufthansa Helper</div>
            <div class="subtitle">демо · liquid glass · tactile</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div id="sessionBadge" class="kv">Неавторизован</div>
          <button id="openGateBtn" class="btn btn-neutral">Вход</button>
          <button id="logoutBtn" class="btn btn-neutral" style="display:none">Выйти</button>
        </div>
      </div>

      <div class="tabs" id="tabsRow" style="margin-top:14px">
        <div class="tab active btn" data-target="panelGenerate" id="tabGen">Генерация</div>
        <div class="tab btn" data-target="panelRoutes" id="tabRoutes">Направления</div>
        <div class="tab btn" data-target="panelFleet" id="tabFleet">Флот</div>
        <div id="liquidUnderline" class="liquid-underline"></div>
      </div>

      <div class="controls">
        <input id="airSearch" class="search" placeholder="Поиск авиакомпании или кода" autocomplete="off" />
        <div style="display:flex;align-items:center;gap:10px">
          <strong class="kv">Время</strong>
          <div id="durations" class="durations"></div>
        </div>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <button id="clearBtn" class="btn btn-ghost">Сброс</button>
          <button id="genBtn" class="btn btn-primary"><span class="btn-label">СГЕНЕРИРОВАТЬ</span></button>
        </div>
      </div>

      <div id="airGrid" class="airline-grid" aria-live="polite"></div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px">
        <main>
          <section id="panelGenerate" class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Генерация</div>
              <div class="kv">Нажмите СГЕНЕРИРОВАТЬ</div>
            </div>
            <div id="generatedNote" style="margin-top:12px" class="kv">Выберите авиакомпанию и интервал времени</div>
          </section>

          <section id="panelRoutes" class="panel hidden" style="display:block">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Направления</div>
              <div class="kv">Список маршрутов</div>
            </div>
            <div id="routesList" style="margin-top:12px"></div>
          </section>

          <section id="panelFleet" class="panel hidden" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Флот</div>
              <div class="kv">Самолёты</div>
            </div>
            <div id="fleetList" style="margin-top:12px"></div>
          </section>
        </main>

        <aside>
          <div class="panel" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Пилоты</div>
              <div class="kv">Demo</div>
            </div>
            <div style="margin-top:8px"><input id="pilotSearch" class="input" placeholder="Поиск пилота" /></div>
            <div id="pilotList" style="margin-top:8px"></div>
          </div>

          <div class="panel" style="margin-top:12px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Актуальные рейсы</div>
              <div class="kv">Локально</div>
            </div>
            <div id="currentFlights" class="kv" style="margin-top:8px;max-height:160px;overflow:auto">Нет текущих рейсов</div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Журнал</div>
              <div><button id="openGate2" class="btn btn-ghost">Вход</button></div>
            </div>
            <div id="log" class="kv" style="margin-top:8px;max-height:320px;overflow:auto">Пусто</div>
          </div>
        </aside>
      </div>

      <section id="inlineTour" class="panel" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Краткая инструкция</div>
          <div class="kv">Появляется после входа</div>
        </div>
        <div class="small kv" style="margin-top:10px">
          1) Введите позывной и пароль; 2) Выберите интервал времени; 3) Нажмите СГЕНЕРИРОВАТЬ; 4) Подтвердите бронь.
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="inlineTourClose" class="btn btn-neutral">Скрыть</button>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- Splash -->
<div id="splash" class="splash-back" role="dialog" aria-modal="true" aria-label="Welcome overlay">
  <svg class="splash-clouds" viewBox="0 0 1200 180" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
    <defs><linearGradient id="gC" x1="0" x2="1"><stop offset="0" stop-color="#fff" stop-opacity="0.06"/><stop offset="1" stop-color="#fff" stop-opacity="0.02"/></linearGradient><filter id="blurC" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="16" /></filter></defs>
    <g filter="url(#blurC)" fill="url(#gC)"><ellipse cx="200" cy="50" rx="220" ry="40"></ellipse><ellipse cx="480" cy="40" rx="200" ry="36"></ellipse><ellipse cx="840" cy="60" rx="260" ry="46"></ellipse><ellipse cx="1060" cy="46" rx="160" ry="30"></ellipse></g>
  </svg>

  <div class="splash-waves" aria-hidden="true">
    <svg viewBox="0 0 1440 320" preserveAspectRatio="none" style="width:100%;height:100%"><defs><linearGradient id="waveGrad" x1="0" x2="1"><stop offset="0" stop-color="#ffd54a" stop-opacity="0.10"/><stop offset="1" stop-color="#00aaff" stop-opacity="0.06"/></linearGradient></defs><path id="wavePath" d="M0,160 C300,240 600,80 900,160 C1200,240 1440,80 1440,80 L1440,320 L0,320 Z" fill="url(#waveGrad)"></path></svg>
  </div>

  <div class="splash-center" role="document" style="z-index:15010">
    <h2 id="splashTitle" style="margin:0;font-size:32px">Welcome to Lufthansa Group</h2>
    <div class="splash-sub">Демо интерфейс</div>
    <div style="margin-top:18px"><button id="splashContinue" class="btn btn-primary">Дальше</button></div>
  </div>
</div>

<!-- Gate modal -->
<div id="gateModal" class="modal-back" style="display:none;align-items:center;justify-content:center" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Вход">
    <div style="font-weight:900">Вход в систему</div>
    <div class="small kv" style="margin-top:8px">Введите позывной и пароль. Кодовое слово: <strong>quickaccess2025</strong></div>

    <div class="row" style="margin-top:10px"><input id="loginCall" class="input" placeholder="Позывной (callSign)" autocomplete="username" /></div>
    <div class="row"><input id="loginPass" class="input" placeholder="Пароль или кодовое слово" type="password" autocomplete="current-password" /></div>

    <div class="row" style="align-items:center;margin-top:12px">
      <input id="tourAfterLogin" type="checkbox" checked />
      <label for="tourAfterLogin" class="small" style="margin-left:6px">Показать инструкцию после входа</label>
    </div>

    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px;align-items:center">
      <div><button id="btnDemoQuick" class="btn btn-neutral">Быстрый вход</button></div>
      <div><button id="btnLogin" class="btn btn-primary">Войти</button></div>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmModal" class="modal-back" style="display:none;align-items:center;justify-content:center" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Подтвердить бронь">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="kv" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn btn-neutral">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ====== DATA & STATE ====== */
const CODEWORD = 'quickaccess2025';
const DURATIONS = [{label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},{label:"5–6ч",min:300,max:360},{label:"6–7ч",min:360,max:420},{label:"7–8ч",min:420,max:480},{label:"8–9ч",min:480,max:540},{label:"9–10ч",min:540,max:600},{label:"10+ч",min:600,max:99999}];
const AIRLINES = [{name:"Lufthansa",code:"LH",color:"#1E6FFF"},{name:"Lufthansa Cargo",code:"G0",color:"#0A63D6"},{name:"Eurowings",code:"EW",color:"#8A4BFF"},{name:"Condor",code:"DE",color:"#FFD200"},{name:"Swiss",code:"LX",color:"#D81E5B"},{name:"Austrian",code:"OS",color:"#DA291C"},{name:"Brussels",code:"SN",color:"#003399"},{name:"SunExpress",code:"SX",color:"#FF8A3D"}];

let ROUTES = []; (function(){ let seq=100; const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","EBBR","LIRF","LOWW","ENBR","EKCH","ESSA","LIMC"]; AIRLINES.forEach((a,ai)=>{ for(let i=0;i<5;i++){ const from=base[(ai+i)%base.length]; const to=base[(ai+i+3)%base.length]; const dur=60+(i*30)+(ai*15); ROUTES.push({ id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code, fromICAO:from,toICAO:to,fromCity:'City-'+from,toCity:'City-'+to,durationMinutes:dur }); } }); })();

let FLEET = [{id:"LH-A320-01",airline:"Lufthansa",type:"A320",locationICAO:"EDDF",status:"idle",fuelMinutes:420,turnaround:35,reserveMargin:30},{id:"LX-A320-01",airline:"Swiss",type:"A320",locationICAO:"EDDF",status:"idle",fuelMinutes:380,turnaround:35,reserveMargin:30},{id:"DE-B767-01",airline:"Condor",type:"B767",locationICAO:"EDDF",status:"idle",fuelMinutes:780,turnaround:50,reserveMargin:60}];

let PILOTS = [{id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},{id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}];

let FLEET_LOG = JSON.parse(localStorage.getItem('lh_fleet_log_v1')||'[]');
let CURRENT_FLIGHTS = JSON.parse(localStorage.getItem('lh_current_flights_v1')||'[]');

let PENDING_RESERVATION = null;
let PENDING_RESERVATION_TEMP = null;
window.PENDING_RESERVATION_TEMP = PENDING_RESERVATION_TEMP;

let SESSION = (function(){ try{ const s = sessionStorage.getItem('lh_force_auth_v1'); return s?JSON.parse(s):{pilotId:null}; }catch(e){ return {pilotId:null}; } })();
window.SESSION = SESSION;

let chosenAirline = null;
let chosenDuration = null;
let searchQuery = '';

/* DOM refs */
const splash = document.getElementById('splash');
const splashContinue = document.getElementById('splashContinue');
const gateModal = document.getElementById('gateModal');
const inlineTour = document.getElementById('inlineTour');
const inlineTourClose = document.getElementById('inlineTourClose');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnDemoQuick = document.getElementById('btnDemoQuick');
const openGateBtn = document.getElementById('openGateBtn');
const openGate2 = document.getElementById('openGate2');
const logoutBtn = document.getElementById('logoutBtn');
const sessionBadge = document.getElementById('sessionBadge');
const durWrap = document.getElementById('durations');
const airGrid = document.getElementById('airGrid');
const airSearch = document.getElementById('airSearch');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotListEl = document.getElementById('pilotList');
const currentFlightsEl = document.getElementById('currentFlights');
const logEl = document.getElementById('log');

/* helpers */
function nowMs(){return Date.now();}
function saveToStorage(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function uid(prefix='id'){ return prefix+'_'+Math.random().toString(36).slice(2,9); }

/* ---- APP READY gating ---- */
window.appReady = false;          // becomes true only after splash "Дальше"
window._pendingOpenGate = false;  // someone tried to open gate before ready
window._pendingOpenConfirm = false; // someone tried to open confirm before ready

// safe gate show (replaced by guard below if needed)
function _nativeShowGate(){
  const g = document.getElementById('gateModal');
  if(g){ g.style.display='flex'; g.setAttribute('aria-hidden','false'); setTimeout(()=> loginCall.focus(),70); }
}
window.showGateModal = function(){
  if(!window.appReady){
    window._pendingOpenGate = true;
    return;
  }
  _nativeShowGate();
};

// safe confirm (guarded)
function _nativeSafeShowConfirm(details){
  const c = document.getElementById('confirmModal');
  if(!c) return false;
  const detailsEl = document.getElementById('confirmDetails');
  if(detailsEl) detailsEl.textContent = details && details.text ? details.text : (details && details.route ? `${details.route.fromICAO}→${details.route.toICAO}` : '');
  c.style.display='flex'; c.setAttribute('aria-hidden','false');
  return true;
}
window.safeShowConfirm = function(details){
  if(!window.appReady){
    window._pendingOpenConfirm = true;
    window.PENDING_RESERVATION_TEMP = window.PENDING_RESERVATION_TEMP || {};
    if(details && details.route) window.PENDING_RESERVATION_TEMP.route = details.route;
    return false;
  }
  return _nativeSafeShowConfirm(details);
};

// guard: hide confirm if opened too early by other code
(function confirmGuard(){
  const confirmEl = document.getElementById('confirmModal');
  if(!confirmEl) return;
  confirmEl.style.display = confirmEl.style.display || 'none';
  const mo = new MutationObserver(()=> {
    const isVisible = confirmEl.style.display !== 'none' && confirmEl.getAttribute('aria-hidden') !== 'true';
    if(isVisible && !window.appReady){
      confirmEl.style.display='none';
      confirmEl.setAttribute('aria-hidden','true');
      window._pendingOpenConfirm = true;
    }
  });
  mo.observe(confirmEl, { attributes:true, attributeFilter:['style','aria-hidden'] });
})();

/* render durations */
function renderDurations(){
  durWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const b=document.createElement('div'); b.className='time-pill btn'; b.dataset.idx=i;
    b.innerHTML=`<div style="display:flex;align-items:center;gap:8px"><div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--accent-yellow),var(--accent-yellow-2))"></div><div style="font-weight:800">${d.label}</div></div>`;
    b.addEventListener('click', ()=>{ chosenDuration=(chosenDuration===i)?null:i; Array.from(durWrap.children).forEach((c,idx)=>c.classList.toggle('active', idx===chosenDuration)); renderLists(); });
    b.style.opacity='0'; b.style.transform='translateY(6px)';
    durWrap.appendChild(b);
    setTimeout(()=>{ b.style.transition='transform 360ms cubic-bezier(.2,.9,.2,1), opacity 360ms'; b.style.opacity='1'; b.style.transform='translateY(0)'; }, 60*i);
  });
}

/* render airlines */
function renderAirGrid(){
  airGrid.innerHTML='';
  const filtered = AIRLINES.filter(a=>{ if(!searchQuery) return true; const q=searchQuery.toLowerCase(); return a.name.toLowerCase().includes(q)||(a.code&&a.code.toLowerCase().includes(q)); });
  filtered.forEach((a,i)=>{
    const card=document.createElement('div'); card.className='airline'; card.dataset.airline=a.name; card.dataset.idx=i;
    card.innerHTML = `<div style="width:18px;height:18px;border-radius:50%;background:${a.color}"></div><div class="meta"><div class="name" style="font-weight:900">${a.name}</div><div class="code" style="font-size:12px;color:var(--muted)">${a.code}</div></div>`;
    if(chosenAirline===a.name){ card.classList.add('selected'); }
    card.style.animationDelay = (i*60) + 'ms';
    setTimeout(()=> card.classList.add('float'), 900 + (i%3)*80);
    card.addEventListener('click', ()=>{
      const was = card.classList.contains('selected');
      document.querySelectorAll('.airline.selected').forEach(c=>c.classList.remove('selected'));
      if(!was){ card.classList.add('selected'); chosenAirline=a.name; } else { chosenAirline=null; }
      renderLists();
    });
    card.tabIndex=0; card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') card.click(); });
    card.addEventListener('pointerdown', ev=>{ let r=card.querySelector('.ripple'); if(!r){ r=document.createElement('span'); r.className='ripple'; card.prepend(r); } const rect=card.getBoundingClientRect(); const size=Math.max(rect.width,rect.height)*1.6; r.style.width=r.style.height=size+'px'; r.style.left=(ev.clientX-rect.left-size/2)+'px'; r.style.top=(ev.clientY-rect.top-size/2)+'px'; r.style.transform='scale(0)'; r.style.opacity='0.36'; requestAnimationFrame(()=>{ r.style.transition='transform 480ms cubic-bezier(.2,.9,.2,1), opacity 360ms'; r.style.transform='scale(1)'; }); setTimeout(()=>{ if(r) r.style.opacity='0'; },360); }, {passive:true});
    airGrid.appendChild(card);
  });
}

/* routes & fleet */
function renderRoutes(){
  routesList.innerHTML='';
  const list = ROUTES.filter(r=>{ if(chosenAirline && r.airline!==chosenAirline) return false; if(chosenDuration!==null){ const d=DURATIONS[chosenDuration]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; } return true; });
  if(!list.length){ routesList.innerHTML='<div class="kv">Нет направлений</div>'; return; }
  list.forEach(r=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='10px'; row.style.marginTop='8px'; row.style.borderRadius='10px'; row.style.background='linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02))';
    row.innerHTML = `<div><div style="font-weight:800">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div><div class="kv">${r.fromCity} → ${r.toCity}</div></div><div style="text-align:right"><div class="kv">${r.durationMinutes} мин</div><div style="margin-top:8px"><button class="btn btn-primary btn-select-route" data-id="${r.id}">Выбрать</button></div></div>`;
    routesList.appendChild(row);
  });
  Array.from(document.querySelectorAll('.btn-select-route')).forEach(b=>b.addEventListener('click', ()=>{ const id=b.dataset.id; const r=ROUTES.find(x=>x.id===id); if(r) openConfirmFromRoute(r); }));
}
function renderFleet(){ fleetList.innerHTML=''; FLEET.forEach(f=>{ const el=document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.marginTop='8px'; el.innerHTML=`<div style="font-weight:800">${f.id}</div><div class="kv">${f.airline} · ${f.type} · ${f.fuelMinutes || f.fuel} мин</div>`; fleetList.appendChild(el); }); }

/* pilots, flights, log */
function renderPilots(){ pilotListEl.innerHTML=''; PILOTS.forEach(p=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px'; row.innerHTML=`<div><strong>${p.name}</strong><div class="kv">${p.callSign} ${p.verified? '· Verified':''}</div></div>`; const b=document.createElement('button'); b.className='btn btn-neutral'; b.textContent='Войти'; b.addEventListener('click', ()=>{ loginCall.value = p.callSign; loginPass.value=''; // ensure gate opens after splash if needed
  if(!window.appReady){ window._pendingOpenGate = true; } showGateModal(); }); row.appendChild(b); pilotListEl.appendChild(row); }); }
function renderCurrentFlights(){ currentFlightsEl.innerHTML=''; if(!CURRENT_FLIGHTS.length){ currentFlightsEl.textContent='Нет текущих рейсов'; return; } CURRENT_FLIGHTS.forEach(f=>{ const e=document.createElement('div'); e.className='kv'; e.style.marginTop='8px'; e.innerHTML=`<div style="font-weight:800">${f.aircraftId} · ${f.airline}</div><div class="kv">${f.fromICAO}→${f.toICAO} · ${f.durationMinutes} мин · Пилот ${f.pilotCallsign}</div>`; currentFlightsEl.appendChild(e); }); }
function renderAssignLog(){ logEl.innerHTML=''; if(!FLEET_LOG.length){ logEl.textContent='Пусто'; return; } FLEET_LOG.slice(-200).reverse().forEach(e=>{ const d=document.createElement('div'); d.className='kv'; d.style.marginTop='6px'; d.textContent = `${new Date(e.ts).toLocaleString()} — ${e.msg}`; logEl.appendChild(d); }); }

/* session & modals */
function showGateModal(){ if(!window.appReady){ window._pendingOpenGate = true; return; } const g = document.getElementById('gateModal'); if(g){ g.style.display='flex'; g.setAttribute('aria-hidden','false'); setTimeout(()=> loginCall.focus(),70); } }
function hideGateModal(){ const g = document.getElementById('gateModal'); if(g){ g.style.display='none'; g.setAttribute('aria-hidden','true'); } }

/* show inline tour after splash hidden */
function showInlineTourWhenReady(){
  if(!inlineTour) return;
  const splashEl = document.getElementById('splash');
  const isSplashHidden = !splashEl || (splashEl.style.display === 'none' || splashEl.classList.contains('splash-hidden'));
  if(isSplashHidden){
    inlineTour.classList.add('show'); inlineTour.setAttribute('aria-hidden','false'); inlineTour.scrollIntoView({ behavior:'smooth', block:'start' }); return;
  }
  const onHidden = ()=>{
    splashEl.removeEventListener('transitionend', onHidden); splashEl.removeEventListener('animationend', onHidden);
    setTimeout(()=>{ inlineTour.classList.add('show'); inlineTour.setAttribute('aria-hidden','false'); inlineTour.scrollIntoView({ behavior:'smooth', block:'start' }); }, 80);
  };
  splashEl.addEventListener('transitionend', onHidden); splashEl.addEventListener('animationend', onHidden);
  setTimeout(()=>{ if(!inlineTour.classList.contains('show')) onHidden(); }, 700);
}

/* login handler */
btnLogin.addEventListener('click', async ()=>{
  const cs = (loginCall.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!cs){ alert('Введите позывной'); loginCall.focus(); return; }
  if(!pass){ alert('Введите пароль или кодовое слово'); loginPass.focus(); return; }
  const p = PILOTS.find(x=> (x.callSign||'').toLowerCase() === cs.toLowerCase());
  setButtonLoading(btnLogin, true, {label:'Вход...'});
  await new Promise(r=>setTimeout(r,600));
  if(pass === CODEWORD || (p && p.password === pass)){
    const pilotId = p? p.id : 'guest_'+Date.now();
    SESSION.pilotId = pilotId;
    sessionStorage.setItem('lh_force_auth_v1', JSON.stringify(SESSION));
    renderSession();
    hideGateModal();

    // after login: show inline tour (if enabled) and resume pending reservation (if any)
    setTimeout(()=> {
      const show = document.getElementById('tourAfterLogin');
      if (show && show.checked) showInlineTourWhenReady();

      if(window.PENDING_RESERVATION_TEMP && window.PENDING_RESERVATION_TEMP.route){
        const pendingRoute = window.PENDING_RESERVATION_TEMP.route;
        window.PENDING_RESERVATION_TEMP = null;
        openConfirmFromRoute(pendingRoute);
      }
    }, 260);
  } else {
    alert('Неверный пароль');
    loginPass.focus();
  }
  setButtonLoading(btnLogin, false);
});
btnDemoQuick.addEventListener('click', ()=>{ loginCall.value = PILOTS[0].callSign; loginPass.value = CODEWORD; btnLogin.click(); });
openGateBtn.addEventListener('click', ()=>{ showGateModal(); });
openGate2.addEventListener('click', ()=>{ showGateModal(); });
logoutBtn.addEventListener('click', ()=>{ SESSION.pilotId = null; sessionStorage.removeItem('lh_force_auth_v1'); renderSession(); showGateModal(); });

function renderSession(){ if(SESSION.pilotId){ const p = PILOTS.find(x=>x.id === SESSION.pilotId) || {}; sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл'; logoutBtn.style.display='inline-flex'; openGateBtn.style.display='none'; } else { sessionBadge.textContent='Неавторизован'; logoutBtn.style.display='none'; openGateBtn.style.display='inline-flex'; } }

/* inlineTour close */
if (inlineTourClose) inlineTourClose.addEventListener('click', ()=>{ inlineTour.classList.remove('show'); inlineTour.setAttribute('aria-hidden','true'); document.getElementById('appHero').focus && document.getElementById('appHero').focus(); });

/* reservation helpers */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (typeof ac.fuelMinutes==='number' && ac.fuelMinutes >= (dur + (ac.reserveMargin||30)));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(ac => can(ac));
  if(!cand.length) return null;
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0];
}

/* open confirm: if not logged in -> save temp and open login; else reserve and show confirm */
function openConfirmFromRoute(route){
  const pilot = (SESSION.pilotId ? PILOTS.find(x=>x.id === SESSION.pilotId) : null);
  if(!pilot){
    window.PENDING_RESERVATION_TEMP = window.PENDING_RESERVATION_TEMP || {};
    window.PENDING_RESERVATION_TEMP.route = route;
    // request gate; will be opened when appReady
    showGateModal();
    return;
  }

  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }

  candidate.status='reserved';
  candidate.reservedBy = pilot.id;
  candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,8);
  candidate.reservedUntil = nowMs() + 120000;
  PENDING_RESERVATION = { token: candidate.reservedToken, aircraft: candidate, route, pilotId: pilot.id, expires: candidate.reservedUntil };

  // Use safe API to open confirm (it will respect appReady)
  window.safeShowConfirm({ text: `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${pilot.callSign}`, route });
}

/* confirm handlers */
document.getElementById('confirmAccept').addEventListener('click', ()=> {
  if(!PENDING_RESERVATION){ document.getElementById('confirmModal').style.display='none'; return; }
  const ac = FLEET.find(a=>a.reservedToken === PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); document.getElementById('confirmModal').style.display='none'; return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId);
  if(!(p && p.verified)){ alert('Пилот не верифицирован'); document.getElementById('confirmModal').style.display='none'; return; }
  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status='inFlight';
  ac.availableAt = nowMs() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  const flight = { id: uid('flt'), aircraftId: ac.id, airline: ac.airline, fromICAO: PENDING_RESERVATION.route.fromICAO, toICAO: PENDING_RESERVATION.route.toICAO, durationMinutes: PENDING_RESERVATION.route.durationMinutes, pilotId: p.id, pilotCallsign: p.callSign, ts: nowMs() };
  CURRENT_FLIGHTS.unshift(flight); saveToStorage('lh_current_flights_v1', CURRENT_FLIGHTS);
  FLEET_LOG.unshift({ts: nowMs(), msg:`Рейс подтверждён ${flight.aircraftId} ${flight.fromICAO}->${flight.toICAO} пилот ${flight.pilotCallsign}`}); saveToStorage('lh_fleet_log_v1', FLEET_LOG);
  PENDING_RESERVATION = null; document.getElementById('confirmModal').style.display='none';
  renderLists(); renderCurrentFlights(); renderAssignLog();
  alert('Рейс подтверждён и сохранён в журнале');
});
document.getElementById('confirmCancel').addEventListener('click', ()=> {
  if(PENDING_RESERVATION){ const token=PENDING_RESERVATION.token; FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; FLEET_LOG.unshift({ts:nowMs(), msg:`Бронь отменена ${a.id}`}); } }); PENDING_RESERVATION=null; }
  document.getElementById('confirmModal').style.display='none';
  renderLists(); renderAssignLog();
});

/* periodic maintenance */
setInterval(()=>{ const now=nowMs(); FLEET.forEach(ac=>{ if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil<=now){ ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; FLEET_LOG.unshift({ts:now,msg:`Резервация истекла ${ac.id}`}); } if(ac.status==='inFlight' && ac.availableAt && ac.availableAt<=now){ ac.status='idle'; delete ac.availableAt; FLEET_LOG.unshift({ts:now,msg:`Самолёт вернулся в сервис ${ac.id}`}); } }); saveToStorage('lh_fleet_log_v1', FLEET_LOG); renderAssignLog(); renderFleet(); }, 1500);

/* UI helpers */
function renderLists(){ renderAirGrid(); renderDurations(); renderRoutes(); renderFleet(); renderPilots(); renderAssignLog(); renderCurrentFlights(); }

/* tabs underline */
const tabEls = document.querySelectorAll('.tab');
const underline = document.getElementById('liquidUnderline');
function placeUnderline(activeEl){
  if(!activeEl){ underline.style.opacity='0'; return; }
  const parentRect = activeEl.parentElement.getBoundingClientRect();
  const r = activeEl.getBoundingClientRect();
  underline.style.left = (r.left - parentRect.left) + 'px';
  underline.style.width = r.width + 'px';
  underline.style.opacity = '1';
}
tabEls.forEach(t=> t.addEventListener('click', ()=>{ tabEls.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const target=t.dataset.target; ['panelGenerate','panelRoutes','panelFleet'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.style.display = (id===target)?'block':'none'; el.classList.toggle('hidden', id!==target); }); placeUnderline(t); }));
window.addEventListener('resize', ()=>{ const active=document.querySelector('.tab.active'); if(active) placeUnderline(active); });

/* search & clear */
airSearch.addEventListener('input', ()=>{ searchQuery = airSearch.value.trim(); renderAirGrid(); });
document.getElementById('clearBtn').addEventListener('click', ()=>{ searchQuery=''; airSearch.value=''; chosenAirline=null; chosenDuration=null; Array.from(durWrap.children).forEach(c=>c.classList.remove('active')); renderLists(); });

/* gen button */
document.getElementById('genBtn').addEventListener('click', async ()=>{
  if(!SESSION.pilotId){ showGateModal(); return; }
  setButtonLoading(document.getElementById('genBtn'), true, {label:'Генерация...'});
  await new Promise(r=>setTimeout(r,1200));
  const pool = ROUTES.filter(r=>{ if(chosenAirline && r.airline!==chosenAirline) return false; if(chosenDuration!==null){ const d=DURATIONS[chosenDuration]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; } return true; });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); setButtonLoading(document.getElementById('genBtn'), false); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
  setButtonLoading(document.getElementById('genBtn'), false);
});

/* splash waves animation */
(function animateWaves(){ const path = document.getElementById('wavePath'); if(!path) return; let t=0; function step(){ t += 0.008; const amp = 12; const d1 = `M0,160 C300,${160+Math.sin(t*1.2)*amp+60} 600,${160+Math.cos(t*0.7)*amp+40} 900,${160+Math.sin(t*0.5)*amp+60} C1200,${160+Math.cos(t*0.9)*amp+40} 1440,${80+Math.sin(t*0.3)*amp} 1440,80 L1440,320 L0,320 Z`; path.setAttribute('d', d1); requestAnimationFrame(step);} requestAnimationFrame(step); })();

/* splash close -> mark app ready and open pending modals */
splashContinue.addEventListener('click', ()=>{
  splash.classList.add('splash-hidden');
  setTimeout(()=>{ try{ splash.style.display='none'; }catch(e){} }, 520);

  // mark ready
  window.appReady = true;

  // if someone tried to open gate earlier - show it now
  if(window._pendingOpenGate){
    window._pendingOpenGate = false;
    setTimeout(()=>{ _nativeShowGate(); }, 120);
  }

  // if confirm was requested earlier - handle it now
  if(window._pendingOpenConfirm){
    window._pendingOpenConfirm = false;
    // if a pending route exists - try to resume reservation (will check auth inside)
    if(window.PENDING_RESERVATION_TEMP && window.PENDING_RESERVATION_TEMP.route){
      const pendingRoute = window.PENDING_RESERVATION_TEMP.route;
      // try to open confirm via normal flow
      setTimeout(()=>{ openConfirmFromRoute(pendingRoute); }, 160);
    } else {
      setTimeout(()=>{ _nativeSafeShowConfirm(); }, 160);
    }
  }

  // optionally auto-open gate after splash (commented out by default)
  // setTimeout(()=> _nativeShowGate(), 380);
});

/* ripples & loading */
function createRippleEl(){ const r=document.createElement('span'); r.className='ripple'; r.style.width=r.style.height='8px'; r.style.left='0px'; r.style.top='0px'; return r; }
function attachRippleForAll(scope=document){ const els = scope.querySelectorAll('.btn'); els.forEach(btn=>{ if(btn._rippleAttached) return; btn._rippleAttached=true; btn.addEventListener('pointerdown', function(ev){ if(btn.getAttribute('aria-disabled')==='true' || btn.disabled) return; let r = btn.querySelector('.ripple'); if(!r){ r = createRippleEl(); btn.prepend(r); } const rect = btn.getBoundingClientRect(); const size = Math.max(rect.width, rect.height)*1.4; r.style.width = r.style.height = size + 'px'; const x = ev.clientX - rect.left - size/2; const y = ev.clientY - rect.top - size/2; r.style.left = x + 'px'; r.style.top = y + 'px'; r.style.transform='scale(0)'; r.style.opacity='0.36'; void r.offsetWidth; r.style.transition='transform 480ms cubic-bezier(.2,.9,.2,1), opacity 360ms'; r.style.transform='scale(1)'; setTimeout(()=> r.style.opacity='0',420); }, {passive:true}); }); }
function setButtonLoading(btn,isLoading,opts={}){ if(!btn) return; if(isLoading){ btn.setAttribute('aria-disabled','true'); btn.disabled=true; if(!btn.querySelector('.btn-spinner')){ const s=document.createElement('span'); s.className='btn-spinner'; s.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16"><circle cx="12" cy="12" r="10" stroke="rgba(0,0,0,0.12)" stroke-width="2" fill="none"/><path d="M22 12a10 10 0 0 1-10 10" stroke="rgba(0,0,0,0.36)" stroke-width="2" stroke-linecap="round" fill="none"/></svg>'; btn.prepend(s); } if(opts.label){ if(!btn._orig) btn._orig = btn.textContent; btn.textContent = ''; const span=document.createElement('span'); span.className='btn-label'; span.textContent = opts.label; btn.appendChild(span); } } else { btn.removeAttribute('aria-disabled'); btn.disabled=false; const sp=btn.querySelector('.btn-spinner'); if(sp) sp.remove(); if(btn._orig){ btn.textContent = btn._orig; delete btn._orig; } } }

/* attach ripples */
document.addEventListener('DOMContentLoaded', ()=> attachRippleForAll(document));

/* init */
function init(){ renderLists(); renderSession(); renderPilots(); renderAssignLog(); renderCurrentFlights(); const defaultTab = document.querySelector('.tab[data-target="panelGenerate"]'); if(defaultTab){ defaultTab.classList.add('active'); placeUnderline(defaultTab); } }
init();
</script>
</body>
</html>
